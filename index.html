<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog.johnnyreilly.com/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog.johnnyreilly.com/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Blog | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="Blog | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/blog.johnnyreilly.com/img/favicon.ico"><script data-react-helmet="true">document.addEventListener("DOMContentLoaded",(function(){var n=document.getElementById("base-url-issue-banner-container");if(n){var e=window.location.pathname,t="/"===e.substr(-1)?e:e+"/";n.innerHTML=t}}))</script><link rel="stylesheet" href="/blog.johnnyreilly.com/styles.a30a8c8e.css">
<link rel="preload" href="/blog.johnnyreilly.com/styles.b80bbee1.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/runtime~main.94d0c56d.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/main.08f1a502.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/1.b4966bec.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/2.7d3f6764.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/a6aa9e1f.88297f1e.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/c3b5bd8c.4d75ffb7.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/e5855285.e4205732.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/564c5296.c117dea0.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/0e1441f0.e386d6bd.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/563b17c1.d76d648e.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/867cd795.8eb4a3f0.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/dbef44d7.0ace3e41.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/ed8dd490.008ff954.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/734a1624.9354b688.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/f8e14f4a.0844f5a2.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/de233e4b.36c6c7e8.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/9127ef1b.583f01b9.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div class="baseUrlIssueBanner_1-cE" style="border:solid red thick;background-color:#ffe6b3;margin:20px;padding:20px;font-size:20px"><p style="font-weight:bold;font-size:30px">Your Docusaurus site did not load properly.</p><p>A very common reason is a wrong site <a href="https://v2.docusaurus.io/docs/docusaurus.config.js/#baseurl" style="font-weight:bold">baseUrl configuration</a>.</p><p>Current configured baseUrl = <span style="font-weight:bold;color:red">/blog.johnnyreilly.com/</span> </p><p>We suggest trying baseUrl = <span style="font-weight:bold;color:green" id="base-url-issue-banner-container"></span> </p></div><nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/blog.johnnyreilly.com/"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/blog.johnnyreilly.com/"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/03/10/managed-identity-azure-sql-entity-framework">Managed Identity, Azure SQL and Entity Framework</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/03/06/generate-typescript-and-csharp-clients-with-nswag">Generate TypeScript and CSharp clients with NSwag based on an API</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure">Goodbye Client Affinity, Hello Data Protection with Azure</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service">Making Easy Auth tokens survive releases on Linux Azure App Service</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/11/azure-app-service-health-checks-and-zero-downtime-deployments">Azure App Service, Health checks and zero downtime deployments</a></li></ul></div></div><main class="col col--8"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2021/03/10/managed-identity-azure-sql-entity-framework">Managed Identity, Azure SQL and Entity Framework</a></h2><div class="margin-vert--md"><time datetime="2021-03-10T00:00:00.000Z" class="blogPostDate_Ta7i">March 10, 2021  · 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>Managed Identity offers a very secure way for applications running in Azure to connect to Azure SQL databases. It&#x27;s an approach that does not require code changes; merely configuration of connection string and associated resources. Hence it has a good developer experience. Importantly, it allows us to avoid exposing our database to username / password authentication, and hence making it a tougher target for bad actors.</p><p>This post talks us through using managed identity for connecting to Azure SQL. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="integrated-securitytrue"></a><code>Integrated Security=true</code><a class="hash-link" href="#integrated-securitytrue" title="Direct link to heading">#</a></h4><p>Everyone is deploying to the cloud. Few are the organisations that view deployment to data centers they manage as the future. This is generally a good thing, however in the excitement of the new, it&#x27;s possible to forget some of the good properties that &quot;on premise&quot; deployment afforded when it came to connectivity and authentication.</p><p>I speak of course, of our old friend <code>Integrated Security=true</code>. When you seek to connect a web application to a database, you&#x27;ll typically use some kind of database connection string. And back in the day, it may have looked something like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Data Source=myServer;Initial Catalog=myDB;Integrated Security=true;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The above provides a database server, a database and also <code>Integrated Security=true</code>. When you see <code>Integrated Security=true</code>, what you&#x27;re essentially looking at is an instruction to use the identity that an application is running under (typically called a &quot;service account&quot;) as the authentication credential to secure access to the database. Under the covers, this amounts to <a href="https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/authentication-in-sql-server" target="_blank" rel="noopener noreferrer">Windows Authentication</a>.</p><p>The significant thing about this approach is that it is more secure than using usernames and passwords in the connection string. If you have to use username and password to authenticate, then you need to persist them somewhere - so you need to make sure that&#x27;s secure. Also, if someone manages to acquire that username and password, they&#x27;re free to get access to the database and do malicious things.</p><p>Bottom line: the less you are sharing authentication credentials, the better your security. Integrated Security is a harder nut to crack than username and password. The thing to note about the above phrase is &quot;Windows Authentication&quot;.  Web Apps in Azure / AWS etc do not typically use Windows Authentication when it comes to connecting to the database.  Connecting with username / password is far more common.</p><p>What if there was a way to have the developer experience of <code>Integrated Security=true</code> without needing to use Windows Authentication?  There is.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="managed-identity"></a>Managed Identity<a class="hash-link" href="#managed-identity" title="Direct link to heading">#</a></h4><p>The docs express the purpose of <a href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview" target="_blank" rel="noopener noreferrer">managed identity</a> well:</p><blockquote><p>A common challenge for developers is the management of secrets and credentials to secure communication between different services. On Azure, managed identities eliminate the need for developers having to manage credentials by providing an identity for the Azure resource in Azure AD and using it to obtain Azure Active Directory (Azure AD) tokens</p></blockquote><p>Historically a certain amount of ceremony was required to use managed identity to connect to a database, and could involve augmenting a <code>DbContext</code> like so:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public MyDbContext(DbContextOptions options) : base(options) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var conn = (Microsoft.Data.SqlClient.SqlConnection)Database.GetDbConnection();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var credential = new DefaultAzureCredential();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var token = credential</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .GetToken(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            new Azure.Core.TokenRequestContext(new[] { &quot;https://database.windows.net/.default&quot; })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    conn.AccessToken = token.Token;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This mechanism works, and has the tremendous upside of no longer requiring credentials be passed in a connection string.  However, as you can see this isn&#x27;t the simplest of setups.  And also, what if you don&#x27;t want to use managed identity when you&#x27;re developing locally?  This approach has baggage and forces us to make code changes.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="connection-string-alone"></a>Connection String alone<a class="hash-link" href="#connection-string-alone" title="Direct link to heading">#</a></h4><p>The wonderful aspect of the original <code>Integrated Security=true</code> approach, was that there were no code changes required; one need only supply the connection string. Just configuration.</p><p>This is now possible with Azure SQL thanks to <a href="https://github.com/dotnet/SqlClient/pull/730" target="_blank" rel="noopener noreferrer">this PR</a> to the <a href="https://www.nuget.org/packages/Microsoft.Data.SqlClient/" target="_blank" rel="noopener noreferrer">Microsoft.Data.SqlClient</a> nuget package. (Incidentally, <a href="https://devblogs.microsoft.com/dotnet/introducing-the-new-microsoftdatasqlclient/" target="_blank" rel="noopener noreferrer">Microsoft.Data.SqlClient is the successor to System.Data.SqlClient.</a>)</p><p>Support for connection string managed identities <a href="https://github.com/dotnet/SqlClient/blob/master/release-notes/2.1/2.1.0.md#Azure-Active-Directory-Managed-Identity-authentication" target="_blank" rel="noopener noreferrer">shipped with v2.1</a>. Connection strings can look slightly different depending on the type of managed identity you&#x27;re using:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// For System Assigned Managed Identity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;Server:{serverURL}; Authentication=Active Directory MSI; Initial Catalog={db};&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// For System Assigned Managed Identity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;Server:{serverURL}; Authentication=Active Directory Managed Identity; Initial Catalog={db};&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// For User Assigned Managed Identity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;Server:{serverURL}; Authentication=Active Directory MSI; User Id={ObjectIdOfManagedIdentity}; Initial Catalog={db};&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// For User Assigned Managed Identity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;Server:{serverURL}; Authentication=Active Directory Managed Identity; User Id={ObjectIdOfManagedIdentity}; Initial Catalog={db};&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Regardless of the approach, you can see that none of the connection strings have credentials in them.  And that&#x27;s special.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="usage-with-entity-framework-core-5"></a>Usage with Entity Framework Core 5<a class="hash-link" href="#usage-with-entity-framework-core-5" title="Direct link to heading">#</a></h4><p>If you&#x27;re using Entity Framework Core, you might be struggling to get this working and encountering strange error messages.  In my ASP.NET project I had a dependendency on
<a href="https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.SqlServer/5.0.4" target="_blank" rel="noopener noreferrer">Microsoft.EntityFrameworkCore.SqlServer@5</a>.</p><p><img alt="Microsoft.EntityFrameworkCore.SqlServer@5 in NuGet" src="/blog.johnnyreilly.com/assets/images/entity-framework-core-nuget-d1da164951dd2d6e8b7c794b7c959d58.png"></p><p>If you look close above, you&#x27;ll see that the package has a dependency on Microsoft.Data.SqlClient, but crucially on 2.0.1 or greater.  So if <code>dotnet</code> has installed a version of Microsoft.Data.SqlClient which is <em>less</em> than 2.1 then the functionality required will not be installed. The resolution is simple, ensure that the required version is installed:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">dotnet add package Microsoft.Data.SqlClient --version 2.1.2</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The version which we want to use is 2.1 (or greater) and fortunately that is compatible with Entity Framework Core 5.  Incidentally, when Entity Framework Core 6 ships it will no longer be necessary to manually specify this dependency as it already requires <a href="mailto:Microsoft.Data.SqlClient@2.1" target="_blank" rel="noopener noreferrer">Microsoft.Data.SqlClient@2.1</a> as a minimum.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="user-assigned-managed-identity"></a>User Assigned Managed Identity<a class="hash-link" href="#user-assigned-managed-identity" title="Direct link to heading">#</a></h4><p>If you&#x27;re using user assigned managed identity, you&#x27;ll need to supply the object id of your managed identity, which you can find in the <a href="https://portal.azure.com/" target="_blank" rel="noopener noreferrer">Azure Portal</a>:</p><p><img alt="Managed Identity object id" src="/blog.johnnyreilly.com/assets/images/managed-identity-object-id-25de76ce41faea196959927a3fefe1e0.png"></p><p>You can configure this in ARM as well, but cryptically, the object id goes by the nom de plume of <code>principalId</code> (thanks to my partner in crime <a href="https://github.com/jmccor99" target="_blank" rel="noopener noreferrer">John McCormick</a> for puzzling that out):</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token property">&quot;CONNECTIONSTRINGS__OURDBCONNECTION&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(&#x27;Server=tcp:&#x27;, parameters(&#x27;sqlServerName&#x27;) , &#x27;.database.windows.net,1433;Initial Catalog=&#x27;, parameters(&#x27;sqlDatabaseName&#x27;),&#x27;;Authentication=Active Directory MSI&#x27;,&#x27;;User Id=&#x27;, reference(resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities/&#x27;, parameters(&#x27;managedIdentityName&#x27;)), &#x27;2018-11-30&#x27;).principalId)]&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>That&#x27;s it! With managed identity handling your authentication you can sleep easy, knowing you should be in a better place security wise.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/connection-string">connection string</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/managed-identity">managed identity</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/entity-framework">entity framework</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/microsoft-data-sql-client">Microsoft.Data.SqlClient</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2021/03/06/generate-typescript-and-csharp-clients-with-nswag">Generate TypeScript and CSharp clients with NSwag based on an API</a></h2><div class="margin-vert--md"><time datetime="2021-03-06T00:00:00.000Z" class="blogPostDate_Ta7i">March 6, 2021  · 9 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>Generating clients for APIs is a tremendous way to reduce the amount of work you have to do when you&#x27;re building a project. Why handwrite that code when it can be auto-generated for you quickly and accurately by a tool like <a href="https://github.com/RicoSuter/NSwag" target="_blank" rel="noopener noreferrer">NSwag</a>? To quote the docs:</p><blockquote><p>The NSwag project provides tools to generate OpenAPI specifications from existing ASP.NET Web API controllers and client code from these OpenAPI specifications. The project combines the functionality of Swashbuckle (OpenAPI/Swagger generation) and AutoRest (client generation) in one toolchain.</p></blockquote><p>There&#x27;s some great posts out there that show you how to generate the clients with NSwag using an <code>nswag.json</code> file directly from a .NET project.</p><p>However, what if you want to use NSwag purely for its client generation capabilities? You may have an API written with another language / platform that exposes a Swagger endpoint, that you simply wish to create a client for. How do you do that? Also, if you want to do some special customisation of the clients you&#x27;re generating, you may find yourself struggling to configure that in <code>nswag.json</code>. In that case, it&#x27;s possible to hook into NSwag directly to do this with a simple .NET console app.</p><p>This post will:</p><ul><li>Create a .NET API which exposes a Swagger endpoint. (Alternatively, you could use any other Swagger endpoint; <a href="https://blog.logrocket.com/documenting-your-express-api-with-swagger/" target="_blank" rel="noopener noreferrer">for example an Express API</a>.)</li><li>Create a .NET console app which can create both TypeScript and CSharp clients from a Swagger endpoint.</li><li>Create a script which, when run, creates a TypeScript client.</li><li>Consume the API using the generated client in a simple TypeScript application.</li></ul><p>You will need both <a href="https://nodejs.org/en/" target="_blank" rel="noopener noreferrer">Node.js</a> and the <a href="https://dotnet.microsoft.com/download" target="_blank" rel="noopener noreferrer">.NET SDK</a> installed.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="create-an-api"></a>Create an API<a class="hash-link" href="#create-an-api" title="Direct link to heading">#</a></h2><p>We&#x27;ll now create an API which exposes a <a href="https://swagger.io/resources/open-api/" target="_blank" rel="noopener noreferrer">Swagger / Open API</a> endpoint. Whilst we&#x27;re doing that we&#x27;ll create a TypeScript React app which we&#x27;ll use later on. We&#x27;ll drop to the command line and enter the following commands which use the .NET SDK, node and the <code>create-react-app</code> package:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-shell codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">mkdir</span><span class="token plain"> src</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> src</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">npx create-react-app client-app --template typescript</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">mkdir</span><span class="token plain"> server-app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> server-app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dotnet new api -o API</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> API</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> package NSwag.AspNetCore</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>We now have a .NET API with a dependency on NSwag. We&#x27;ll start to use it by replacing the <code>Startup.cs</code> that&#x27;s been generated with the following:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Builder;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Hosting;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.Configuration;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.Hosting;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace API</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class Startup</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        const string ALLOW_DEVELOPMENT_CORS_ORIGINS_POLICY = &quot;AllowDevelopmentSpecificOrigins&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        const string LOCAL_DEVELOPMENT_URL = &quot;http://localhost:3000&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public Startup(IConfiguration configuration)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Configuration = configuration;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public IConfiguration Configuration { get; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // This method gets called by the runtime. Use this method to add services to the container.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public void ConfigureServices(IServiceCollection services)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            services.AddControllers();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            services.AddCors(options =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                options.AddPolicy(name: ALLOW_DEVELOPMENT_CORS_ORIGINS_POLICY,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    builder =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        builder.WithOrigins(LOCAL_DEVELOPMENT_URL)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .AllowAnyMethod()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .AllowAnyHeader()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .AllowCredentials();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Register the Swagger services</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            services.AddSwaggerDocument();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public void Configure (IApplicationBuilder app, IWebHostEnvironment env)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (env.IsDevelopment())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                app.UseDeveloperExceptionPage();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            } </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                app.UseExceptionHandler(&quot;/Error&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                app.UseHsts ();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                app.UseHttpsRedirection();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseDefaultFiles();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseStaticFiles();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseRouting();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseAuthorization();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Register the Swagger generator and the Swagger UI middlewares</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseOpenApi();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseSwaggerUi3();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (env.IsDevelopment())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                app.UseCors(ALLOW_DEVELOPMENT_CORS_ORIGINS_POLICY);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseEndpoints(endpoints =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                endpoints.MapControllers();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The significant changes in the above <code>Startup.cs</code> are:</p><ol><li>Exposing a Swagger endpoint with <code>UseOpenApi</code> and <code>UseSwaggerUi3</code>. NSwag will automagically create Swagger endpoints in your application for all your controllers. The .NET template ships with a <code>WeatherForecastController</code>.</li><li>Allowing <a href="https://docs.microsoft.com/en-us/aspnet/core/security/cors" target="_blank" rel="noopener noreferrer">Cross-Origin Requests (CORS)</a> which is useful during development (and will facilitate a demo later).</li></ol><p>Back in the root of our project we&#x27;re going to initialise an npm project. We&#x27;re going to use this to put in place a number of handy <a href="https://docs.npmjs.com/cli/v6/using-npm/scripts" target="_blank" rel="noopener noreferrer"><code>npm scripts</code></a> that will make our project easier to work with. So we&#x27;ll <code>npm init</code> and accept all the defaults.</p><p>Now we&#x27;re going add some dependencies which our scripts will use: <code>npm install cpx cross-env npm-run-all start-server-and-test</code></p><p>We&#x27;ll also add ourselves some <code>scripts</code> to our <code>package.json</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token property">&quot;scripts&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;postinstall&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;npm run install:client-app &amp;&amp; npm run install:server-app&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;install:client-app&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cd src/client-app &amp;&amp; npm install&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;install:server-app&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cd src/server-app/API &amp;&amp; dotnet restore&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;build&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;npm run build:client-app &amp;&amp; npm run build:server-app&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;build:client-app&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cd src/client-app &amp;&amp; npm run build&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;postbuild:client-app&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cpx \&quot;src/client-app/build/**/*.*\&quot; \&quot;src/server-app/API/wwwroot/\&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;build:server-app&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cd src/server-app/API &amp;&amp; dotnet build --configuration release&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;start&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;run-p start:client-app start:server-app&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;start:client-app&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cd src/client-app &amp;&amp; npm start&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;start:server-app&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cross-env ASPNETCORE_URLS=http://*:5000 ASPNETCORE_ENVIRONMENT=Development dotnet watch --project src/server-app/API run --no-launch-profile&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Let&#x27;s walk through what the above scripts provide us with:</p><ul><li>Running <code>npm install</code> in the root of our project will not only install dependencies for our root <code>package.json</code>, thanks to our <code>postinstall</code>, <code>install:client-app</code> and <code>install:server-app</code> scripts it will install the React app and .NET app dependencies as well.</li><li>Running <code>npm run build</code> will build our client and server apps.</li><li>Running <code>npm run start</code> will start both our React app and our .NET app. Our React app will be started at <a href="http://localhost:3000" target="_blank" rel="noopener noreferrer">http://localhost:3000</a>. Our .NET app will be started at <a href="http://localhost:5000" target="_blank" rel="noopener noreferrer">http://localhost:5000</a> (some environment variables are passed to it with <a href="https://github.com/kentcdodds/cross-env" target="_blank" rel="noopener noreferrer"><code>cross-env</code></a> ).</li></ul><p>Once <code>npm run start</code> has been run, you will find a Swagger endpoint at <a href="http://localhost:5000/swagger" target="_blank" rel="noopener noreferrer">http://localhost:5000/swagger</a>:</p><p><img alt="swagger screenshot" src="/blog.johnnyreilly.com/assets/images/swagger-0d11295a182e25826af77915f0f1c321.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-client-generator-project"></a>The client generator project<a class="hash-link" href="#the-client-generator-project" title="Direct link to heading">#</a></h2><p>Now we&#x27;ve scaffolded our Swagger-ed API, we want to put together the console app that will generate our typed clients.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-shell codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> src/server-app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dotnet new console -o APIClientGenerator</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> APIClientGenerator</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> package NSwag.CodeGeneration.CSharp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> package NSwag.CodeGeneration.TypeScript</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> package NSwag.Core</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>We now have a console app with dependencies on the code generation portions of NSwag. Now let&#x27;s change up <code>Program.cs</code> to make use of this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.IO;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Threading.Tasks;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using NJsonSchema;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using NJsonSchema.CodeGeneration.TypeScript;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using NJsonSchema.Visitors;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using NSwag;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using NSwag.CodeGeneration.CSharp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using NSwag.CodeGeneration.TypeScript;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace APIClientGenerator</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    class Program</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        static async Task Main(string[] args)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (args.Length != 3)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new ArgumentException(&quot;Expecting 3 arguments: URL, generatePath, language&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var url = args[0];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var generatePath = Path.Combine(Directory.GetCurrentDirectory(), args[1]);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var language = args[2];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (language != &quot;TypeScript&quot; &amp;&amp; language != &quot;CSharp&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new ArgumentException(&quot;Invalid language parameter; valid values are TypeScript and CSharp&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (language == &quot;TypeScript&quot;) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                await GenerateTypeScriptClient(url, generatePath);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                await GenerateCSharpClient(url, generatePath);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        async static Task GenerateTypeScriptClient(string url, string generatePath) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            await GenerateClient(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                document: await OpenApiDocument.FromUrlAsync(url),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                generatePath: generatePath,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                generateCode: (OpenApiDocument document) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var settings = new TypeScriptClientGeneratorSettings();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    settings.TypeScriptGeneratorSettings.TypeStyle = TypeScriptTypeStyle.Interface;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    settings.TypeScriptGeneratorSettings.TypeScriptVersion = 3.5M;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    settings.TypeScriptGeneratorSettings.DateTimeType = TypeScriptDateTimeType.String;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var generator = new TypeScriptClientGenerator(document, settings);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var code = generator.GenerateFile();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    return code;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        async static Task GenerateCSharpClient(string url, string generatePath) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            await GenerateClient(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                document: await OpenApiDocument.FromUrlAsync(url),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                generatePath: generatePath,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                generateCode: (OpenApiDocument document) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var settings = new CSharpClientGeneratorSettings</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        UseBaseUrl = false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var generator = new CSharpClientGenerator(document, settings);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var code = generator.GenerateFile();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    return code;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private async static Task GenerateClient(OpenApiDocument document, string generatePath, Func&lt;OpenApiDocument, string&gt; generateCode)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Console.WriteLine($&quot;Generating {generatePath}...&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var code = generateCode(document);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            await System.IO.File.WriteAllTextAsync(generatePath, code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>We&#x27;ve created ourselves a simple .NET console application that creates TypeScript and CSharp clients for a given Swagger URL. It expects three arguments:</p><ul><li><code>url</code> - the url of the <code>swagger.json</code> file to generate a client for.</li><li><code>generatePath</code> - the path where the generated client file should be placed, relative to this project.</li><li><code>language</code> - the language of the client to generate; valid values are &quot;TypeScript&quot; and &quot;CSharp&quot;.</li></ul><p>To create a TypeScript client with it then we&#x27;d use the following command:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-shell codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">dotnet run --project src/server-app/APIClientGenerator http://localhost:5000/swagger/v1/swagger.json src/client-app/src/clients.ts TypeScript</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>However, for this to run successfully, we&#x27;ll first have to ensure the API is running. It would be great if we had a single command we could run that would:</p><ul><li>bring up the API</li><li>generate a client</li><li>bring down the API</li></ul><p>Let&#x27;s make that.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="building-a-make-a-client-script"></a>Building a &quot;make a client&quot; script<a class="hash-link" href="#building-a-make-a-client-script" title="Direct link to heading">#</a></h2><p>In the root of the project we&#x27;re going to add the following <code>scripts</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token property">&quot;generate-client:server-app&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;start-server-and-test generate-client:server-app:serve http-get://localhost:5000/swagger/v1/swagger.json generate-client:server-app:generate&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;generate-client:server-app:serve&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cross-env ASPNETCORE_URLS=http://*:5000 ASPNETCORE_ENVIRONMENT=Development dotnet run --project src/server-app/API --no-launch-profile&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;generate-client:server-app:generate&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;dotnet run --project src/server-app/APIClientGenerator http://localhost:5000/swagger/v1/swagger.json src/client-app/src/clients.ts TypeScript&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Let&#x27;s walk through what&#x27;s happening here. Running <code>npm run generate-client:server-app</code> will:</p><ul><li>Use the <a href="https://github.com/bahmutov/start-server-and-test" target="_blank" rel="noopener noreferrer"><code>start-server-and-test</code></a> package to spin up our server-app by running the <code>generate-client:server-app:serve</code> script.</li><li><code>start-server-and-test</code> waits for the Swagger endpoint to start responding to requests. When it does start responding, <code>start-server-and-test</code> runs the <code>generate-client:server-app:generate</code> script which runs our APIClientGenerator console app and provides it with the URL where our swagger can be found, the path of the file to generate and the language of &quot;TypeScript&quot;</li></ul><p>If you were wanting to generate a C# client (say if you were writing a <a href="https://blog.logrocket.com/js-free-frontends-blazor/" target="_blank" rel="noopener noreferrer">Blazor</a> app) then you could change the <code>generate-client:server-app:generate</code> script as follows:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token property">&quot;generate-client:server-app:generate&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;dotnet run --project src/server-app/ApiClientGenerator http://localhost:5000/swagger/v1/swagger.json clients.cs CSharp&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="consume-our-generated-api-client"></a>Consume our generated API client<a class="hash-link" href="#consume-our-generated-api-client" title="Direct link to heading">#</a></h2><p>Let&#x27;s run the <code>npm run generate-client:server-app</code> command. It creates a <code>clients.ts</code> file which nestles nicely inside our <code>client-app</code>. We&#x27;re going to exercise that in a moment. First of all, let&#x27;s enable proxying from our <code>client-app</code> to our <code>server-app</code> following the instructions in the <a href="https://create-react-app.dev/docs/proxying-api-requests-in-development/" target="_blank" rel="noopener noreferrer">Create React App docs</a> and adding the following to our <code>client-app/package.json</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token property">&quot;proxy&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;http://localhost:5000&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Now let&#x27;s start our apps with <code>npm run start</code>. We&#x27;ll then replace the contents of <code>App.tsx</code> with:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-jsx codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> React </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;react&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;./App.css&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> WeatherForecast</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> WeatherForecastClient </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;./clients&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">App</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">weather</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> setWeather</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> React</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">useState</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">WeatherForecast</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">null</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  React</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">useEffect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">loadWeather</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> weatherClient </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">WeatherForecastClient</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* baseUrl */</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> forecast </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> weatherClient</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token function" style="color:rgb(130, 170, 255)">setWeather</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">forecast</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">loadWeather</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">setWeather</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">div</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">className</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">App</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">header</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">className</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">App-header</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">weather </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">table</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">thead</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">tr</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">th</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">Date</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">th</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">th</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">Summary</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">th</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">th</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">Centigrade</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">th</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">th</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">Fahrenheit</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">th</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">tr</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">thead</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">tbody</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">weather</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">map</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token parameter"> date</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> summary</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> temperatureC</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> temperatureF </span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">tr</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">key</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">date</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">td</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">toLocaleDateString</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">td</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">td</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">summary</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">td</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">td</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">temperatureC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">td</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">td</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">temperatureF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">td</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">tr</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">tbody</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">table</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">p</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">Loading weather</span><span class="token operator" style="color:rgb(137, 221, 255)">...</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">p</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">header</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">div</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">default</span><span class="token plain"> App</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Inside the <code>React.useEffect</code> above you can see we create a new instance of the auto-generated <code>WeatherForecastClient</code>. We then call <code>weatherClient.get()</code> which sends the <code>GET</code> request to the server to acquire the data and provides it in a strongly typed fashion (<code>get()</code> returns an array of <code>WeatherForecast</code>). This is then displayed on the page like so:</p><p><img alt="load data from server" src="/blog.johnnyreilly.com/assets/images/use-generated-client-37998806f2c5b14790c76479439f4300.gif"></p><p>As you an see we&#x27;re loading data from the server using our auto-generated client. We&#x27;re reducing the amount of code we have to write <em>and</em> we&#x27;re reducing the likelihood of errors.</p><p><em>This post was originally posted on <a href="https://blog.logrocket.com/generate-typescript-csharp-clients-nswag-api/" target="_blank" rel="noopener noreferrer">LogRocket</a>.</em></p></section></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure">Goodbye Client Affinity, Hello Data Protection with Azure</a></h2><div class="margin-vert--md"><time datetime="2021-02-27T00:00:00.000Z" class="blogPostDate_Ta7i">February 27, 2021  · 4 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>I&#x27;ve written lately about <a href="https://blog.johnnyreilly.com/2021/02/azure-app-service-health-checks-and-zero-downtime-deployments.html" target="_blank" rel="noopener noreferrer">zero downtime releases with Azure App Service</a>. Zero downtime releases are only successful if your authentication mechanism survives a new deployment. We looked in my last post at <a href="https://blog.johnnyreilly.com/2021/02/easy-auth-tokens-survive-releases-on-linux-azure-app-service.html" target="_blank" rel="noopener noreferrer">how to achieve this with Azure&#x27;s in-built authentication mechanism; Easy Auth</a>.</p><p>We&#x27;re now going to look at how the same goal can be achieved if your ASP.NET application is authenticating another way. We achieve this through use of the <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview" target="_blank" rel="noopener noreferrer">ASP.NET Data Protection</a> system. Andrew Lock has written <a href="https://andrewlock.net/an-introduction-to-the-data-protection-system-in-asp-net-core/" target="_blank" rel="noopener noreferrer">an excellent walkthrough on the topic</a> and I encourage you to read it.</p><p>We&#x27;re interested in the ASP.NET data-protection system because it encrypts and decrypts sensitive data including the authentication cookie. It&#x27;s wonderful that the data protection does this, but at the same time it presents a problem. We would like to route traffic to <em>multiple</em> instances of our application… So traffic could go to instance 1, instance 2 of our app etc.</p><p> <img alt="traffic to app service" src="/blog.johnnyreilly.com/assets/images/traffic-to-app-service-a11ff2c51af6c3776075153eae17e9eb.png"></p><p>How can we ensure the different instances of our app can read the authentication cookies regardless of the instance that produced them? How can we ensure that instance 1 can read cookies produced by instance 2 and vice versa? And for that matter, we&#x27;d like all instances to be able to read cookies whether they were produced by an instance in a production or staging slot.</p><p>We&#x27;re aiming to avoid the use of &quot;sticky sessions&quot; and ARRAffinity cookies. These ensure that traffic is continually routed to the same instance. Routing to the same instance explicitly prevents us from stopping routing traffic to an old instance and starting routing to a new one.</p><p>With the data protection activated and multiple instances of your app service you immediately face the issue that different instances of the app will be unable to read cookies they did not create. This is the default behaviour of data protection. <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/web-farm?view=aspnetcore-5.0#data-protection" target="_blank" rel="noopener noreferrer">To quote the docs:</a></p><blockquote><p>Data Protection relies upon a set of cryptographic keys stored in a key ring. When the Data Protection system is initialized, it applies default settings that store the key ring locally. Under the default configuration, a unique key ring is stored on each node of the web farm. Consequently, each web farm node can&#x27;t decrypt data that&#x27;s encrypted by an app on any other node.</p></blockquote><p>The problem here is the data protection keys (the key ring) is being stored locally on each instance. What are the implications of this? Well, For example, instance 2 doesn&#x27;t have access to the keys instance 1 is using and so can&#x27;t decrypt instance 1 cookies.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="sharing-is-caring"></a>Sharing is caring<a class="hash-link" href="#sharing-is-caring" title="Direct link to heading">#</a></h2><p>What we need to do is move away from storing keys locally, and to storing it in a <em>shared</em> place instead. We&#x27;re going to store data protection keys in Azure Blob Storage and protect the keys with Azure Key Vault:</p><p><img alt="persist keys to azure blob" src="/blog.johnnyreilly.com/assets/images/data-protection-zero-downtime-0e3b1ca7d853ca65fa0ebc09dbe1b2de.png"></p><p>All instances of the application can access the key ring and consequently sharing cookies is enabled. <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview?view=aspnetcore-5.0#protectkeyswithazurekeyvault" target="_blank" rel="noopener noreferrer">As the documentation attests</a>, enabling this is fairly simple. It amounts to adding the following packages to your ASP.NET app:</p><ul><li><a href="https://www.nuget.org/packages/Azure.Extensions.AspNetCore.DataProtection.Blobs" target="_blank" rel="noopener noreferrer"><code>Azure.Extensions.AspNetCore.DataProtection.Blobs</code></a></li><li><a href="https://www.nuget.org/packages/Azure.Extensions.AspNetCore.DataProtection.Keys" target="_blank" rel="noopener noreferrer"><code>Azure.Extensions.AspNetCore.DataProtection.Keys</code></a></li></ul><p>And adding the following to the <code>ConfigureServices</code> in your ASP.NET app:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">services.AddDataProtection().SetApplicationName(&quot;OurWebApp&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // azure credentials require storage blob contributor role permissions</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // eg https://my-storage-account.blob.core.windows.net/keys/key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .PersistKeysToAzureBlobStorage(new Uri($&quot;https://{Configuration[&quot;StorageAccountName&quot;]}.blob.core.windows.net/keys/key&quot;), new DefaultAzureCredential())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // azure credentials require key vault crypto role permissions</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // eg https://my-key-vault.vault.azure.net/keys/dataprotection</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .ProtectKeysWithAzureKeyVault(new Uri($&quot;https://{Configuration[&quot;KeyVaultName&quot;]}.vault.azure.net/keys/dataprotection&quot;), new DefaultAzureCredential());</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>In the above example you can see we&#x27;re passing the name of our Storage account and Key Vault via configuration.</p><p>There&#x27;s one more crucial piece of the puzzle here; and it&#x27;s role assignments, better known as permissions. Your App Service needs to be able to read and write to Azure Key Vault and the Azure Blob Storage. The permissions of <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#storage-blob-data-contributor" target="_blank" rel="noopener noreferrer">Storage Blob Data Contributor</a> and <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#key-vault-crypto-officer-preview" target="_blank" rel="noopener noreferrer">Key Vault Crypto Officer</a> are sufficient to enable this. (If you&#x27;d like to see what configuring that looks like via ARM templates then <a href="https://blog.johnnyreilly.com/2021/02/arm-templates-security-role-assignments.html" target="_blank" rel="noopener noreferrer">check out this post</a>.)</p><p>With this in place we&#x27;re able to route traffic to any instance of our application, secure in the knowledge that it will be able to read the cookies. Furthermore, we&#x27;ve enabled zero downtime releases as a direct consequence.</p></section></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service">Making Easy Auth tokens survive releases on Linux Azure App Service</a></h2><div class="margin-vert--md"><time datetime="2021-02-16T00:00:00.000Z" class="blogPostDate_Ta7i">February 16, 2021  · 4 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>I <a href="https://blog.johnnyreilly.com/2021/02/azure-app-service-health-checks-and-zero-downtime-deployments.html" target="_blank" rel="noopener noreferrer">wrote recently about zero downtime deployments on Azure App Service</a>. Many applications require authentication, and ours is no exception. In our case we&#x27;re using Azure Active Directory facilitated by <a href="https://docs.microsoft.com/en-us/azure/app-service/overview-authentication-authorization" target="_blank" rel="noopener noreferrer">&quot;Easy Auth&quot;</a> which provides authentication to our App Service.</p><p>Our app uses a Linux App Service. It&#x27;s worth knowing that Linux App Services run as a Docker container. As a consequence, Easy Auth works in a slightly different way; effectively as a middleware. <a href="https://docs.microsoft.com/en-us/azure/app-service/overview-authentication-authorization#on-containers" target="_blank" rel="noopener noreferrer">To quote the docs on Easy Auth</a>:</p><blockquote><p>This module handles several things for your app:</p><ul><li>Authenticates users with the specified provider</li><li>Validates, stores, and refreshes tokens</li><li>Manages the authenticated session</li><li>Injects identity information into request headers The module runs separately from your application code and is configured using app settings. No SDKs, specific languages, or changes to your application code are required.</li></ul><p>The authentication and authorization module runs in a separate container, isolated from your application code. Using what&#x27;s known as the <a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/ambassador" target="_blank" rel="noopener noreferrer">Ambassador</a> pattern, it interacts with the incoming traffic to perform similar functionality as on Windows.</p></blockquote><p>However, <a href="https://social.msdn.microsoft.com/Forums/en-US/dde551b2-c86d-474b-b0a6-cc66163785a1/restarting-azure-app-service-on-linux-with-azure-active-directory-authentication-resets-authme#b59951ab-623a-4442-a221-80c157387bbe" target="_blank" rel="noopener noreferrer">Microsoft have acknowledged there is a potential bug in Easy Auth support at present</a>. When the app service is restarted, the stored tokens are removed, and <strong>authentication begins to fail</strong>. As you might well imagine, authentication similarly starts to fail when a new app service is introduced - as is the case during deployment.</p><p>This is really significant. You may well have &quot;zero downtime deployment&quot;, but it doesn&#x27;t amount to a hill of beans if the moment you&#x27;ve deployed your users find they&#x27;re effectively logged out. <a href="https://social.msdn.microsoft.com/Forums/en-US/dde551b2-c86d-474b-b0a6-cc66163785a1/restarting-azure-app-service-on-linux-with-azure-active-directory-authentication-resets-authme#b59951ab-623a-4442-a221-80c157387bbe" target="_blank" rel="noopener noreferrer">The advice from Microsoft</a> is to use <a href="https://docs.microsoft.com/en-gb/archive/blogs/jpsanders/azure-app-service-authentication-using-a-blob-storage-for-token-cache" target="_blank" rel="noopener noreferrer">Blob Storage for Token Cache</a>:</p><p><a href="https://twitter.com/cgillum" target="_blank" rel="noopener noreferrer">Chris Gillum</a> said in a <a href="https://cgillum.tech/2016/03/07/app-service-token-store/" target="_blank" rel="noopener noreferrer">blog on the topic</a>:</p><blockquote><p>you can provision an Azure Blob Storage container and configure your web app with a SaS URL (with read/write/list access) pointing to that blob container. This SaS URL can then be saved to the <code>WEBSITE_AUTH_TOKEN_CONTAINER_SASURL</code> app setting. When this app setting is present, all tokens will be stored in and fetched from the specified blob container.</p></blockquote><p>To turn that into something visual, what&#x27;s suggested is this:</p><p> <img alt="diagram of Easy Auth with blog storage" src="/blog.johnnyreilly.com/assets/images/easy-auth-zero-downtime-deployment-61490054e3f8ba565854d7105a175ee6.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="sas-sy-arm-templates"></a>SaS-sy ARM Templates<a class="hash-link" href="#sas-sy-arm-templates" title="Direct link to heading">#</a></h2><p>I have the good fortune to work with some very talented people. One of them, <a href="https://github.com/jmccor99" target="_blank" rel="noopener noreferrer">John McCormick</a> turned his hand to putting this proposed solution into <code>azure-pipelines.yml</code> and ARM template-land. First of all, let&#x27;s look at our <code>azure-pipelines.yml</code>. We add the following, prior to our deployment job:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-yml codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> SASGen</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Generate SAS Token</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzurePowerShell@4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ObtainSasTokenTask</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">ScriptType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inlineScript</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">Inline</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(195, 232, 141)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">                $startTime = Get-Date</span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">                $expiryTime = $startTime.AddDays(90)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">                $storageAcc = Get-AzStorageAccount -ResourceGroupName $(azureResourceGroup) -Name $(storageAccountName)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">                $ctx = $storageAcc.Context</span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">                $sas = New-AzStorageContainerSASToken -Context $ctx -Name &quot;tokens&quot; -Permission &quot;rwl&quot; -Protocol HttpsOnly -StartTime $startTime -ExpiryTime $expiryTime -FullUri</span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">                Write-Host &quot;##vso[task.setvariable variable=sasToken;issecret=true;isOutput=true]$sas&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">azurePowerShellVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;LatestVersion&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeployAppARMTemplates</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">variables</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">sasToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">dependencies.SASGen.outputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;ObtainSasTokenTask.sasToken&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy App ARM Templates</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> SASGen</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service ARM Template</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">deploymentScope</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Resource Group</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">subscriptionId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(subscriptionId)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(azureResourceGroup)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(location)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;infra/app-service/azuredeploy.json&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">csmParametersFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;infra/azuredeploy.parameters.json&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">overrideParameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">sasUrl $(sasToken)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>There&#x27;s two notable things happening above:</p><ol><li>In the <code>SASGen</code> job, a PowerShell script runs that <a href="https://docs.microsoft.com/en-us/powershell/module/az.storage/new-azstoragecontainersastoken?view=azps-5.5.0" target="_blank" rel="noopener noreferrer">generates a SaS token URL</a> with read, write and list permissions that will last for 90 days. (Incidentally, there is a way to do this via <a href="https://stackoverflow.com/a/56127006/761388" target="_blank" rel="noopener noreferrer">ARM templates, and without PowerShell</a> - but alas it didn&#x27;t seem to work when we experimented with it.)</li><li>The generated (secret) token URL (<code>sasUrl</code>) is passed as a parameter to our App Service ARM template. The ARM template sets an appsetting for the app service:</li></ol><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;apiVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2020-09-01&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;appsettings&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;config&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;properties&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;WEBSITE_AUTH_TOKEN_CONTAINER_SASURL&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[parameters(&#x27;sasUrl&#x27;)]&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If you google <code>WEBSITE_AUTH_TOKEN_CONTAINER_SASURL</code> you will not find a geat deal. Documentation is short. What you will find is <a href="http://jsandersblog.azurewebsites.net/2017/08/10/azure-app-service-authentication-using-a-blob-storage-for-token-cache/" target="_blank" rel="noopener noreferrer">Jeff Sanders excellent blog on the topic</a>. It is, in terms of content, it has some commonality with this post; except in Jeff&#x27;s example he&#x27;s manually implementing the workaround in the Azure Portal.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="whats-actually-happening"></a>What&#x27;s actually happening?<a class="hash-link" href="#whats-actually-happening" title="Direct link to heading">#</a></h2><p>With this in place, every time someone logs into your app a JSON token is written to the storage like so:</p><p><img alt="token in storage account" src="/blog.johnnyreilly.com/assets/images/token-1efdd5206571d649dca09531f014ea5a.png"></p><p>If you take the trouble to look inside you&#x27;ll find something like this tucked away:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;encrypted&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;tokens&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;aad&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;herewith_a_very_very_long_encrypted_token&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;version&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>With this in place, you can safely restart your app service and / or deploy a new one, safe in the knowledge that the tokens will live on in the storage account, and that consequently you will not be unauthenticating users.</p></section></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2021/02/11/azure-app-service-health-checks-and-zero-downtime-deployments">Azure App Service, Health checks and zero downtime deployments</a></h2><div class="margin-vert--md"><time datetime="2021-02-11T00:00:00.000Z" class="blogPostDate_Ta7i">February 11, 2021  · 8 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>I&#x27;ve been working recently on zero downtime deployments using Azure App Service. They&#x27;re facilitated by a combination of <a href="https://docs.microsoft.com/en-us/azure/app-service/monitor-instances-health-check" target="_blank" rel="noopener noreferrer">Health checks</a> and <a href="https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots" target="_blank" rel="noopener noreferrer">deployment slots</a>. This post will talk about why this is important and how it works.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="why-zero-downtime-deployments"></a>Why zero downtime deployments?<a class="hash-link" href="#why-zero-downtime-deployments" title="Direct link to heading">#</a></h2><p>Historically (and for many applications, currently) deployment results in downtime. A period of time during the release where an application is not available to users whilst the new version is deployed. There are a number of downsides to releases with downtime:</p><ol><li>Your users cannot use your application. This will frustrate them and make them sad.</li><li>Because you&#x27;re a kind person and you want your users to be happy, you&#x27;ll optimise to make their lives better. You&#x27;ll release when the fewest users are accessing your application. It will likely mean you&#x27;ll end up working late, early or at weekends.</li><li>Again because you want to reduce impact on users, you&#x27;ll release less often. This means that every release will bring with it a greater collection of changes. This is turn will often result in a large degree of focus on manually testing each release, to reduce the likelihood of bugs ending up in users hands. This is a noble aim, but it drags the teams focus away from shipping.</li></ol><p>Put simply: downtime in releases impacts customer happiness and leads to reduced pace for teams. It&#x27;s a vicious circle.</p><p>But if we turn it around, what does it look like if releases have <em>no</em> downtime at all?</p><ol><li>Your users can always use your application. This will please them.</li><li>Your team is now safe to release at any time, day or night. They will likely release more often as a consequence.</li><li>If your team has sufficient automated testing in place, they&#x27;re now in a position where they can move to <a href="https://www.atlassian.com/continuous-delivery/principles/continuous-integration-vs-delivery-vs-deployment" target="_blank" rel="noopener noreferrer">Continuous Deployment</a>.</li><li>Releases become boring. This is good. They &quot;just work™️&quot; and so the team can focus instead on building the cool features that are going to make users lives even better.</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="manual-zero-downtime-releases-with-app-services"></a>Manual zero downtime releases with App Services<a class="hash-link" href="#manual-zero-downtime-releases-with-app-services" title="Direct link to heading">#</a></h2><p>App Services have the ability to scale out. To <a href="https://azure.microsoft.com/en-us/blog/scaling-up-and-scaling-out-in-windows-azure-web-sites/" target="_blank" rel="noopener noreferrer">quote the docs</a>:</p><blockquote><p>A scale out operation is the equivalent of creating multiple copies of your web site and adding a load balancer to distribute the demand between them. When you scale out ... there is no need to configure load balancing separately since this is already provided by the platform.</p></blockquote><p>As you can see, scaling out works by having multiple instances of your app. Deployment slots are exactly this, but with an extra twist. If you add a deployment slot to your App Service, then you <strong>no longer deploy to production</strong>. Instead you deploy to your staging slot. Your staging slot is accessible in the same way your production slot is accessible. So whilst your users may go to <a href="https://my-glorious-app.io" target="_blank" rel="noopener noreferrer">https://my-glorious-app.io</a>, your staging slot may live at <a href="https://my-glorious-app-stage.azurewebsites.net" target="_blank" rel="noopener noreferrer">https://my-glorious-app-stage.azurewebsites.net</a> instead. Because this is accessible, this is testable. You are in a position to test the deployed application before making it generally available.</p><p> <img src="/blog.johnnyreilly.com/assets/images/app-service-with-slots-16aac8093f6180c5595123ea418e11e1.png"></p><p>Once you&#x27;re happy that everything looks good, you can &quot;swap slots&quot;. What this means, is the version of the app living in the staging slot, gets moved into the production slot. So that which lived at <a href="https://my-glorious-app-stage.azurewebsites.net" target="_blank" rel="noopener noreferrer">https://my-glorious-app-stage.azurewebsites.net</a> moves to <a href="https://my-glorious-app.io" target="_blank" rel="noopener noreferrer">https://my-glorious-app.io</a>. For a more details on what that involves <a href="https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots#what-happens-during-a-swap" target="_blank" rel="noopener noreferrer">read this</a>. The significant take home is this: there is no downtime. Traffic stops being routed to the old instance and starts being routed to the new one. It&#x27;s as simple as that.</p><p>I should mention at this point that there&#x27;s a <a href="https://opensource.com/article/17/5/colorful-deployments" target="_blank" rel="noopener noreferrer">number of zero downtime strategies out there</a> and slots can help support a number of these. This includes canary deployments, where a subset of traffic is routed to the new version prior to it being opened out more widely. In our case, we&#x27;re looking at rolling deployments, where we replace the currently running instances of our application with the new ones; but it&#x27;s worth being aware that there are other strategies that slots can facilitate.</p><p>So what does it look like when slots swap? Well, to test that out, we swapped slots on our two App Service instances. We repeatedly CURLed our apps <a href="https://blog.johnnyreilly.com/2021/01/surfacing-azure-pipelines-build-info-in.html" target="_blank" rel="noopener noreferrer"><code>api/build</code></a> endpoint that exposes the build information; to get visibility around which version of our app we were routing traffic to. This is what we saw:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:51:51 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.5&quot;,&quot;buildId&quot;:&quot;17992&quot;,&quot;commitHash&quot;:&quot;c2122919df54bfa6a0d20bceb9f06890f822b26e&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:51:54 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.6&quot;,&quot;buildId&quot;:&quot;18015&quot;,&quot;commitHash&quot;:&quot;062ac1488fcf1737fe1dbab0d05c095786218f30&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:51:57 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.5&quot;,&quot;buildId&quot;:&quot;17992&quot;,&quot;commitHash&quot;:&quot;c2122919df54bfa6a0d20bceb9f06890f822b26e&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:00 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.6&quot;,&quot;buildId&quot;:&quot;18015&quot;,&quot;commitHash&quot;:&quot;062ac1488fcf1737fe1dbab0d05c095786218f30&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:03 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.6&quot;,&quot;buildId&quot;:&quot;18015&quot;,&quot;commitHash&quot;:&quot;062ac1488fcf1737fe1dbab0d05c095786218f30&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:05 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.6&quot;,&quot;buildId&quot;:&quot;18015&quot;,&quot;commitHash&quot;:&quot;062ac1488fcf1737fe1dbab0d05c095786218f30&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:08 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.5&quot;,&quot;buildId&quot;:&quot;17992&quot;,&quot;commitHash&quot;:&quot;c2122919df54bfa6a0d20bceb9f06890f822b26e&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:10 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.6&quot;,&quot;buildId&quot;:&quot;18015&quot;,&quot;commitHash&quot;:&quot;062ac1488fcf1737fe1dbab0d05c095786218f30&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:12 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.5&quot;,&quot;buildId&quot;:&quot;17992&quot;,&quot;commitHash&quot;:&quot;c2122919df54bfa6a0d20bceb9f06890f822b26e&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:15 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.6&quot;,&quot;buildId&quot;:&quot;18015&quot;,&quot;commitHash&quot;:&quot;062ac1488fcf1737fe1dbab0d05c095786218f30&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:17 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.6&quot;,&quot;buildId&quot;:&quot;18015&quot;,&quot;commitHash&quot;:&quot;062ac1488fcf1737fe1dbab0d05c095786218f30&quot;}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The first new version of our application showed up in a production slot at 11:51:54, and the last old version showed up at 11:52:12. So it took a total of 15 seconds to complete the transition from hitting only instances of the old application to hitting only instances of the new application. During that 15 seconds either old or new versions of the application would be serving traffic. Significantly, there was always a version of the application returning responses.</p><p>This is <em>very</em> exciting! We have zero downtime deployments!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="rollbacks-for-bonus-points"></a>Rollbacks for bonus points<a class="hash-link" href="#rollbacks-for-bonus-points" title="Direct link to heading">#</a></h2><p>We now have the new version of the app (<code>buildNumber: 20210121.6</code>) in the production slot, and the old version of the app (<code>buildNumber: 20210121.5</code>) in the staging slot.</p><p>Slots have a tremendous rollback story. If it emerges that there was some uncaught issue in your release and you&#x27;d like to revert to the previous version, you can! Just as we swapped just now to move <code>buildNumber: 20210121.6</code> from the staging slot to the production slot and <code>buildNumber: 20210121.5</code> the other way, we can swap right back and revert our release like so:</p><p><img src="/blog.johnnyreilly.com/assets/images/app-service-with-slots-and-build-number-cb3ff72d23c65edd5c0775f2c018ac8c.png"></p><p>Once again users going to <a href="https://my-glorious-app.io" target="_blank" rel="noopener noreferrer">https://my-glorious-app.io</a> are hitting <code>buildNumber: 20210121.5</code>.</p><p>This is also <em>very</em> exciting! We have zero downtime deployments <em>and</em> rollbacks!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="automated-zero-downtime-releases-with-health-checks"></a>Automated zero downtime releases with Health checks<a class="hash-link" href="#automated-zero-downtime-releases-with-health-checks" title="Direct link to heading">#</a></h2><p>The final piece of the puzzle here automation. You&#x27;re a sophisticated team, you&#x27;ve put a great deal of energy into automating your tests. You don&#x27;t want your release process to be manual for this very reason; you trust your test coverage. You want to move to Continuous Deployment.</p><p>Fortunately, automating swapping slots is a breeze with <code>azure-pipelines.yml</code>. Consider the following:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-yml codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeployApp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> DeployARMTemplates</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">download</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> current</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">artifact</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> webapp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureWebApp@1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Deploy Web Application&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(azureResourceGroup)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">appName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(appServiceName)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">package</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(Pipeline.Workspace)/webapp/</span><span class="token important">**/*.zip</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">slotName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> stage</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">deployToSlotOrASE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">deploymentMethod</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> auto</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> SwapSlots</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Swap Slots</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> DeployApp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureAppServiceManage@0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Swap Slots</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Swap Slots&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(azureResourceGroup)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">webAppName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(appServiceName)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">SourceSlot</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;stage&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The first job here, deploys our previously built <code>webapp</code> to the <code>stage</code> slot. The second job swaps the slot.</p><p>When I first considered this, the question rattling around in the back of my mind was this: how does App Service know when it&#x27;s safe to swap? What if we swap before our app has fully woken up and started serving responses?</p><p>It so happens that using <a href="https://docs.microsoft.com/en-us/azure/app-service/monitor-instances-health-check" target="_blank" rel="noopener noreferrer">Health checks, App Service caters for this beautifully</a>. A health check endpoint is a URL in your application which, when hit, checks the dependencies of your application. &quot;Is the database accessible?&quot; &quot;Are the APIs I depend upon accessible?&quot; The diagram from the docs expresses it very well:</p><p><img src="/blog.johnnyreilly.com/assets/images/health-check-failure-diagram-fa96ff15c146b91e8deaac2c01d9fa66.png"></p><p>This approach is very similar to <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/" target="_blank" rel="noopener noreferrer">liveness, readiness and startup probes in Kubernetes</a>. To make use of Health checks, in our ARM template for our App Service we have configured a <code>healthCheckPath</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token property">&quot;siteConfig&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;linuxFxVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[parameters(&#x27;linuxFxVersion&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;alwaysOn&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;http20Enabled&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;minTlsVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;healthCheckPath&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/api/health&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This tells App Service where to look to check the health. The health check endpoint itself is provided by the <code>MapHealthChecks</code> in our <code>Startup.cs</code> of our .NET application:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">app.UseEndpoints(endpoints =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    endpoints.MapControllerRoute(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        name: &quot;default&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        pattern: &quot;{controller}/{action=Index}/{id?}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    endpoints.MapHealthChecks(&quot;/api/health&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>You read a full list of all the ways App Service uses Health checks <a href="https://docs.microsoft.com/en-us/azure/app-service/monitor-instances-health-check#what-app-service-does-with-health-checks" target="_blank" rel="noopener noreferrer">here</a>. Pertinent for zero downtime deployments is this:</p><blockquote><p>when scaling up or out, App Service pings the Health check path to ensure new instances are ready.</p></blockquote><p>This is the magic sauce. App Service doesn&#x27;t route traffic to an instance until it&#x27;s given the thumbs up that it&#x27;s ready in the form of passing health checks. This is excellent; it is this that makes automated zero downtime releases a reality.</p><p>Props to the various Azure teams that have made this possible; I&#x27;m very impressed by the way in which the Health checks and slots can be combined together to support some tremendous use cases.</p></section></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2021/02/08/arm-templates-security-role-assignments">ARM templates, security, role assignments and magic GUIDs</a></h2><div class="margin-vert--md"><time datetime="2021-02-08T00:00:00.000Z" class="blogPostDate_Ta7i">February 8, 2021  · 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>If you&#x27;re deploying to Azure, there&#x27;s a good chance you&#x27;re using <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview" target="_blank" rel="noopener noreferrer">ARM templates</a> to do so. Once you&#x27;ve got past &quot;Hello World&quot;, you&#x27;ll probably find yourself in a situation when you&#x27;re deploying multiple types of resource to make your solution. For instance, you may be deploying an <a href="https://docs.microsoft.com/en-us/azure/app-service/quickstart-arm-template?pivots=platform-linux#review-the-template" target="_blank" rel="noopener noreferrer">App Service</a> alongside <a href="https://docs.microsoft.com/en-us/azure/templates/microsoft.keyvault/vaults" target="_blank" rel="noopener noreferrer">Key Vault</a> and <a href="https://docs.microsoft.com/en-us/azure/templates/microsoft.storage/storageaccounts" target="_blank" rel="noopener noreferrer">Storage</a>.</p><p>One of the hardest things when it comes to deploying software and having it work, is permissions. Without adequate permissions configured, the most beautiful code can do <em>nothing</em>. Incidentally, this is a good thing. We&#x27;re deploying to the web; many people are there, not all good. As a different kind of web-head once said:</p><p> <img alt="With great power, comes great responsibility" src="/blog.johnnyreilly.com/assets/images/with-great-power-comes-great-responsibility-ddb19c8983f70b47f00f40d073daa163.jpg"></p><p>Azure has great power and <a href="https://docs.microsoft.com/en-us/azure/security/fundamentals/identity-management-best-practices#use-role-based-access-control" target="_blank" rel="noopener noreferrer">suggests you use it wisely</a>.</p><blockquote><p>Access management for cloud resources is critical for any organization that uses the cloud. <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/overview" target="_blank" rel="noopener noreferrer">Azure role-based access control (Azure RBAC)</a> helps you manage who has access to Azure resources, what they can do with those resources, and what areas they have access to.</p><p>Designating groups or individual roles responsible for specific functions in Azure helps avoid confusion that can lead to human and automation errors that create security risks. Restricting access based on the <a href="https://en.wikipedia.org/wiki/Need_to_know" target="_blank" rel="noopener noreferrer">need to know</a> and <a href="https://en.wikipedia.org/wiki/Principle_of_least_privilege" target="_blank" rel="noopener noreferrer">least privilege</a> security principles is imperative for organizations that want to enforce security policies for data access.</p></blockquote><p>This is good advice. With that in mind, how can we ensure that the different resources we&#x27;re deploying to Azure can talk to one another?</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="role-up-for-your-assignments"></a>Role (up for your) assignments<a class="hash-link" href="#role-up-for-your-assignments" title="Direct link to heading">#</a></h2><p>The answer is roles. There&#x27;s a number of roles that exist in Azure that can be assigned to users, groups, service principals and managed identities. In our own case we&#x27;re using managed identity for our resources. What we can do is use <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-works" target="_blank" rel="noopener noreferrer">&quot;role assignments&quot;</a> to give our managed identity access to given resources. <a href="https://twitter.com/ArLucaID" target="_blank" rel="noopener noreferrer">Arturo Lucatero</a> gives a great short explanation of this:</p><iframe width="560" height="315" src="https://www.youtube.com/embed/Dzhm-garKBM" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe><p>Whilst this explanation is delightfully simple, the actual implementation when it comes to ARM templates is a little more involved. Because now it&#x27;s time to talk &quot;magic&quot; GUIDs. Consider the following truncated ARM template, which gives our managed identity (and hence our App Service which uses this identity) access to Key Vault and Storage:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;$schema&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;variables&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;managedIdentity&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(&#x27;mi-&#x27;, parameters(&#x27;applicationName&#x27;), &#x27;-&#x27;, parameters(&#x27;environment&#x27;), &#x27;-&#x27;, &#x27;001&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;appInsightsName&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(&#x27;appi-&#x27;, parameters(&#x27;applicationName&#x27;), &#x27;-&#x27;, parameters(&#x27;environment&#x27;), &#x27;-&#x27;, &#x27;001&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;keyVaultName&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(&#x27;kv-&#x27;, parameters(&#x27;applicationName&#x27;), &#x27;-&#x27;, parameters(&#x27;environment&#x27;), &#x27;-&#x27;, &#x27;001&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;storageAccountName&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(&#x27;st&#x27;, parameters(&#x27;applicationName&#x27;), parameters(&#x27;environment&#x27;), &#x27;001&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;storageBlobDataContributor&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;ba92f5b4-2d11-453d-a403-e96b0029c9fe&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;keyVaultSecretsOfficer&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;b86a8fe4-44ce-4948-aee5-eccb2c155cd7&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;keyVaultCryptoOfficer&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;14b46e9e-c2b7-41b4-b07b-48a6ebf60603&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;uniqueRoleGuidKeyVaultSecretsOfficer&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[guid(resourceId(&#x27;Microsoft.KeyVault/vaults&#x27;,  variables(&#x27;keyVaultName&#x27;)), variables(&#x27;keyVaultSecretsOfficer&#x27;), resourceId(&#x27;Microsoft.KeyVault/vaults&#x27;, variables(&#x27;keyVaultName&#x27;)))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;uniqueRoleGuidKeyVaultCryptoOfficer&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[guid(resourceId(&#x27;Microsoft.KeyVault/vaults&#x27;,  variables(&#x27;keyVaultName&#x27;)), variables(&#x27;keyVaultCryptoOfficer&#x27;), resourceId(&#x27;Microsoft.KeyVault/vaults&#x27;, variables(&#x27;keyVaultName&#x27;)))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;uniqueRoleGuidStorageAccount&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[guid(resourceId(&#x27;Microsoft.Storage/storageAccounts&#x27;,  variables(&#x27;storageAccountName&#x27;)), variables(&#x27;storageBlobDataContributor&#x27;), resourceId(&#x27;Microsoft.Storage/storageAccounts&#x27;, variables(&#x27;storageAccountName&#x27;)))]&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;resources&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Microsoft.ManagedIdentity/userAssignedIdentities&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[variables(&#x27;managedIdentity&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;apiVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2018-11-30&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;location&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[parameters(&#x27;location&#x27;)]&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Microsoft.Storage/storageAccounts/providers/roleAssignments&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;apiVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2020-04-01-preview&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(variables(&#x27;storageAccountName&#x27;), &#x27;/Microsoft.Authorization/&#x27;, variables(&#x27;uniqueRoleGuidStorageAccount&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;dependsOn&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities&#x27;, variables(&#x27;managedIdentity&#x27;))]&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;properties&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;roleDefinitionId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[variables(&#x27;storageBlobDataContributor&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[reference(resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities/&#x27;, variables(&#x27;managedIdentity&#x27;)), &#x27;2018-11-30&#x27;).principalId]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;scope&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.Storage/storageAccounts&#x27;, variables(&#x27;storageAccountName&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalType&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ServicePrincipal&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Microsoft.KeyVault/vaults/providers/roleAssignments&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;apiVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2018-01-01-preview&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(variables(&#x27;keyVaultName&#x27;), &#x27;/Microsoft.Authorization/&#x27;, variables(&#x27;uniqueRoleGuidKeyVaultSecretsOfficer&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;dependsOn&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities&#x27;, variables(&#x27;managedIdentity&#x27;))]&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;properties&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;roleDefinitionId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[variables(&#x27;keyVaultSecretsOfficer&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[reference(resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities/&#x27;, variables(&#x27;managedIdentity&#x27;)), &#x27;2018-11-30&#x27;).principalId]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;scope&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.KeyVault/vaults&#x27;, variables(&#x27;keyVaultName&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalType&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ServicePrincipal&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Microsoft.KeyVault/vaults/providers/roleAssignments&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;apiVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2018-01-01-preview&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(variables(&#x27;keyVaultName&#x27;), &#x27;/Microsoft.Authorization/&#x27;, variables(&#x27;uniqueRoleGuidKeyVaultCryptoOfficer&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;dependsOn&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities&#x27;, variables(&#x27;managedIdentity&#x27;))]&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;properties&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;roleDefinitionId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[variables(&#x27;keyVaultCryptoOfficer&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[reference(resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities/&#x27;, variables(&#x27;managedIdentity&#x27;)), &#x27;2018-11-30&#x27;).principalId]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;scope&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.KeyVault/vaults&#x27;, variables(&#x27;keyVaultName&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalType&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ServicePrincipal&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Let&#x27;s take a look at these three variables:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token property">&quot;storageBlobDataContributor&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;ba92f5b4-2d11-453d-a403-e96b0029c9fe&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;keyVaultSecretsOfficer&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;b86a8fe4-44ce-4948-aee5-eccb2c155cd7&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;keyVaultCryptoOfficer&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;14b46e9e-c2b7-41b4-b07b-48a6ebf60603&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The three variables above contain the subscription resource ids for the roles <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#storage-blob-data-contributor" target="_blank" rel="noopener noreferrer">Storage Blob Data Contributor</a>, <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#key-vault-secrets-officer-preview" target="_blank" rel="noopener noreferrer">Key Vault Secrets Officer</a> and <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#key-vault-crypto-officer-preview" target="_blank" rel="noopener noreferrer">Key Vault Crypto Officer</a>. The first question on your mind is likely: &quot;what is <code>ba92f5b4-2d11-453d-a403-e96b0029c9fe</code> and where does it come from?&quot; Great question! Well, each of these GUIDs represents a built-in role in Azure RBAC. The <code>ba92f5b4-2d11-453d-a403-e96b0029c9fe</code> represents the Storage Blob Data Contributor role.</p><p>How can I look these up? Well, there&#x27;s two ways; <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles" target="_blank" rel="noopener noreferrer">there&#x27;s an article which documents them here</a> or you could crack open the <a href="https://azure.microsoft.com/en-gb/features/cloud-shell/" target="_blank" rel="noopener noreferrer">Cloud Shell</a> and look up a role by GUID like so:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-ps codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Get-AzRoleDefinition | ? {$_.id -eq &quot;ba92f5b4-2d11-453d-a403-e96b0029c9fe&quot; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Name             : Storage Blob Data Contributor</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Id               : ba92f5b4-2d11-453d-a403-e96b0029c9fe</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">IsCustom         : False</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Description      : Allows for read, write and delete access to Azure Storage blob containers and data</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Actions          : {Microsoft.Storage/storageAccounts/blobServices/containers/delete, Microsoft.Storage/storageAccounts/blobServices/containers/read,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   Microsoft.Storage/storageAccounts/blobServices/containers/write, Microsoft.Storage/storageAccounts/blobServices/generateUserDelegationKey/action}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NotActions       : {}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">DataActions      : {Microsoft.Storage/storageAccounts/blobServices/containers/blobs/delete, Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   Microsoft.Storage/storageAccounts/blobServices/containers/blobs/write, Microsoft.Storage/storageAccounts/blobServices/containers/blobs/move/action…}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NotDataActions   : {}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">AssignableScopes : {/}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Or by name like so:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-ps codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Get-AzRoleDefinition | ? {$_.name -like &quot;*Crypto Officer*&quot; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Name             : Key Vault Crypto Officer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Id               : 14b46e9e-c2b7-41b4-b07b-48a6ebf60603</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">IsCustom         : False</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Description      : Perform any action on the keys of a key vault, except manage permissions. Only works for key vaults that use the &#x27;Azure role-based access control&#x27; permission model.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Actions          : {Microsoft.Authorization/*/read, Microsoft.Insights/alertRules/*, Microsoft.Resources/deployments/*, Microsoft.Resources/subscriptions/resourceGroups/read…}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NotActions       : {}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">DataActions      : {Microsoft.KeyVault/vaults/keys/*}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NotDataActions   : {}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">AssignableScopes : {/}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>As you can see, the <code>Actions</code> section of the output above (and in even more detail on the <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles" target="_blank" rel="noopener noreferrer">linked article</a>) provides information about what the different roles can do. So if you&#x27;re looking to enable one Azure resource to talk to another, you should be able to refer to these to identify a role that you might want to use.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="creating-a-role-assignment"></a>Creating a role assignment<a class="hash-link" href="#creating-a-role-assignment" title="Direct link to heading">#</a></h2><p>So now we understand how you identify the roles in question, let&#x27;s take the final leap and look at assigning those roles to our managed identity. For each role assignment, you&#x27;ll need a <code>roleAssignments</code> resource defined that looks like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Microsoft.KeyVault/vaults/providers/roleAssignments&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;apiVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2018-01-01-preview&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(variables(&#x27;keyVaultName&#x27;), &#x27;/Microsoft.Authorization/&#x27;, variables(&#x27;uniqueRoleGuidKeyVaultCryptoOfficer&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;dependsOn&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities&#x27;, variables(&#x27;managedIdentity&#x27;))]&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;properties&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;roleDefinitionId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[variables(&#x27;keyVaultCryptoOfficer&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[reference(resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities/&#x27;, variables(&#x27;managedIdentity&#x27;)), &#x27;2018-11-30&#x27;).principalId]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;scope&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.KeyVault/vaults&#x27;, variables(&#x27;keyVaultName&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalType&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ServicePrincipal&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Let&#x27;s go through the above, significant property by significant property (it&#x27;s also worth checking the official reference <a href="https://docs.microsoft.com/en-us/azure/templates/microsoft.authorization/roleassignments" target="_blank" rel="noopener noreferrer">here</a>):</p><ul><li><code>type</code> - the type of role assignment we want to create, for a key vault it&#x27;s <code>&quot;Microsoft.KeyVault/vaults/providers/roleAssignments&quot;</code>, for storage it&#x27;s <code>&quot;Microsoft.Storage/storageAccounts/providers/roleAssignments&quot;</code>. The pattern is that it&#x27;s the resource type, followed by <code>&quot;/providers/roleAssignments&quot;</code>. </li><li><code>dependsOn</code> - before we can create a role assignment, we need the service principal we desire to permission (in our case a managed identity) to exist</li><li><code>properties.roleDefinitionId</code> - the role that we&#x27;re assigning, provided as an id. So for this example it&#x27;s the <code>keyVaultCryptoOfficer</code> variable, which was earlier defined as <code>[subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;ba92f5b4-2d11-453d-a403-e96b0029c9fe&#x27;)]</code>. (Note the use of the GUID)</li><li><code>properties.principalId</code> - the id of the principal we&#x27;re adding permissions for. In our case this is a managed identity (a type of service principal).</li><li><code>properties.scope</code> - we&#x27;re modifying another resource; our key vault isn&#x27;t defined in this ARM template and we want to specify the resource we&#x27;re granting permissions to.</li><li><code>properties.principalType</code> - the type of principal that we&#x27;re creating an assignment for; in our this is <code>&quot;ServicePrincipal&quot;</code> - our managed identity.</li></ul><p>There is an alternate approach that you can use where the <code>type</code> is <code>&quot;Microsoft.Authorization/roleAssignments&quot;</code>. Whilst this also works, it displayed errors in the <a href="https://marketplace.visualstudio.com/items?itemName=msazurermtools.azurerm-vscode-tools" target="_blank" rel="noopener noreferrer">Azure tooling for VS Code</a>. As such, we&#x27;ve opted not to use that approach in our ARM templates.</p><p>Many thanks to the awesome <a href="https://github.com/jmccor99" target="_blank" rel="noopener noreferrer">John McCormick</a> who wrangled permissions with me until we bent Azure RBAC to our will.</p></section></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2021/01/30/aspnet-serilog-and-application-insights">ASP.NET, Serilog and Application Insights</a></h2><div class="margin-vert--md"><time datetime="2021-01-30T00:00:00.000Z" class="blogPostDate_Ta7i">January 30, 2021  · 4 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>If you&#x27;re deploying an ASP.NET application to Azure App Services, there&#x27;s a decent chance you&#x27;ll also be using the fantastic <a href="https://serilog.net/" target="_blank" rel="noopener noreferrer">Serilog</a> and will want to plug it into Azure&#x27;s <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview" target="_blank" rel="noopener noreferrer">Application Insights</a>.</p><p>This post will show you how it&#x27;s done, and it&#x27;ll also build upon the <a href="https://blog.johnnyreilly.com/2021/01/surfacing-azure-pipelines-build-info-in.html" target="_blank" rel="noopener noreferrer">build info work from our previous post</a>. In what way? Great question. Well logs are a tremendous diagnostic tool. If you have logs which display some curious behaviour, and you&#x27;d like to replicate that in another environment, you really want to take exactly that version of the codebase out to play. Our last post introduced build info into our application in the form of our <code>AppVersionInfo</code> class that looks something like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;buildNumber&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;20210130.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;buildId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;123456&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;branchName&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;main&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;commitHash&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;7089620222c30c1ad88e4b556c0a7908ddd34a8e&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>We&#x27;d initially exposed an endpoint in our application which surfaced up this information. Now we&#x27;re going to take that self same information and bake it into our log messages by making use of <a href="https://github.com/serilog/serilog/wiki/Enrichment" target="_blank" rel="noopener noreferrer">Serilog&#x27;s enrichment functionality</a>. Build info and Serilog&#x27;s enrichment are the double act your logging has been waiting for.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="lets-plug-it-together"></a>Let&#x27;s plug it together<a class="hash-link" href="#lets-plug-it-together" title="Direct link to heading">#</a></h2><p>We&#x27;re going to need a number of Serilog dependencies added to our <code>.csproj</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-xml codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">PackageReference</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Serilog.AspNetCore</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">3.4.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">PackageReference</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Serilog.Enrichers.Environment</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">2.1.3</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">PackageReference</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Serilog.Enrichers.Thread</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">3.1.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">PackageReference</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Serilog.Sinks.ApplicationInsights</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">3.1.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">PackageReference</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Serilog.Sinks.Async</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">1.4.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The earlier in your application lifetime you get logging wired up, the happier you will be. Earlier, means more information when you&#x27;re diagnosing issues. So we want to start in our <code>Program.cs</code>; <code>Startup.cs</code> would be just <em>way</em> too late.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class Program {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    const string APP_NAME = &quot;MyAmazingApp&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static int Main(string[] args) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        AppVersionInfo.InitialiseBuildInfoGivenPath(Directory.GetCurrentDirectory());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        LoggerConfigurationExtensions.SetupLoggerConfiguration(APP_NAME, AppVersionInfo.GetBuildInfo());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Log.Information(&quot;Starting web host&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            CreateHostBuilder(args).Build().Run();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        catch (Exception ex)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Log.Fatal(ex, &quot;Host terminated unexpectedly&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        finally</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Log.CloseAndFlush();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static IHostBuilder CreateHostBuilder(string[] args) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Host.CreateDefaultBuilder(args)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .UseSerilog((hostBuilderContext, services, loggerConfiguration) =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                loggerConfiguration.ConfigureBaseLogging(APP_NAME, AppVersionInfo.GetBuildInfo());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                loggerConfiguration.AddApplicationInsightsLogging(services, hostBuilderContext.Configuration);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .ConfigureWebHostDefaults(webBuilder =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                webBuilder</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    .UseStartup&lt;Startup&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If you look at the code above you&#x27;ll see that the first line of code that executes is <code>AppVersionInfo.InitialiseBuildInfoGivenPath</code>. This initialises our <code>AppVersionInfo</code> so we have meaningful build info to pump into our logs. The next thing we do is to configure Serilog with <code>LoggerConfigurationExtensions.SetupLoggerConfiguration</code>. This provides us with a configured logger so we are free to log any issues that take place during startup. (Incidentally, after startup you&#x27;ll likely inject an <code>ILogger</code> into your classes rather than using the static <code>Log</code> directly.)</p><p>Finally, we call <code>CreateHostBuilder</code> which in turn calls <code>UseSerilog</code> to plug Serilog into ASP.NET. If you take a look inside the body of <code>UserSerilog</code> you&#x27;ll see we configure the logging of ASP.NET (in the same we did for Serilog) and we hook into Application Insights as well. There&#x27;s been a number of references to <code>LoggerConfigurationExtensions</code>. Let&#x27;s take a look at it:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">internal static class LoggerConfigurationExtensions {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    internal static void SetupLoggerConfiguration(string appName, BuildInfo buildInfo) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Log.Logger = new LoggerConfiguration()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .ConfigureBaseLogging(appName, buildInfo)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .CreateLogger();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    internal static LoggerConfiguration ConfigureBaseLogging(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        this LoggerConfiguration loggerConfiguration,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        string appName,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        BuildInfo buildInfo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        loggerConfiguration</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .MinimumLevel.Debug()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .MinimumLevel.Override(&quot;Microsoft&quot;, LogEventLevel.Information)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // AMAZING COLOURS IN THE CONSOLE!!!!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .WriteTo.Async(a =&gt; a.Console(theme: AnsiConsoleTheme.Code))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.FromLogContext()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.WithMachineName()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.WithThreadId()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Build information as custom properties</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.WithProperty(nameof(buildInfo.BuildId), buildInfo.BuildId)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.WithProperty(nameof(buildInfo.BuildNumber), buildInfo.BuildNumber)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.WithProperty(nameof(buildInfo.BranchName), buildInfo.BranchName)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.WithProperty(nameof(buildInfo.CommitHash), buildInfo.CommitHash)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.WithProperty(&quot;ApplicationName&quot;, appName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return loggerConfiguration;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    internal static LoggerConfiguration AddApplicationInsightsLogging(this LoggerConfiguration loggerConfiguration, IServiceProvider services, IConfiguration configuration)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (!string.IsNullOrWhiteSpace(configuration.GetValue&lt;string&gt;(&quot;APPINSIGHTS_INSTRUMENTATIONKEY&quot;)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            loggerConfiguration.WriteTo.ApplicationInsights(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                services.GetRequiredService&lt;TelemetryConfiguration&gt;(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                TelemetryConverter.Traces);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return loggerConfiguration;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If we take a look at the <code>ConfigureBaseLogging</code> method above, we can see that our logs are being enriched with the build info, property by property. We&#x27;re also giving ourselves a beautifully coloured console thanks to Serilog&#x27;s glorious <a href="https://github.com/serilog/serilog-sinks-console#themes" target="_blank" rel="noopener noreferrer">theme support</a>:</p><p> <img src="/blog.johnnyreilly.com/assets/images/coloured-console-235bc09c89c446ffb16f886abbfa36b2.png"></p><p>Take a moment to admire the salmon pinks. Is it not lovely?</p><p>Finally we come to the main act. Plugging in Application Insights is as simple as dropping in <code>loggerConfiguration.WriteTo.ApplicationInsights</code> into our configuration. You&#x27;ll note that this depends upon the existence of an application setting of <code>APPINSIGHTS_INSTRUMENTATIONKEY</code> - this is the secret sauce that we need to be in place so we can pipe logs merrily to Application Insights. So you&#x27;ll need this configuration in place so this works.</p><p><img src="/blog.johnnyreilly.com/assets/images/application-insights-properties-bad281e33f559caeb9a87686f1b58f55.png"></p><p>As you can see, we now have the likes of <code>BuildNumber</code>, <code>CommitHash</code> and friends visible on each log. Happy diagnostic days!</p><p>I&#x27;m indebted to the marvellous <a href="https://twitter.com/MarcelMichau" target="_blank" rel="noopener noreferrer">Marcel Michau</a> who showed me how to get the fiddlier parts of how to get Application Insights plugged in the right way. Thanks chap!</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/asp-net">asp.net</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/azure">Azure</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/application-insights">Application Insights</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/serilog">Serilog</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2021/01/29/surfacing-azure-pipelines-build-info-in">Surfacing Azure Pipelines Build Info in a .NET React SPA</a></h2><div class="margin-vert--md"><time datetime="2021-01-29T00:00:00.000Z" class="blogPostDate_Ta7i">January 29, 2021  · 7 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>The title of this post is hugely specific, but the idea is simple. We want to answer the question: &quot;what codebase is running in Production right now?&quot; Many is the time where I&#x27;ve been pondering over why something isn&#x27;t working as expected and burned a disappointing amount of time before realising that I&#x27;m playing with an old version of an app. Wouldn&#x27;t it be great give our app a way to say: &quot;Hey! I&#x27;m version 1.2.3.4 of your app; built from this commit hash, I was built on Wednesday, I was the nineth build that day and I was built from the <code>main</code> branch. And I&#x27;m an Aries.&quot; Or something like that.</p><p>This post was inspired by <a href="https://www.hanselman.com/blog/adding-a-git-commit-hash-and-azure-devops-build-number-and-build-id-to-an-aspnet-website" target="_blank" rel="noopener noreferrer">Scott Hanselman&#x27;s similar post on the topic</a>. Ultimately this ended up going in a fairly different direction and so seemed worthy of a post of its own.</p><p>A particular difference is that this is targeting SPAs. Famously, cache invalidation is hard. It&#x27;s possible for the HTML/JS/CSS of your app to be stale due to aggressive caching. So we&#x27;re going to make it possible to see build information for both when the SPA (or &quot;client&quot;) is built, as well as when the .NET app (or &quot;server&quot;) is built. We&#x27;re using a specific type of SPA here; a <a href="https://reactjs.org/" target="_blank" rel="noopener noreferrer">React</a> SPA built with <a href="https://www.typescriptlang.org/" target="_blank" rel="noopener noreferrer">TypeScript</a> and <a href="https://material-ui.com/" target="_blank" rel="noopener noreferrer">Material UI</a>, however the principles here are general; you could surface this up any which way you choose.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="putting-build-info-into-azure-pipelinesyml"></a>Putting build info into <code>azure-pipelines.yml</code><a class="hash-link" href="#putting-build-info-into-azure-pipelinesyml" title="Direct link to heading">#</a></h2><p>The first thing we&#x27;re going to do is to inject our build details into two identical <code>buildinfo.json</code> files; one that sits in the server codebase and which will be used to drive the server build information, and one that sits in the client codebase to drive the client equivalent. They&#x27;ll end up looking something like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;buildNumber&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;20210130.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;buildId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;123456&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;branchName&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;main&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;commitHash&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;7089620222c30c1ad88e4b556c0a7908ddd34a8e&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>We generate this by adding the following <code>yml</code> to the beginning of our <code>azure-pipelines.yml</code> (crucially before the client or server build take place):</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-yml codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">script</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(195, 232, 141)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">            echo -e -n &quot;{\&quot;buildNumber\&quot;:\&quot;$(Build.BuildNumber)\&quot;,\&quot;buildId\&quot;:\&quot;$(Build.BuildId)\&quot;,\&quot;branchName\&quot;:\&quot;$(Build.SourceBranchName)\&quot;,\&quot;commitHash\&quot;:\&quot;$(Build.SourceVersion)\&quot;}&quot; &gt; &quot;$(Build.SourcesDirectory)/src/client-app/src/buildinfo.json&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">            echo -e -n &quot;{\&quot;buildNumber\&quot;:\&quot;$(Build.BuildNumber)\&quot;,\&quot;buildId\&quot;:\&quot;$(Build.BuildId)\&quot;,\&quot;branchName\&quot;:\&quot;$(Build.SourceBranchName)\&quot;,\&quot;commitHash\&quot;:\&quot;$(Build.SourceVersion)\&quot;}&quot; &gt; &quot;$(Build.SourcesDirectory)/src/server-app/Server/buildinfo.json&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;emit build details as JSON&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">failOnStderr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>As you can see, we&#x27;re placing the following variables that are available at build time in Azure Pipelines, into the <code>buildinfo.json</code>:</p><ul><li><code>BuildNumber</code> - The name of the completed build; which usually takes the form of a date in the <code>yyyyMMdd</code> format, suffixed by <code>.x</code> where <code>x</code> is a number that increments representing the number of builds that have taken place on the given day.</li><li><code>BuildId</code> - The ID of the record for the completed build.</li><li><code>SourceVersion</code> - This is the commit hash of the source code in Git</li><li><code>SourceBranchName</code> - The name of the branch in Git.</li></ul><p><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops&amp;tabs=yaml#build-variables-devops-services" target="_blank" rel="noopener noreferrer">There&#x27;s many variables available in Azure Pipelines that can be used</a> - we&#x27;ve picked out the ones most interesting to us.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="surfacing-the-server-build-info"></a>Surfacing the server build info<a class="hash-link" href="#surfacing-the-server-build-info" title="Direct link to heading">#</a></h2><p>Our pipeline is dropping the <code>buildinfo.json</code> over pre-existing stub <code>buildinfo.json</code> files in both our client and server codebases. The stub files look like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;buildNumber&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;yyyyMMdd.x&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;buildId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;xxxxxx&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;branchName&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;commitHash&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;LOCAL_BUILD&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>In our .NET app, the <code>buildinfo.json</code> file has been dropped in the root of the app. And as luck would have it, all JSON files are automatically included in a .NET build and so it will be available at runtime. We want to surface this file through an API, and we also want to use it to stamp details into our logs.</p><p>So we need to parse the file, and for that we&#x27;ll use this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.IO;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Text.Json;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Server {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public record BuildInfo(string BranchName, string BuildNumber, string BuildId, string CommitHash);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static class AppVersionInfo {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private const string _buildFileName = &quot;buildinfo.json&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private static BuildInfo _fileBuildInfo = new(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            BranchName: &quot;&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            BuildNumber: DateTime.UtcNow.ToString(&quot;yyyyMMdd&quot;) + &quot;.0&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            BuildId: &quot;xxxxxx&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            CommitHash: $&quot;Not yet initialised - call {nameof(InitialiseBuildInfoGivenPath)}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static void InitialiseBuildInfoGivenPath(string path) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var buildFilePath = Path.Combine(path, _buildFileName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (File.Exists(buildFilePath)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var buildInfoJson = File.ReadAllText(buildFilePath);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var buildInfo = JsonSerializer.Deserialize&lt;BuildInfo&gt;(buildInfoJson, new JsonSerializerOptions {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        PropertyNamingPolicy = JsonNamingPolicy.CamelCase</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    if (buildInfo == null) throw new Exception($&quot;Failed to deserialise {_buildFileName}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    _fileBuildInfo = buildInfo;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                } catch (Exception) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    _fileBuildInfo = new BuildInfo(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        BranchName: &quot;&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        BuildNumber: DateTime.UtcNow.ToString(&quot;yyyyMMdd&quot;) + &quot;.0&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        BuildId: &quot;xxxxxx&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        CommitHash: &quot;Failed to load build info from buildinfo.json&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static BuildInfo GetBuildInfo() =&gt; _fileBuildInfo;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The above code reads the <code>buildinfo.json</code> file and deserialises it into a <code>BuildInfo</code> record which is then surfaced up by the <code>GetBuildInfo</code> method. We initialise this at the start of our <code>Program.cs</code> like so:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static int Main(string[] args) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            AppVersionInfo.InitialiseBuildInfoGivenPath(Directory.GetCurrentDirectory());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Now we&#x27;re free to call AppVersionInfo.GetBuildInfo()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // ....</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Now we need a controller to surface this information up. We&#x27;ll add ourselves a <code>BuildInfoController.cs</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Authorization;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Mvc;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Server.Controllers {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [ApiController]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class BuildInfoController : ControllerBase {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [AllowAnonymous]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [HttpGet(&quot;api/build&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public BuildInfo GetBuild() =&gt; AppVersionInfo.GetBuildInfo();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This exposes an <code>api/build</code> endpoint in our .NET app that, when hit, will display the following JSON:</p><p> <img src="/blog.johnnyreilly.com/assets/images/api-build-screenshot-ab49ee5e5ea7ce25c13f5aaba1022650.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="surfacing-the-client-build-info"></a>Surfacing the client build info<a class="hash-link" href="#surfacing-the-client-build-info" title="Direct link to heading">#</a></h2><p>Our server now lets the world know which version it is running and this is tremendous. Now let&#x27;s make our client do the same.</p><p>Very little is required to achieve this. Again we have a <code>buildinfo.json</code> sat in the root of our codebase. We&#x27;re able to import it as a module in TypeScript because we&#x27;ve set the following property in our <code>tsconfig.json</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token property">&quot;resolveJsonModule&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>As a consequence, consumption is as simple as:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">import clientBuildInfo from &#x27;./buildinfo.json&#x27;;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Which provides us with a <code>clientBuildInfo</code> which TypeScript automatically derives as this type:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">type ClientBuildInfo = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    buildNumber: string;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    buildId: string;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    branchName: string;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    commitHash: string;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>How you choose to use that information is entirely your choice. We&#x27;re going to add ourselves an &quot;about&quot; screen in our app, which displays both client info (loaded using the mechanism above) and server info (<code>fetch</code>ed from the <code>/api/build</code> endpoint).</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-tsx codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token maybe-class-name">Card</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token maybe-class-name">CardContent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token maybe-class-name">CardHeader</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    createStyles</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token maybe-class-name">Grid</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    makeStyles</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token maybe-class-name">Theme</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token maybe-class-name">Typography</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token maybe-class-name">Zoom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;@material-ui/core&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;react&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> clientBuildInfo </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;../../buildinfo.json&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> projectsPurple </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;../shared/colors&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token maybe-class-name">Loading</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;../shared/Loading&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token maybe-class-name">TransitionContainer</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;../shared/TransitionContainer&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">useStyles</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">cardColor</span><span class="token parameter operator" style="color:rgb(137, 221, 255)">:</span><span class="token parameter"> string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">makeStyles</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">theme</span><span class="token parameter operator" style="color:rgb(137, 221, 255)">:</span><span class="token parameter"> Theme</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">createStyles</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            card</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                padding</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> theme</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">spacing</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                backgroundColor</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> cardColor</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                color</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> theme</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">palette</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">common</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">white</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                minHeight</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> theme</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">spacing</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">28</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            avatar</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                backgroundColor</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> theme</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">palette</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">getContrastText</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cardColor</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                color</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> cardColor</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            main</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                padding</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> theme</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">spacing</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">type</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 107)">Styles</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token keyword" style="font-style:italic">typeof</span><span class="token plain"> useStyles</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token maybe-class-name">AboutPage</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function-variable function maybe-class-name" style="color:rgb(130, 170, 255)">FC</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">serverBuildInfo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> setServerBuildInfo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token generic-function function" style="color:rgb(130, 170, 255)">useState</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token generic-function generic class-name keyword" style="color:rgb(255, 203, 107);font-style:italic">typeof</span><span class="token generic-function generic class-name" style="color:rgb(255, 203, 107)"> clientBuildInfo</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">useEffect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">fetch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;/api/build&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">then</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">response</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">json</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">then</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">setServerBuildInfo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> classes </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">useStyles</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">projectsPurple</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">TransitionContainer</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Grid</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">container</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">spacing</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript number" style="color:rgb(247, 140, 108)">3</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Grid</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">item</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xs</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript number" style="color:rgb(247, 140, 108)">12</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">sm</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript number" style="color:rgb(247, 140, 108)">12</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">container</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">alignItems</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">center</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Grid</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">item</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Typography</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">variant</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">h4</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">component</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">h1</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            </span><span class="token maybe-class-name">About</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Typography</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Grid</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Grid</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Grid</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Grid</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">container</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">spacing</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript number" style="color:rgb(247, 140, 108)">1</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">BuildInfo</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">classes</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">classes</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">title</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Client Version</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag spread punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag spread punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token tag spread attr-value" style="color:rgb(255, 85, 114)">clientBuildInfo</span><span class="token tag spread punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Grid</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">br</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Grid</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">container</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">spacing</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript number" style="color:rgb(247, 140, 108)">1</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">serverBuildInfo </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">BuildInfo</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">classes</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">classes</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">title</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Server Version</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag spread punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag spread punctuation" style="color:rgb(199, 146, 234)">...</span><span class="token tag spread attr-value" style="color:rgb(255, 85, 114)">serverBuildInfo</span><span class="token tag spread punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Loading</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Grid</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">TransitionContainer</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">interface</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 107)">Props</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    classes</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">Styles</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    title</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    branchName</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    buildNumber</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    buildId</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    commitHash</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token maybe-class-name">BuildInfo</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token constant" style="color:rgb(130, 170, 255)">FC</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token maybe-class-name">Props</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token parameter"> classes</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> title</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> branchName</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> buildNumber</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> buildId</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> commitHash </span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Zoom</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">mountOnEnter</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">unmountOnExit</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">in</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript boolean" style="color:rgb(255, 88, 116)">true</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Card</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">className</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">classes</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">card</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">CardHeader</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">title</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">title</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">CardContent</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">className</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">classes</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">main</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Typography</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">variant</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">body1</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">component</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">p</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">b</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token maybe-class-name">Build</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(255, 203, 107)">Number</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">b</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">buildNumber</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Typography</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Typography</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">variant</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">body1</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">component</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">p</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">b</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token maybe-class-name">Build</span><span class="token plain"> </span><span class="token maybe-class-name">Id</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">b</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">buildId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Typography</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Typography</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">variant</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">body1</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">component</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">p</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">b</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token maybe-class-name">Branch</span><span class="token plain"> </span><span class="token maybe-class-name">Name</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">b</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">branchName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Typography</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Typography</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">variant</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">body1</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">component</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">p</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">b</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token maybe-class-name">Commit</span><span class="token plain"> </span><span class="token maybe-class-name">Hash</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">b</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">commitHash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Typography</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">CardContent</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Card</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Zoom</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">default</span><span class="token plain"> </span><span class="token maybe-class-name">AboutPage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>When the above page is viewed it looks like this:</p><p><img src="/blog.johnnyreilly.com/assets/images/about-page-220dea782e9493f89e65f9d68511d7b7.png"></p><p>And that&#x27;s it! Our app is clearly telling us what version is being run, both on the server and in the client. Thanks to Scott Hanselman for his work which inspired this.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/build-information">build information</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/azure-pipelines">azure pipelines</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2021/01/17/azure-easy-auth-and-roles-with-net-and-microsoft-identity-web">Azure Easy Auth and Roles with .NET and Microsoft.Identity.Web</a></h2><div class="margin-vert--md"><time datetime="2021-01-17T00:00:00.000Z" class="blogPostDate_Ta7i">January 17, 2021  · 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p><a href="https://blog.johnnyreilly.com/2021/01/azure-easy-auth-and-roles-with-dotnet-and-core.html" target="_blank" rel="noopener noreferrer">I wrote recently about how to get Azure Easy Auth to work with roles</a>. This involved borrowing the approach used by <a href="https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth" target="_blank" rel="noopener noreferrer">MaximeRouiller.Azure.AppService.EasyAuth</a>.</p><p>As a consequence of writing that post I came to learn that official support for Azure Easy Auth had landed in October 2020 in v1.2 of <a href="https://github.com/AzureAD/microsoft-identity-web/wiki/1.2.0#integration-with-azure-app-services-authentication-of-web-apps-running-with-microsoftidentityweb" target="_blank" rel="noopener noreferrer">Microsoft.Identity.Web</a>. This was great news; I was delighted.</p><p>However, it turns out that the same authorization issue that <code>MaximeRouiller.Azure.AppService.EasyAuth</code> suffers from, is visited upon <code>Microsoft.Identity.Web</code> as well.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="getting-set-up"></a>Getting set up<a class="hash-link" href="#getting-set-up" title="Direct link to heading">#</a></h2><p>We&#x27;re using a .NET 5 project, running in an Azure App Service (Linux). In our <code>.csproj</code> we have:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-xml codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">PackageReference</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Microsoft.Identity.Web</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">1.4.1</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>In our <code>Startup.cs</code> we&#x27;re using:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public void ConfigureServices(IServiceCollection services) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            //...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            services.AddMicrosoftIdentityWebAppAuthentication(Configuration);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            //...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      public void Configure(IApplicationBuilder app, IWebHostEnvironment env) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            //...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseAuthentication();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseAuthorization();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            //...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="you-gotta-roles-with-it"></a>You gotta <code>roles</code> with it<a class="hash-link" href="#you-gotta-roles-with-it" title="Direct link to heading">#</a></h2><p>Whilst the authentication works, authorization does not. So whilst my app knows who I am - the authorization is not working with relation to <strong>roles</strong>.</p><p>When directly using <code>Microsoft.Identity.Web</code> when running locally, we see these claims:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Administrator&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Reader&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>However, we get different behaviour with EasyAuth; it provides roles related claims with a <strong>different type</strong>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Administrator&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Reader&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This means that roles related authorization <em>does not work</em> with Easy Auth:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Authorize(Roles = &quot;Reader&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[HttpGet(&quot;api/reader&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public string GetWithReader() =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;this is a secure endpoint that users with the Reader role can access&quot;;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This is because .NET is looking for claims with a <code>type</code> of <code>&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</code> and not finding them with Easy Auth.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="claims-transformation-ftw"></a>Claims transformation FTW<a class="hash-link" href="#claims-transformation-ftw" title="Direct link to heading">#</a></h2><p>There is a way to work around this issue .NET using <code>IClaimsTransformation</code>. This is a poorly documented feature, but fortunately <a href="https://gunnarpeipman.com/aspnet-core-adding-claims-to-existing-identity/" target="_blank" rel="noopener noreferrer">Gunnar Peipman&#x27;s blog does a grand job of explaining it</a>.</p><p>Inside our <code>Startup.cs</code> I&#x27;ve registered a claims transformer:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">services.AddScoped&lt;IClaimsTransformation, AddRolesClaimsTransformation&gt;();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>And that claims transformer looks like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class AddRolesClaimsTransformation : IClaimsTransformation {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly ILogger&lt;AddRolesClaimsTransformation&gt; _logger;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public AddRolesClaimsTransformation(ILogger&lt;AddRolesClaimsTransformation&gt; logger) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            _logger = logger;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public Task&lt;ClaimsPrincipal&gt; TransformAsync(ClaimsPrincipal principal) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var mappedRolesClaims = principal.Claims</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .Where(claim =&gt; claim.Type == &quot;roles&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .Select(claim =&gt; new Claim(ClaimTypes.Role, claim.Value))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Clone current identity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var clone = principal.Clone();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (clone.Identity is not ClaimsIdentity newIdentity) return Task.FromResult(principal);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Add role claims to cloned identity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            foreach (var mappedRoleClaim in mappedRolesClaims) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                newIdentity.AddClaim(mappedRoleClaim);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (mappedRolesClaims.Count &gt; 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                _logger.LogInformation(&quot;Added roles claims {mappedRolesClaims}&quot;, mappedRolesClaims);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                _logger.LogInformation(&quot;No roles claims added&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return Task.FromResult(clone);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The class above creates a new principal with <code>&quot;roles&quot;</code> claims mapped across to <code>&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</code>. This is enough to get .NET treating roles the way you&#x27;d hope.</p><p><a href="https://github.com/AzureAD/microsoft-identity-web/issues/881" target="_blank" rel="noopener noreferrer">I&#x27;ve raised an issue against the <code>Microsoft.Identity.Web</code> repo</a> about this. Perhaps one day this workaround will no longer be necessary.</p></section></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2021/01/14/azure-easy-auth-and-roles-with-dotnet-and-core">Azure Easy Auth and Roles with .NET (and .NET Core)</a></h2><div class="margin-vert--md"><time datetime="2021-01-14T00:00:00.000Z" class="blogPostDate_Ta7i">January 14, 2021  · 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p><em>If this post is interesting to you, you may also want to <a href="https://blog.johnnyreilly.com/2021/01/azure-easy-auth-and-roles-with-net-and-microsoft-identity-web.html" target="_blank" rel="noopener noreferrer">look at this one where we try to use Microsoft.Identity.Web for the same purpose.</a></em></p><p> Azure has a feature which is intended to allow Authentication and Authorization to be applied outside of your application code. It&#x27;s called <a href="https://docs.microsoft.com/en-us/azure/app-service/overview-authentication-authorization" target="_blank" rel="noopener noreferrer">&quot;Easy Auth&quot;</a>. Unfortunately, in the context of App Services it doesn&#x27;t work with .NET Core and .NET. Perhaps it would be better to say: of the various .NETs, it supports .NET Framework. <a href="https://docs.microsoft.com/en-us/azure/app-service/overview-authentication-authorization#userapplication-claims" target="_blank" rel="noopener noreferrer">To quote the docs</a>:</p><blockquote><p>At this time, ASP.NET Core does not currently support populating the current user with the Authentication/Authorization feature. However, some <a href="https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth" target="_blank" rel="noopener noreferrer">3rd party, open source middleware components</a> do exist to help fill this gap.</p></blockquote><p>Thanks to <a href="https://twitter.com/MaximRouiller" target="_blank" rel="noopener noreferrer">Maxime Rouiller</a> there&#x27;s a way forward here. However, as I was taking this for a spin today, I discovered another issue.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="where-are-our-roles"></a>Where are our roles?<a class="hash-link" href="#where-are-our-roles" title="Direct link to heading">#</a></h2><p>Consider the following .NET controller:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Authorize(Roles = &quot;Administrator,Reader&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[HttpGet(&quot;api/admin-reader&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public string GetWithAdminOrReader() =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;this is a secure endpoint that users with the Administrator or Reader role can access&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Authorize(Roles = &quot;Administrator&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[HttpGet(&quot;api/admin&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public string GetWithAdmin() =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;this is a secure endpoint that users with the Administrator role can access&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Authorize(Roles = &quot;Reader&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[HttpGet(&quot;api/reader&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public string GetWithReader() =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;this is a secure endpoint that users with the Reader role can access&quot;;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The three endpoints above restrict access based upon roles. However, even with Maxime&#x27;s marvellous shim in the mix, authorization doesn&#x27;t work when deployed to an Azure App Service. Why? Well, it comes down to how roles are mapped to claims.</p><p>Let&#x27;s back up a bit. First of all we&#x27;ve added a dependency to our project:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-shell codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> package MaximeRouiller.Azure.AppService.EasyAuth</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Next we&#x27;ve updated our <code>Startup.cs``ConfigureServices</code> such that it looks like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (Env.IsDevelopment()) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    services.AddMicrosoftIdentityWebAppAuthentication(Configuration);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    services.AddAuthentication(&quot;EasyAuth&quot;).AddEasyAuthAuthentication((o) =&gt; { });</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>With the above in place, either the Microsoft Identity platform will directly be used for authentication, or Maxime&#x27;s package will be used as the default authentication scheme. The driver for this is <code>Env</code> which is an <code>IHostEnvironment</code> that was injected to the <code>Startup.cs</code>. Running locally, both authentication and authorization will work. However, deployed to an Azure App Service, only authentication will work.</p><p>It turns out that directly using the Microsoft Identity platform, we see roles claims coming through like so:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Administrator&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Reader&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>But in Azure we see roles claims showing up with a different <code>type</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Administrator&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Reader&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This is the crux of the problem; .NET and .NET Core are looking in a different place for roles.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="role-up-role-up"></a>Role up, role up!<a class="hash-link" href="#role-up-role-up" title="Direct link to heading">#</a></h2><p>There wasn&#x27;t an obvious way to make this work with Maxime&#x27;s package. So we ended up lifting the source code of Maxime&#x27;s package and tweaking it. Take a look:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Authentication;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.Logging;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.Options;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Collections.Generic;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Linq;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Security.Claims;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Text.Encodings.Web;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Text.Json;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Text.Json.Serialization;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Threading.Tasks;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// Based on https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// Essentially EasyAuth only supports .NET Framework: https://docs.microsoft.com/en-us/azure/app-service/app-service-authentication-how-to#access-user-claims</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// This allows us to get support for Authentication and Authorization (using roles) with .NET</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace EasyAuth {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static class EasyAuthAuthenticationBuilderExtensions {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static AuthenticationBuilder AddEasyAuthAuthentication(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this IServiceCollection services) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            services.AddAuthentication(&quot;EasyAuth&quot;).AddEasyAuthAuthenticationScheme(o =&gt; { });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static AuthenticationBuilder AddEasyAuthAuthenticationScheme(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this AuthenticationBuilder builder,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Action&lt;EasyAuthAuthenticationOptions&gt; configure) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                builder.AddScheme&lt;EasyAuthAuthenticationOptions, EasyAuthAuthenticationHandler&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;EasyAuth&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;EasyAuth&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    configure);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class EasyAuthAuthenticationOptions : AuthenticationSchemeOptions {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public EasyAuthAuthenticationOptions() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Events = new object();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class EasyAuthAuthenticationHandler : AuthenticationHandler&lt;EasyAuthAuthenticationOptions&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public EasyAuthAuthenticationHandler(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            IOptionsMonitor&lt;EasyAuthAuthenticationOptions&gt; options,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ILoggerFactory logger,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            UrlEncoder encoder,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ISystemClock clock)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            : base(options, logger, encoder, clock) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var easyAuthEnabled = string.Equals(Environment.GetEnvironmentVariable(&quot;WEBSITE_AUTH_ENABLED&quot;, EnvironmentVariableTarget.Process), &quot;True&quot;, StringComparison.InvariantCultureIgnoreCase);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (!easyAuthEnabled) return Task.FromResult(AuthenticateResult.NoResult());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var easyAuthProvider = Context.Request.Headers[&quot;X-MS-CLIENT-PRINCIPAL-IDP&quot;].FirstOrDefault();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var msClientPrincipalEncoded = Context.Request.Headers[&quot;X-MS-CLIENT-PRINCIPAL&quot;].FirstOrDefault();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (string.IsNullOrWhiteSpace(easyAuthProvider) ||</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    string.IsNullOrWhiteSpace(msClientPrincipalEncoded))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    return Task.FromResult(AuthenticateResult.NoResult());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var decodedBytes = Convert.FromBase64String(msClientPrincipalEncoded);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var msClientPrincipalDecoded = System.Text.Encoding.Default.GetString(decodedBytes);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var clientPrincipal = JsonSerializer.Deserialize&lt;MsClientPrincipal&gt;(msClientPrincipalDecoded);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (clientPrincipal == null) return Task.FromResult(AuthenticateResult.NoResult());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var mappedRolesClaims = clientPrincipal.Claims</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    .Where(claim =&gt; claim.Type == &quot;roles&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    .Select(claim =&gt; new Claim(ClaimTypes.Role, claim.Value))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    .ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var claims = clientPrincipal.Claims.Select(claim =&gt; new Claim(claim.Type, claim.Value)).ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                claims.AddRange(mappedRolesClaims);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var principal = new ClaimsPrincipal();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                principal.AddIdentity(new ClaimsIdentity(claims, clientPrincipal.AuthenticationType, clientPrincipal.NameType, clientPrincipal.RoleType));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var ticket = new AuthenticationTicket(principal, easyAuthProvider);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var success = AuthenticateResult.Success(ticket);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                Context.User = principal;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return Task.FromResult(success);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            } catch (Exception ex) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return Task.FromResult(AuthenticateResult.Fail(ex));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class MsClientPrincipal {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [JsonPropertyName(&quot;auth_typ&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public string? AuthenticationType { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [JsonPropertyName(&quot;claims&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public IEnumerable&lt;UserClaim&gt; Claims { get; set; } = Array.Empty&lt;UserClaim&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [JsonPropertyName(&quot;name_typ&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public string? NameType { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [JsonPropertyName(&quot;role_typ&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public string? RoleType { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class UserClaim {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [JsonPropertyName(&quot;typ&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public string Type { get; set; } = string.Empty;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [JsonPropertyName(&quot;val&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public string Value { get; set; } = string.Empty;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>There&#x27;s a number of changes in the above code to Maxime&#x27;s package. Three changes that are not significant and one that is. First the insignificant changes:</p><ol><li>It uses <a href="https://docs.microsoft.com/en-us/dotnet/standard/serialization/system-text-json-how-to?pivots=dotnet-5-0" target="_blank" rel="noopener noreferrer"><code>System.Text.Json</code></a> in place of JSON.NET</li><li>It uses <a href="https://blog.johnnyreilly.com/2020/12/nullable-reference-types-csharp-strictnullchecks.html" target="_blank" rel="noopener noreferrer">C#s nullable reference types</a></li><li>It changes the extension method signature such that instead of entering <code>services.AddAuthentication().AddEasyAuthAuthentication((o) =&amp;gt; { })</code> we now need only enter <code>services.AddEasyAuthAuthentication()</code></li></ol><p>Now the significant change:</p><p>Where the middleware encounters claims in the <code>X-MS-CLIENT-PRINCIPAL</code> header with the <code>Type</code> of <code>&quot;roles&quot;</code> it creates brand new claims for each, with the same <code>Value</code> but with the official <code>Type</code> supplied by <code>ClaimsTypes.Role</code> of <code>&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</code>. The upshot of this, is that when the processed claims are inspected in Azure they now look more like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Administrator&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Reader&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Administrator&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Reader&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>As you can see, we now have both the originally supplied roles <em>as well</em> as roles of the type that .NET and .NET Core expect. Consequently, roles based behaviour starts to work. Thanks to Maxime for his fine work on the initial solution. It would be tremendous if neither the code in this blog post nor Maxime&#x27;s shim were required. Still, until that glorious day!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="update-potential-ways-forward"></a>Update: Potential ways forward<a class="hash-link" href="#update-potential-ways-forward" title="Direct link to heading">#</a></h2><p>When I was tweeting this post, Maxime was good enough to respond and suggest that this may be resolved within Azure itself in future:</p><blockquote><p>Oh, so that&#x27;s why they removed the name? 😲😜 Jokes aside, we hope that this package won&#x27;t be necessary for the future. I know that <a href="https://twitter.com/mattchenderson?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">@mattchenderson</a> is part of a working group to update Easy Auth. Might want to make sure you follow him as well. 😁</p><p>— Maxime Rouiller (@MaximRouiller) <a href="https://twitter.com/MaximRouiller/status/1349804324713615366?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">January 14, 2021</a></p></blockquote><script src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>There&#x27;s a prospective PR that would add an event to Maxime&#x27;s API. If something along these lines was merged, then my workaround would no longer be necessary. Follow the PR <a href="https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth/pull/13" target="_blank" rel="noopener noreferrer">here</a>.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/azure">Azure</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/app-service">App service</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/authorisation">authorisation</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/authentication">Authentication</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/azure-ad">azure AD</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog.johnnyreilly.com/page/2"><div class="pagination-nav__label">Older Entries »</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/blog.johnnyreilly.com/styles.b80bbee1.js"></script>
<script src="/blog.johnnyreilly.com/runtime~main.94d0c56d.js"></script>
<script src="/blog.johnnyreilly.com/main.08f1a502.js"></script>
<script src="/blog.johnnyreilly.com/1.b4966bec.js"></script>
<script src="/blog.johnnyreilly.com/2.7d3f6764.js"></script>
<script src="/blog.johnnyreilly.com/a6aa9e1f.88297f1e.js"></script>
<script src="/blog.johnnyreilly.com/c3b5bd8c.4d75ffb7.js"></script>
<script src="/blog.johnnyreilly.com/e5855285.e4205732.js"></script>
<script src="/blog.johnnyreilly.com/564c5296.c117dea0.js"></script>
<script src="/blog.johnnyreilly.com/0e1441f0.e386d6bd.js"></script>
<script src="/blog.johnnyreilly.com/563b17c1.d76d648e.js"></script>
<script src="/blog.johnnyreilly.com/867cd795.8eb4a3f0.js"></script>
<script src="/blog.johnnyreilly.com/dbef44d7.0ace3e41.js"></script>
<script src="/blog.johnnyreilly.com/ed8dd490.008ff954.js"></script>
<script src="/blog.johnnyreilly.com/734a1624.9354b688.js"></script>
<script src="/blog.johnnyreilly.com/f8e14f4a.0844f5a2.js"></script>
<script src="/blog.johnnyreilly.com/de233e4b.36c6c7e8.js"></script>
<script src="/blog.johnnyreilly.com/9127ef1b.583f01b9.js"></script>
</body>
</html>