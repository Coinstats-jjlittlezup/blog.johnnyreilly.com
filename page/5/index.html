<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog.johnnyreilly.com/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog.johnnyreilly.com/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed"><title data-react-helmet="true">Blog | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="Blog | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/blog.johnnyreilly.com/img/favicon.ico"><link rel="stylesheet" href="/blog.johnnyreilly.com/styles.a755cef0.css">
<link rel="preload" href="/blog.johnnyreilly.com/styles.7c653e04.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/runtime~main.8fae10d8.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/main.aa01ada2.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/1.a2fa6ec1.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/2.541c8135.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/a6aa9e1f.8b47d5c4.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/c3b5bd8c.b5dc6e8e.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/0ffd0b88.504fd013.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/f7dab29d.1309c12e.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/0f9ea58f.7995d72e.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/1b063778.5c9d5981.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/d4086ce6.8bcf1997.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/2d328955.c7c8f5f4.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/e476ec94.0a39b9a3.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/6eb1980c.83bb52a5.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/20a3dccc.0c1693ce.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/357a35a7.2fbf7d37.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/8f3ed738.855e4d1b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/blog.johnnyreilly.com/"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/blog.johnnyreilly.com/"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/03/10/managed-identity-azure-sql-entity-framework">Managed Identity, Azure SQL and Entity Framework</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/03/06/generate-typescript-and-csharp-clients-with-nswag">Generate TypeScript and CSharp clients with NSwag based on an API</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure">Goodbye Client Affinity, Hello Data Protection with Azure</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service">Making Easy Auth tokens survive releases on Linux Azure App Service</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/11/azure-app-service-health-checks-and-zero-downtime-deployments">Azure App Service, Health checks and zero downtime deployments</a></li></ul></div></div><main class="col col--8"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2019/08/17/symbiotic-definitely-typed">Symbiotic Definitely Typed</a></h2><div class="margin-vert--md"><time datetime="2019-08-17T00:00:00.000Z" class="blogPostDate_Ta7i">August 17, 2019  Â· 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>I did ponder calling this post &quot;how to enable a good TypeScript developer experience for npm modules that aren&#x27;t written in TypeScript&quot;... Not exactly pithy though.</p><p>Definitely Typed is the resource which allows developers to use TypeScript with existing JavaScript libraries that ship without their own type definitions.</p><p>DT began as a way to enable interop between JS and TS. When DT started, everything on npm was JavaScript. Over time it has become more common for libraries (eg <a href="https://github.com/mobxjs/mobx" target="_blank" rel="noopener noreferrer">Mobx</a> / <a href="https://github.com/angular/angular" target="_blank" rel="noopener noreferrer">Angular</a>) to be written (or rewritten) in TypeScript. For publishing, they are compiled down to JS with perfect type definitions generated from the TypeScript alongside the compiled JavaScript. These libraries do not need to exist in Definitely Typed anymore.</p><p>Another pattern that has emerged over time is that of type definitions being removed from Definitely Typed to live and be maintained alongside the libraries they support. An example of this is <a href="https://github.com/moment/moment" target="_blank" rel="noopener noreferrer">MomentJS</a>.</p><p>This week, I think for the first time, there emerged another approach. <a href="https://kentcdodds.com/" target="_blank" rel="noopener noreferrer">Kent C Dodds</a>&#x27; <code>react-testing-library</code> had started out with the MomentJS approach of hosting type definitions alongside the JavaScript source code. <a href="https://github.com/testing-library/react-testing-library/pull/437" target="_blank" rel="noopener noreferrer">Alex Krolic raised a PR which proposed removing the type definitions from the RTL repo in favor of having the community maintain them at DefinitelyTyped.</a></p><p>I&#x27;ll directly quote Kent&#x27;s explanation of the motivation for this:</p><blockquote><p>We were getting a lot of drive-by contributions to the TypeScript typings and many pull requests would either sit without being reviewed by someone who knows TypeScript well enough, or be merged by a maintainer who just hoped the contributor knew what they were doing. This resulted in a poor experience for TypeScript users who could experience type definition churn and delays, and it became a burden on project maintainers as well (most of us don&#x27;t know TypeScript very well). Moving the type definitions to DefinitelyTyped puts the maintenance in much more capable hands.</p></blockquote><p>I have to admit I was reticent about this idea in the first place. I like the idea that types ship with the package they support. It&#x27;s a good developer experience; users install your package and it works with TypeScript straight out of the box. However Alex&#x27;s PR addressed a real issue: what do you do when the authors of a package aren&#x27;t interested / equipped / don&#x27;t have the time to support TypeScript? Or don&#x27;t want to deal with the noise of TypeScript related PRs which aren&#x27;t relevant to them. What then?</p><p>Alex was saying, let&#x27;s not force it. Let the types and the library be maintained separately. This can and is done well already; React is a case in point. The React team does not work on the type definitions for React, that&#x27;s done (excellently) by a crew of dedicated React lovers in Definitely Typed.</p><p>It&#x27;s a fair point. The thing that was sad about this move was that the developer experience was going to have more friction. Users would have to <code>yarn add -D @testing-library/react</code> and then subsequently <code>yarn add -D @types/testing-library__react</code> to get the types.</p><p>This two step process isn&#x27;t the end of the world, but it does make it marginally harder for TypeScript users to get up and running. It reduces the developer joy. As a side note, this is made more unlovely by <code>@testing-library/react</code> being a scoped package. <a href="https://stackoverflow.com/questions/47296731/how-can-i-install-typescript-declarations-for-scoped-namespaced-packages-via-ty" target="_blank" rel="noopener noreferrer">Types for a scoped package have a quirky convention for publishing.</a> A fictional scoped package of <code>@foo/bar</code> would be published to npm as: <code>@types/foo__bar</code>. This is functional but non-obvious; it&#x27;s tricky to discover. A two step process instead of a one step process is a non-useful friction that it would be great to eliminate.</p><p>Fortunately, Kent and <a href="https://github.com/FredyC" target="_blank" rel="noopener noreferrer">Daniel K</a> had one of these moments:</p><p> <a href="https://4.bp.blogspot.com/-tmH5nbo_kGY/XG-8jmokKdI/AAAAAAAAN_U/umq24uPgdKAZgAlePU5teNs57i8RWOg7gCPcBGAYYCw/s1600/hang-on-lads-ive-got-a-great-idea.jpg" target="_blank" rel="noopener noreferrer">![null](&lt;https://4.bp.blogspot.com/-tmH5nbo_kGY/XG-8jmokKdI/AAAAAAAAN_U/umq24uPgdKAZgAlePU5teNs57i8RWOg7gCPcBGAYYCw/s640/hang-on-lads-ive-got-a-great-idea.jpg&gt; =640x271)</a>Kent suggested that at the same time as dropping the type definitions that were shipped with the library, we try making <code>@types/testing-library__react</code> a dependency of <code>@testing-library/react</code>. This would mean that people installing <code>@testing-library/react</code> would get <code>@types/testing-library__react</code> installed <em>automatically</em>. So from the developers point of view, it&#x27;s as though the type definitions shipped with the package directly.</p><p>To cut a long story short reader, that&#x27;s what happened. If you&#x27;re using <code>@testing-library/react</code> from 9.1.2 you&#x27;re getting Definitely Typed under the covers. This was <a href="https://github.com/testing-library/react-testing-library/pull/437#issuecomment-521763117" target="_blank" rel="noopener noreferrer">nicely illustrated by Kent</a> showing what the TypeScript consumption experience looked like before the Definitely Typed switch:</p><p><a href="https://1.bp.blogspot.com/-wJCLzg0uPuU/XVhqss-lXwI/AAAAAAAAQ48/SGCl9aEHGjUh1qE7OpyyY8MhqPkd2Rw4wCPcBGAYYCw/s1600/RTL-9.1.1.png" target="_blank" rel="noopener noreferrer">![null](&lt;https://1.bp.blogspot.com/-wJCLzg0uPuU/XVhqss-lXwI/AAAAAAAAQ48/SGCl9aEHGjUh1qE7OpyyY8MhqPkd2Rw4wCPcBGAYYCw/s640/RTL-9.1.1.png&gt; =640x385)</a>And here&#x27;s what it looked like after:</p><p><a href="https://4.bp.blogspot.com/-jeTQeQnKpVY/XVhrvq8D-0I/AAAAAAAAQ5E/tOieujozFZQ_pttgStAAj_zQwtpGl1AsgCLcBGAs/s1600/RTL-9.1.2.png" target="_blank" rel="noopener noreferrer">![null](&lt;https://4.bp.blogspot.com/-jeTQeQnKpVY/XVhrvq8D-0I/AAAAAAAAQ5E/tOieujozFZQ_pttgStAAj_zQwtpGl1AsgCLcBGAs/s640/RTL-9.1.2.png&gt; =640x403)</a>Identical! i.e it worked. I grant you this is one of the more boring before / after comparisons there isâ€¦ But hopefully you can see it demonstrates that this is giving us exactly what we need.</p><p>To quote Kent once more:</p><blockquote><p>By adding the type definitions to the dependencies of React Testing Library, the experience for users is completely unchanged. So it&#x27;s a huge improvement for the maintenance of the type definitions without any breaking changes for the users of those definitions.</p></blockquote><p>This is clearly an approach that&#x27;s useful; it adds value. It would be tremendous to see other libraries that aren&#x27;t written in TypeScript but would like to enable a good TypeScript experience for those people that do use TS also adopting this approach.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="update-use-a-loose-version-range-in-packagejson"></a>Update: Use a Loose Version Range in <code>package.json</code><a class="hash-link" href="#update-use-a-loose-version-range-in-packagejson" title="Direct link to heading">#</a></h2><p>When I <a href="https://twitter.com/johnny_reilly/status/1162843916661592064" target="_blank" rel="noopener noreferrer">tweeted this article</a> it prompted this helpful response from <a href="https://twitter.com/atcb" target="_blank" rel="noopener noreferrer">Andrew Branch</a> of the TypeScript team:</p><blockquote><p>&gt; use a loose version range This is my advice as well and should probably be mentioned in the article TBH.</p><p>â€” Kent C. Dodds (@kentcdodds) <a href="https://twitter.com/kentcdodds/status/1162876792287293440?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">August 18, 2019</a></p></blockquote><script src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>Andrew makes the useful point that if you are adding support for TypeScript via an <code>@types/...</code> dependency then it&#x27;s wise to do so with a loose version range. <a href="https://github.com/testing-library/react-testing-library/blob/c4ba755e42938018ec67dbc716037cfafca15e03/package.json#L46" target="_blank" rel="noopener noreferrer">In the case of RTL we did it like this:</a></p><div class="mdxCodeBlock_1zKU">    &quot;@types/testing-library__react&quot;: &quot;^9.1.0&quot;</div><p>i.e. Any type definition with a version of <code>9.1</code> or greater (whilst still lower than <code>10.0.0</code>) is considered valid. You could go even looser than that. If you really don&#x27;t want to think about TypeScript beyond adding the dependency then a completely loose version range would do:</p><div class="mdxCodeBlock_1zKU">    &quot;@types/testing-library__react&quot;: &quot;*&quot;</div><p>This will always install the latest version of the <code>@types/testing-library__react</code> dependency and (importantly) allow users to override if there&#x27;s a problematic <code>@types/testing-library__react</code> out there. This level of looseness is not really advised though. As in the scenario when a library (and associated type definitions) do a major release, users of the old major would get the wrong definitions by default when installing or upgrading (in range).</p><p>Probably the most helpful approach is the approach followed by RTL; fixing the major version but allowing all minor and patch releases <em>inside</em> a major version.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="update-2-further-discussions"></a>Update 2: Further Discussions!<a class="hash-link" href="#update-2-further-discussions" title="Direct link to heading">#</a></h2><p>The technique used in this blog post sparked an interesting conversation with members of the TypeScript team when it was applied to <code>&lt;a href=&quot;https://github.com/testing-library/jest-dom&quot;&gt;https://github.com/testing-library/jest-dom&lt;/a&gt;</code>. <a href="https://github.com/testing-library/jest-dom/issues/123#issuecomment-523586977" target="_blank" rel="noopener noreferrer">The conversation can be read here</a>.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/type-script">TypeScript</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/react-testing-library">react-testing-library</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/definitely-typed">Definitely Typed</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2019/08/02/hard-coding-claim-in-development-mode">Hard-coding a Claim in Development Mode in ASP.Net Core</a></h2><div class="margin-vert--md"><time datetime="2019-08-02T00:00:00.000Z" class="blogPostDate_Ta7i">August 2, 2019  Â· 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>I was recently part of a hackathon team that put together an API in just 30 hours. We came second. (Not bitter, not bitter...)</p><p>We were moving pretty quickly during the hackathon and, when we came to the end of it, we had a working API which we were able to demo. The good news is that the API is going to graduate to be a product! We&#x27;re going to ship this. Before we can do that though, there&#x27;s a little tidy up to do.</p><p>The first thing I remembered / realised when I picked up the codebase again, was the shortcuts we&#x27;d made on the developer experience. We&#x27;d put the API together using ASP.Net Core. We&#x27;re handling authentication using JWTs which is nicely supported. When we&#x27;re deployed, an external facing proxy calls our application with the appropriate JWT and everything works as you&#x27;d hope.</p><p>The question is, what&#x27;s it like to develop against this on your laptop? Getting a JWT for when I&#x27;m debugging locally is too much friction. I want to be able to work on the problem at hand, going away to get a JWT each time is a timesuck. So what to do? Well, during the hackathon, we just commented out <code>[Authorize]</code> attributes and hardcoded user ids in our controllers. This works, but it&#x27;s a messy developer experience; it&#x27;s easy to forget to uncomment things you&#x27;ve commented and break things. There must be a better way.</p><p>The solution I landed on was this: in development mode (which we only use whilst debugging) we hardcode an authenticated user. The way our authentication works is that we have a claim on our principal called something like <code>&quot;our-user-id&quot;</code>, the value of which is our authenticated user id. So in the <code>ConfigureServices</code> method of our <code>Startup.cs</code> we have a conditional authentication registration like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Whilst developing, we don&#x27;t want to authenticate; we hardcode to a particular users id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (Env.IsDevelopment()) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    services.AddAuthentication(nameof(DevelopmentModeAuthenticationHandler))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .AddScheme&lt;DevelopmentModeAuthenticationOptions, DevelopmentModeAuthenticationHandler&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            nameof(DevelopmentModeAuthenticationHandler), </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            options =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                options.UserIdToSetInClaims = &quot;this-is-a-user-id&quot;; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // The application typically uses this</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .AddJwtBearer(options =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>As you can see, we&#x27;re using a special <code>DevelopmentModeAuthenticationHandler</code> authentication scheme in development mode, instead of JWT. As we register that, we declare the user id that we want to use. Whenever the app runs using the <code>DevelopmentModeAuthenticationHandler</code> auth, all requests will arrive using a principal with an <code>&quot;our-user-id&quot;</code> claim with a value of <code>&quot;this-is-a-user-id&quot;</code> (or whatever you&#x27;ve set it to.)</p><p>The <code>DevelopmentModeAuthenticationHandler</code> looks like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Collections.Generic;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Security.Claims;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Text.Encodings.Web;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Threading.Tasks;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Authentication;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.Logging;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.Options;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace OurApp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class DevelopmentModeAuthenticationOptions : AuthenticationSchemeOptions </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public string UserIdToSetInClaims { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class DevelopmentModeAuthenticationHandler : AuthenticationHandler&lt;DevelopmentModeAuthenticationOptions&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly ILoggingService _loggingService;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public DevelopmentModeAuthenticationHandler(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            IOptionsMonitor&lt;DevelopmentModeAuthenticationOptions&gt; options,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ILoggerFactory logger,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            UrlEncoder encoder,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ISystemClock clock</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ) : base(options, logger, encoder, clock) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var claims = new List&lt;Claim&gt; { new Claim(&quot;our-user-id&quot;, Options.UserIdToSetInClaims) };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var identity = new ClaimsIdentity(claims, nameof(DevelopmentModeAuthenticationHandler));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var ticket = new AuthenticationTicket(new ClaimsPrincipal(identity), Scheme.Name);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return Task.FromResult(AuthenticateResult.Success(ticket));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Now, developing locally is frictionless! We don&#x27;t comment out <code>[Authorize]</code> attributes, we don&#x27;t hard code user ids in controllers.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/asp-net-core">ASP.Net Core</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/authentication">Authentication</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2019/07/13/typescript-and-eslint-meet-fork-ts-checker-webpack-plugin">Using TypeScript and ESLint with webpack (fork-ts-checker-webpack-plugin new feature!)</a></h2><div class="margin-vert--md"><time datetime="2019-07-13T00:00:00.000Z" class="blogPostDate_Ta7i">July 13, 2019  Â· 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>The <code>fork-ts-checker-webpack-plugin</code> has, since its inception, performed two classes of checking:</p><ol><li>Compilation errors which the TypeScript compiler surfaces up</li><li>Linting issues which TSLint reports</li></ol><p><a href="https://eslint.org/blog/2019/01/future-typescript-eslint" target="_blank" rel="noopener noreferrer">You may have caught the announcement that TSLint is being deprecated and ESLint is the future of linting in the TypeScript world.</a> This plainly has a bearing on linting in <code>fork-ts-checker-webpack-plugin</code>.</p><p><a href="https://github.com/TypeStrong/fork-ts-checker-webpack-plugin/pull/305" target="_blank" rel="noopener noreferrer">I&#x27;ve been beavering away at adding support for ESLint to the fork-ts-checker-webpack-plugin.</a> I&#x27;m happy to say, the plugin now supports ESLint. Do you want to get your arms all around ESLint with <code>fork-ts-checker-webpack-plugin</code>? Read on!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="how-do-you-migrate-from-tslint-to-eslint"></a>How do you migrate from TSLint to ESLint?<a class="hash-link" href="#how-do-you-migrate-from-tslint-to-eslint" title="Direct link to heading">#</a></h2><p>Well, first of all you need the latest and greatest <code>fork-ts-checker-webpack-plugin</code>. Support for ESLint shipped with <a href="https://github.com/TypeStrong/fork-ts-checker-webpack-plugin/releases/tag/v1.4.0" target="_blank" rel="noopener noreferrer">v1.4.0</a>.</p><p>You need to change the options you supply to the plugin in your <code>webpack.config.js</code> to look something like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">ForkTsCheckerWebpackPlugin</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> eslint</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>You&#x27;ll also need the various ESLint related packages to your <code>package.json</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">yarn add eslint @typescript</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">eslint</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">parser @typescript</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">eslint</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">eslint</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">plugin </span><span class="token operator" style="color:rgb(137, 221, 255)">--</span><span class="token plain">dev</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ul><li><code>eslint</code></li><li><code>@typescript-eslint/parser</code>: The parser that will allow ESLint to lint TypeScript code</li><li><code>@typescript-eslint/eslint-plugin</code>: A plugin that contains ESLint rules that are TypeScript specific</li></ul><p>If you want, you can pass options to ESLint using the <code>eslintOptions</code> option as well. These will be passed through to the underlying ESLint CLI Engine when it is instantiated. Docs on the supported options are <a href="https://eslint.org/docs/developer-guide/nodejs-api#cliengine" target="_blank" rel="noopener noreferrer">documented here</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="go-configure"></a>Go Configure<a class="hash-link" href="#go-configure" title="Direct link to heading">#</a></h2><p>Now you&#x27;re ready to use ESLint, you just need to give it some configuration. Typically, an <code>.eslintrc.js</code> is what you want here.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> path </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">require</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;path&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">module</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    parser</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;@typescript-eslint/parser&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Specifies the ESLint parser</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    plugins</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;@typescript-eslint&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    env</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        browser</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        jest</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">extends</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;plugin:@typescript-eslint/recommended&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Uses the recommended rules from the @typescript-eslint/eslint-plugin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    parserOptions</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        project</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">resolve</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">__dirname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;./tsconfig.json&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        tsconfigRootDir</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> __dirname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ecmaVersion</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2018</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Allows for the parsing of modern ECMAScript features</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sourceType</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;module&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Allows for the use of imports</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    rules</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Place to specify ESLint rules. Can be used to overwrite rules specified from the extended configs</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// e.g. &quot;@typescript-eslint/explicit-function-return-type&quot;: &quot;off&quot;,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;@typescript-eslint/explicit-function-return-type&#x27;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;off&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;@typescript-eslint/no-unused-vars&#x27;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;off&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If you&#x27;re a React person (and I am!) then you&#x27;ll also need: <code>yarn add eslint-plugin-react</code>. Then enrich your <code>eslintrc.js</code> a little:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> path </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">require</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;path&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">module</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    parser</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;@typescript-eslint/parser&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Specifies the ESLint parser</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    plugins</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;@typescript-eslint&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;react&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// &#x27;prettier&#x27; commented as we don&#x27;t want to run prettier through eslint because performance</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    env</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        browser</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        jest</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">extends</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;plugin:@typescript-eslint/recommended&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Uses the recommended rules from the @typescript-eslint/eslint-plugin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;prettier/@typescript-eslint&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Uses eslint-config-prettier to disable ESLint rules from @typescript-eslint/eslint-plugin that would conflict with prettier</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// &#x27;plugin:react/recommended&#x27;, // Uses the recommended rules from @eslint-plugin-react</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;prettier/react&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// disables react-specific linting rules that conflict with prettier</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// &#x27;plugin:prettier/recommended&#x27; // Enables eslint-plugin-prettier and displays prettier errors as ESLint errors. Make sure this is always the last configuration in the extends array.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    parserOptions</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        project</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">resolve</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">__dirname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;./tsconfig.json&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        tsconfigRootDir</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> __dirname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ecmaVersion</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2018</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Allows for the parsing of modern ECMAScript features</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sourceType</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;module&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Allows for the use of imports</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ecmaFeatures</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            jsx</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Allows for the parsing of JSX</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    rules</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Place to specify ESLint rules. Can be used to overwrite rules specified from the extended configs</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// e.g. &quot;@typescript-eslint/explicit-function-return-type&quot;: &quot;off&quot;,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;@typescript-eslint/explicit-function-return-type&#x27;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;off&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;@typescript-eslint/no-unused-vars&#x27;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;off&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// These rules don&#x27;t add much value, are better covered by TypeScript and good definition files</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;react/no-direct-mutation-state&#x27;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;off&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;react/no-deprecated&#x27;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;off&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;react/no-string-refs&#x27;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;off&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;react/require-render-return&#x27;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;off&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;react/jsx-filename-extension&#x27;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;warn&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                extensions</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;.jsx&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;.tsx&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// also want to use with &quot;.tsx&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;react/prop-types&#x27;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;off&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Is this incompatible with TS props type?</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    settings</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        react</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            version</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;detect&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Tells eslint-plugin-react to automatically detect the version of React to use</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>You can add Prettier into the mix too. You can see how it is used in the above code sample. But given the impact that has on performance I wouldn&#x27;t recommend it; hence it&#x27;s commented out. <a href="https://dev.to/robertcoopercode/using-eslint-and-prettier-in-a-typescript-project-53jb" target="_blank" rel="noopener noreferrer">There&#x27;s a good piece by Rob Cooper&#x27;s for more details on setting up Prettier and VS Code with TypeScript and ESLint.</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="performance-and-power-tools"></a>Performance and Power Tools<a class="hash-link" href="#performance-and-power-tools" title="Direct link to heading">#</a></h2><p>It&#x27;s worth noting that support for TypeScript in ESLint is still brand new. As such, the rule of &quot;Make it Work, Make it Right, Make it Fast&quot; applies.... ESLint with TypeScript still has some performance issues which should be ironed out in the fullness of time. You can <a href="https://github.com/typescript-eslint/typescript-eslint/issues/389" target="_blank" rel="noopener noreferrer">track them here</a>.</p><p>This is important to bear in mind as, when I converted a large codebase over to using ESLint, I discovered that initial performance of linting was terribly slow. Something that&#x27;s worth doing right now is identifying which rules are costing you most timewise and tweaking based on whether you think they&#x27;re earning their keep.</p><p>The <a href="https://eslint.org/docs/developer-guide/working-with-rules#per-rule-performance" target="_blank" rel="noopener noreferrer"><code>TIMING</code> environment variable</a> can be used to provide a report on the relative cost performance wise of running each rule. A nice way to plug this into your workflow is to add the <code>cross-env</code> package to your project: <code>yarn add cross-env -D</code> and then add 2 scripts to your <code>package.json</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;lint&quot;: &quot;eslint ./&quot;, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;lint-rule-timings&quot;: &quot;cross-env TIMING=1 yarn lint&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ul><li><code>lint</code> - just runs the linter standalone</li><li><code>lint-rule-timings</code> - does the same but with the <code>TIMING</code> environment variable set to 1 so a report will be generated.</li></ul><p>I&#x27;d advise, making use of <code>lint-rule-timings</code> to identify which rules are costing you performance and then turning <code>off</code> rules as you need to. Remember, different rules have different value.</p><p><a href="https://github.com/TypeStrong/ts-loader/pull/960" target="_blank" rel="noopener noreferrer">Finally, if you&#x27;d like to see how it&#x27;s done, here&#x27;s an example of porting from TSLint to ESLint.</a></p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/es-lint">ESLint</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/type-script">TypeScript</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/fork-ts-checker-webpack-plugin">fork-ts-checker-webpack-plugin</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/webpack">Webpack</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2019/06/07/typescript-webpack-you-down-with-pnp">TypeScript / webpack - you down with PnP? Yarn, you know me!</a></h2><div class="margin-vert--md"><time datetime="2019-06-07T00:00:00.000Z" class="blogPostDate_Ta7i">June 7, 2019  Â· 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>Yarn PnP is an innovation by the Yarn team designed to speed up module resolution by node. To quote the <a href="https://yarnpkg.com/en/docs/pnp" target="_blank" rel="noopener noreferrer">(excellent) docs</a>:</p><blockquote><p>Plugâ€™nâ€™Play is an alternative installation strategy unveiled in September 2018...</p><p>The way regular installs work is simple: Yarn generates a <code>node_modules</code> directory that Node is then able to consume. In this context, Node doesnâ€™t know the first thing about what a package is: it only reasons in terms of files. â€œDoes this file exist here? No? Letâ€™s look in the parent <code>node_modules</code> then. Does it exist here? Still no? Too badâ€¦ parent folder it is!â€ - and it does this until it matches something that matches one of the possibilities. Thatâ€™s vastly inefficient.</p><p>When you think about it, Yarn knows everything about your dependency tree - it evens installs it! So why is Node tasked with locating your packages on the disk? Why donâ€™t we simply query Yarn, and let it tell us where to look for a package X required by a package Y? Thatâ€™s what Plugâ€™nâ€™Play (abbreviated PnP) is. Instead of generating a node_modules directory and leaving the resolution to Node, we now generate a single .pnp.js file and let Yarn tell us where to find our packages.</p></blockquote><p>Yarn has been worked upon, amongst others, by the excellent <a href="https://twitter.com/arcanis" target="_blank" rel="noopener noreferrer">MaÃ«l Nison</a>. You can hear him talking about it in person <a href="https://youtu.be/XePfzVs852s" target="_blank" rel="noopener noreferrer">in this talk at JSConfEU</a>.</p><p>Thanks particularly to MaÃ«l&#x27;s work, it&#x27;s possible to use Yarn PnP with TypeScript using webpack with <code>ts-loader</code> <em>and</em><code>fork-ts-checker-webpack-plugin</code>. This post intends to show you just how simple it is to convert a project that uses either to work with Yarn PnP.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="vanilla-ts-loader"></a>Vanilla <code>ts-loader</code><a class="hash-link" href="#vanilla-ts-loader" title="Direct link to heading">#</a></h2><p>Your project is built using standalone <code>ts-loader</code>; i.e. a simple setup that handles both transpilation and type checking.</p><p>First things first, add this property to your <code>package.json</code>: (this is only required if you are using Yarn 1; this tag will be optional starting from the v2, where projects will switch to PnP by default.)</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;installConfig&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;pnp&quot;: true </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Also, because this is webpack, we&#x27;re going to need to add an extra dependency in the form of <code>pnp-webpack-plugin</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">yarn add -D pnp-webpack-plugin</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>To quote the excellent docs, make the following amends to your <code>webpack.config.js</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">const PnpWebpackPlugin = require(`pnp-webpack-plugin`);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">module.exports = { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    module: { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        rules: [{ </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            test: /\.ts$/, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            loader: require.resolve(&#x27;ts-loader&#x27;), </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            options: PnpWebpackPlugin.tsLoaderOptions(), </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }], </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    resolve: { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        plugins: [ PnpWebpackPlugin, ], </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    resolveLoader: { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        plugins: [ PnpWebpackPlugin.moduleLoader(module), ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If you have any options you want to pass to <code>ts-loader</code>, just pass them as parameter of <code>pnp-webpack-plugin</code>&#x27;s <code>tsLoaderOptions</code> function and it will take care of forwarding them properly. Behind the scenes the <code>tsLoaderOptions</code> function is providing <code>ts-loader</code> with the options necessary to switch into Yarn PnP mode.</p><p>Congratulations; you now have <code>ts-loader</code> functioning with Yarn PnP support!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="fork-ts-checker-webpack-plugin-with-ts-loader"></a><code>fork-ts-checker-webpack-plugin</code> with <code>ts-loader</code><a class="hash-link" href="#fork-ts-checker-webpack-plugin-with-ts-loader" title="Direct link to heading">#</a></h2><p>You may well be using <code>fork-ts-checker-webpack-plugin</code> to handle type checking whilst <code>ts-loader</code> gets on with the transpilation. This workflow is also supported using <code>pnp-webpack-plugin</code>. You&#x27;ll have needed to follow the same steps as the <code>ts-loader</code> setup. It&#x27;s just the <code>webpack.config.js</code> tweaks that will be different.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">const PnpWebpackPlugin = require(`pnp-webpack-plugin`);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">module.exports = { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    plugins: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new ForkTsCheckerWebpackPlugin(PnpWebpackPlugin.forkTsCheckerOptions({</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            useTypescriptIncrementalApi: false, // not possible to use this until: https://github.com/microsoft/TypeScript/issues/31056</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        })),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    module: { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        rules: [{ </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            test: /\.ts$/, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            loader: require.resolve(&#x27;ts-loader&#x27;), </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            options: PnpWebpackPlugin.tsLoaderOptions({ transpileOnly: true }), </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }], </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    resolve: { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        plugins: [ PnpWebpackPlugin, ], </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    resolveLoader: { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        plugins: [ PnpWebpackPlugin.moduleLoader(module), ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Again if you have any options you want to pass to <code>ts-loader</code>, just pass them as parameter of <code>pnp-webpack-plugin</code>&#x27;s <code>tsLoaderOptions</code> function. As we&#x27;re using <code>fork-ts-checker-webpack-plugin</code> we&#x27;re going to want to stop <code>ts-loader</code> doing type checking with the <code>transpileOnly: true</code> option.</p><p>We&#x27;re now initialising <code>fork-ts-checker-webpack-plugin</code> with <code>pnp-webpack-plugin</code>&#x27;s <code>forkTsCheckerOptions</code> function. Behind the scenes the <code>forkTsCheckerOptions</code> function is providing the <code>fork-ts-checker-webpack-plugin</code> with the options necessary to switch into Yarn PnP mode.</p><p>And that&#x27;s it! You now have <code>ts-loader</code> and <code>fork-ts-checker-webpack-plugin</code> functioning with Yarn PnP support!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="living-on-the-bleeding-edge"></a>Living on the Bleeding Edge<a class="hash-link" href="#living-on-the-bleeding-edge" title="Direct link to heading">#</a></h2><p>Whilst you can happily develop and build using Yarn PnP, it&#x27;s worth bearing in mind that this is a new approach. As such, there&#x27;s some rough edges right now.</p><p>If you&#x27;re interested in Yarn PnP, it&#x27;s worth taking the v2 of Yarn (Berry) for a spin. You can find it here: <a href="https://github.com/yarnpkg/berry" target="_blank" rel="noopener noreferrer">https://github.com/yarnpkg/berry</a>. It&#x27;s where most of the Yarn PnP work happens, and it includes zip loading - two birds, one stone!</p><p>Because there isn&#x27;t first class support for Yarn PnP in TypeScript itself yet, you cannot make use of the Watch API through <code>fork-ts-checker-webpack-plugin</code>. (You can read about that issue <a href="https://github.com/microsoft/TypeScript/issues/31056" target="_blank" rel="noopener noreferrer">here</a>)</p><p>As you&#x27;ve likely noticed, the webpack configuration required makes for a noisy <code>webpack.config.js</code>. Further to that, VS Code (which is powered by TypeScript remember) has no support for Yarn PnP yet and so will present resolution errors to you. If you can ignore the sea of red squigglies all over your source files in the editor and just look at your webpack build you&#x27;ll be fine.</p><p>There is a tool called <code>PnPify</code> that adds support for PnP to TypeScript (in particular tsc). You can find more information here: <a href="https://yarnpkg.github.io/berry/advanced/pnpify" target="_blank" rel="noopener noreferrer">https://yarnpkg.github.io/berry/advanced/pnpify</a>. For tsc it would be:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$&gt; yarn pnpify tsc [...]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The gist is that it simulates the existence of <code>node_modules</code> by leveraging the data from the PnP file. As such it&#x27;s not a perfect fix (<code>pnp-webpack-plugin</code> is a better integration), but it&#x27;s a very useful tool to have to unblock yourself when using a project that doesn&#x27;t support it.</p><p>PnPify actually allows us to use TypeScript in VSCode with PnP! Its documentation is here: <a href="https://yarnpkg.github.io/berry/advanced/pnpify#vscode-support" target="_blank" rel="noopener noreferrer">https://yarnpkg.github.io/berry/advanced/pnpify#vscode-support</a></p><p>All of these hindrances should hopefully be resolved in future. Ideally, one day a good developer experience can be the default experience. In the meantime, you can still dev - just be prepared for the rough edges. Here&#x27;s some useful resources to track the future of support:</p><ul><li>You can follow more on built in webpack support here: <a href="https://github.com/webpack/enhanced-resolve/issues/162" target="_blank" rel="noopener noreferrer">https://github.com/webpack/enhanced-resolve/issues/162</a></li><li>And on built in TypeScript support here: <a href="https://github.com/Microsoft/TypeScript/issues/18896" target="_blank" rel="noopener noreferrer">https://github.com/Microsoft/TypeScript/issues/18896</a></li><li>Finally, there it&#x27;s worth watching the <a href="https://github.com/nodejs/modules" target="_blank" rel="noopener noreferrer">nodejs/module</a> repository, which debates amongst other things how to properly integrate loaders with Node.</li></ul><p>This last one would be nice because:</p><ul><li>We&#x27;d stop having to patch require</li><li>We probably wouldn&#x27;t have to use yarn node if Node itself was able to find the loader somehow (such as if it was listed in the package.json metadata)</li></ul><p>Thanks to MaÃ«l for his tireless work on Yarn. To my mind MaÃ«l is certainly a candidate for the hardest worker in open source. I&#x27;ve been shamelessly borrowing his excellent docs for this post - thanks for writing so excellently MaÃ«l!</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/type-script">TypeScript</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/yarn">yarn</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/webpack">Webpack</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/pn-p">PnP</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2019/05/23/typescript-and-high-cpu-usage-watch">TypeScript and high CPU usage - watch don&#x27;t stare!</a></h2><div class="margin-vert--md"><time datetime="2019-05-23T00:00:00.000Z" class="blogPostDate_Ta7i">May 23, 2019  Â· 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>I&#x27;m one of the maintainers of the <a href="https://github.com/Realytics/fork-ts-checker-webpack-plugin" target="_blank" rel="noopener noreferrer">fork-ts-checker-webpack-plugin</a>. Hi there!</p><p>Recently, various issues have been raised against create-react-app (which uses fork-ts-checker-webpack-plugin) as well as against the plugin itself. They&#x27;ve been related to the level of CPU usage in watch mode on idle; i.e. it&#x27;s high!</p><ul><li><a href="https://github.com/Realytics/fork-ts-checker-webpack-plugin/issues/236" target="_blank" rel="noopener noreferrer">https://github.com/Realytics/fork-ts-checker-webpack-plugin/issues/236</a></li><li><a href="https://github.com/facebook/create-react-app/issues/6792" target="_blank" rel="noopener noreferrer">https://github.com/facebook/create-react-app/issues/6792</a></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="why-high"></a>Why High?<a class="hash-link" href="#why-high" title="Direct link to heading">#</a></h2><p>Now, under the covers, the <code>fork-ts-checker-webpack-plugin</code> uses the TypeScript watch API.</p><p>The marvellous <a href="https://github.com/NeKJ" target="_blank" rel="noopener noreferrer">John</a> (not me - another John) did some digging and discovered the root cause came down to the way that the TypeScript watch API watches files:</p><blockquote><p>TS uses internally the <code>fs.watch</code> and <code>fs.watchFile</code> API functions of nodejs for their watch mode. The latter function <a href="https://nodejs.org/api/fs.html#fs_fs_watchfile_filename_options_listener" target="_blank" rel="noopener noreferrer">is even not recommended by nodejs documentation</a> for performance reasons, and urges to use <code>fs.watch</code> instead.</p><p> <strong>NodeJS doc:</strong></p><blockquote><p>Using fs.watch() is more efficient than fs.watchFile and fs.unwatchFile. fs.watch should be used instead of fs.watchFile and fs.unwatchFile when possible.</p></blockquote></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="there-is-another"></a>&quot;there is another&quot;<a class="hash-link" href="#there-is-another" title="Direct link to heading">#</a></h2><p>John also found that there are other file watching behaviours offered by TypeScript. What&#x27;s more, the file watching behaviour is <em>configurable with an environment variable</em>. That&#x27;s right, if an environment variable called <code>TSC_WATCHFILE</code> is set, it controls the file watching approach used. Big news!</p><p>John did some rough benchmarking of the performance of the different options that be set on his PC running linux 64 bit. Here&#x27;s how it came out:</p><table><thead><tr><th>Value</th><th>CPU usage on idle</th></tr></thead><tbody><tr><td>TS default <em>(TSC_WATCHFILE not set)</em></td><td><strong>7.4%</strong></td></tr><tr><td>UseFsEventsWithFallbackDynamicPolling</td><td>0.2%</td></tr><tr><td>UseFsEventsOnParentDirectory</td><td>0.2%</td></tr><tr><td>PriorityPollingInterval</td><td><strong>6.2%</strong></td></tr><tr><td>DynamicPriorityPolling</td><td>0.5%</td></tr><tr><td>UseFsEvents</td><td>0.2%</td></tr></tbody></table><p>As you can see, the default performs poorly. On the other hand, an option like <code>UseFsEventsWithFallbackDynamicPolling</code> is comparative greasy lightning.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="workaround"></a>workaround!<a class="hash-link" href="#workaround" title="Direct link to heading">#</a></h2><p>To get this better experience into your world now, you could just set an environment variable on your machine. However, that doesn&#x27;t scale; let&#x27;s instead look at introducing the environment variable into your project explicitly.</p><p>We&#x27;re going to do this in a cross platform way using <code>&lt;a href=&quot;https://github.com/kentcdodds/cross-env&quot;&gt;cross-env&lt;/a&gt;</code>. This is a mighty useful utility by Kent C Dodds which allows you to set environment variables in a way that will work on Windows, Mac and Linux. Imagine it as the jQuery of the environment variables world :-)</p><p>Let&#x27;s add it as a <code>devDependency</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">yarn add -D cross-env</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Then take a look at your <code>package.json</code>. You&#x27;ve probably got a <code>start</code> script that looks something like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;start&quot;: &quot;webpack-dev-server --progress --color --mode development --config webpack.config.development.js&quot;,</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Or if you&#x27;re a create-react-app user maybe this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;start&quot;: &quot;react-scripts start&quot;,</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Prefix your <code>start</code> script with <code>cross-env TSC_WATCHFILE=UseFsEventsWithFallbackDynamicPolling</code>. This will, when run, initialise an environment variable called <code>TSC_WATCHFILE</code> with the value <code>UseFsEventsWithFallbackDynamicPolling</code>. Then it will start your development server as it did before. When TypeScript is fired up by webpack it will see this environment variable and use it to configure the file watching behaviour to one of the more performant options.</p><p>So, in the case of a <code>create-react-app</code> user, your finished <code>start</code> script would look like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;start&quot;: &quot;cross-env TSC_WATCHFILE=UseFsEventsWithFallbackDynamicPolling react-scripts start&quot;,</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-future"></a>The Future<a class="hash-link" href="#the-future" title="Direct link to heading">#</a></h2><p>There&#x27;s a possibility that the default watch behaviour may change in TypeScript in future. It&#x27;s currently under discussion, you can read more <a href="https://github.com/microsoft/TypeScript/issues/31048" target="_blank" rel="noopener noreferrer">here</a>.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/cross-env">cross-env</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/type-script">TypeScript</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/fork-ts-checker-webpack-plugin">fork-ts-checker-webpack-plugin</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/watch-api">watch API</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/webpack">Webpack</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2019/04/27/react-select-with-less-typing-lag">react-select with less typing lag</a></h2><div class="margin-vert--md"><time datetime="2019-04-27T00:00:00.000Z" class="blogPostDate_Ta7i">April 27, 2019  Â· 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>This is going out to all those people using <a href="https://react-select.com" target="_blank" rel="noopener noreferrer"><code>react-select</code></a> with 1000+ items to render. To those people typing into the select and saying out loud &quot;it&#x27;s <em>so</em> laggy.... This can&#x27;t be... It&#x27;s 2019... I mean, right?&quot; To the people who read this <a href="https://github.com/JedWatson/react-select/issues/3128" target="_blank" rel="noopener noreferrer">GitHub issue</a> top to bottom 30 times and still came back unsure of what to do. This is for you.</p><p>I&#x27;m lying. Mostly this goes out to me. I have a select box. I need it to render 2000+ items. I want it to be lovely. I want my users to be delighted as they use it. I want them to type in and (<em>this is the crucial part!</em>) for the control to feel responsive. Not laggy. Not like each keypress is going to Jupiter and back before it renders to the screen.</p><p>Amongst the various gems on the GitHub issue are shared CodeSandboxes illustrating ways to integrate react-select with react-window. That&#x27;s great and they do improve things. However, they don&#x27;t do much to improve the laggy typing feel. There&#x27;s <a href="https://github.com/JedWatson/react-select/issues/3128#issuecomment-431397942" target="_blank" rel="noopener noreferrer">brief mention</a> of a props tweak you can make to react-select; this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">filterOption</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token function" style="color:rgb(130, 170, 255)">createFilter</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> ignoreAccents</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>What does this do? Well, this improves the typing lag experience <em>massively</em>. For why? Well, <a href="https://github.com/JedWatson/react-select/blob/292bad3298f2cafad6767f2134bd79a9c27e4073/src/filters.js#L21" target="_blank" rel="noopener noreferrer">if you look at the code</a> you find that the default value is <code>ignoreAccents: true</code>. This default makes react-select invoke an expensive (and scary sounding) function called <a href="https://github.com/JedWatson/react-select/blob/292bad3298f2cafad6767f2134bd79a9c27e4073/src/diacritics.js#L90" target="_blank" rel="noopener noreferrer"><code>stripDiacritics</code></a>. Not once but twice. Ouchy. And this kills performance.</p><p>But if you&#x27;re okay with accents not being ignored (and <em>spoiler</em>: I am) then this is the option for you.</p><p>Here&#x27;s a CodeSandbox which also includes the <code>ignoreAccents: false</code> tweak. Enjoy!</p><p><a href="https://codesandbox.io/s/zn70lqp31m?fontsize=14" target="_blank" rel="noopener noreferrer"><img src="https://codesandbox.io/static/img/play-codesandbox.svg" alt="Edit johnnyreilly/react-window-with-react-select-less-laggy"></a></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword module" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">React</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Component</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword module" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;react&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword module" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">ReactDOM</span><span class="token plain"> </span><span class="token keyword module" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;react-dom&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword module" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Select</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> createFilter </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword module" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;react-select&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword module" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">FixedSizeList</span><span class="token imports"> </span><span class="token imports keyword module" style="font-style:italic">as</span><span class="token imports"> </span><span class="token imports maybe-class-name">List</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword module" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;react-window&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword module" style="font-style:italic">import</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;./styles.css&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> options </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword control-flow" style="font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">let</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2500</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">push</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> value</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> label</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token template-string string" style="color:rgb(195, 232, 141)">Option </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">${</span><span class="token template-string interpolation">i</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> height </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">35</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">MenuList</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">extends</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Component</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">render</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> children</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> maxHeight</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> getValue </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">getValue</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> initialOffset </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">indexOf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> height</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword control-flow" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token maybe-class-name">List</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        height</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">maxHeight</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        itemCount</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">children</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        itemSize</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">height</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        initialScrollOffset</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">initialOffset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token parameter"> index</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> style </span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">div style</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">style</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">children</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">div</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token maybe-class-name">List</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token function-variable function maybe-class-name" style="color:rgb(130, 170, 255)">App</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token maybe-class-name">Select</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    filterOption</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token function" style="color:rgb(130, 170, 255)">createFilter</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> ignoreAccents</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// this makes all the difference!</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    components</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token maybe-class-name">MenuList</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    options</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token maybe-class-name">ReactDOM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">render</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token dom variable" style="color:rgb(191, 199, 213)">document</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">getElementById</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;root&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/large-lists">large lists</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/react-select">react-select</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/typing">typing</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2019/03/24/template-tricks-for-dainty-dom">Template Tricks for a Dainty DOM</a></h2><div class="margin-vert--md"><time datetime="2019-03-24T00:00:00.000Z" class="blogPostDate_Ta7i">March 24, 2019  Â· 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>I&#x27;m somewhat into code golf. Placing restrictions on what you&#x27;re &quot;allowed&quot; to do in code and seeing what the happens as a result. I&#x27;d like to share with you something that came out of some recent dabblings.</p><p>Typically I spend a good amount of time playing with TypeScript. Either working on build tools or making web apps with it. (Usually with a portion of React on the side.) This is something different.</p><p>I have a side project on the go which is essentially a mini analytics dashboard. For the purposes of this piece let&#x27;s call it &quot;StatsDash&quot;. When I was starting it I thought: let&#x27;s try something different. Let&#x27;s build StatsDash with HTML <em>only</em>. The actual HTML is hand cranked by me and generated in ASP.Net Core / C# using a combination of LINQ and string interpolation. (Who needs Razor? ðŸ˜Ž) I&#x27;ll say it&#x27;s pretty fun - but the back end is not what I want to focus on.</p><p>I got something up and running pretty quickly in pure HTML. The first lesson I learned was this: HTML alone is hella ugly. So I relaxed my criteria; I allowed CSS to come play as long as I didn&#x27;t have to write any / much myself. There followed some experimentation with different CSS frameworks. For a while I rolled with Bootstrap (old school!), then Bulma and finally I settled on <a href="https://materializecss.com/" target="_blank" rel="noopener noreferrer">Materialized</a>. Materialized is a heavily inspired by Google&#x27;s Material Design and is hence quite beautiful. With my HTML and Materialize&#x27;s CSS we were rolling. Beautiful stats - no JS.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="oh-all-right-just-a-splash"></a>&quot;Oh All Right; Just a Splash&quot;<a class="hash-link" href="#oh-all-right-just-a-splash" title="Direct link to heading">#</a></h2><p>Lovely as things were, StatsDash quickly got to the point where there was too much information on the screen. It was time to make some changes. If data is to convey a message, it must first be comprehensible.</p><p>I needed a way to hide and show data as people interacted with StatsDash. I wanted to achieve this <em>without</em> starting to render on the client side and also without going back to the server each time.</p><p>If you want interactions in your UI all roads lead to JS. It&#x27;s certainly possible to do some tricks with CSS but that&#x27;s a round of code golf I&#x27;m ill equipped to play. So, I took a look at what Materialized had to offer. Usefully it has a <a href="https://materializecss.com/modals.html" target="_blank" rel="noopener noreferrer">Modal</a> component. With that in play I&#x27;d be able to separate the detailed information into different modals which the users could show and hide as required. Perfect!</p><p>It required a little JS. What&#x27;s a line or two between friends? Dear reader, I compromised once more.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-dom-bunker"></a>The DOM Bunker<a class="hash-link" href="#the-dom-bunker" title="Direct link to heading">#</a></h2><p>With my handy modals, StatsDash was now a one stop shop for a great deal of information. Info which took the form of DOM nodes. Lots of them. And by &quot;lots of them&quot; I want you to think along the lines of &quot;space is big, really big...&quot;.</p><p>This was impacting users. Clicking to open a modal resulted in a noticeable lag. It would take 2+ seconds for the browser to respond. Users found themselves clicking multiple times; wondering why nothing seemed to occur. In the end the modal would shuffle into view. However, this wasn&#x27;t the best experience. The lack of responsiveness was getting in the way of users enjoying all StatsDash had to offer.</p><p>Running an audit of StatsDash in Chrome DevTools there was no doubt we had a DOM problem:</p><p> <a href="https://1.bp.blogspot.com/-lrVKXxqAtmU/XJdHE509SCI/AAAAAAAAOhU/vxVhqlOMtFMbdm_HDpNkSW55B73Wxm86ACPcBGAYYCw/s1600/DOM-massive.png" target="_blank" rel="noopener noreferrer">![null](&lt;https://1.bp.blogspot.com/-lrVKXxqAtmU/XJdHE509SCI/AAAAAAAAOhU/vxVhqlOMtFMbdm_HDpNkSW55B73Wxm86ACPcBGAYYCw/s640/DOM-massive.png&gt; =640x298)</a>What to do? I still didn&#x27;t want to go back to the server on each click in StatsDash. And I didn&#x27;t want to start writing rendering code on the client as well either. I have in the past mixed client and server side rendering and I know well that it&#x27;s a first class ticket to a confusing codebase.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="smuggling-dom-in-templates"></a>Smuggling DOM in Templates<a class="hash-link" href="#smuggling-dom-in-templates" title="Direct link to heading">#</a></h2><p>There&#x27;s a mechanism that supports this use case directly: the <code>&amp;lt;template&amp;gt;</code> element. <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/template" target="_blank" rel="noopener noreferrer">To quote MDN</a>:</p><blockquote><p>The HTML Content Template (<code>&amp;lt;template&amp;gt;</code>) element is a mechanism for holding client-side content that is not to be rendered when a page is loaded but may subsequently be instantiated during runtime using JavaScript.</p></blockquote><blockquote><p>Think of a template as a content fragment that is being stored for subsequent use in the document.</p></blockquote><p>This is <em>exactly</em> what I&#x27;m after. I can keep my rendering server side, but instead wrap content that isn&#x27;t immediately visible to users inside a <code>&amp;lt;template&amp;gt;</code> element and render that only when users need it.</p><p>So in the case of my modals (where most of my DOM lives), I can tuck the contents of each modal into a <code>&amp;lt;template&amp;gt;</code> element. Then, when the user clicks to open a modal we move that template content into the DOM so they can see it. Likewise, as they close a modal we can clear out the modal&#x27;s DOM content to ease the load on the dear old browser.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="that-sounds-complicated"></a>&quot;That Sounds Complicated...&quot;<a class="hash-link" href="#that-sounds-complicated" title="Direct link to heading">#</a></h2><p>It&#x27;s not. Let me show you how easily this is accomplished. First of all, wrap all your modal contents into <code>&amp;lt;template&amp;gt;</code> elements. They should look a little something like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-html codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">div</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">button</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">data-target</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">modalId</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">class</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">btn modal-trigger</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">Open the Modal!</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">button</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">template</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">&lt;!--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">        loads of DOM nodes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">        --&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">template</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">div</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">id</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">modalId</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">class</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">modal modal-fixed-footer</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">div</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">div</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Next, where you initialise your modals you need to make a little tweak:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-js codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token dom variable" style="color:rgb(191, 199, 213)">document</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">addEventListener</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;DOMContentLoaded&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token constant" style="color:rgb(130, 170, 255)">M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">Modal</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">init</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token dom variable" style="color:rgb(191, 199, 213)">document</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">querySelectorAll</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;.modal&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">onOpenStart</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token parameter">modalDiv</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> template </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> modalDiv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">parentNode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">querySelector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;template&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            modalDiv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">appendChild</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token dom variable" style="color:rgb(191, 199, 213)">document</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">importNode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">template</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">content</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">onCloseEnd</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token parameter">modalDiv</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword control-flow" style="font-style:italic">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">modalDiv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">firstChild</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                modalDiv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">removeChild</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">modalDiv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">firstChild</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>That&#x27;s it! As you can see, before we open our modals, the <code>onOpenStart</code> callback will fire which creates the actual DOM elements based upon the <code>template</code>. And when the modals finish closing the <code>onCloseEnd</code> callback runs to remove those DOM elements once more.</p><p>For this minimal change, the client gets a dramatically different user experience. StatsDash went from super laggy to satisfyingly fast. Using <code>template</code>s, The number of initial DOM nodes dropped from more than <em>20,000</em> to <em>200</em>. That&#x27;s right ðŸ’¯ times smaller!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="do-it-yourself"></a>Do It Yourself<a class="hash-link" href="#do-it-yourself" title="Direct link to heading">#</a></h2><p>The code examples above rely upon the Materialize modals. However the principles used here are broadly applicable. It&#x27;s easy for you to take the approach outlined here and apply it in a different situation.</p><p>If you&#x27;re interested in some of the other exciting things you can do with templates then I recommend <a href="https://www.html5rocks.com/en/tutorials/webcomponents/template/" target="_blank" rel="noopener noreferrer">Eric Bidelman&#x27;s post on the topic</a>.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/dom">DOM</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/template">template</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/materialized">Materialized</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2019/03/22/google-analytics-api-and-aspnet-core">Google Analytics API and ASP.Net Core</a></h2><div class="margin-vert--md"><time datetime="2019-03-22T00:00:00.000Z" class="blogPostDate_Ta7i">March 22, 2019  Â· 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>Some of my posts are meaningful treaties on the nature of software development. Some are detailed explanations of approaches you can use. Some are effectively code dumps. This is one of those.</p><p>I recently had need to be able to access the API for Google Analytics from ASP.Net Core. Getting this up and running turned out to be surprisingly tough because of an absence of good examples. So here it is; an example of how you can access a simple page access stat using <a href="https://www.nuget.org/packages/Google.Apis.AnalyticsReporting.v4/" target="_blank" rel="noopener noreferrer">the API</a>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">async Task&lt;SomeKindOfDataStructure[]&gt; GetUsageFromGoogleAnalytics(DateTime startAtThisDate, DateTime endAtThisDate)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Create the DateRange object. Here we want data from last week.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var dateRange = new DateRange</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        StartDate = startAtThisDate.ToString(&quot;yyyy-MM-dd&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        EndDate = endAtThisDate.ToString(&quot;yyyy-MM-dd&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Create the Metrics and dimensions object.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // var metrics = new List&lt;Metric&gt; { new Metric { Expression = &quot;ga:sessions&quot;, Alias = &quot;Sessions&quot; } };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // var dimensions = new List&lt;Dimension&gt; { new Dimension { Name = &quot;ga:pageTitle&quot; } };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var metrics = new List&lt;Metric&gt; { new Metric { Expression = &quot;ga:uniquePageviews&quot; } };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var dimensions = new List&lt;Dimension&gt; { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new Dimension { Name = &quot;ga:date&quot; },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new Dimension { Name = &quot;ga:dimension1&quot; } </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Get required View Id from configuration</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var viewId = $&quot;ga:{&quot;[VIEWID]&quot;}&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Create the Request object.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var reportRequest = new ReportRequest</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        DateRanges = new List&lt;DateRange&gt; { dateRange },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Metrics = metrics,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Dimensions = dimensions,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        FiltersExpression = &quot;ga:pagePath==/index.html&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ViewId = viewId</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var getReportsRequest = new GetReportsRequest {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ReportRequests = new List&lt;ReportRequest&gt; { reportRequest }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    //Invoke Google Analytics API call and get report</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var analyticsService = GetAnalyticsReportingServiceInstance();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var response = await (analyticsService.Reports.BatchGet(getReportsRequest)).ExecuteAsync();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var logins = response.Reports[0].Data.Rows.Select(row =&gt; new SomeKindOfDataStructure {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Date = new DateTime(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            year: Convert.ToInt32(row.Dimensions[0].Substring(0, 4)), </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            month: Convert.ToInt32(row.Dimensions[0].Substring(4, 2)), </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            day: Convert.ToInt32(row.Dimensions[0].Substring(6, 2))),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        NumberOfLogins = Convert.ToInt32(row.Metrics[0].Values[0])</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .OrderByDescending(login =&gt; login.Date)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .ToArray();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return logins;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// Intializes and returns Analytics Reporting Service Instance</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">AnalyticsReportingService GetAnalyticsReportingServiceInstance() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var googleAuthFlow = new GoogleAuthorizationCodeFlow(new GoogleAuthorizationCodeFlow.Initializer {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ClientSecrets = new ClientSecrets {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ClientId = &quot;[CLIENTID]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ClientSecret = &quot;[CLIENTSECRET]&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var responseToken = new TokenResponse {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        AccessToken = &quot;[ANALYTICSTOKEN]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        RefreshToken = &quot;[REFRESHTOKEN]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Scope = AnalyticsReportingService.Scope.AnalyticsReadonly, //Read-only access to Google Analytics,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        TokenType = &quot;Bearer&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var credential = new UserCredential(googleAuthFlow, &quot;&quot;, responseToken);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Create the  Analytics service.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return new AnalyticsReportingService(new BaseClientService.Initializer {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpClientInitializer = credential,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ApplicationName = &quot;my-super-applicatio&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>You can see above that you need various credentials to be able to use the API. You can acquire these by logging into GA. Enjoy!</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/asp-net-core">asp net core</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/google-analytics">google analytics</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2019/03/06/the-big-one-point-oh">The Big One Point Oh</a></h2><div class="margin-vert--md"><time datetime="2019-03-06T00:00:00.000Z" class="blogPostDate_Ta7i">March 6, 2019  Â· 2 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p><a href="https://github.com/Realytics/fork-ts-checker-webpack-plugin/releases/tag/v1.0.0" target="_blank" rel="noopener noreferrer">It&#x27;s time for the first major version of <code>fork-ts-checker-webpack-plugin</code></a>. It&#x27;s been a long time coming :-)</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="a-little-history"></a>A Little History<a class="hash-link" href="#a-little-history" title="Direct link to heading">#</a></h2><p>The <code>fork-ts-checker-webpack-plugin</code> was originally the handiwork of <a href="https://github.com/piotr-oles" target="_blank" rel="noopener noreferrer">Piotr OleÅ›</a>. He raised an issue with <a href="https://github.com/TypeStrong/ts-loader/issues/537" target="_blank" rel="noopener noreferrer"><code>ts-loader</code></a> suggesting it could be the McCartney to <code>ts-loader</code>&#x27;s Lennon:</p><blockquote><p>Hi everyone!</p><p>I&#x27;ve created webpack plugin: <a href="https://github.com/Realytics/fork-ts-checker-webpack-plugin" target="_blank" rel="noopener noreferrer">fork-ts-checker-webpack-plugin</a> that plays nicely with <code>ts-loader</code>. The idea is to compile project with <code>transpileOnly: true</code> and check types on separate process (async). With this approach, webpack build is not blocked by type checker and we have semantic check with fast incremental build. More info on github repo :)</p><p>So if you like it and you think it would be good to add some info in README.md about this plugin, I would be greatful.</p><p>Thanks :)</p></blockquote><p>We did like it. We did think it would be good. We took him up on his kind offer.</p><p>Since that time many people have had their paws on the <code>fork-ts-checker-webpack-plugin</code> codebase. We love them all.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="one-point-oh"></a>One Point Oh<a class="hash-link" href="#one-point-oh" title="Direct link to heading">#</a></h2><p>We could have had our first major release a long time ago. The idea first occurred when webpack 5 alpha appeared. &quot;Huh, look at that, a major version number.... Maybe we should do that?&quot; &quot;<em>Great</em> idea chap - do it!&quot; So here it is; fresh out the box: v1.0.0</p><p>There are actually no breaking changes that we&#x27;re aware of; users of 0.x <code>fork-ts-checker-webpack-plugin</code> should be be able to upgrade without any drama.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="incremental-watch-api-on-by-default"></a>Incremental Watch API on by Default<a class="hash-link" href="#incremental-watch-api-on-by-default" title="Direct link to heading">#</a></h2><p>Users of TypeScript 3+ may notice a performance improvement as by default the plugin now uses the <a href="https://github.com/Microsoft/TypeScript/pull/20234" target="_blank" rel="noopener noreferrer">incremental watch API</a> in TypeScript.</p><p>Should this prove problematic you can opt out of using it by supplying <code>useTypescriptIncrementalApi: false</code>. We are aware of an <a href="https://github.com/Realytics/fork-ts-checker-webpack-plugin/issues/219" target="_blank" rel="noopener noreferrer">issue with Vue and the incremental API</a>. We hope it will be fixed soon - a generous member of the community is taking a look. In the meantime, we will <em>not</em> default to using the incremental watch API when in Vue mode.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="compatibility"></a>Compatibility<a class="hash-link" href="#compatibility" title="Direct link to heading">#</a></h2><p>As it stands, the plugin supports webpack 2, 3, 4 and 5 alpha. It is compatible with TypeScript 2.1+ and TSLint 4+.</p><p>Right that&#x27;s it - enjoy it! And thanks everyone for contributing - we really dig your help. Much love.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/type-script">TypeScript</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/fork-ts-checker-webpack-plugin">fork-ts-checker-webpack-plugin</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/ts-loader">ts-loader</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/tslint">tslint</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/1-0-0">1.0.0</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/webpack">Webpack</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2019/02/22/whitelist-proxying-with-aspnet-core">WhiteList Proxying with ASP.Net Core</a></h2><div class="margin-vert--md"><time datetime="2019-02-22T00:00:00.000Z" class="blogPostDate_Ta7i">February 22, 2019  Â· 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>Once upon a time there lived a young team who were building a product. They were ready to go live with their beta and so they set off on a journey to a mystical land they had heard tales of. This magical kingdom was called &quot;Production&quot;. However, Production was a land with walls and but one gate. That gate was jealously guarded by a defender named &quot;InfoSec&quot;. InfoSec was there to make sure that only the the right people, noble of thought and pure of deed were allowed into the promised land. InfoSec would ask questions like &quot;are you serving over HTTPS&quot; and &quot;what are you doing about cross site scripting&quot;?</p><p>The team felt they had good answers to InfoSec&#x27;s questions. However, just as they were about to step through the gate, InfoSec held up their hand and said &quot;your application wants to access a database... database access needs to take place on our own internal network. Not over the publicly accessible internet. You shall not pass.&quot;</p><p>The team, with one foot in the air, paused. They swallowed and said &quot;can you give us five minutes?&quot;</p><p> <a href="https://3.bp.blogspot.com/-tmH5nbo_kGY/XG-8jmokKdI/AAAAAAAAN_Q/1zzN3IfRtlopNC9HTRio6HdpVCeO5jMkwCPcBGAYYCw/s1600/hang-on-lads-ive-got-a-great-idea.jpg" target="_blank" rel="noopener noreferrer">![null](&lt;https://3.bp.blogspot.com/-tmH5nbo_kGY/XG-8jmokKdI/AAAAAAAAN_Q/1zzN3IfRtlopNC9HTRio6HdpVCeO5jMkwCPcBGAYYCw/s640/hang-on-lads-ive-got-a-great-idea.jpg&gt; =640x271)</a>## The Proxy Regroup</p><p>And so it came to pass that the teams product (which took the form of ASP.Net Core web application) had to be changed. Where once there had been a single application, there would now be two; one that lived on the internet (the <em>web</em> app) and one that lived on the companies private network (the <em>API</em> app). The API app would do all the database access. In fact the product team opted to move all significant operations into the API as well. This left the web app with two purposes:</p><ol><li>the straightforward serving of HTML, CSS, JS and images</li><li>the proxying of API calls through to the API app</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="proxy-part-1"></a>Proxy Part 1<a class="hash-link" href="#proxy-part-1" title="Direct link to heading">#</a></h2><p>In the early days of this proxying the team reached for <a href="https://github.com/twitchax/AspNetCore.Proxy" target="_blank" rel="noopener noreferrer"><code>AspNetCore.Proxy</code></a>. It&#x27;s a great open source project that allows you to proxy HTTP requests. It gives you complete control over the construction of proxy requests, so that you can have a request come into your API and end up proxying it to a URL with a completely different path on the proxy server.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="proxy-part-2"></a>Proxy Part 2<a class="hash-link" href="#proxy-part-2" title="Direct link to heading">#</a></h2><p>The approach offered by <code>AspNetCore.Proxy</code> is fantastically powerful in terms of control. However, we didn&#x27;t actually need that level of configurability. In fact, it resulted in us writing a great deal of boilerplate code. You see in our case we&#x27;d opted to proxy path for path, changing only the server name on each proxied request. So if a GET request came in going to <a href="https://web.app.com/api/version" target="_blank" rel="noopener noreferrer">https://web.app.com/api/version</a> then we would want to proxy it to a GET request to <a href="https://api.app.com/api/version" target="_blank" rel="noopener noreferrer">https://api.app.com/api/version</a>. You see? All we did was swap <a href="https://web.app.com" target="_blank" rel="noopener noreferrer">https://web.app.com</a> for <a href="https://api.app.com." target="_blank" rel="noopener noreferrer">https://api.app.com.</a> Nothing more. We did that as a rule. We knew we <em>always</em> wanted to do just this.</p><p>So we ended up spinning up our own solution which allowed just the specification of paths we wanted to proxy with their corresponding HTTP verbs. Let&#x27;s talk through it. Usage of our approach ended up as a middleware within our web app&#x27;s <code>Startup.cs</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public void Configure(IApplicationBuilder app) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseProxyWhiteList(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // where ServerToProxyToBaseUrl is the server you want requests to be proxied to</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                proxyAddressTweaker: (requestPath) =&gt; $&quot;{ServerToProxyToBaseUrl}{requestPath}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                whiteListProxyRoutes: new [] {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // An anonymous request</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    WhiteListProxy.AnonymousRoute(&quot;api/version&quot;, HttpMethod.Get),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // An authenticated request; to send this we must know who the user is</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    WhiteListProxy.Route(&quot;api/account/{accountId:int}/all-the-secret-info&quot;, HttpMethod.Get, HttpMethod.Post),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseMvc();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If you look at the code above you can see that we are proxing all our requests to a single server: <code>ServerToProxyToBaseUrl</code>. We&#x27;re proxying 2 different requests:</p><ol><li><code>GET</code> requests to <code>api/version</code> are proxied through as <em>anonymous</em><code>GET</code> requests.</li><li><code>GET</code> and <code>POST</code> requests to <code>api/account/{accountId:int}/all-the-secret-info</code> are proxied through as <code>GET</code> and <code>POST</code> requests. These requests require that a user be authenticated first.</li></ol><p>The <code>WhiteListProxy</code> proxy class we&#x27;ve been using looks like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Collections.Generic;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net.Http;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace My.Web.Proxy {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class WhiteListProxy {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public string Path { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public IEnumerable&lt;HttpMethod&gt; Methods { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public bool IsAnonymous { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private WhiteListProxy(string path, bool isAnonymous, params HttpMethod[] methods) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (methods == null || methods.Length == 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new ArgumentException($&quot;You need at least a single HttpMethod to be specified for {path}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Path = path;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            IsAnonymous = isAnonymous;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Methods = methods;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static WhiteListProxy Route(string path, params HttpMethod[] methods) =&gt; new WhiteListProxy(path, isAnonymous : false, methods: methods);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static WhiteListProxy AnonymousRoute(string path, params HttpMethod[] methods) =&gt; new WhiteListProxy(path, isAnonymous : true, methods: methods);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The middleware for proxying (our <code>UseProxyWhiteList</code>) looks like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Collections.Generic;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.ComponentModel;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Linq;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net.Http;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Reflection;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Threading.Tasks;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Authentication;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Builder;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Http;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Routing;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.DependencyModel;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Serilog;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace My.Web.Proxy {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static class ProxyRouteExtensions {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// Middleware which proxies the supplied whitelist routes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static void UseProxyWhiteList(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this IApplicationBuilder app,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Func&lt;string, string&gt; proxyAddressTweaker,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Action&lt;HttpContext, HttpRequestMessage&gt; preSendProxyRequestAction,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            IEnumerable&lt;WhiteListProxy&gt; whiteListProxyRoutes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseRouter(builder =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                foreach (var whiteListProxy in whiteListProxyRoutes) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    foreach (var method in whiteListProxy.Methods) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        builder.MapMiddlewareVerb(method.ToString(), whiteListProxy.Path, proxyApp =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            proxyApp.UseProxy_Challenge(whiteListProxy.IsAnonymous);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            proxyApp.UseProxy_Run(proxyAddressTweaker, preSendProxyRequestAction);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private static void UseProxy_Challenge(this IApplicationBuilder app, bool allowAnonymous) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.Use((context, next) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var routePath = context.Request.Path.Value;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var weAreAuthenticatedOrWeDontNeedToBe =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    context.User.Identity.IsAuthenticated || allowAnonymous;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (weAreAuthenticatedOrWeDontNeedToBe)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    return next();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return context.ChallengeAsync();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private static void UseProxy_Run(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this IApplicationBuilder app,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Func&lt;string, string&gt; proxyAddressTweaker,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Action&lt;HttpContext, HttpRequestMessage&gt; preSendProxyRequestAction</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.Run(async context =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var proxyAddress = &quot;&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    proxyAddress = proxyAddressTweaker(context.Request.Path.Value);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var proxyRequest = context.Request.CreateProxyHttpRequest(proxyAddress);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    if (preSendProxyRequestAction != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        preSendProxyRequestAction(context, proxyRequest);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var httpClients = context.RequestServices.GetService&lt;IHttpClients&gt;(); // IHttpClients is just a wrapper for HttpClient - insert your own here</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var proxyResponse = await httpClients.SendRequestAsync(proxyRequest,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            HttpCompletionOption.ResponseHeadersRead, context.RequestAborted)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        .ConfigureAwait(false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    await context.CopyProxyHttpResponse(proxyResponse).ConfigureAwait(false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                catch (OperationCanceledException ex) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    if (ex.CancellationToken.IsCancellationRequested)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        return;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    if (!context.Response.HasStarted)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        context.Response.StatusCode = 408;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        await context.Response</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .WriteAsync(&quot;Request timed out.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                catch (Exception e) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    if (!context.Response.HasStarted)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        context.Response.StatusCode = 500;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        await context.Response</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .WriteAsync(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                $&quot;Request could not be proxied.\n\n{e.Message}\n\n{e.StackTrace}.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static void AddOrReplaceHeader(this HttpRequestMessage request, string headerName, string headerValue) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // It&#x27;s possible for there to be multiple headers with the same name; we only want a single header to remain.  Our one.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            while (request.Headers.TryGetValues(headerName, out var existingAuthorizationHeader)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                request.Headers.Remove(headerName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            request.Headers.TryAddWithoutValidation(headerName, headerValue);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static HttpRequestMessage CreateProxyHttpRequest(this HttpRequest request, string uriString) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var uri = new Uri(uriString + request.QueryString);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var requestMessage = new HttpRequestMessage();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var requestMethod = request.Method;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (!HttpMethods.IsGet(requestMethod) &amp;&amp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                !HttpMethods.IsHead(requestMethod) &amp;&amp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                !HttpMethods.IsDelete(requestMethod) &amp;&amp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                !HttpMethods.IsTrace(requestMethod)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var streamContent = new StreamContent(request.Body);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                requestMessage.Content = streamContent;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Copy the request headers.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (requestMessage.Content != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                foreach (var header in request.Headers)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    if (!requestMessage.Headers.TryAddWithoutValidation(header.Key, header.Value.ToArray()))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        requestMessage.Content?.Headers.TryAddWithoutValidation(header.Key, header.Value.ToArray());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            requestMessage.Headers.Host = uri.Authority;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            requestMessage.RequestUri = uri;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            requestMessage.Method = new HttpMethod(request.Method);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return requestMessage;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static async Task CopyProxyHttpResponse(this HttpContext context, HttpResponseMessage responseMessage) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var response = context.Response;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            response.StatusCode = (int) responseMessage.StatusCode;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            foreach (var header in responseMessage.Headers) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                response.Headers[header.Key] = header.Value.ToArray();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (responseMessage.Content != null) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                foreach (var header in responseMessage.Content.Headers) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    response.Headers[header.Key] = header.Value.ToArray();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            response.Headers.Remove(&quot;transfer-encoding&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            using(var responseStream = await responseMessage.Content.ReadAsStreamAsync().ConfigureAwait(false)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                await responseStream.CopyToAsync(response.Body, 81920, context.RequestAborted).ConfigureAwait(false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/asp-net-core">asp net core</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/proxy">proxy</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/http-requests">http requests</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/whitelist">whitelist</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog.johnnyreilly.com/page/4"><div class="pagination-nav__label">Â« Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog.johnnyreilly.com/page/6"><div class="pagination-nav__label">Older Entries Â»</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/blog.johnnyreilly.com/styles.7c653e04.js"></script>
<script src="/blog.johnnyreilly.com/runtime~main.8fae10d8.js"></script>
<script src="/blog.johnnyreilly.com/main.aa01ada2.js"></script>
<script src="/blog.johnnyreilly.com/1.a2fa6ec1.js"></script>
<script src="/blog.johnnyreilly.com/2.541c8135.js"></script>
<script src="/blog.johnnyreilly.com/a6aa9e1f.8b47d5c4.js"></script>
<script src="/blog.johnnyreilly.com/c3b5bd8c.b5dc6e8e.js"></script>
<script src="/blog.johnnyreilly.com/0ffd0b88.504fd013.js"></script>
<script src="/blog.johnnyreilly.com/f7dab29d.1309c12e.js"></script>
<script src="/blog.johnnyreilly.com/0f9ea58f.7995d72e.js"></script>
<script src="/blog.johnnyreilly.com/1b063778.5c9d5981.js"></script>
<script src="/blog.johnnyreilly.com/d4086ce6.8bcf1997.js"></script>
<script src="/blog.johnnyreilly.com/2d328955.c7c8f5f4.js"></script>
<script src="/blog.johnnyreilly.com/e476ec94.0a39b9a3.js"></script>
<script src="/blog.johnnyreilly.com/6eb1980c.83bb52a5.js"></script>
<script src="/blog.johnnyreilly.com/20a3dccc.0c1693ce.js"></script>
<script src="/blog.johnnyreilly.com/357a35a7.2fbf7d37.js"></script>
<script src="/blog.johnnyreilly.com/8f3ed738.855e4d1b.js"></script>
</body>
</html>