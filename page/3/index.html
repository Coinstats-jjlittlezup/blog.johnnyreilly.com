<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog.johnnyreilly.com/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog.johnnyreilly.com/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed"><title data-react-helmet="true">Blog | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="Blog | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/blog.johnnyreilly.com/img/favicon.ico"><link rel="stylesheet" href="/blog.johnnyreilly.com/styles.a755cef0.css">
<link rel="preload" href="/blog.johnnyreilly.com/styles.acafb066.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/runtime~main.ff161662.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/main.c1c76de5.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/1.08786e85.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/2.4fd9db96.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/a6aa9e1f.917b34ca.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/c3b5bd8c.4fdda474.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/f3c1932d.32f51e9b.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/b3f58b0c.bfce6d1a.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/46a40735.fa9caee6.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/698cc75e.6c4a8a48.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/3e162f19.f6b719af.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/c987543e.81e88e8a.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/a764018b.fa45b12a.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/f5746e63.077f7df3.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/f8bf99fe.2c1a5b65.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/e6b3b17d.de0672db.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/4ecfc4b2.63591e0e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/blog.johnnyreilly.com/"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/blog.johnnyreilly.com/"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure">Goodbye Client Affinity, Hello Data Protection with Azure</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service">Making Easy Auth tokens survive releases on Linux Azure App Service</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/11/azure-app-service-health-checks-and-zero-downtime-deployments">Azure App Service, Health checks and zero downtime deployments</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/08/arm-templates-security-role-assignments">ARM templates, security, role assignments and magic GUIDs</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/01/30/aspnet-serilog-and-application-insights">ASP.NET, Serilog and Application Insights</a></li></ul></div></div><main class="col col--8"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2020/10/02/autofac-6-integration-tests-and-generic-hosting">Autofac 6, integration tests and .NET generic hosting</a></h2><div class="margin-vert--md"><time datetime="2020-10-02T00:00:00.000Z" class="blogPostDate_Ta7i">October 2, 2020  · 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>I <a href="https://blog.johnnyreilly.com/2020/05/autofac-webapplicationfactory-and.html" target="_blank" rel="noopener noreferrer">blogged a little while ago around to support integration tests using Autofac</a>. This was specific to Autofac but documented a workaround for a <a href="https://github.com/dotnet/aspnetcore/issues/14907" target="_blank" rel="noopener noreferrer">long standing issue with <code>ConfigureTestContainer</code> that was introduced into .NET core 3.0</a> which affects <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-3.1#default-service-container-replacement" target="_blank" rel="noopener noreferrer">all third-party containers</a> that use <code>ConfigureTestContainer</code> in their tests.</p><p>I&#x27;ll not repeat the contents of the previous post - it all still stands. However, with Autofac 6 the approach documented there will cease to work. This is because the previous approach relied upon <code>ContainerBuilder</code> not being sealed. <a href="https://github.com/autofac/Autofac/issues/1120" target="_blank" rel="noopener noreferrer">As of Autofac 6 it is.</a></p><p>Happily the tremendous <a href="https://twitter.com/evocationist" target="_blank" rel="noopener noreferrer">Alistair Evans</a> came up with an <a href="https://github.com/autofac/Autofac/issues/1207#issuecomment-701961371" target="_blank" rel="noopener noreferrer">alternative approach</a> which is listed below:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Based upon https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/3.x/IntegrationTestsSample</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;typeparam name=&quot;TStartup&quot;&gt;&lt;/typeparam&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class AutofacWebApplicationFactory&lt;TStartup&gt; : WebApplicationFactory&lt;TStartup&gt; where TStartup : class</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected override IHost CreateHost(IHostBuilder builder)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            builder.UseServiceProviderFactory&lt;ContainerBuilder&gt;(new CustomServiceProviderFactory());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return base.CreateHost(builder);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Based upon https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-620750841 - only necessary because of an issue in ASP.NET Core</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class CustomServiceProviderFactory : IServiceProviderFactory&lt;ContainerBuilder&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private AutofacServiceProviderFactory _wrapped;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private IServiceCollection _services;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public CustomServiceProviderFactory()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            _wrapped = new AutofacServiceProviderFactory();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public ContainerBuilder CreateBuilder(IServiceCollection services)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Store the services for later.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            _services = services;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return _wrapped.CreateBuilder(services);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public IServiceProvider CreateServiceProvider(ContainerBuilder containerBuilder)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var sp = _services.BuildServiceProvider();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma warning disable CS0612 // Type or member is obsolete</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var filters = sp.GetRequiredService&lt;IEnumerable&lt;IStartupConfigureContainerFilter&lt;ContainerBuilder&gt;&gt;&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma warning restore CS0612 // Type or member is obsolete</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            foreach (var filter in filters)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                filter.ConfigureContainer(b =&gt; { })(containerBuilder);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return _wrapped.CreateServiceProvider(containerBuilder);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Using this in place of the previous approach should allow you continue running your integration tests with Autofac 6. Thanks Alistair!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="concern-for-third-party-containers"></a>Concern for third-party containers<a class="hash-link" href="#concern-for-third-party-containers" title="Direct link to heading">#</a></h2><p>Whilst this gets us back up and running, <a href="https://github.com/autofac/Autofac/issues/1207#issuecomment-702250044" target="_blank" rel="noopener noreferrer">Alistair pointed out that this approach depends upon a deprecated interface</a>. This is the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.istartupconfigurecontainerfilter-1.configurecontainer?view=aspnetcore-3.1" target="_blank" rel="noopener noreferrer"><code>IStartupConfigureContainerFilter</code></a> which <a href="https://github.com/dotnet/aspnetcore/pull/11505" target="_blank" rel="noopener noreferrer">has been marked as <code>Obsolete</code> since mid 2019</a>. What this means is, at some point, this approach will stop working.</p><p>The marvellous David Fowler has said that <a href="https://github.com/autofac/Autofac/issues/1207#issuecomment-702361608" target="_blank" rel="noopener noreferrer"><code>ConfigureTestContainer</code> issue should be resolved in .NET</a>. However it&#x27;s worth noting that this has been an issue since .NET Core 3 shipped and unfortunately the wonderful <a href="https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-702287717" target="_blank" rel="noopener noreferrer">Chris Ross has advised that it&#x27;s not likely to be fixed for .NET 5</a>.</p><p>I&#x27;m very keen this does get resolved in .NET. Building tests upon an <code>Obsolete</code> attribute doesn&#x27;t fill me with confidence. I&#x27;m a long time user of Autofac and I&#x27;d like to continue to be. Here&#x27;s hoping that&#x27;s made possible by a fix landing in .NET. If this is something you care about, it may be worth upvoting / commenting on <a href="https://github.com/dotnet/aspnetcore/issues/14907" target="_blank" rel="noopener noreferrer">the issue in GitHub</a> so the team are aware of desire around this being resolved.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/autofac">autofac</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/asp-net">asp.net</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/configure-test-container">ConfigureTestContainer</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/integration-testing">Integration Testing</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2020/09/04/why-your-team-needs-newsfeed">Why your team needs a newsfeed</a></h2><div class="margin-vert--md"><time datetime="2020-09-04T00:00:00.000Z" class="blogPostDate_Ta7i">September 4, 2020  · 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>I&#x27;m part of a team that builds an online platform. I&#x27;m often preoccupied by how to narrow the gap between our users and &quot;us&quot; - the people that build the platform. It&#x27;s important we understand how people use and interact with what we&#x27;ve built. If we don&#x27;t then we&#x27;re liable to waste our time and energy building the wrong things. Or the wrong amount of the right things.</p><p>On a recent holiday I spent a certain amount of time pondering how to narrow the gap between our user and us. We have lots of things that help us; we use various analytics tools like <a href="https://mixpanel.com/" target="_blank" rel="noopener noreferrer">mixpanel</a>, we&#x27;ve got a mini analytics platform of our own, we have teams notifications that pop up client feedback and so on. They are all great, but they&#x27;re somewhat disparate; they don&#x27;t give us a clear insight as to who uses our platform and how they do so. The information is there, but it&#x27;s tough to grok. It doesn&#x27;t make for a joined up story.</p><p>Reaching around for how to solve this I had an idea: what if our platform had a newsfeed? The kind of thing that social media platforms the likes of Twitter and Facebook have used to great effect; a stream of mini-activities which show how the community interacts with the product. People logging in and browsing around, using features on the platform. If we could see this in near real time we&#x27;d be brought closer to our users; we&#x27;d have something that would help us have real empathy and understanding. We&#x27;d see our product as the stories of users interacting with it.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="how-do-you-build-a-newsfeed"></a>How do you build a newsfeed?<a class="hash-link" href="#how-do-you-build-a-newsfeed" title="Direct link to heading">#</a></h2><p>This was an experiment that seemed worth pursuing. So I decided to build a proof of concept and see what happened. Now I intended to put the &quot;M&quot; into MVP with this; I went in with a number of intentional constraints:</p><ol><li>The news feed wouldn&#x27;t auto update (users have the F5 key for that)</li><li>We&#x27;d host the newsfeed in our own mini analytics platform (which is already used by the team to understand how people use the platform)</li><li>News stories wouldn&#x27;t be stored anywhere; we&#x27;d generate them on the fly by querying various databases / APIs. The cost of this would be that our news stories wouldn&#x27;t be &quot;persistent&quot;; you wouldn&#x27;t be able to address them with a URL; there&#x27;d be no way to build &quot;like&quot; or &quot;share&quot; functionality.</li></ol><p>All of the above constraints are, importantly, reversable decisions. If we want auto update it could be built later. If we want the newsfeed to live somewhere else we could move it. If we wanted news stories to be persisted then we could do that.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="implementation"></a>Implementation<a class="hash-link" href="#implementation" title="Direct link to heading">#</a></h2><p>With these constraints in mind, I turned my attention to the implementation. I built a <code>NewsFeedService</code> that would be queried for news stories. The interface I decided to build looked like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">NewsFeedService.getNewsFeed(from: Date, to: Date): NewsFeed</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">type NewsFeed {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    startedAt: Date;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ended at: Date;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    stories: NewsStory[];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">type NewsStory {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /** When the story happened */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    happenedAt: Date;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /** A code that represents the type of story this is; eg USER_SESSION */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    storyCode: string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /** The story details in markdown format */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    story: string;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Each query to <code>NewsFeedService.getNewsFeed</code> would query various databases / APIs related to our product, looking for interesting events. Whether it be users logging in, users performing some kind of action, whatever. For each interested event a news story like this would be produced:</p><blockquote><p>Jane Smith logged in at 10:03am for 25 minutes. They placed <a href="https://my-glorious-platform.io/orders/janes-order" target="_blank" rel="noopener noreferrer">an order</a> worth £3,000.</p></blockquote><p>Now the killer feature here is <a href="https://en.wikipedia.org/wiki/Markdown#:~:text=Markdown%20is%20a%20lightweight%20markup,using%20a%20plain%20text%20editor." target="_blank" rel="noopener noreferrer">Markdown</a>. Our stories are written in Markdown. Why is Markdown cool? Well <a href="https://web.archive.org/web/20040402182332/http://daringfireball.net/projects/markdown/" target="_blank" rel="noopener noreferrer">to quote the creators of Markdown</a>:</p><blockquote><p>Markdown allows you to write using an easy-to-read, easy-to-write plain text format, then convert it to structurally valid XHTML (or HTML).</p></blockquote><p>This crucially includes the ability to include links. This was significant because I want us to be able to be able to click on pieces of information in the stories and be taken to the relevant place in the platform to see more details. Just as you see status updates on, for example, Twitter which lead you on to more details:</p><blockquote><p>This is the history of <a href="https://twitter.com/DefinitelyTyped?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">@DefinitelyTyped</a>: <a href="https://t.co/AY6s3bWnKP" target="_blank" rel="noopener noreferrer">https://t.co/AY6s3bWnKP</a> Thanks to <a href="https://twitter.com/SeaRyanC?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">@SeaRyanC</a> &amp; <a href="https://twitter.com/drosenwasser?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">@drosenwasser</a> of the <a href="https://twitter.com/typescript?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">@typescript</a> team, <a href="https://twitter.com/blakeembrey?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">@blakeembrey</a> inventor of typings, <a href="https://twitter.com/vvakame?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">@vvakame</a>, <a href="https://twitter.com/_stevefenton?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">@_stevefenton</a>, <a href="https://twitter.com/basarat?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">@basarat</a>, and of course <a href="https://twitter.com/borisyankov?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">@borisyankov</a> for telling me their parts of the story❤️🌻</p><p>— John Reilly (@johnny_reilly) <a href="https://twitter.com/johnny_reilly/status/1181542739994976256?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">October 8, 2019</a></p></blockquote><script src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>Again consider this example news story:</p><blockquote><p>Jane Smith logged in at 10:03am for 25 minutes. They placed <a href="https://my-glorious-platform.io/orders/janes-order" target="_blank" rel="noopener noreferrer">an order</a> worth £3,000.</p></blockquote><p>Consider that story but without a link. It&#x27;s not the same is it? A newsfeed without links would be missing a trick. Markdown gives us links. And happily due to my extensive work down the open source mines, I speak it like a native.</p><p>The first consumer of the newsfeed was to be our own mini analytics platform, which is a React app. Converting the markdown stories to React is a solved problem thanks to the wonderful <a href="https://github.com/rexxars/react-markdown" target="_blank" rel="noopener noreferrer">react-markdown</a>. You can simply sling Markdown at it and out comes HTML. Et voilà a news feed!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="whats-next"></a>What&#x27;s next?<a class="hash-link" href="#whats-next" title="Direct link to heading">#</a></h2><p>So that&#x27;s it! We&#x27;ve built a (primitive) news feed. We can now see in real time how are users are getting on. We&#x27;re closer to them, we understand them better as a consequence. If we want to take it further there&#x27;s a number of things we could do:</p><ol><li>We could make the feed auto-update</li><li>We could push news stories to other destinations. Markdown is a gloriously portable format which can be used in a variety of environments. For instance the likes of Slack and <a href="https://blog.johnnyreilly.com/2019/12/automating-teams-notifications-recently.html" target="_blank" rel="noopener noreferrer">Teams</a> accept it and apps like these are generally open on people&#x27;s desktops and phones all the time anyway. Another way to narrow the gap between us and and our users.</li></ol><p>It&#x27;s very exciting!</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/newsfeed">newsfeed</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2020/08/09/devcontainers-aka-performance-in-secure">Devcontainers AKA performance in a secure sandbox</a></h2><div class="margin-vert--md"><time datetime="2020-08-09T00:00:00.000Z" class="blogPostDate_Ta7i">August 9, 2020  · 7 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>Many corporate machines arrive in engineers hands with a preponderance of pre-installed background tools; from virus checkers to backup utilities to port blockers; the list is long.</p><p>The reason that these tools are installed is generally noble. However, the implementation can often be problematic. The tools may be set up in such a way as they impact and interfere with one another. Really powerful machines with 8 CPUs and hardy SSDs can be slowed to a crawl. Put simply: the good people responsible for ensuring security are rarely encouraged to incentivise performance alongside it. And so don&#x27;t.</p><p>The unfortunate consequence of considering the role of security without regard to performance is this: sluggish computers. The further consequence (and this is the one I want you to think long and hard about) is <em>low developer productivity</em>. And that sucks. It impacts what an organisation is able to do, how fast an organisation is able to move. Put simply: it can be the difference between success and failure.</p><p>The most secure computer is off. But you won&#x27;t ship much with it. Encouraging your organisation to consider tackling security with performance in mind is worthwhile. It&#x27;s a long game though. In the meantime what can we do?</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="hide-from-the-virus-checkers-in-a-devcontainer"></a>&quot;Hide from the virus checkers*** in a devcontainer&quot;<a class="hash-link" href="#hide-from-the-virus-checkers-in-a-devcontainer" title="Direct link to heading">#</a></h2><p>Devcontainers, the infrastructure as code equivalent for developing software, have an underappreciated quality: unlocking your machine&#x27;s performance.</p><p>Devcontainers are isolated secure sandboxes in which you can build software. To quote the <a href="https://code.visualstudio.com/docs/remote/containers" target="_blank" rel="noopener noreferrer">docs</a>:</p><blockquote><p>A <code>devcontainer.json</code> file in your project tells VS Code how to access (or create) a development container with a well-defined tool and runtime stack. This container can be used to run an application or to sandbox tools, libraries, or runtimes needed for working with a codebase.</p><p>Workspace files are mounted from the local file system or copied or <em>cloned into the container</em>.</p></blockquote><p>We&#x27;re going to set up a devcontainer to code an ASP.NET Core application with a JavaScript (well TypeScript) front end. If there&#x27;s one thing that&#x27;s sure to catch a virus checkers beady eye, it&#x27;s <code>node_modules</code>. <code>node_modules</code> contains more files than a black hole has mass. Consider a project with 5,000 source files. One trusty <code>yarn</code> later and the folder now has a tidy 250,000 files. The virus checker is now really sitting up and taking notice.</p><p>Our project has a <code>git commit</code> hook set up with <a href="https://github.com/typicode/husky" target="_blank" rel="noopener noreferrer">Husky</a> that formats our TypeScript files with <a href="https://prettier.io/" target="_blank" rel="noopener noreferrer">Prettier</a>. Every commit the files are formatted to align with the project standard. With all the virus checkers in place a <code>git commit</code> takes around 45 seconds. Inside a devcontainer we can drop this to 5 seconds. That&#x27;s nine times faster. I&#x27;ll repeat that: that&#x27;s <strong>nine times faster</strong>!</p><p>The &quot;cloned into a container&quot; above is key to what we&#x27;re going to do. We&#x27;re <em>not</em> going to mount our local file system into the devcontainer. Oh no. We&#x27;re going to build a devcontainer with ASP.NET CORE and JavaScript in. Then, inside there, we&#x27;re going to clone our repo. Then we can develop, build and debug all inside the container. It will feel like we&#x27;re working on our own machine because VS Code does such a damn fine job. In reality, we&#x27;re connecting to another computer (a Linux computer to boot) that is running in isolation to our own. In our case that machine is sharing our hardware; but that&#x27;s just an implementation detail. It could be anywhere (and in the future may well be).</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="make-me-a-devcontainer"></a>Make me a devcontainer...<a class="hash-link" href="#make-me-a-devcontainer" title="Direct link to heading">#</a></h2><p>Enough talk... We&#x27;re going to need a <code>.devcontainer/devcontainer.json</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;my devcontainer&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;dockerComposeFile&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;../docker-compose.devcontainer.yml&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;service&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;my-devcontainer&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;workspaceFolder&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/workspace&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Set *default* container specific settings.json values on container create.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;settings&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;terminal.integrated.shell.linux&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/bin/zsh&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Add the IDs of extensions you want installed when the container is created.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;extensions&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ms-dotnettools.csharp&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;dbaeumer.vscode-eslint&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;esbenp.prettier-vscode&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ms-mssql.mssql&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;eamodio.gitlens&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ms-azuretools.vscode-docker&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;k--kato.docomment&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Leopotam.csharpfixformat&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Use &#x27;postCreateCommand&#x27; to clone the repo into the workspace folder when the devcontainer starts</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// and copy in the .env file</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;postCreateCommand&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;git clone git@github.com:my-org/my-repo.git . &amp;&amp; cp /.env /workspace/.env&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// &quot;remoteUser&quot;: &quot;vscode&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p> Now the <code>docker-compose.devcontainer.yml</code> which lives in the root of the project. It provisions a SQL Server container (using the official image) and our devcontainer:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">version: &quot;3.7&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">services:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  my-devcontainer:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    image: my-devcontainer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    build: </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      context: .</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      dockerfile: Dockerfile.devcontainer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    command: /bin/zsh -c &quot;while sleep 1000; do :; done&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    volumes:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      # mount .zshrc from home - make sure it doesn&#x27;t contain Windows line endings</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - ~/.zshrc:/root/.zshrc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # user: vscode</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ports:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;5000:5000&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - &quot;8080:8080&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    environment:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - CONNECTIONSTRINGS__MYDATABASECONNECTION</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    depends_on:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - db</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  db:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    image: mcr.microsoft.com/mssql/server:2019-latest</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    privileged: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ports:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - 1433:1433</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    environment:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      SA_PASSWORD: &quot;Your_password123&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ACCEPT_EULA: &quot;Y&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The devcontainer will be built with the <code>Dockerfile.devcontainer</code> in the root of our repo. It relies upon your SSH keys and a <code>.env</code> file being available to be copied in:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#-----------------------------------------------------------------------------------------------------------</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Based upon: https://github.com/microsoft/vscode-dev-containers/tree/master/containers/dotnetcore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#-----------------------------------------------------------------------------------------------------------</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ARG VARIANT=&quot;3.1-bionic&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">FROM mcr.microsoft.com/dotnet/core/sdk:${VARIANT}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Because MITM certificates</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COPY ./docker/certs/. /usr/local/share/ca-certificates/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ENV NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/mitm.pem</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN update-ca-certificates </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># This Dockerfile adds a non-root user with sudo access. Use the &quot;remoteUser&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># property in devcontainer.json to use it. On Linux, the container user&#x27;s GID/UIDs</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># will be updated to match your local UID/GID (when using the dockerFile property).</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># See https://aka.ms/vscode-remote/containers/non-root-user for details.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ARG USERNAME=vscode</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ARG USER_UID=1000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ARG USER_GID=$USER_UID</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Options for common package install script</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ARG INSTALL_ZSH=&quot;true&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ARG UPGRADE_PACKAGES=&quot;true&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ARG COMMON_SCRIPT_SOURCE=&quot;https://raw.githubusercontent.com/microsoft/vscode-dev-containers/master/script-library/common-debian.sh&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ARG COMMON_SCRIPT_SHA=&quot;dev-mode&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Settings for installing Node.js.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ARG INSTALL_NODE=&quot;true&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ARG NODE_SCRIPT_SOURCE=&quot;https://raw.githubusercontent.com/microsoft/vscode-dev-containers/master/script-library/node-debian.sh&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ARG NODE_SCRIPT_SHA=&quot;dev-mode&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ARG NODE_VERSION=&quot;lts/*&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ARG NODE_VERSION=&quot;14&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ENV NVM_DIR=/usr/local/share/nvm</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Have nvm create a &quot;current&quot; symlink and add to path to work around https://github.com/microsoft/vscode-remote-release/issues/3224</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ENV NVM_SYMLINK_CURRENT=true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ENV PATH=${NVM_DIR}/current/bin:${PATH}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Configure apt and install packages</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN apt-get update \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; export DEBIAN_FRONTEND=noninteractive \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # Verify git, common tools / libs installed, add/modify non-root user, optionally install zsh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; apt-get -y install --no-install-recommends curl ca-certificates 2&gt;&amp;1 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; curl -sSL ${COMMON_SCRIPT_SOURCE} -o /tmp/common-setup.sh \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; ([ &quot;${COMMON_SCRIPT_SHA}&quot; = &quot;dev-mode&quot; ] || (echo &quot;${COMMON_SCRIPT_SHA} */tmp/common-setup.sh&quot; | sha256sum -c -)) \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; /bin/bash /tmp/common-setup.sh &quot;${INSTALL_ZSH}&quot; &quot;${USERNAME}&quot; &quot;${USER_UID}&quot; &quot;${USER_GID}&quot; &quot;${UPGRADE_PACKAGES}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # Install Node.js</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; curl -sSL ${NODE_SCRIPT_SOURCE} -o /tmp/node-setup.sh \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; ([ &quot;${NODE_SCRIPT_SHA}&quot; = &quot;dev-mode&quot; ] || (echo &quot;${COMMON_SCRIPT_SHA} */tmp/node-setup.sh&quot; | sha256sum -c -)) \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; /bin/bash /tmp/node-setup.sh &quot;${NVM_DIR}&quot; &quot;${NODE_VERSION}&quot; &quot;${USERNAME}&quot; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # Clean up</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; apt-get autoremove -y \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; apt-get clean -y \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; rm -f /tmp/common-setup.sh /tmp/node-setup.sh \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; rm -rf /var/lib/apt/lists/* \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # Workspace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; mkdir workspace \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; chown -R ${NONROOT_USER}:root workspace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Install Vim</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN apt-get update &amp;&amp; apt-get install -y \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    vim \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Set up a timezone in the devcontainer - necessary for anything timezone dependent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ENV TZ=Europe/London</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> &amp;&amp; apt-get update \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> &amp;&amp; apt-get install --no-install-recommends -y \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    apt-utils \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tzdata  \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> &amp;&amp; apt-get autoremove -y \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> &amp;&amp; apt-get clean -y \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> &amp;&amp; rm -rf /var/lib/apt/lists/* </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ENV DOTNET_RUNNING_IN_CONTAINER=true </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Copy across SSH keys so you can git clone</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN mkdir /root/.ssh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN chmod 700 /root/.ssh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COPY .ssh/id_rsa /root/.ssh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN chmod 600 /root/.ssh/id_rsa</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COPY .ssh/id_rsa.pub /root/.ssh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN chmod 644 /root/.ssh/id_rsa.pub</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COPY .ssh/known_hosts /root/.ssh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN chmod 644 /root/.ssh/known_hosts  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Disable initial git clone prompt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN echo &quot;StrictHostKeyChecking no&quot; &gt;&gt; /etc/ssh/ssh_config</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Copy across .env file so you can customise environment variables</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># This will be copied into the root of the repo post git clone</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COPY .env /.env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN chmod 644 /.env  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Install dotnet entity framework tools</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN dotnet tool install dotnet-ef --tool-path /usr/local/bin --version 3.1.2</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>With this devcontainer you&#x27;re good to go for an ASP.NET Core / JavaScript developer setup that is blazing fast! Remember to fire up Docker and give it goodly access to the resources of your host machine. All the CPUs, lots of memory and all the performance that there ought to be.</p><p><em>* &quot;virus checkers&quot; is a euphemism here for all the background tools that may be running. It was that or calling them &quot;we are legion&quot;</em></p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/git-clone">git clone</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/devcontainer">devcontainer</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/performance">performance</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/ssh">SSH</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2020/07/11/devcontainers-and-ssl-interception">Devcontainers and SSL interception</a></h2><div class="margin-vert--md"><time datetime="2020-07-11T00:00:00.000Z" class="blogPostDate_Ta7i">July 11, 2020  · 4 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p><a href="https://code.visualstudio.com/docs/remote/containers" target="_blank" rel="noopener noreferrer">Devcontainers</a> are cool. They are the infrastructure as code equivalent for developing software.</p><p>Imagine your new starter joins the team, you&#x27;d like them to be contributing code on <em>day 1</em>. But if the first thing that happens is you hand them a sheaf of paper upon which are the instructions for how to get their machines set up for development, well, maybe it&#x27;s going to be a while. But if your project has a devcontainer then you&#x27;re off to the races. One trusty <code>git clone</code>, fire up VS Code and they can get going.</p><p>That&#x27;s the dream right?</p><p>I&#x27;ve recently been doing some work getting a project I work on set up with a devcontainer. As I&#x27;ve worked on that I&#x27;ve become aware of some of the hurdles that might hamper your adoption of devcontainers in a corporate environment.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="certificates-im-starting-with-the-man-in-the-middle"></a>Certificates: I&#x27;m starting with the man in the middle<a class="hash-link" href="#certificates-im-starting-with-the-man-in-the-middle" title="Direct link to heading">#</a></h2><p>It is a common practice in company networks to perform <a href="https://docs.citrix.com/en-us/citrix-adc/13/forward-proxy/ssl-interception.html" target="_blank" rel="noopener noreferrer">SSL interception</a>. Not SSL inception; that&#x27;d be more fun.</p><iframe src="https://giphy.com/embed/l7JDTHpsXM26k" width="100%" height="100%" frameborder="0"></iframe><p>SSL interception is the practice of installing a &quot;man-in-the-middle&quot; (MITM) CA certificate on users machines. When SSL traffic takes place from a users machine, it goes through a proxy. That proxy performs the SSL on behalf of that user and, if it&#x27;s happy, supplies another certificate back to the users machine which satisfies the MITM CA certificate. So rather than seeing, for example, Google&#x27;s certificate from <a href="https://google.com" target="_blank" rel="noopener noreferrer">https://google.com</a> you&#x27;d see the one resulting from the SSL interception. You can read more <a href="https://security.stackexchange.com/questions/107542/is-it-common-practice-for-companies-to-mitm-https-traffic" target="_blank" rel="noopener noreferrer">here</a>.</p><p>Now this is a little known and less understood practice. I barely understand it myself. Certificates are <em>hard</em>. Even having read the above you may be none the wiser about why this is relevant. Let&#x27;s get to the broken stuff.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="devcontainers-dont-work-at-work"></a>&quot;Devcontainers don&#x27;t work at work!&quot;<a class="hash-link" href="#devcontainers-dont-work-at-work" title="Direct link to heading">#</a></h2><p>So, you&#x27;re ready to get going with your first devcontainer. You fire up the <a href="https://github.com/Microsoft/vscode-dev-containers" target="_blank" rel="noopener noreferrer">vscode-dev-containers</a> repo and find the container that&#x27;s going to work for you. Copy pasta the <code>.devcontainer</code> into your repo, install the <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack" target="_blank" rel="noopener noreferrer">Remote Development</a> extension into VS Code and enter the <code>Remote-Containers: Reopen Folder in Container</code>. Here comes the future!</p><p>But when it comes to performing SSL inside the devcontainer, trouble awaits. Here&#x27;s what a <code>yarn install</code> results in:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">yarn install v1.22.4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1/4] Resolving packages...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[2/4] Fetching packages...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">error An unexpected error occurred: &quot;https://registry.yarnpkg.com/@octokit/core/-/core-2.5.0.tgz: self signed certificate in certificate chain&quot;.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Oh no!</p><p>Gosh but it&#x27;s okay - you&#x27;re just bumping on the SSL interception. Why though? Well it&#x27;s like this: when you fire up your devcontainer it builds a new Docker container. It&#x27;s as well to imagine the container as a virtual operating system. So what&#x27;s the difference between this operating system and the one our machine is running? Well a number of things, but crucially our host operating system has the MITM CA certificate installed. So when we SSL, we have the certificate that will match up with what the proxy sends back to us certificate-wise. And inside our trusty devcontainer we don&#x27;t have that. Hence the sadness.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="devcontainer--mitm-cert--working"></a>Devcontainer + MITM cert = working<a class="hash-link" href="#devcontainer--mitm-cert--working" title="Direct link to heading">#</a></h2><p>We need to do two things to get this working:</p><ol><li>Acquire the requisite CA certificate(s) from your friendly neighbourhood networking team. Place them in a <code>certs</code> folder inside your repo, in the <code>.devcontainer</code> folder.</li><li>Add the following lines to your <code>.devcontainer/Dockerfile</code>, just after the initial <code>FROM</code> statement:</li></ol><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Because MITM certificates</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COPY certs/. /usr/local/share/ca-certificates/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ENV NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/mitm.pem</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN update-ca-certificates</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Which does the following:</p><ul><li>Copies the certs into the devcontainer</li><li>This is a Node example and so we set an environment variable called <a href="https://nodejs.org/api/cli.html#cli_node_extra_ca_certs_file" target="_blank" rel="noopener noreferrer"><code>NODE_EXTRA_CA_CERTS</code></a> which points to the path of your MITM CA certificate file inside your devcontainer.</li><li>updates the directory <code>/etc/ssl/certs</code> to hold SSL certificates and generates <code>ca-certificates.crt</code></li></ul><p>With these in place then you should be able to build your devcontainer with no SSL trauma. Enjoy!</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/devcontainer">devcontainer</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/mitm-certificate">mitm certificate</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/ssl-interception">ssl interception</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2020/06/21/taskwhenall-select-is-footgun">Task.WhenAll / Select is a footgun 👟🔫</a></h2><div class="margin-vert--md"><time datetime="2020-06-21T00:00:00.000Z" class="blogPostDate_Ta7i">June 21, 2020  · 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>This post differs from my typical fayre. Most often I write &quot;here&#x27;s how to do a thing&quot;. This is not that. It&#x27;s more &quot;don&#x27;t do this thing I did&quot;. And maybe also, &quot;how can we avoid a situation like this happening again in future?&quot;. On this topic I very much don&#x27;t have all the answers - but by putting my thoughts down maybe I&#x27;ll learn and maybe others will educate me. I would love that!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="doing-things-that-dont-scale"></a>Doing things that don&#x27;t scale<a class="hash-link" href="#doing-things-that-dont-scale" title="Direct link to heading">#</a></h2><p>The platform that I work on once had zero users. We used to beg people to log in and see what we had built. Those days are (happily) but a memory. We&#x27;re getting popular.</p><p>As our platform has grown in popularity it has revealed some bad choices we made. Approaches that look fine on the surface (and that work just dandy when you have no users) may start to cause problems as your number of users grows.</p><p>I wanted to draw attention to one approach in particular that impacted us severely. In this case &quot;impacted us severely&quot; is a euphemism for &quot;brought the site down and caused a critical incident&quot;.</p><p>You don&#x27;t want this to happen to you. Trust me. So, what follows is a cautionary tale. The purpose of which is simply this: reader, do you have code of this ilk in your codebase? If you do: out, damn&#x27;d spot! out, I say!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="so-cool-so-terrible"></a>So cool, so terrible<a class="hash-link" href="#so-cool-so-terrible" title="Direct link to heading">#</a></h2><p>I love LINQ. I love a declarative / functional style of coding. It appeals to me on some gut level. I find it tremendously readable. Read any C# of mine and the odds are pretty good that you&#x27;ll find some LINQ in the mix.</p><p>Imagine this scenario: you have a collection of user ids. You want to load the details of each user represented by their id from an API. You want to bag up all of those users into some kind of collection and send it back to the calling code.</p><p>Reading that, if you&#x27;re like me, you&#x27;re imagining some kind of map operation which loads the user details for each user id. Something like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var users = userIds.Select(userId =&gt; GetUserDetails(userId)).ToArray(); // users is User[]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Lovely. But you&#x27;ll note that I&#x27;m loading users from an API. Oftentimes, APIs are asynchronous. Certainly, in my case they were. So rather than calling a <code>GetUserDetails</code> function I found myself calling a <code>GetUserDetailsAsync</code> function, behind which an HTTP request is being sent and, later, a response is being returned.</p><p>So how do we deal with this? <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.whenall?view=netcore-3.1#System_Threading_Tasks_Task_WhenAll__1_System_Collections_Generic_IEnumerable_System_Threading_Tasks_Task___0___" target="_blank" rel="noopener noreferrer"><code>Task.WhenAll</code></a> my friends!</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var userTasks = userIds.Select(userId =&gt; GetUserDetailsAsync(userId));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">var users = await Task.WhenAll(tasks); // users is User[]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>It worked great! Right up until to the point where it didn&#x27;t. These sorts of shenanigans were fine when we had a minimal number of users... But there came a point where problems arose. It got to the point where that simple looking mapping operation became a cause of many, many, <em>many</em> HTTP requests being fired concurrently. Then bad things started to happen. Not only did we realise we were launching a denial of service attack on the API we were consuming, we were bringing our own application to collapse.</p><p>Not a proud day.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="what-is-the-problem"></a>What is the problem?<a class="hash-link" href="#what-is-the-problem" title="Direct link to heading">#</a></h2><p>Through log analysis, code reading and speculation, (with the help of the invaluable <a href="https://www.linkedin.com/in/robert-grzankowski-53618114" target="_blank" rel="noopener noreferrer">Robski</a>) we came to realise that the cause of our woes was the <code>Task.WhenAll</code> / <code>Select</code> combination. Exercising that codepath was a surefire way to bring the application to its knees.</p><p>As I read around on the topic I happened upon <a href="https://www.twitter.com/mark_heath" target="_blank" rel="noopener noreferrer">Mark Heath</a>&#x27;s excellent list of <a href="https://markheath.net/post/async-antipatterns" target="_blank" rel="noopener noreferrer">Async antipatterns</a>. Number #6 on the list is &quot;Excessive parallelization&quot;. It describes a nearly identical scenario to my own:</p><blockquote><p>Now, this does &quot;work&quot;, but what if there were 10,000 orders? We&#x27;ve flooded the thread pool with thousands of tasks, potentially preventing other useful work from completing. If <code>ProcessOrderAsync</code> makes downstream calls to another service like a database or a microservice, we&#x27;ll potentially overload that with too high a volume of calls.</p></blockquote><p>We&#x27;re definitely overloading the API we&#x27;re consuming with too high a volume of calls. I have to admit that I&#x27;m less clear on the direct reason that a <code>Task.WhenAll</code> / <code>Select</code> combination could prove fatal to our application. Mark suggests this approach will flood the thread pool with tasks. As I read around on <code>async</code> and <code>await</code> it&#x27;s repeated again and again that a <code>Task</code> is not the same thing as a <code>Thread</code>. I have to hold my hands up here and say that I don&#x27;t understand the implementation of <code>async</code> / <code>await</code> in C# well enough. <a href="https://docs.microsoft.com/en-us/dotnet/standard/async-in-depth#deeper-dive-into-tasks-for-an-io-bound-operation" target="_blank" rel="noopener noreferrer">These docs are helpful but I still don&#x27;t think the penny has fully dropped for me yet.</a> I will continue to read.</p><p>One thing we learned as we debugged the production k8s pod was that, prior to its collapse, our app appeared to be opening up 1 million connections to the API we were consuming. Which seemed a bit much. Worthy of investigation. It&#x27;s worth saying that we&#x27;re not certain this is exactly what is happening; we have less instrumentation in place than we&#x27;d like. But some fancy wc grepping on Robski&#x27;s behalf suggested this was the case.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="what-will-we-change-in-future"></a>What will we change in future?<a class="hash-link" href="#what-will-we-change-in-future" title="Direct link to heading">#</a></h2><p>A learning that came out of this for us was this: we need more metrics exposed. We don&#x27;t understand our application&#x27;s behaviour under load as well as we&#x27;d like. So we&#x27;re planning to do some work with <a href="https://www.app-metrics.io/" target="_blank" rel="noopener noreferrer">App Metrics</a> and <a href="https://grafana.com/" target="_blank" rel="noopener noreferrer">Grafana</a> so we&#x27;ve a better idea of how our application performs. If you want to improve something, first measure it.</p><p>Another fly in the ointment was that we were unable to reproduce the issue when running locally. It&#x27;s worth saying here that I develop on a Windows machine and, when deployed, our application runs in a (Linux) Docker container. So there&#x27;s a difference and a distance between our development experience and our running one.</p><p>I&#x27;m planning to migrate to developing in a <a href="https://code.visualstudio.com/docs/remote/containers" target="_blank" rel="noopener noreferrer">devcontainer</a> where that&#x27;s possible. That should narrow the gap between our production experience and our development one. Reducing the difference between the two is always useful as it means you&#x27;re less likely to get different behaviour (ie &quot;problems&quot;) in production as compared to development. I&#x27;m curious as to whether I&#x27;ll be able to replicate that behaviour in a devcontainer.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="what-did-we-do-right-now"></a>What did we do right now?<a class="hash-link" href="#what-did-we-do-right-now" title="Direct link to heading">#</a></h2><p>To solve the immediate issue we were able to pivot away to a completely different approach. We moved aggregation from our ASP.NET Core web application to our TypeScript / React client with a (pretty sweet) custom hook. The topic for a subsequent blog post.</p><p>Moving to a different approach solved my immediate issue. But it left me puzzling. What was actually going wrong? Is it thread pool exhaustion? Is it something else? So many possibilities!</p><p>If anyone has any insights they&#x27;d like to share that would be incredible! I&#x27;ve also <a href="https://stackoverflow.com/questions/62490098/task-whenall-with-select-is-a-footgun-but-why/62490705" target="_blank" rel="noopener noreferrer">asked a question on Stack Overflow</a> which has kindly had answers from generous souls. <a href="https://twitter.com/jamesskimming" target="_blank" rel="noopener noreferrer">James Skimming</a>&#x27;s answer lead me to <a href="https://www.stevejgordon.co.uk/httpclient-connection-pooling-in-dotnet-core" target="_blank" rel="noopener noreferrer">Steve Gordon&#x27;s excellent post on connection pooling</a> which I&#x27;m still absorbing and seems like it could be relevant.</p></section></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2020/05/21/autofac-webapplicationfactory-and">Autofac, WebApplicationFactory and integration tests</a></h2><div class="margin-vert--md"><time datetime="2020-05-21T00:00:00.000Z" class="blogPostDate_Ta7i">May 21, 2020  · 4 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p><strong>Updated 2nd Oct 2020:</strong> <em>for an approach that works with Autofac 6 see <a href="https://blog.johnnyreilly.com/2020/10/autofac-6-integration-tests-and-generic-hosting.html" target="_blank" rel="noopener noreferrer">this post.</a></em></p><hr><p>This is one of those occasions where I&#x27;m not writing up my own work so much as my discovery after in depth googling.</p><p>Integration tests with ASP.NET Core are the best. They spin up an in memory version of your application and let you fire requests at it. They&#x27;ve gone through a number of iterations since ASP.NET Core has been around. You may also be familiar with the <code>TestServer</code> approach of earlier versions. For some time, the advised approach has been using <code>&lt;a href=&quot;https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-3.1#basic-tests-with-the-default-webapplicationfactory&quot;&gt;WebApplicationFactory&lt;/a&gt;</code>.</p><p>What makes this approach particularly useful / powerful is that you can swap out dependencies of your running app with fakes / stubs etc. Just like unit tests! But potentially more useful because they run your whole app and hence give you a greater degree of confidence. What does this mean? Well, imagine you changed a piece of middleware in your application; this could potentially break functionality. Unit tests would probably not reveal this. Integration tests would.</p><p>There is a fly in the ointment. A hair in the gazpacho. ASP.NET Core ships with dependency injection in the box. It has its own Inversion of Control container which is perfectly fine. However, many people are accustomed to using other IOC containers such as <a href="https://autofac.org/" target="_blank" rel="noopener noreferrer">Autofac</a>.</p><p>What&#x27;s the problem? Well, swapping out dependencies registered using ASP.NET Core&#x27;s IOC requires using a hook called <a href="https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-3.1#inject-mock-services" target="_blank" rel="noopener noreferrer"><code>ConfigureTestServices</code></a>. There&#x27;s an equivalent hook for swapping out services registered using a custom IOC container: <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestcontainer?view=aspnetcore-3.0" target="_blank" rel="noopener noreferrer"><code>ConfigureTestContainer</code></a>. Unfortunately, there is a bug in ASP.NET Core as of version 3.0: <a href="https://github.com/dotnet/aspnetcore/issues/14907" target="_blank" rel="noopener noreferrer">When using GenericHost, in tests <code>ConfigureTestContainer</code> is not executed</a></p><p>This means you cannot swap out dependencies that have been registered with Autofac and the like. According to the tremendous <a href="https://www.twitter.com/davidfowl" target="_blank" rel="noopener noreferrer">David Fowler</a> of the ASP.NET team, <a href="https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-592102145" target="_blank" rel="noopener noreferrer">this will hopefully be resolved</a>.</p><p>In the meantime, <a href="https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-620750841" target="_blank" rel="noopener noreferrer">there&#x27;s a workaround thanks to various commenters on the thread</a>. Instead of using <code>WebApplicationFactory</code> directly, subclass it and create a custom <code>AutofacWebApplicationFactory</code> (the name is not important). This custom class overrides the behavior of <code>ConfigureServices</code> and <code>CreateHost</code> with a <code>CustomServiceProviderFactory</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace My.Web.Tests.Helpers {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Based upon https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/3.x/IntegrationTestsSample</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;typeparam name=&quot;TStartup&quot;&gt;&lt;/typeparam&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class AutofacWebApplicationFactory&lt;TStartup&gt; : WebApplicationFactory&lt;TStartup&gt; where TStartup : class {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected override void ConfigureWebHost(IWebHostBuilder builder) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            builder.ConfigureServices(services =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    services.AddSingleton&lt;IAuthorizationHandler&gt;(new PassThroughPermissionedRolesHandler());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .ConfigureTestServices(services =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }).ConfigureTestContainer&lt;Autofac.ContainerBuilder&gt;(builder =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // called after Startup.ConfigureContainer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected override IHost CreateHost(IHostBuilder builder) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            builder.UseServiceProviderFactory(new CustomServiceProviderFactory());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return base.CreateHost(builder);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Based upon https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-620750841 - only necessary because of an issue in ASP.NET Core</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class CustomServiceProviderFactory : IServiceProviderFactory&lt;CustomContainerBuilder&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public CustomContainerBuilder CreateBuilder(IServiceCollection services) =&gt; new CustomContainerBuilder(services);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public IServiceProvider CreateServiceProvider(CustomContainerBuilder containerBuilder) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new AutofacServiceProvider(containerBuilder.CustomBuild());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class CustomContainerBuilder : Autofac.ContainerBuilder {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly IServiceCollection services;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public CustomContainerBuilder(IServiceCollection services) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this.services = services;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this.Populate(services);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public Autofac.IContainer CustomBuild() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var sp = this.services.BuildServiceProvider();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma warning disable CS0612 // Type or member is obsolete</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var filters = sp.GetRequiredService&lt;IEnumerable&lt;IStartupConfigureContainerFilter&lt;Autofac.ContainerBuilder&gt;&gt;&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma warning restore CS0612 // Type or member is obsolete</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            foreach (var filter in filters) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                filter.ConfigureContainer(b =&gt; { }) (this);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return this.Build();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I&#x27;m going to level with you; I don&#x27;t understand all of this code. I&#x27;m not au fait with the inner workings of ASP.NET Core or Autofac but I can tell you what this allows. With this custom <code>WebApplicationFactory</code> in play you get <code>ConfigureTestContainer</code> back in the mix! You get to write code like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net.Http.Headers;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Threading.Tasks;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using FakeItEasy;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using FluentAssertions;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.TestHost;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Xunit;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.Options;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Autofac;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net.Http;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Newtonsoft.Json;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace My.Web.Tests.Controllers</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class MyControllerTests : IClassFixture&lt;AutofacWebApplicationFactory&lt;My.Web.Startup&gt;&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly AutofacWebApplicationFactory&lt;My.Web.Startup&gt; _factory;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public MyControllerTests(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            AutofacWebApplicationFactory&lt;My.Web.Startup&gt; factory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            _factory = factory;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [Fact]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public async Task My() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var fakeSomethingService = A.Fake&lt;IMySomethingService&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var fakeConfig = Options.Create(new MyConfiguration {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                SomeConfig = &quot;Important thing&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                OtherConfigMaybeAnEmailAddress = &quot;johnny_reilly@hotmail.com&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            A.CallTo(() =&gt; fakeSomethingService.DoSomething(A&lt;string&gt;.Ignored))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .Returns(Task.FromResult(true));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            void ConfigureTestServices(IServiceCollection services) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                services.AddSingleton(fakeConfig);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            void ConfigureTestContainer(ContainerBuilder builder) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                builder.RegisterInstance(fakeSomethingService);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var client = _factory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .WithWebHostBuilder(builder =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    builder.ConfigureTestServices(ConfigureTestServices);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    builder.ConfigureTestContainer&lt;Autofac.ContainerBuilder&gt;(ConfigureTestContainer);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .CreateClient();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Act</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var request = StringContent(&quot;{\&quot;sommat\&quot;:\&quot;to see\&quot;}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            request.Headers.ContentType = MediaTypeHeaderValue.Parse(&quot;application/json&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var response = await client.PostAsync(&quot;/something/submit&quot;, request);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Assert</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            response.StatusCode.Should().Be(HttpStatusCode.OK);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            A.CallTo(() =&gt; fakeSomethingService.DoSomething(A&lt;string&gt;.Ignored))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .MustHaveHappened();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/autofac">autofac</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/asp-net-core">ASP.Net Core</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/configure-test-container">ConfigureTestContainer</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/integration-testing">Integration Testing</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2020/05/10/from-react-window-to-react-virtual">From react-window to react-virtual</a></h2><div class="margin-vert--md"><time datetime="2020-05-10T00:00:00.000Z" class="blogPostDate_Ta7i">May 10, 2020  · 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>The tremendous <a href="https://twitter.com/tannerlinsley" target="_blank" rel="noopener noreferrer">Tanner Linsley</a> recently released <a href="https://github.com/tannerlinsley/react-virtual" target="_blank" rel="noopener noreferrer"><code>react-virtual</code></a>. <code>react-virtual</code> provides &quot;hooks for virtualizing scrollable elements in React&quot;.</p><p>I was already using the (also excellent) <a href="https://github.com/bvaughn/react-window" target="_blank" rel="noopener noreferrer"><code>react-window</code></a> for this purpose. <code>react-window</code> does the virtualising job and does it very well indeed However, I was both intrigued by the lure of the new shiny thing. I&#x27;ve also never been the biggest fan of <code>react-window</code>&#x27;s API. So I tried switching over from <code>react-window</code> to <code>react-virtual</code> as an experiment. To my delight, the experiment went so well I didn&#x27;t look back!</p><p>What did I get out of the switch?</p><ul><li>Simpler code / nicer developer ergonomics. The API for <code>react-virtual</code> allowed me to simplify my code and lose a layer of components. </li><li>TypeScript support in the box</li><li>Improved perceived performance. I didn&#x27;t run any specific tests to quantify this, but I can say that the same functionality now feels snappier.</li></ul><p>I tweeted my delight at this and Tanner asked if there was commit diff I could share. I couldn&#x27;t as it&#x27;s a private codebase, but I thought it could form the basis of a blogpost.</p><blockquote><p>Nice! Do you have a commit diff we could see?</p><p>— Tanner Linsley ⚛️ (@tannerlinsley) <a href="https://twitter.com/tannerlinsley/status/1259503283103608832?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">May 10, 2020</a></p></blockquote><script src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>In case you hadn&#x27;t guessed, this is that blog post...</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="make-that-change"></a>Make that change<a class="hash-link" href="#make-that-change" title="Direct link to heading">#</a></h2><p>So what does the change look like? Well first remove <code>react-window</code> from your project:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">yarn remove react-window @types/react-window</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Add the dependency to <code>react-virtual</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">yarn add react-virtual</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Change your imports from:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-ts codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">FixedSizeList</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> </span><span class="token imports maybe-class-name">ListChildComponentProps</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;react-window&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>to:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-ts codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> useVirtual </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;react-virtual&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Change your component code from:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-ts codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">type</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 107)">ImportantDataListProps</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    classes</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token keyword" style="font-style:italic">typeof</span><span class="token plain"> useStyles</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    importants</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">ImportantData</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token maybe-class-name">ImportantDataList</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token constant" style="color:rgb(130, 170, 255)">FC</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token maybe-class-name">ImportantDataListProps</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">memo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">props </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token maybe-class-name">FixedSizeList</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        height</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token number" style="color:rgb(247, 140, 108)">400</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        width</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;100%&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        itemSize</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        itemCount</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">importants</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        itemData</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token maybe-class-name">RenderRow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token maybe-class-name">FixedSizeList</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">type</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 107)">ListItemProps</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    classes</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token keyword" style="font-style:italic">typeof</span><span class="token plain"> useStyles</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    importants</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">ImportantData</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">RenderRow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">props</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">ListChildComponentProps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> style </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> importants</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> classes </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">data</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> </span><span class="token maybe-class-name">ListItemProps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> important </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> importants</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token maybe-class-name">ListItem</span><span class="token plain"> button style</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">style</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> key</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token maybe-class-name">ImportantThing</span><span class="token plain"> classes</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">classes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> important</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">important</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token maybe-class-name">ListItem</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Of the above you can delete the <code>ListItemProps</code> type and the associate <code>RenderRow</code> function. You won&#x27;t need them again! There&#x27;s no longer a need to pass down data to the child element and then extract it for usage; it all comes down into a single simpler component.</p><p>Replace the <code>ImportantDataList</code> component with this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-ts codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token maybe-class-name">ImportantDataList</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token constant" style="color:rgb(130, 170, 255)">FC</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token maybe-class-name">ImportantDataListProps</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">memo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">props </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> parentRef </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token generic-function function" style="color:rgb(130, 170, 255)">useRef</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token generic-function generic class-name maybe-class-name" style="color:rgb(255, 203, 107)">HTMLDivElement</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> rowVirtualizer </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">useVirtual</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        size</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">importants</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        parentRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        estimateSize</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">useCallback</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// This is just a best guess</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        overscan</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">div</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ref</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">parentRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                style</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    width</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token template-string string" style="color:rgb(195, 232, 141)">100%</span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    height</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token template-string string" style="color:rgb(195, 232, 141)">500px</span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    overflow</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;auto&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">div</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    style</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        height</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">${</span><span class="token template-string interpolation">rowVirtualizer</span><span class="token template-string interpolation punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token template-string interpolation">totalSize</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token template-string string" style="color:rgb(195, 232, 141)">px</span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        width</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;100%&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        position</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;relative&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">rowVirtualizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">virtualItems</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">map</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">virtualRow </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">div</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            key</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">virtualRow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">index</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            ref</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">virtualRow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">measureRef</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            className</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">classes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">hoverRow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            style</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                position</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;absolute&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                top</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                left</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                width</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;100%&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                height</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">${</span><span class="token template-string interpolation">virtualRow</span><span class="token template-string interpolation punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token template-string interpolation">size</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token template-string string" style="color:rgb(195, 232, 141)">px</span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                transform</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token template-string string" style="color:rgb(195, 232, 141)">translateY(</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">${</span><span class="token template-string interpolation">virtualRow</span><span class="token template-string interpolation punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token template-string interpolation">start</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token template-string string" style="color:rgb(195, 232, 141)">px)</span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token maybe-class-name">ImportantThing</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                classes</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">classes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                important</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">importants</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">virtualRow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">index</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            </span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">div</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">div</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">div</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>And you are done! Thanks Tanner for this tremendous library!</p></section></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2020/04/04/up-to-clouds">Up to the clouds!</a></h2><div class="margin-vert--md"><time datetime="2020-04-04T00:00:00.000Z" class="blogPostDate_Ta7i">April 4, 2020  · 11 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>This last four months has been quite the departure for me. Most typically I find myself building applications; for this last period of time I&#x27;ve been taking the platform that I work on, and been migrating it from running on our on premise servers to running in the cloud.</p><p>This turned out to be much more difficult than I&#x27;d expected and for reasons that often surprised me. We knew where we wanted to get to, but not all of what we&#x27;d need to do to get there. So many things you can only learn by doing. Whilst these experiences are still fresh in my mind I wanted to document some of the challenges we faced.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-mission"></a>The mission<a class="hash-link" href="#the-mission" title="Direct link to heading">#</a></h2><p>At the start of January, the team decided to make a concerted effort to take our humble ASP.NET Core application and migrate it to the cloud. We sat down with some friends from the DevOps team who are part of our organisation. We&#x27;re fortunate in that these marvellous people are very talented engineers indeed. It was going to be a collaboration between our two teams of budding cloudmongers that would make this happen.</p><p>Now our application is young. It is not much more than a year old. However it is growing <em>fast</em>. And as we did the migration from on premise to the cloud, that wasn&#x27;t going to stop. Development of the application was to continue as is, shipping new versions daily. Without impeding that, we were to try and get the application migrated to the cloud.</p><p>I would liken it to boarding a speeding train, fighting your way to the front, taking the driver hostage and then diverting the train onto a different track. It was challenging. Really, really challenging.</p><p>So many things had to change for us to get from on premise servers to the cloud, all the while keeping our application a going (and shipping) concern. Let&#x27;s go through them one by one.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="kubernetes-and-docker"></a>Kubernetes and Docker<a class="hash-link" href="#kubernetes-and-docker" title="Direct link to heading">#</a></h2><p>Our application was built using ASP.NET Core. A technology that is entirely cloud friendly (that&#x27;s one of the reasons we picked it). We were running on a collection of hand installed, hand configured Windows servers. That had to change. We wanted to move our application to run on Kubernetes; so we didn&#x27;t have to manually configure servers. Rather k8s would manage the provisioning and deployment of containers running our application. Worth saying now: I knew <em>nothing</em> about Kubernetes. Or nearly nothing. I learned a bunch along the way, but, as I&#x27;ve said, this was a collaboration between our team and the mighty site reliability engineers of the DevOps team. They knew a <em>lot</em> about this k8s stuff and moreoften than not, our team stood back and let them work their magic.</p><p>In order that we could migrate to running in k8s, we first needed to containerise our application. We needed a <code>Dockerfile</code>. There followed a good amount of experimentation as we worked out how to build ourselves images. There&#x27;s an art to building an optimal Docker image.</p><p>So that we can cover a lot of ground, this post will remain relatively high level. So here&#x27;s a number of things that we encountered along the way that are worth considering:</p><ul><li>Multi-stage builds were an absolute necessity for us. We&#x27;d build the front end of our app (React / TypeScript) using one stage with a <a href="https://hub.docker.com/_/node" target="_blank" rel="noopener noreferrer">Node base image</a>. Then we&#x27;d build our app using a <a href="https://hub.docker.com/_/microsoft-dotnet-core-sdk/" target="_blank" rel="noopener noreferrer">.NET Core SDK base image</a>. Finally, we&#x27;d use a <a href="https://hub.docker.com/_/microsoft-dotnet-core-aspnet" target="_blank" rel="noopener noreferrer">ASP.Net</a> image to run the app; copying in the output of previous stages. </li><li>Our application accesses various SQL Server databases. We struggled to get our application to connect to them. The issue related to the SSL configuration of our runner image. The fix was simple but frustrating; use a <code>-bionic</code> image as it has the configuration you need. We found that gem <a href="https://github.com/dotnet/SqlClient/issues/222#issuecomment-535802822" target="_blank" rel="noopener noreferrer">here</a>. </li><li>Tests. Automated tests. We want to run them in our build; but how? Once more multi-stage builds to the rescue. We&#x27;d build our application, then in a separate stage we&#x27;d run the tests; copying in the app from the build stage. If the tests failed, the build failed. If they passed then the intermediate stage containing the tests would be discarded by Docker. No unnecessary bloat of the image; all that testing goodness still; now in containerised form! </li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="jenkins"></a>Jenkins<a class="hash-link" href="#jenkins" title="Direct link to heading">#</a></h2><p>Our on premise world used TeamCity for our continuous integration needs and Octopus for deployment. We liked these tools well enough; particularly Octopus. However, the DevOps team were very much of the mind that we should be use Jenkins instead. And <a href="https://jenkins.io/doc/book/pipeline/" target="_blank" rel="noopener noreferrer">Pipeline</a>. It was here that we initially struggled. To quote the docs:</p><blockquote><p>Jenkins Pipeline (or simply &quot;Pipeline&quot; with a capital &quot;P&quot;) is a suite of plugins which supports implementing and integrating continuous delivery pipelines into Jenkins.</p></blockquote><p>Whilst continuous delivery is super cool, and is something our team was interested in, we weren&#x27;t ready for it yet. We didn&#x27;t yet have the kind of automated testing in place that gave us the confidence that we&#x27;d need to move to it. One day, but not today. For now there was still some manual testing done on each release, prior to shipping. Octopus suited us very well here as it allowed us to deploy, on demand, a build of our choice to a given environment. So the question was: what to do? Fortunately the immensely talented Aby Egea came up with a mechanism that supported that very notion. A pipeline that would, optionally, deploy our build to a specified environment. So we were good!</p><p>One thing we got to really appreciate about Jenkins was that the build is scripted with a <a href="https://jenkins.io/doc/book/pipeline/jenkinsfile/" target="_blank" rel="noopener noreferrer">Jenkinsfile</a>. This was in contrast to our TeamCity world where it was all manually configured. <a href="https://jenkins.io/projects/jcasc/" target="_blank" rel="noopener noreferrer">Configuration as code</a> is truly a wonderful thing as your build pipeline becomes part of your codebase; open for everyone to see and understand. If anyone wants to change the build pipeline it has to get code reviewed like everything else. It was as code in our <code>Jenkinsfile</code> that the deployment mechanism lived.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="vault"></a>Vault<a class="hash-link" href="#vault" title="Direct link to heading">#</a></h2><p>Another thing that we used Octopus for was secrets. Applications run on configuration; these are settings that drive the behaviour of your application. A subset of configuration is &quot;secrets&quot;. Secrets are configuration that can&#x27;t be stored in source code; they would represent a risk if they did. For instance a database connection string. We&#x27;d been merrily using Octopus for this; as Octopus deploys an application to a server it enriches the <code>appsettings.json</code> file with any required secrets.</p><p>Without Octopus in the mix, how were we to handle our secrets? The answer is with <a href="https://www.vaultproject.io/" target="_blank" rel="noopener noreferrer">Hashicorp Vault</a>. We&#x27;d store our secrets in there and, thanks to clever work by <a href="https://uk.linkedin.com/in/robert-grzankowski-53618114" target="_blank" rel="noopener noreferrer">Robski</a> of the DevOps team, when our container was brought up by Kubernetes, it would mount into the filesystem an <code>appsettings.Vault.json</code> file which we read thanks to our trusty friend <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-3.1#json-configuration-provider" target="_blank" rel="noopener noreferrer"><code>.AddJsonFile</code></a> with <code>optional: true</code>. (As the file didn&#x27;t exist in our development environment.)</p><p>Hey presto! Safe secrets in k8s.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="networking"></a>Networking<a class="hash-link" href="#networking" title="Direct link to heading">#</a></h2><p>Our on premise servers sat on the company network. They could see <em>everything</em> that there was to see. All the other servers around them on the network, bleeping and blooping. The opposite was true in AWS. There was nothing to see. Nothing to access. As it should be. It&#x27;s safer that way should a machine become compromised. For each database and each API our application depended upon, we needed to specifically whitelist access.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="kerberos"></a>Kerberos<a class="hash-link" href="#kerberos" title="Direct link to heading">#</a></h2><p>There&#x27;s always a fly in the ointment. A nasty surprise on a dark night. Ours was realising that our application depended upon an API that was secured using <a href="https://docs.microsoft.com/en-us/iis/configuration/system.webserver/security/authentication/windowsauthentication/" target="_blank" rel="noopener noreferrer">Windows Authentication</a>. Our application was accessing it by running under a service account which had been permissioned to access it. However, in AWS, our application wasn&#x27;t running as under a service account on the company network. Disappointingly, in the short term the API was not going to support an alternate authentication mechanism.</p><p>What to do? Honestly it wasn&#x27;t looking good. We were considering proxying through one of our Windows servers just to get access to that API. I was tremendously disappointed. At this point our hero arrived; one <a href="https://twitter.com/foldr" target="_blank" rel="noopener noreferrer">JMac</a> hacked together a Kerberos sidecar approach one weekend. You can see a similar approach <a href="https://github.com/edseymour/kinit-sidecar" target="_blank" rel="noopener noreferrer">here</a>. This got us to a point that allowed us to access the API we needed to.</p><p>I&#x27;m kind of amazed that there isn&#x27;t better documentation out there around have a Kerberos sidecar in a k8s setup. Tragically Windows Authentication is a widely used authentication mechanism. That being the case, having good docs to show how you can get a Kerberos sidecar in place would likely greatly advance the ability of enterprises to migrate to the cloud. The best docs I&#x27;ve found are <a href="https://blog.openshift.com/kerberos-sidecar-container/" target="_blank" rel="noopener noreferrer">here</a>. It is super hard though. <em>So hard!</em></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="hangfire"></a>Hangfire<a class="hash-link" href="#hangfire" title="Direct link to heading">#</a></h2><p>We were using <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services?view=aspnetcore-3.1&amp;tabs=visual-studio" target="_blank" rel="noopener noreferrer">Hosted Services</a> to perform background task running in our app. The nature of our background tasks meant that it was important to only run a single instance of a background task at a time. Or bad things would happen. This was going to become a problem since we had ambitions to be able to horizontally scale our application; to add new pods as running our app as demand determined.</p><p>So we started to use <a href="https://www.hangfire.io/" target="_blank" rel="noopener noreferrer">Hangfire</a> to perform task running in our app. With Hangfire, when a job is picked up it gets locked so other servers can&#x27;t pick it up. That&#x27;s what we need.</p><p>Hangfire is pretty awesome. However it turns out that there&#x27;s quirks when you move to a containerised environment. We have a number of recurring jobs that are scheduled to run at certain dates and times. In order that Hangfire can ascertain what time it is, it needs a timezone. It turns out that timezones on Windows != timezones in Docker / Linux.</p><p>This was a problem because, as we limbered up for the great migration, we were trying to run our cloud implementation side by side with our on premise one. And Windows picked a fight with Linux over timezones. You can see others bumping into this condition <a href="https://github.com/HangfireIO/Hangfire/issues/1268" target="_blank" rel="noopener noreferrer">here</a>. We learned this the hard way; jobs mysteriously stopping due to timezone related errors. Windows Hangfire not able to recognise Linux Hangfire timezones and vica versa.</p><p>The TL;DR is that we had to do a hard switch with Hangfire; it couldn&#x27;t run side by side. Not the end of the world, but surprising.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="azure-active-directory-single-sign-on"></a>Azure Active Directory Single Sign-On<a class="hash-link" href="#azure-active-directory-single-sign-on" title="Direct link to heading">#</a></h2><p>Historically our application had used two modes of authentication; Windows Authentication and cookies. Windows Authentication doesn&#x27;t generally play nicely with Docker. It&#x27;s doable, but it&#x27;s not the hill you want to die on. So we didn&#x27;t; we swapped out Windows Authentication for <a href="https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/what-is-single-sign-on" target="_blank" rel="noopener noreferrer">Azure AD SSO</a> and didn&#x27;t look back.</p><p>We also made some changes so our app would support cookies auth alongside Azure AD auth; <a href="https://blog.johnnyreilly.com/2020/03/dual-boot-authentication-with-aspnetcore.html" target="_blank" rel="noopener noreferrer">I&#x27;ve written about this previously</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="do-the-right-thing-and-tell-people-about-it"></a>Do the right thing and tell people about it<a class="hash-link" href="#do-the-right-thing-and-tell-people-about-it" title="Direct link to heading">#</a></h2><p>We&#x27;re there now; we&#x27;ve made the move. It was a difficult journey but one worth making; it sets up our platform for where we want to take it in the future. Having infrastructure as code makes all kinds of approaches possible that weren&#x27;t before. Here&#x27;s some things we&#x27;re hoping to get out of the move:</p><ul><li>blue green deployments - shipping without taking down our platform</li><li>provision environments on demand - currently we have a highly contended situation when it comes to test environments. With k8s and AWS we can look at spinning up environments as we need them and throwing them away also</li><li>autoscaling for need - we can start to look at spinning up new containers in times of high load and removing excessive containers in times of low load</li></ul><p>We&#x27;ve also become more efficient as a team. We are no longer maintaining servers, renewing certificates, installing software, RDPing onto boxes. All that time and effort we can plough back into making awesome experiences for our users.</p><p>There&#x27;s a long list of other benefits and it&#x27;s very exciting indeed! It&#x27;s not enough for us to have done this though. It&#x27;s important that we tell the story of what we&#x27;ve done and how and why we&#x27;ve done it. That way people have empathy for the work. Also they can start to think about how they could start to reap similar benefits themselves. By talking to others about the road we&#x27;ve travelled, we can save them time and help them to travel a similar road. This is good for them and it&#x27;s good for us; it helps our relationships and it helps us all to move forwards together.</p><p>A rising tide lifts all boats. By telling others about our journey, we raise the water level. Up to the clouds!</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/docker">docker</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/kubernetes">kubernetes</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/asp-net-core">asp net core</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/aws">aws</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2020/03/29/offline-storage-in-pwa">Offline storage in a PWA</a></h2><div class="margin-vert--md"><time datetime="2020-03-29T00:00:00.000Z" class="blogPostDate_Ta7i">March 29, 2020  · 10 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>When you are building any kind of application it&#x27;s typical to want to store information which persists beyond a single user session. Sometimes that will be information that you&#x27;ll want to live in some kind of centralised database, but not always.</p><p>Also, you may want that data to still be available if your user is offline. Even if they can&#x27;t connect to the network, the user may still be able to use the app to do meaningful tasks; but the app will likely require a certain amount of data to drive that.</p><p>How can we achieve this in the context of a PWA?</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-problem-with-localstorage"></a>The problem with <code>localStorage</code><a class="hash-link" href="#the-problem-with-localstorage" title="Direct link to heading">#</a></h2><p>If you were building a classic web app you&#x27;d probably be reaching for <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage" target="_blank" rel="noopener noreferrer"><code>Window.localStorage</code></a> at this point. <code>Window.localStorage</code> is a long existing API that stores data beyond a single session. It has a simple API and is very easy to use. However, it has a couple of problems:</p><ol><li><code>Window.localStorage</code> is synchronous. Not a tremendous problem for every app, but if you&#x27;re building something that has significant performance needs then this could become an issue.</li><li><code>Window.localStorage</code> cannot be used in the context of a <code>Worker</code> or a <code>ServiceWorker</code>. The APIs are not available there.</li><li><code>Window.localStorage</code> stores only <code>string</code>s. Given <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify" target="_blank" rel="noopener noreferrer"><code>JSON.stringify</code></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse" target="_blank" rel="noopener noreferrer"><code>JSON.parse</code></a> that&#x27;s not a big problem. But it&#x27;s an inconvenience.</li></ol><p>The second point here is the significant one. If we&#x27;ve a need to access our offline data in the context of a <code>ServiceWorker</code> (and if you&#x27;re offline you&#x27;ll be using a <code>ServiceWorker</code>) then what do you do?</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="indexeddb-to-the-rescue"></a>IndexedDB to the rescue?<a class="hash-link" href="#indexeddb-to-the-rescue" title="Direct link to heading">#</a></h2><p>Fortunately, <code>localStorage</code> is not the only game in town. There&#x27;s alternative offline storage mechanism available in browsers with the curious name of <a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API" target="_blank" rel="noopener noreferrer">IndexedDB</a>. To quote the docs:</p><blockquote><p>IndexedDB is a transactional database system, like an SQL-based RDBMS. However, unlike SQL-based RDBMSes, which use fixed-column tables, IndexedDB is a JavaScript-based object-oriented database. IndexedDB lets you store and retrieve objects that are indexed with a key; any objects supported by the structured clone algorithm can be stored. You need to specify the database schema, open a connection to your database, and then retrieve and update data within a series of transactions.</p></blockquote><p>It&#x27;s clear that IndexedDB is <em>very</em> powerful. But it doesn&#x27;t sound very simple. A further look at the <a href="https://github.com/mdn/to-do-notifications/blob/8b3e1708598e42062b0136608b1c5fbb66520f0a/scripts/todo.js#L48" target="_blank" rel="noopener noreferrer">MDN example</a> of how to interact with IndexedDB does little to remove that thought.</p><p>We&#x27;d like to be able to access data offline; but in a simple fashion. Like we could with <code>localStorage</code> which has a wonderfully straightforward API. If only someone would build an astraction on top of IndexedDB to make our lives easier...</p><p>Someone did.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="idb-keyval-to-the-rescue"></a>IDB-Keyval to the rescue!<a class="hash-link" href="#idb-keyval-to-the-rescue" title="Direct link to heading">#</a></h2><p>The excellent <a href="https://twitter.com/jaffathecake" target="_blank" rel="noopener noreferrer">Jake Archibald</a> of Google has written <a href="https://github.com/jakearchibald/idb-keyval" target="_blank" rel="noopener noreferrer">IDB-Keyval</a> which is:</p><blockquote><p>A super-simple-small promise-based keyval store implemented with IndexedDB</p></blockquote><p>The API is essentially equivalent to <code>localStorage</code> with a few lovely differences:</p><ol><li>The API is promise based; all functions return a <code>Promise</code>; this makes it a non-blocking API.</li><li>The API is not restricted to <code>string</code>s as <code>localStorage</code> is. To quote the docs: <em>this is IDB-backed, you can store anything structured-clonable (numbers, arrays, objects, dates, blobs etc)</em></li><li>Because this is abstraction built on top of IndexedDB, it can be used both in the context of a typical web app and also in a <code>Worker</code> or a <code>ServiceWorker</code> if required.</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="simple-usage"></a>Simple usage<a class="hash-link" href="#simple-usage" title="Direct link to heading">#</a></h2><p>Let&#x27;s take a look at what usage of <code>IDB-Keyval</code> might be like. For that we&#x27;re going to need an application. It would be good to be able to demonstrate both simple usage and also how usage in the context of an application might look.</p><p>Let&#x27;s spin up a TypeScript React app with <a href="https://create-react-app.dev/" target="_blank" rel="noopener noreferrer">Create React App</a>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-shell codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">npx create-react-app offline-storage-in-a-pwa --template typescript</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This creates us a simple app. Now let&#x27;s add IDB-Keyval to it:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-shell codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">yarn</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> idb-keyval</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Then, let&#x27;s update the <code>index.tsx</code> file to add a function that tests using IDB-Keyval:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-tsx codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;react&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token maybe-class-name">ReactDOM</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;react-dom&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">get</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;idb-keyval&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;./index.css&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;./App&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> serviceWorker </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;./serviceWorker&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token maybe-class-name">ReactDOM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">render</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">App</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token dom variable" style="color:rgb(191, 199, 213)">document</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">getElementById</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;root&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">serviceWorker</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">register</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">testIDBKeyval</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;hello&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;world&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> whatDoWeHave </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">await</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;hello&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin" style="color:rgb(130, 170, 255)">console</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token template-string string" style="color:rgb(195, 232, 141)">When we queried idb-keyval for &#x27;hello&#x27;, we found: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">${</span><span class="token template-string interpolation">whatDoWeHave</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">testIDBKeyval</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>As you can see, we&#x27;ve added a <code>testIDBKeyval</code> function which does the following:</p><ol><li>Adds a value of <code>&#x27;world&#x27;</code> to IndexedDB using IDB-Keyval for the key of <code>&#x27;hello&#x27;</code></li><li>Queries IndexedDB using IDB-Keyval for the key of <code>&#x27;hello&#x27;</code> and stores it in the variable <code>whatDoWeHave</code></li><li>Logs out what we found.</li></ol><p>You&#x27;ll also note that <code>testIDBKeyval</code> is an <code>async</code> function. This is so that we can use <code>await</code> when we&#x27;re interacting with IDB-Keyval. Given that its API is <code>Promise</code> based, it is <code>await</code> friendly. Where you&#x27;re performing more than an a single asynchronous operation at a time, it&#x27;s often valuable to use <code>async</code> / <code>await</code> to increase the readability of your codebase.</p><p>What happens when we run our application with <code>yarn start</code>? Let&#x27;s do that and take a look at the devtools:</p><p> <a href="https://4.bp.blogspot.com/-b9-GrL0IXaY/Xmqj4GRhKXI/AAAAAAAAT5s/ZoceUInSY5EWXeCr2LkGV9Zvea8S6-mUgCPcBGAYYCw/s1600/hello_world_idb_keyval.png" target="_blank" rel="noopener noreferrer">![null](&lt;https://4.bp.blogspot.com/-b9-GrL0IXaY/Xmqj4GRhKXI/AAAAAAAAT5s/ZoceUInSY5EWXeCr2LkGV9Zvea8S6-mUgCPcBGAYYCw/s640/hello_world_idb_keyval.png&gt; =640x484)</a>We successfully wrote something into IndexedDB, read it back and printed that value to the console. Amazing!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="usage-in-react"></a>Usage in React<a class="hash-link" href="#usage-in-react" title="Direct link to heading">#</a></h2><p>What we&#x27;ve done so far is slightly abstract. It would be good to implement a real-world use case. Let&#x27;s create an application which gives users the choice between using a &quot;Dark mode&quot; version of the app or not. To do that we&#x27;ll replace our <code>App.tsx</code> with this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-tsx codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> useState </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;react&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;./App.css&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> sharedStyles </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  height</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;30rem&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fontSize</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;5rem&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  textAlign</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;center&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">const</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">App</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">darkModeOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> setDarkModeOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">useState</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">handleOnChange</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token parameter"> target </span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token parameter operator" style="color:rgb(137, 221, 255)">:</span><span class="token parameter"> React</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token parameter">ChangeEvent</span><span class="token parameter operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token parameter">HTMLInputElement</span><span class="token parameter operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">setDarkModeOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">target</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">checked</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> styles </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">...</span><span class="token plain">sharedStyles</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">...</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">darkModeOn</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          backgroundColor</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;black&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          color</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;white&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          backgroundColor</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;white&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          color</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;black&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">div</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">style</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">styles</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">input</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">        </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">type</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">checkbox</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">        </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">darkMode</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">        </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">checked</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">darkModeOn</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">        </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">id</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">darkModeOn</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">        </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">darkModeOn</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">        </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">style</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> width</span><span class="token tag script language-javascript operator" style="color:rgb(137, 221, 255)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> </span><span class="token tag script language-javascript string" style="color:rgb(195, 232, 141)">&quot;3rem&quot;</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> height</span><span class="token tag script language-javascript operator" style="color:rgb(137, 221, 255)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> </span><span class="token tag script language-javascript string" style="color:rgb(195, 232, 141)">&quot;3rem&quot;</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">        </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">onChange</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">handleOnChange</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">label</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">htmlFor</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">darkModeOn</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token maybe-class-name">Use</span><span class="token plain"> dark mode</span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">label</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">div</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">default</span><span class="token plain"> </span><span class="token maybe-class-name">App</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>When you run the app you can see how it works:</p><p><a href="https://3.bp.blogspot.com/-xS6AYMXkqfw/Xmqk4QZQx0I/AAAAAAAAT54/ACHaHu6I9BsKSqQAIW7IgBH9D-UP6iHuACPcBGAYYCw/s1600/use-dark-mode.gif" target="_blank" rel="noopener noreferrer">![null](&lt;https://3.bp.blogspot.com/-xS6AYMXkqfw/Xmqk4QZQx0I/AAAAAAAAT54/ACHaHu6I9BsKSqQAIW7IgBH9D-UP6iHuACPcBGAYYCw/s640/use-dark-mode.gif&gt; =640x127)</a>Looking at the code you&#x27;ll be able to see that this is implemented using React&#x27;s <code>useState</code> hook. So any user preference selected will be lost on a page refresh. Let&#x27;s see if we can take this state and move it into IndexedDB using <code>IDB-Keyval</code>.</p><p>We&#x27;ll change the code like so:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-tsx codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> useState</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> useEffect </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;react&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">get</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;idb-keyval&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;./App.css&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> sharedStyles </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  height</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;30rem&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fontSize</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;5rem&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  textAlign</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;center&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">const</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">App</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">darkModeOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> setDarkModeOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:rgb(130, 170, 255)">useState</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token generic-function generic class-name builtin" style="color:rgb(130, 170, 255)">boolean</span><span class="token generic-function generic class-name" style="color:rgb(255, 203, 107)"> </span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">|</span><span class="token generic-function generic class-name" style="color:rgb(255, 203, 107)"> </span><span class="token generic-function generic class-name keyword" style="color:rgb(255, 203, 107);font-style:italic">undefined</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">undefined</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">useEffect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">get</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token builtin" style="color:rgb(130, 170, 255)">boolean</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;darkModeOn&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">then</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">value</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// If a value is retrieved then use it; otherwise default to true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token function" style="color:rgb(130, 170, 255)">setDarkModeOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">value </span><span class="token operator" style="color:rgb(137, 221, 255)">??</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">setDarkModeOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">handleOnChange</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token parameter"> target </span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token parameter operator" style="color:rgb(137, 221, 255)">:</span><span class="token parameter"> React</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token parameter">ChangeEvent</span><span class="token parameter operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token parameter">HTMLInputElement</span><span class="token parameter operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">setDarkModeOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">target</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">checked</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;darkModeOn&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">checked</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> styles </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">...</span><span class="token plain">sharedStyles</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">...</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">darkModeOn</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          backgroundColor</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;black&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          color</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;white&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          backgroundColor</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;white&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          color</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;black&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">div</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">style</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">styles</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">darkModeOn </span><span class="token operator" style="color:rgb(137, 221, 255)">===</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">undefined</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token maybe-class-name">Loading</span><span class="token plain"> preferences</span><span class="token operator" style="color:rgb(137, 221, 255)">...</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">input</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">type</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">checkbox</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">darkMode</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">checked</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">darkModeOn</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">id</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">darkModeOn</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">darkModeOn</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">style</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> width</span><span class="token tag script language-javascript operator" style="color:rgb(137, 221, 255)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> </span><span class="token tag script language-javascript string" style="color:rgb(195, 232, 141)">&quot;3rem&quot;</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> height</span><span class="token tag script language-javascript operator" style="color:rgb(137, 221, 255)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> </span><span class="token tag script language-javascript string" style="color:rgb(195, 232, 141)">&quot;3rem&quot;</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">onChange</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">handleOnChange</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">          </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">label</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">htmlFor</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">darkModeOn</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token maybe-class-name">Use</span><span class="token plain"> dark mode</span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">label</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">div</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">default</span><span class="token plain"> </span><span class="token maybe-class-name">App</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The changes here are:</p><ol><li><code>darkModeOn</code> is now initialised to <code>undefined</code> and the app displays a loading message until <code>darkModeOn</code> has a value.</li><li>The app attempts to app load a value from IDB-Keyval with the key <code>&#x27;darkModeOn&#x27;</code> and set <code>darkModeOn</code> with the retrieved value. If no value is retrieved then it sets <code>darkModeOn</code> to <code>true</code>.</li><li>When the checkbox is changed, the corresponding value is both applied to <code>darkModeOn</code> and saved to IDB-Keyval with the key <code>&#x27;darkModeOn&#x27;</code></li></ol><p>As you can see, this means that we are persisting preferences beyond page refresh in a fashion that will work both online <em>and</em> offline!</p><p><a href="https://1.bp.blogspot.com/-ZBsWsQNFDVk/XmqledYAp4I/AAAAAAAAT6E/3ShBesSOuxsrJ34r1QIs0R3HsXGRFBBzgCPcBGAYYCw/s1600/use-dark-mode-with-idb-keyval.gif" target="_blank" rel="noopener noreferrer">![null](&lt;https://1.bp.blogspot.com/-ZBsWsQNFDVk/XmqledYAp4I/AAAAAAAAT6E/3ShBesSOuxsrJ34r1QIs0R3HsXGRFBBzgCPcBGAYYCw/s640/use-dark-mode-with-idb-keyval.gif&gt; =640x315)</a>## Usage as a React hook</p><p>Finally it&#x27;s time for bonus points. Wouldn&#x27;t it be nice if we could move this functionality into a reusable React hook? Let&#x27;s do it!</p><p>Let&#x27;s create a new <code>usePersistedState.ts</code> file:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-ts codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> useState</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> useEffect</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> useCallback </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;react&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports keyword" style="font-style:italic">set</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> </span><span class="token imports keyword" style="font-style:italic">get</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;idb-keyval&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token generic-function function" style="color:rgb(130, 170, 255)">usePersistedState</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token generic-function generic class-name maybe-class-name" style="color:rgb(255, 203, 107)">TState</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">keyToPersistWith</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> defaultState</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">TState</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> setState</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:rgb(130, 170, 255)">useState</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token generic-function generic class-name maybe-class-name" style="color:rgb(255, 203, 107)">TState</span><span class="token generic-function generic class-name" style="color:rgb(255, 203, 107)"> </span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">|</span><span class="token generic-function generic class-name" style="color:rgb(255, 203, 107)"> </span><span class="token generic-function generic class-name keyword" style="color:rgb(255, 203, 107);font-style:italic">undefined</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">undefined</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">useEffect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">get</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token maybe-class-name">TState</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">keyToPersistWith</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">then</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">retrievedState </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// If a value is retrieved then use it; otherwise default to defaultValue</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">setState</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">retrievedState </span><span class="token operator" style="color:rgb(137, 221, 255)">??</span><span class="token plain"> defaultState</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">keyToPersistWith</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> setState</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> defaultState</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> setPersistedValue </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">useCallback</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">newValue</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token maybe-class-name">TState</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">setState</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">newValue</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">keyToPersistWith</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> newValue</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">keyToPersistWith</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> setState</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> setPersistedValue</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">const</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This new hook is modelled after the API of <a href="https://reactjs.org/docs/hooks-reference.html#usestate" target="_blank" rel="noopener noreferrer"><code>useState</code></a> and is named <code>usePersistentState</code>. It requires that a key be supplied which is the key that will be used to save the data. It also requires a default value to use in the case that nothing is found during the lookup.</p><p>It returns (just like <code>useState</code>) a stateful value, and a function to update it. Finally, let&#x27;s switch over our <code>App.tsx</code> to use our shiny new hook:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-tsx codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;react&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;./App.css&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> usePersistedState </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;./usePersistedState&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> sharedStyles </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  height</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;30rem&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fontSize</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;5rem&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  textAlign</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;center&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">const</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">App</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">darkModeOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> setDarkModeOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:rgb(130, 170, 255)">usePersistedState</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token generic-function generic class-name builtin" style="color:rgb(130, 170, 255)">boolean</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;darkModeOn&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">handleOnChange</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token parameter"> target </span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token parameter operator" style="color:rgb(137, 221, 255)">:</span><span class="token parameter"> React</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token parameter">ChangeEvent</span><span class="token parameter operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token parameter">HTMLInputElement</span><span class="token parameter operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">setDarkModeOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">target</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">checked</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> styles </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">...</span><span class="token plain">sharedStyles</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">...</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">darkModeOn</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        backgroundColor</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;black&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        color</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;white&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        backgroundColor</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;white&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        color</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;black&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">div</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">style</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">styles</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">darkModeOn </span><span class="token operator" style="color:rgb(137, 221, 255)">===</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">undefined</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token maybe-class-name">Loading</span><span class="token plain"> preferences</span><span class="token operator" style="color:rgb(137, 221, 255)">...</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">input</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">              </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">type</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">checkbox</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">              </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">darkMode</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">              </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">checked</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">darkModeOn</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">              </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">id</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">darkModeOn</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">              </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">darkModeOn</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">              </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">style</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> width</span><span class="token tag script language-javascript operator" style="color:rgb(137, 221, 255)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> </span><span class="token tag script language-javascript string" style="color:rgb(195, 232, 141)">&quot;3rem&quot;</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> height</span><span class="token tag script language-javascript operator" style="color:rgb(137, 221, 255)">:</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> </span><span class="token tag script language-javascript string" style="color:rgb(195, 232, 141)">&quot;3rem&quot;</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)"> </span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">              </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">onChange</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript" style="color:rgb(255, 85, 114)">handleOnChange</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">label</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">htmlFor</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">darkModeOn</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token maybe-class-name">Use</span><span class="token plain"> dark mode</span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">label</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">div</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">default</span><span class="token plain"> </span><span class="token maybe-class-name">App</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>This post has demonstrate how a web application or a PWA can safely store data that is persisted between sessions using native browser capabilities easily. IndexedDB powered the solution we&#x27;ve built. We used used <a href="https://github.com/jakearchibald/idb-keyval" target="_blank" rel="noopener noreferrer">IDB-Keyval</a> for the delightful and familiar abstraction it offers over IndexedDB. It&#x27;s allowed us to come up with a solution with a similarly lovely API. It&#x27;s worth knowing that there are alternatives to IDB-Keyval available such as <a href="https://github.com/localForage/localForage" target="_blank" rel="noopener noreferrer">localForage</a>. If you are building for older browsers which may lack good IndexedDB support then this would be a good choice. But be aware that with greater backwards compatibility comes greater download size. Do consider this and make the tradeoffs that make sense for you.</p><p>Finally, I&#x27;ve finished this post illustrating what usage would look like in a React context. Do be aware that there&#x27;s nothing React specific about our offline storage mechanism. So if you&#x27;re rolling with Vue, Angular or something else entirely: <em>this is for you too</em>! Offline storage is a feature that provide much greater user experiences. Please do consider making use of it in your applications.</p><p><a href="https://blog.logrocket.com/offline-storage-for-pwas/" target="_blank" rel="noopener noreferrer">This post was originally published on LogRocket.</a></p><p><a href="https://github.com/johnnyreilly/offline-storage-in-a-pwa" target="_blank" rel="noopener noreferrer">The source code for this project can be found here.</a></p></section></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog.johnnyreilly.com/2020/03/22/dual-boot-authentication-with-aspnetcore">Dual boot authentication with ASP.Net Core</a></h2><div class="margin-vert--md"><time datetime="2020-03-22T00:00:00.000Z" class="blogPostDate_Ta7i">March 22, 2020  · 9 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>This is a post about having two kinds of authentication working at the same time in ASP.Net Core. But choosing which authentication method to use dynamically at runtime; based upon the criteria of your choice.</p><p>Already this sounds complicated; let&#x27;s fix that. Perhaps I should describe my situation to you. I&#x27;ve an app which has two classes of user. One class, let&#x27;s call them &quot;customers&quot; (because... uh... they&#x27;re customers). The customers access our application via a public facing website. Traffic rolls through Cloudflare and into our application. The public facing URL is something fancy like <a href="https://mega-app.com" target="_blank" rel="noopener noreferrer">https://mega-app.com</a>. That&#x27;s one class of user.</p><p>The other class of user we&#x27;ll call &quot;our peeps&quot;; because they are <em>us</em>. We use the app that we build. Traffic from &quot;us&quot; comes from a different hostname; only addressable on our network. So URLs from requests that we make are more along the lines of <a href="https://strictly4mypeeps.io" target="_blank" rel="noopener noreferrer">https://strictly4mypeeps.io</a>.</p><p>So far, so uncontroversial. Now it starts to get interesting. Our customers log into our application using their super secret credentials. It&#x27;s <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/cookie?view=aspnetcore-3.1#create-an-authentication-cookie" target="_blank" rel="noopener noreferrer">cookie based authentication</a>. But for our peeps we do something different. Having to enter your credentials each time you use the app is friction. It gets in the way. So for us we have <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/azure-active-directory/?view=aspnetcore-3.1" target="_blank" rel="noopener noreferrer">Azure AD</a> in the mix. Azure AD is how we authenticate ourselves; and that means we don&#x27;t spend 5% of each working day entering credentials.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="let-us-speak-of-the-past"></a>Let us speak of the past<a class="hash-link" href="#let-us-speak-of-the-past" title="Direct link to heading">#</a></h2><p>Now our delightful little application grew up in a simpler time. A time where you went to the marketplace, picked out some healthy looking servers, installed software upon them, got them attached to the internet, deployed an app onto them and said &quot;hey presto, we&#x27;re live!&quot;.</p><p>Way back when, we had some servers on the internet, that&#x27;s how our customers got to our app. Our peeps, us, we went to other servers that lived on our network. So we had multiple instances of our app, deployed to different machines. The ones on the internet were configured to use cookie based auth, the ones on our internal network were Azure AD.</p><p>As I said, a simpler time.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="a-new-hope"></a>A new hope<a class="hash-link" href="#a-new-hope" title="Direct link to heading">#</a></h2><p>We&#x27;ve been going through the process of cloudifying our app. Bye, bye servers, hello <a href="https://www.docker.com/" target="_blank" rel="noopener noreferrer">Docker</a> and <a href="https://kubernetes.io/" target="_blank" rel="noopener noreferrer">Kubernetes</a>. So exciting! As we change the way our app is built and deployed; we&#x27;ve been thinking about whether the choices we make still make sense.</p><p>When it came to authentication, my initial thoughts were to continue the same road we&#x27;re travelling; just in containers and pods. So where we had &quot;internal&quot; servers, we&#x27;d have &quot;internal&quot; pods, and where we&#x27;d have &quot;external&quot; servers we&#x27;d have external pods. I had the good fortune to be working with the amazingly talented <a href="https://uk.linkedin.com/in/robert-grzankowski-53618114" target="_blank" rel="noopener noreferrer">Robski</a>. Robski knows far more about K8s and networking than I&#x27;m ever likely to. He&#x27;d regularly say things like &quot;ingress&quot; and &quot;MTLS&quot; whilst I stared blankly at him. He definitely knows stuff.</p><p>Robski challenged my plans. &quot;We don&#x27;t need it. Have one pod that does both sorts of auth. If you do that, your implementation is simpler and scaling is more straightforward. You&#x27;ll only need half the pods because you won&#x27;t need internal <em>and</em> external ones; one pod can handle both sets of traffic. You&#x27;ll save money.&quot;</p><p> I loved the idea but I didn&#x27;t think that ASP.Net Core supported it. &quot;It&#x27;s just not a thing Robski; ASP.Net Core doesn&#x27;t suppport it.&quot; Robski didn&#x27;t believe me. That turned out to a <em>very good thing</em>. There followed a period of much googling and experimentation. One day of hunting in, I was still convinced there was no way to do it that would allow me to look in the mirror without self loathing. Then Robski sent me this:</p><p><a href="https://4.bp.blogspot.com/-CjllrSY1e04/XneghUmKZ_I/AAAAAAAAUEA/WfZwU25wfQUWFVItCeC5l7FITgCaru9PgCPcBGAYYCw/s1600/robski-dynamic-auth.png" target="_blank" rel="noopener noreferrer">![null](&lt;https://4.bp.blogspot.com/-CjllrSY1e04/XneghUmKZ_I/AAAAAAAAUEA/WfZwU25wfQUWFVItCeC5l7FITgCaru9PgCPcBGAYYCw/s400/robski-dynamic-auth.png&gt; =400x365)</a>It was a link to the amazing <a href="https://twitter.com/davidfowl" target="_blank" rel="noopener noreferrer">David Fowler</a> talking about <a href="https://github.com/aspnet/Security/issues/1469#issuecomment-335027005" target="_blank" rel="noopener noreferrer">some API I&#x27;d never heard of called <code>SchemeSelector</code></a>. It turned out that this was the starting point for exactly what we needed; a way to dynamically select an authentication scheme at runtime.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="show-me-the-code"></a>Show me the code<a class="hash-link" href="#show-me-the-code" title="Direct link to heading">#</a></h2><p>This API did end up landing in ASP.Net Core, but with the name <code>ForwardDefaultSelector</code>. Not the most descriptive of names and I&#x27;ve struggled to find any documentation on it at all. What I did discover was <a href="https://stackoverflow.com/a/51897159/761388" target="_blank" rel="noopener noreferrer">an answer on StackOverflow by the marvellous Barbara Post</a>. I was able to take the approach Barbara laid out and use it to my own ends. I ended up with this snippet of code added to my <code>Startup.ConfigureServices</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">services</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .AddAuthentication(sharedOptions =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sharedOptions.DefaultScheme = &quot;WhichAuthDoWeUse&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sharedOptions.DefaultAuthenticateScheme = &quot;WhichAuthDoWeUse&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sharedOptions.DefaultChallengeScheme = &quot;WhichAuthDoWeUse&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .AddPolicyScheme(&quot;WhichAuthDoWeUse&quot;, &quot;Azure AD or Cookies&quot;, options =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        options.ForwardDefaultSelector = context =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var (isExternalRequest, requestUrl) = context.Request.GetIsExternalRequestAndDomain();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (isExternalRequest) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                _logger.LogInformation(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;Request ({RequestURL}) has come from external domain ({Domain}) so using Cookie Authentication&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    requestUrl, ExternalBaseUrl);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return CookieAuthenticationDefaults.AuthenticationScheme;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           _logger.LogInformation(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               &quot;Request ({RequestURL}) has not come from external domain ({Domain}) so using Azure AD Authentication&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               requestUrl, ExternalBaseUrl);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return AzureADDefaults.AuthenticationScheme;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .AddAzureAD(options =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Configuration.Bind(&quot;AzureAd&quot;, options);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .AddCookie(options =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        options.Cookie.SecurePolicy = CookieSecurePolicy.Always;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        options.Cookie.SameSite = SameSiteMode.Strict;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        options.Cookie.HttpOnly = true;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        options.Events.OnRedirectToAccessDenied = (context) =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            context.Response.StatusCode = Microsoft.AspNetCore.Http.StatusCodes.Status401Unauthorized;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return Task.CompletedTask;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        options.Events.OnRedirectToLogin = (context) =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            context.Response.StatusCode = Microsoft.AspNetCore.Http.StatusCodes.Status401Unauthorized;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return Task.CompletedTask;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If you look at this code it&#x27;s doing these things:</p><ol><li>Registering three types of authentication: Cookie, Azure AD and &quot;WhichAuthDoWeUse&quot;</li><li>Registers the default <code>Scheme</code> to be &quot;WhichAuthDoWeUse&quot;.</li></ol><p>&quot;WhichAuthDoWeUse&quot; is effectively an <code>if</code> statement that says, <em>&quot;if this is an external <code>Request</code> use Cookies authentication, otherwise use Azure AD&quot;</em>. Given that &quot;WhichAuthDoWeUse&quot; is the default scheme, this code runs for each request, to determine which authentication method to use.</p><p>Alongside this mechanism I added these extension methods:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Http;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Http.Extensions;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace My.App.Auth {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static class AuthExtensions {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public const string ExternalBaseUrl = &quot;https://mega-app.com&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public const string InternalBaseUrl = &quot;https://strictly4mypeeps.io&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// Determines if a request is an &quot;external&quot; URL (eg begins &quot;https://mega-app.com&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// or an &quot;internal&quot; URL (eg begins &quot;https://strictly4mypeeps.io&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static (bool, string) GetIsExternalRequestAndDomain(this HttpRequest request) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var (requestUrl, domain) = GetRequestUrlAndDomain(request);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var isExternalUrl = domain == ExternalBaseUrl;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var isUnknownPath = domain == null; // This scenario is extremely unlikely but has been observed once during testing so we will cater for it</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var isExternalRequest = isExternalUrl || isUnknownPath; // If unknown we&#x27;ll treat as &quot;external&quot; for a safe fallback</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return (isExternalRequest, requestUrl);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// Determines if a request is an &quot;external&quot; URL (eg begins &quot;https://mega-app.com&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// or an &quot;internal&quot; URL (eg begins &quot;https://strictly4mypeeps.io&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static (bool, string) GetIsInternalRequestAndDomain(this HttpRequest request) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var (requestUrl, domain) = GetRequestUrlAndDomain(request);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var isInternalRequest = domain == InternalBaseUrl;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return (isInternalRequest, requestUrl);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private static (string, string) GetRequestUrlAndDomain(HttpRequest request) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            string requestUrl = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            string domain = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (request.Host.HasValue) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                requestUrl = request.GetEncodedUrl();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                domain = new Uri(requestUrl).GetLeftPart(UriPartial.Authority);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return (requestUrl, domain);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Finally, I updated the <code>SpaController.cs</code> (which serves initial requests to our Single Page Application) to cater for having two types of Auth in play:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// ASP.NET will try and load the index.html using the FileServer if we don&#x27;t have a route</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// here to match `/`. These attributes can&#x27;t be on Index or the spa fallback doesn&#x27;t work</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// Note: this is almost perfect except that if someone actually calls /index.html they&#x27;ll get</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// the FileServer one, not the one from this file.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [HttpGet(&quot;/&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [AllowAnonymous]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public async Task&lt;IActionResult&gt; SpaFallback([FromQuery] string returnUrl) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var redirectUrlIfUserIsInternalAndNotAuthenticated = GetRedirectUrlIfUserIsInternalAndNotAuthenticated(returnUrl);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (redirectUrlIfUserIsInternalAndNotAuthenticated != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return LocalRedirect(redirectUrlIfUserIsInternalAndNotAuthenticated);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return await Index(); // Index just serves up our SPA index.html</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// SPA landing with authorisation - this endpoint will typically not be directly navigated to by a user; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// rather it will be redirected to from the IndexWithoutAuthorisation and SpaFallback actions above</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// in the case where a user is *not* authenticated but has come from an internal URL eg https://strictlyformypeeps.io</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [HttpGet(&quot;/login-with-azure-ad&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [Authorize]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public async Task&lt;IActionResult&gt; IndexWithAuthorisation()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return await Index(); // Index just serves up our SPA index.html</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// This method returns a RedirectURL if a request is coming from an internal URL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// eg https://ix-web-int.prd.investec.cloud and is not authenticated.  In this case</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// we likely want to trigger authentication by redirecting to an authorized endpoint</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        string GetRedirectUrlIfUserIsInternalAndNotAuthenticated(string returnUrl)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // If a user is authenticated then we don&#x27;t need to trigger authentication</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var isAuthenticated = User?.Identity?.Name != null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (isAuthenticated)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // This scenario is extremely unlikely but has been observed once during testing so we will cater for it</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var (isInternalRequest, requestUrl) = Request.GetIsInternalRequestAndDomain();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (isInternalRequest) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var redirectUrl = $&quot;/login-with-azure-ad{(string.IsNullOrEmpty(returnUrl) ? &quot;&quot; : &quot;?returnUrl=&quot; + WebUtility.UrlEncode(returnUrl))}&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                _logger.LogInformation(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;Request ({RequestURL}) has come from internal domain ({InternalDomain}) but is not authenticated; redirecting to {RedirectURL}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    requestUrl, AuthExtensions.InternalBaseUrl, redirectUrl);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return redirectUrl;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The code above allows anonymous requests to land in our app through the <code>AllowAnonymous</code> attribute. However, it checks the request when it comes in to see if:</p><ol><li>It&#x27;s an internal request (i.e. the Request URL starts &quot;<a href="https://strictly4mypeeps.io/%22" target="_blank" rel="noopener noreferrer">https://strictly4mypeeps.io/&quot;</a>)</li><li>The current user is <em>not</em> authenticated.</li></ol><p>In this case the user is redirected to the <a href="https://strictly4mypeeps.io/login-with-azure-ad" target="_blank" rel="noopener noreferrer">https://strictly4mypeeps.io/login-with-azure-ad</a> route which is decorated with the <code>Authorize</code> attribute. This will trigger authentication for our unauthenticated internal users and drive them through the Azure AD login process.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-mystery-of-no-documentation"></a>The mystery of no documentation<a class="hash-link" href="#the-mystery-of-no-documentation" title="Direct link to heading">#</a></h2><p>I&#x27;m so surprised that this approach hasn&#x27;t yet been better documented on the (generally superb) ASP.Net Core docs. It&#x27;s such a potentially useful approach; and in our case, money saving too! I hope the official docs feature something on this in future. If they do, and I&#x27;ve just missed it (possible!) then please hit me up in the comments.</p></section></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog.johnnyreilly.com/page/2"><div class="pagination-nav__label">« Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog.johnnyreilly.com/page/4"><div class="pagination-nav__label">Older Entries »</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/blog.johnnyreilly.com/styles.acafb066.js"></script>
<script src="/blog.johnnyreilly.com/runtime~main.ff161662.js"></script>
<script src="/blog.johnnyreilly.com/main.c1c76de5.js"></script>
<script src="/blog.johnnyreilly.com/1.08786e85.js"></script>
<script src="/blog.johnnyreilly.com/2.4fd9db96.js"></script>
<script src="/blog.johnnyreilly.com/a6aa9e1f.917b34ca.js"></script>
<script src="/blog.johnnyreilly.com/c3b5bd8c.4fdda474.js"></script>
<script src="/blog.johnnyreilly.com/f3c1932d.32f51e9b.js"></script>
<script src="/blog.johnnyreilly.com/b3f58b0c.bfce6d1a.js"></script>
<script src="/blog.johnnyreilly.com/46a40735.fa9caee6.js"></script>
<script src="/blog.johnnyreilly.com/698cc75e.6c4a8a48.js"></script>
<script src="/blog.johnnyreilly.com/3e162f19.f6b719af.js"></script>
<script src="/blog.johnnyreilly.com/c987543e.81e88e8a.js"></script>
<script src="/blog.johnnyreilly.com/a764018b.fa45b12a.js"></script>
<script src="/blog.johnnyreilly.com/f5746e63.077f7df3.js"></script>
<script src="/blog.johnnyreilly.com/f8bf99fe.2c1a5b65.js"></script>
<script src="/blog.johnnyreilly.com/e6b3b17d.de0672db.js"></script>
<script src="/blog.johnnyreilly.com/4ecfc4b2.63591e0e.js"></script>
</body>
</html>