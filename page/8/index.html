<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">I CAN MAKE THIS WORK | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="I CAN MAKE THIS WORK | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="The blog of johnnyreilly"><meta data-react-helmet="true" property="og:description" content="The blog of johnnyreilly"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/page/8"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_posts_list"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/blog/2021-03-20-bicep-meet-azure-pipelines/bicep-meet-azure-pipelines.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/blog/2021-03-20-bicep-meet-azure-pipelines/bicep-meet-azure-pipelines.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/page/8"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/page/8" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/page/8" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.e07a5399.css">
<link rel="preload" href="/assets/js/runtime~main.aee1581e.js" as="script">
<link rel="preload" href="/assets/js/main.f93ba7ce.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/about">About</a></li><li class="menu__list-item"><a class="menu__link" href="/blog-archive">Blog Archive</a></li><li class="menu__list-item"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="menu__link">Twitter</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/05/15/azurite-and-table-storage-dev-container">Azurite and Table Storage in a dev container</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/05/08/create-pipeline-with-azure-devops-api">Create a Pipeline with the Azure DevOps API</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/05/01/blog-archive-for-docusaurus">Blog Archive for Docusaurus</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/04/24/service-now-api-and-typescript-conditional-types">The Service Now API and TypeScript Conditional Types</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/04/20/ts-loader-goes-webpack-5">ts-loader goes webpack 5</a></li></ul></div></div><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/2021/03/20/bicep-meet-azure-pipelines">Bicep meet Azure Pipelines</a></h2><div class="margin-vert--md"><time datetime="2021-03-20T00:00:00.000Z" class="blogPostDate_fNvV">March 20, 2021 Â· 5 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><p><a href="https://github.com/Azure/bicep" target="_blank" rel="noopener noreferrer">Bicep</a> is a terser and more readable alternative language to ARM templates. Running ARM templates in Azure Pipelines is straightforward. However, there isn&#x27;t yet a first class experience for running Bicep in Azure Pipelines. This post demonstrates an approach that can be used until a Bicep task is available.</p><p><img alt="Bicep meet Azure Pipelines" src="/assets/images/bicep-meet-azure-pipelines-cfcdd6693ae17634089935e5cb24c972.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="bicep-mostly-armless"></a>Bicep: mostly ARMless<a class="hash-link" href="#bicep-mostly-armless" title="Direct link to heading">#</a></h2><p>If you&#x27;ve been working with Azure and infrastructure as code, you&#x27;ll likely have encountered <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview" target="_blank" rel="noopener noreferrer">ARM templates</a>. They&#x27;re a domain specific language that lives inside JSON, used to define the infrastructure that is deployed to Azure; App Services, Key Vaults and the like.</p><p>ARM templates are quite verbose and not the easiest thing to read. This is a consequence of being effectively a language nestled inside another language. Bicep is an alternative language which is far more readable. Bicep transpiles down to ARM templates, in the same way that TypeScript transpiles down to JavaScript.</p><p>Bicep is quite new, but already it enjoys feature parity with ARM templates (as of <a href="https://github.com/Azure/bicep/releases/tag/v0.3.1" target="_blank" rel="noopener noreferrer">v0.3</a>) and ships as part of the <a href="https://github.com/MicrosoftDocs/azure-docs-cli/blob/master/docs-ref-conceptual/release-notes-azure-cli.md#arm-1" target="_blank" rel="noopener noreferrer">Azure CLI</a>. However, as Bicep is new, it doesn&#x27;t yet have a dedicated Azure Pipelines task for deployment.  This should exist in future, perhaps as soon as the <a href="https://github.com/Azure/bicep/issues/1341" target="_blank" rel="noopener noreferrer">v0.4 release</a>. In the meantime there&#x27;s an alternative way to achieve this which we&#x27;ll go through.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="app-service-with-bicep"></a>App Service with Bicep<a class="hash-link" href="#app-service-with-bicep" title="Direct link to heading">#</a></h2><p>Let&#x27;s take a simple Bicep file, <code>azuredeploy.bicep</code>, which is designed to deploy an App Service resource to Azure. It looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bicep"><div tabindex="0" class="prism-code language-bicep codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@description(&#x27;Tags that our resources need&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">param tags object = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  costCenter: &#x27;todo: replace&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  environment: &#x27;todo: replace&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  application: &#x27;todo: replace with app name&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  description: &#x27;todo: replace&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  managedBy: &#x27;ARM&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@minLength(2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@description(&#x27;Base name of the resource such as web app name and app service plan&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">param applicationName string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@description(&#x27;Location for all resources.&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">param location string = resourceGroup().location</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@description(&#x27;The SKU of App Service Plan&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">param sku string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">var appServicePlanName_var = &#x27;plan-${applicationName}-${tags.environment}&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">var linuxFxVersion = &#x27;DOTNETCORE|5.0&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">var fullApplicationName_var = &#x27;app-${applicationName}-${uniqueString(applicationName)}&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">resource appServicePlanName &#x27;Microsoft.Web/serverfarms@2019-08-01&#x27; = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: appServicePlanName_var</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  location: location</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  sku: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: sku</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  kind: &#x27;linux&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tags: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CostCenter: tags.costCenter</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Environment: tags.environment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Description: tags.description</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ManagedBy: tags.managedBy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  properties: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    reserved: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">resource fullApplicationName &#x27;Microsoft.Web/sites@2018-11-01&#x27; = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: fullApplicationName_var</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  location: location</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  kind: &#x27;app&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tags: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CostCenter: tags.costCenter</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Environment: tags.environment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Description: tags.description</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ManagedBy: tags.managedBy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  properties: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    serverFarmId: appServicePlanName.id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    clientAffinityEnabled: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    siteConfig: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      appSettings: []</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      linuxFxVersion: linuxFxVersion</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      alwaysOn: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ftpsState: &#x27;Disabled&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      http20Enabled: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      minTlsVersion: &#x27;1.2&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      remoteDebuggingEnabled: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    httpsOnly: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  identity: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type: &#x27;SystemAssigned&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">output fullApplicationName string = fullApplicationName_var</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>When transpiled down to an ARM template, this Bicep file more than doubles in size: </p><ul><li><code>azuredeploy.bicep</code> - 1782 bytes</li><li><code>azuredeploy.json</code> - 3863 bytes</li></ul><p>This tells you something of the advantage of Bicep. The template comes with an associated <code>azuredeploy.parameters.json</code> file:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><div tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;$schema&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;contentVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.0.0.0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;parameters&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;tags&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;costCenter&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;8888&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;environment&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;stg&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;application&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;hello-azure&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;description&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;App Service for hello-azure&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;managedBy&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ARM&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;sku&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;B1&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>It&#x27;s worth remembering that you can use the same parameters files with Bicep that you can use with ARM templates. This is great for minimising friction when it comes to migrating.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="bicep-in-azure-pipelinesyml"></a>Bicep in <code>azure-pipelines.yml</code><a class="hash-link" href="#bicep-in-azure-pipelinesyml" title="Direct link to heading">#</a></h2><p>Now we have our Bicep file, we want to execute it from the context of an Azure Pipeline. If we were working directly with the ARM template we&#x27;d likely have something like this in place:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><div tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Deploy Hello Azure ARM&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;$(azureSubscription)&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;$(resourceGroupName)&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;North Europe&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;infra/app-service/azuredeploy.json&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">csmParametersFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;infra/app-service/azuredeploy.parameters.json&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">deploymentOutputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> resourceGroupDeploymentOutputs</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">overrideParameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">applicationName $(Build.Repository.Name)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">pwsh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(195, 232, 141)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">            $outputs = ConvertFrom-Json &#x27;$(resourceGroupDeploymentOutputs)&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">            foreach ($output in $outputs.PSObject.Properties) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">                Write-Host &quot;##vso[task.setvariable variable=RGDO_$($output.Name)]$($output.Value.value)&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">            }</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Turn ARM outputs into variables&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>There&#x27;s two tasks above. The first is the native task for ARM deployments which takes our ARM template and our parameters and deploys them. The second task takes the output variables from the first task and converts them into Azure Pipeline variables such that they can be referenced later in the pipeline. In this case this variablifies our <code>fullApplicationName</code> output.</p><p>There is, as yet, no <code>BicepTemplateDeployment@1</code>. <a href="https://github.com/Azure/bicep/issues/1341" target="_blank" rel="noopener noreferrer">Though it&#x27;s coming</a>. In the meantime, the marvellous <a href="https://twitter.com/adotfrank" target="_blank" rel="noopener noreferrer">Alex Frankel</a> <a href="https://github.com/Azure/bicep/issues/1341#issuecomment-802010110" target="_blank" rel="noopener noreferrer">advised</a>:</p><blockquote><p>I&#x27;d recommend using the <a href="https://docs.microsoft.com/azure/devops/pipelines/tasks/deploy/azure-cli?view=azure-devops" target="_blank" rel="noopener noreferrer">Azure CLI task</a> to deploy. As long as that task is updated to Az CLI version 2.20 or later, it will automatically install the bicep CLI when calling <code>az deployment group create -f main.bicep</code>.</p></blockquote><p>Let&#x27;s give it a go!</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><div tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureCLI@2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Deploy Hello Azure Bicep&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;$(azureSubscription)&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> bash</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inlineScript</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(195, 232, 141)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">              az --version</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              echo &quot;az deployment group create </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">group &#x27;$(resourceGroupName)&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">name appservicedeploy&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              az deployment group create </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">group &#x27;$(resourceGroupName)&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">name appservicedeploy \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">template</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file infra/app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service/azuredeploy.bicep \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">parameters infra/app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service/azuredeploy.parameters.json \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">parameters applicationName=&#x27;$(Build.Repository.Name)&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              echo &quot;az deployment group show </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">group &#x27;$(resourceGroupName)&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">name appservicedeploy&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              deploymentoutputs=$(az deployment group show </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">group &#x27;$(resourceGroupName)&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">name appservicedeploy \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">query properties.outputs)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              echo &#x27;convert outputs to variables&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              echo $deploymentoutputs </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> jq </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">c &#x27;. </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> to_entries</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">.key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> .value.value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                while IFS=$&quot;\n&quot; read </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">r c; do</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  outputname=$(echo &quot;$c&quot; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> jq </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">r &#x27;.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  outputvalue=$(echo &quot;$c&quot; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> jq </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">r &#x27;.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  echo &quot;setting variable RGDO_$outputname=$outputvalue&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  echo &quot;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">##vso[task.setvariable variable=RGDO_$outputname]$outputvalue&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                done</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The above is just a single Azure CLI task (as advised).  It invokes <code>az deployment group create</code> passing the relevant parameters. It then acquires the output properties using <code>az deployment group show</code>.  Finally it once again converts these outputs to Azure Pipeline variables with some <a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener noreferrer"><code>jq</code></a> smarts.</p><p>This works right now, and running it results in something like the output below. So if you&#x27;re excited about Bicep and don&#x27;t want to wait for 0.4 to start moving on this, then this can get you going. To track the progress of the custom task, <a href="https://github.com/Azure/bicep/issues/1341" target="_blank" rel="noopener noreferrer">keep an eye on this issue</a>.</p><p><img alt="Bicep in an Azure Pipeline" src="/assets/images/bicep-in-a-pipeline-626bfeeb531b0312a2840c4a38b9545e.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="update-an-even-simpler-alternative"></a>Update: an even simpler alternative<a class="hash-link" href="#update-an-even-simpler-alternative" title="Direct link to heading">#</a></h2><p>There is even a simpler way to do this which I discovered subsequent to writing this. <a href="/2021/03/23/bicep-meet-azure-pipelines-2">Have a read</a>.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/bicep">Bicep</a><a class="margin-horiz--sm" href="/tags/arm-templates">ARM templates</a><a class="margin-horiz--sm" href="/tags/azure-pipelines">Azure Pipelines</a><a class="margin-horiz--sm" href="/tags/azure-cli">Azure CLI</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/page/7"><div class="pagination-nav__label">Â« Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/page/9"><div class="pagination-nav__label">Older Entries Â»</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Support me</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><h4 class="footer__title">Feeds</h4><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">RSS</a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">Atom</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.aee1581e.js"></script>
<script src="/assets/js/main.f93ba7ce.js"></script>
</body>
</html>