<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Blog | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="Blog | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.a30a8c8e.css">
<link rel="preload" href="/styles.9c2995a9.js" as="script">
<link rel="preload" href="/runtime~main.e2b992e5.js" as="script">
<link rel="preload" href="/main.9ec81549.js" as="script">
<link rel="preload" href="/1.9d1369a3.js" as="script">
<link rel="preload" href="/2.3dd236d5.js" as="script">
<link rel="preload" href="/a6aa9e1f.6c8d1a94.js" as="script">
<link rel="preload" href="/c3b5bd8c.0459a1fb.js" as="script">
<link rel="preload" href="/ad8809cb.20423fd5.js" as="script">
<link rel="preload" href="/8c2314fc.0663e26a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/03/10/managed-identity-azure-sql-entity-framework">Managed Identity, Azure SQL and Entity Framework</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/03/06/generate-typescript-and-csharp-clients-with-nswag">Generate TypeScript and CSharp clients with NSwag based on an API</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure">Goodbye Client Affinity, Hello Data Protection with Azure</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service">Making Easy Auth tokens survive releases on Linux Azure App Service</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/02/11/azure-app-service-health-checks-and-zero-downtime-deployments">Azure App Service, Health checks and zero downtime deployments</a></li></ul></div></div><main class="col col--8"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/2016/04/25/instant-stubs-with-jsonnet">Instant Stubs with JSON.Net (just add hot water)</a></h2><div class="margin-vert--md"><time datetime="2016-04-25T00:00:00.000Z" class="blogPostDate_Ta7i">April 25, 2016  Â· 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>I&#x27;d like you to close your eyes and imagine a scenario. You&#x27;re handed a prototype system. You&#x27;re told it works. It has no documentation. It has 0 unit tests. The hope is that you can take it on, refactor it, make it better and (crucially) not break it. Oh, and you don&#x27;t really understand what the code does or why it does it either; information on that front is, alas, sorely lacking.</p><p> This has happened to me; it&#x27;s alas not that unusual. The common advice handed out in this situation is: &quot;add unit tests before you change it&quot;. That&#x27;s good advice. We need to take the implementation that embodies the correctness of the system and create unit tests that set that implementation in stone. However, what say the system that you&#x27;re hoping to add tests to takes a number of large and complex inputs from some external source and produces a similarly large and complex output?</p><p>You could start with integration tests. They&#x27;re good but slow and crucially they depend upon the external inputs being available and unchanged (which is perhaps unlikely). What you could do (what I have done) is debug a working working system. At each point that an input is obtained I have painstakingly transcribed the data which allows me to subsequently hand code stub data. There comes a point when this is plainly untenable; it&#x27;s just too much data to transcribe. At this point the temptation is to think &quot;it&#x27;s okay; I can live without the tests. I&#x27;ll just be super careful with my refactoring... It&#x27;ll be fine It&#x27;ll be fine It&#x27;ll be fine It&#x27;ll be fine&quot;.</p><p>Actually, it probably won&#x27;t be fine. And even if it is (miracles do happen) you&#x27;re going to be fairly stressed as you wonder if you&#x27;ve been careful enough. What if there was another way? A way that wasn&#x27;t quite so hard but that allowed you to add tests without requiring 3 months hand coding....</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="instant-stubs"></a>Instant Stubs<a class="hash-link" href="#instant-stubs" title="Direct link to heading">#</a></h2><p>What I&#x27;ve come up with is a super simple utility class for creating stubs / fakes. (I&#x27;m aware the naming of such things <a href="http://martinfowler.com/articles/mocksArentStubs.html" target="_blank" rel="noopener noreferrer">can be a little contentious</a>.)</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Newtonsoft.Json;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.IO;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace MakeFakeData.UnitTests</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public static class Stubs</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private static JsonSerializer _serializer = new JsonSerializer { NullValueHandling = NullValueHandling.Ignore };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static void Make&lt;T&gt;(string stubPath, T data)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (string.IsNullOrEmpty(stubPath))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          throw new ArgumentNullException(nameof(stubPath));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (data == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          throw new ArgumentNullException(nameof(data));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        using (var sw = new StreamWriter(stubPath))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        using (var writer = new JsonTextWriter(sw) { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Formatting = Formatting.Indented, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            IndentChar = &#x27; &#x27;, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Indentation = 2})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          _serializer.Serialize(writer, data);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      catch (Exception exc)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        throw new Exception($&quot;Failed to make {stubPath}&quot;, exc);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static T Load&lt;T&gt;(string stubPath)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (string.IsNullOrEmpty(stubPath))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          throw new ArgumentNullException(nameof(stubPath));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        using (var file = File.OpenText(stubPath))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        using (var reader = new JsonTextReader(file))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          return _serializer.Deserialize&lt;T&gt;(reader);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      catch (Exception exc)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        throw new Exception($&quot;Failed to load {stubPath}&quot;, exc);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>As you can see this class uses <a href="http://www.newtonsoft.com/json" target="_blank" rel="noopener noreferrer">JSON.Net</a> and exposes 2 methods:</p><dl><dt>Make</dt><dd>Takes a given piece of data and uses JSON.Net to serialise it as JSON to a file. (nb I choose to format the JSON for readability and exclude null values; both totally optional)</dd><dt>Load</dt><dd>Takes the given path and loads the associated JSON file and deserialises it back into an object.</dd></dl><p>The idea is this: we take our working implementation and, wherever it extracts data from an external source, we insert a temporary statement like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var data = _dataService.GetComplexData();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Just inserted so we can generate the stub data...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Stubs.Make($&quot;{System.AppDomain.CurrentDomain.BaseDirectory}\\data.json&quot;, data);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The next time you run the implementation you&#x27;ll find the app generates a <code>data.json</code> file containing the complex data serialized to JSON. Strip out your <code>Stubs.Make</code> statements from the implementation and we&#x27;re ready for the next stage.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="using-your-json"></a>Using your JSON<a class="hash-link" href="#using-your-json" title="Direct link to heading">#</a></h2><p>What you need to do now is to take the new and shiny <code>data.json</code> file and move it to your unit test project. It needs to be included within the unit test project. Also, for each JSON file you have, the <code>Build Action</code> in VS needs to be set to <code>Content</code> and the <code>Copy to Output Directory</code> to <code>Copy if newer</code>.</p><p>Then within your unit tests you can write code like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-ts codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> dummyData </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token maybe-class-name">Stubs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token generic-function function" style="color:rgb(130, 170, 255)">Load</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token generic-function generic class-name maybe-class-name" style="color:rgb(255, 203, 107)">ComplexDataType</span><span class="token generic-function generic class-name operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Stubs/data.json&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Which pulls in your data from the JSON file and deserialises it into the original types. With this in hand you can plug together a unit test based on an existing implementation which depends on external data much faster than the hand-cranked method of old.</p><p>Finally, before the wildebeest of TDD descend upon me howling and wailing, let me say again; I anticipate this being useful when you&#x27;re trying to add tests to something that already exists but is untested. Clearly it would be better not to be in this situaion in the first place.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/unit-testing">unit testing</a><a class="margin-horiz--sm" href="/tags/stub-data">stub data</a><a class="margin-horiz--sm" href="/tags/json-net">json.net</a><a class="margin-horiz--sm" href="/tags/mock-data">mock data</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/page/105"><div class="pagination-nav__label">Â« Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/page/107"><div class="pagination-nav__label">Older Entries Â»</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.9c2995a9.js"></script>
<script src="/runtime~main.e2b992e5.js"></script>
<script src="/main.9ec81549.js"></script>
<script src="/1.9d1369a3.js"></script>
<script src="/2.3dd236d5.js"></script>
<script src="/a6aa9e1f.6c8d1a94.js"></script>
<script src="/c3b5bd8c.0459a1fb.js"></script>
<script src="/ad8809cb.20423fd5.js"></script>
<script src="/8c2314fc.0663e26a.js"></script>
</body>
</html>