<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Blog | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="Blog | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.a30a8c8e.css">
<link rel="preload" href="/styles.abcb43ba.js" as="script">
<link rel="preload" href="/runtime~main.333857ee.js" as="script">
<link rel="preload" href="/main.cedb1112.js" as="script">
<link rel="preload" href="/1.b4966bec.js" as="script">
<link rel="preload" href="/2.45eb8537.js" as="script">
<link rel="preload" href="/a6aa9e1f.16952003.js" as="script">
<link rel="preload" href="/c3b5bd8c.985f0121.js" as="script">
<link rel="preload" href="/9e16dc16.7798d1bf.js" as="script">
<link rel="preload" href="/3fde0b39.6680c3ff.js" as="script">
<link rel="preload" href="/c741b9e4.28cb2d0e.js" as="script">
<link rel="preload" href="/0a4541fe.fea080d1.js" as="script">
<link rel="preload" href="/32cba561.ca0734d4.js" as="script">
<link rel="preload" href="/e0812a81.f25c4a3d.js" as="script">
<link rel="preload" href="/22119250.a5038537.js" as="script">
<link rel="preload" href="/94977d73.2ade51ca.js" as="script">
<link rel="preload" href="/d76b298c.6a32ccf5.js" as="script">
<link rel="preload" href="/7d658055.831d1391.js" as="script">
<link rel="preload" href="/96adae60.806b73ab.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">üåû</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/03/10/managed-identity-azure-sql-entity-framework">Managed Identity, Azure SQL and Entity Framework</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/03/06/generate-typescript-and-csharp-clients-with-nswag">Generate TypeScript and CSharp clients with NSwag based on an API</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure">Goodbye Client Affinity, Hello Data Protection with Azure</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service">Making Easy Auth tokens survive releases on Linux Azure App Service</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/02/11/azure-app-service-health-checks-and-zero-downtime-deployments">Azure App Service, Health checks and zero downtime deployments</a></li></ul></div></div><main class="col col--8"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/2013/02/18/unit-testing-mvc-controllers-mocking">Unit testing MVC controllers / Mocking UrlHelper</a></h2><div class="margin-vert--md"><time datetime="2013-02-18T00:00:00.000Z" class="blogPostDate_Ta7i">February 18, 2013  ¬∑ 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="i-have-put-a-name-to-my-pain"></a>I have put a name to my pain...<a class="hash-link" href="#i-have-put-a-name-to-my-pain" title="Direct link to heading">#</a></h2><p> And it is unit testing ASP.Net MVC controllers.</p><p>Well perhaps that&#x27;s unfair. I have no problem unit testing MVC controllers.... <strong>until</strong> it comes to making use of the &quot;innards&quot; of MVC. Let me be more specific. This week I had a controller action that I needed to test. It looked a little like this:</p><script src="https://gist.github.com/johnnyreilly/4959924.js?file=DemoController.cs"></script><p>Looks fine right? It&#x27;s an action that takes a simple object as an argument. That&#x27;s ok. It returns a JsonResult. No worries. The JsonResult consists of an anonymous class. De nada. The anonymous class has one property that is driven by the controllers <code>UrlHelper</code>. Yeah that shouldn&#x27;t be an issue... <strong>Hold your horses sunshine - you&#x27;re going nowhere!</strong></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="getting-disillusioned"></a>Getting disillusioned<a class="hash-link" href="#getting-disillusioned" title="Direct link to heading">#</a></h2><p>Yup, the minute you start pumping in asserts around that <code>UrlHelper</code> driven property you&#x27;re going to be mighty disappointed. What, you didn&#x27;t expect the result to be <code>null</code>? Damn shame.</p><p>Despite <a href="http://msdn.microsoft.com/en-us/magazine/dd942838.aspx" target="_blank" rel="noopener noreferrer">articles</a> on MSDN about how the intention is for MVC to be deliberately testable the sad fact of the matter is that there is a yawning hole around the testing support for controllers in ASP.Net MVC. Whenever you try to test something that makes use of controller &quot;gubbins&quot; you have <strong>serious</strong> problems. And unfortunately I didn&#x27;t find anyone out there who could offer the whole solution.</p><p>After what I can best describe as a day of pain I found a way to scratch my particular itch. I found a way to write unit tests for controllers that made use of UrlHelper. As a bonus I managed to include the unit testing of Routes and Areas (well kind of) too.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="mvcmockcontrollers-updated"></a>MvcMockControllers updated<a class="hash-link" href="#mvcmockcontrollers-updated" title="Direct link to heading">#</a></h2><p>This solution is heavily based on the work of Scott Hanselman who <a href="http://www.hanselman.com/blog/ASPNETMVCSessionAtMix08TDDAndMvcMockHelpers.aspx" target="_blank" rel="noopener noreferrer">wrote and blogged about <code>MvcMockHelpers</code></a> back in 2008. Essentially I&#x27;ve taken this and tweaked it so I could achieve my ends. My version of <code>MvcMockHelpers</code> looks a little like this:</p><script src="https://gist.github.com/johnnyreilly/4959924.js?file=MvcMockHelpers.cs"></script><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="what-i-want-to-test"></a>What I want to test<a class="hash-link" href="#what-i-want-to-test" title="Direct link to heading">#</a></h2><p>I want to be able to unit test the controller <code>Edit</code> method I mentioned earlier. This method calls the <code>Action</code> method on the controllers <code>Url</code> member (which is, in turn, a <code>UrlHelper</code>) to generate a URL for passing pack to the client. The URL generated should fit with the routing mechanism I have set up. In this case the route we expect a URL for was mapped by the following area registration:</p><script src="https://gist.github.com/johnnyreilly/4959924.js?file=DemoAreaRegistration.cs"></script><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="enough-of-the-waffle---show-me-a-unit-test"></a>Enough of the waffle - show me a unit test<a class="hash-link" href="#enough-of-the-waffle---show-me-a-unit-test" title="Direct link to heading">#</a></h2><p>Now to the meat; here&#x27;s a unit test which demonstrates how this is used:</p><script src="https://gist.github.com/johnnyreilly/4959924.js?file=UnitTestingAnAreaUsingUrlHelper.cs"></script><p>Let&#x27;s go through this unit test and breakdown what&#x27;s happening:</p><ol><li>Arrange</li><li>Act</li><li>Assert</li></ol><p>The most interesting thing you&#x27;ll note is the controller&#x27;s UrlHelper is now generating a URL as we might have hoped. The URL is generated making use of our routing, yay! Finally we&#x27;re also managing to unit test a route registered by our area.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/mvc">MVC</a><a class="margin-horiz--sm" href="/tags/unit-testing">unit testing</a><a class="margin-horiz--sm" href="/tags/area-registration-register-all-areas">AreaRegistration.RegisterAllAreas()</a><a class="margin-horiz--sm" href="/tags/moq">MOQ</a><a class="margin-horiz--sm" href="/tags/url-helper">UrlHelper</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/2013/02/13/using-expressions-with-constructors">Using Expressions with Constructors</a></h2><div class="margin-vert--md"><time datetime="2013-02-13T00:00:00.000Z" class="blogPostDate_Ta7i">February 13, 2013  ¬∑ 2 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>Every now and then you think &quot;x should be easy&quot; - and it isn&#x27;t. I had one of those situations this morning. Something I thought would take 5 minutes had me still pondering 30 minutes later. I finally cracked it (with the help of a colleague - thanks Marc!) and I wanted to note down what I did since I&#x27;m sure to forget this.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="so-whats-the-problem"></a>So what&#x27;s the problem?<a class="hash-link" href="#so-whats-the-problem" title="Direct link to heading">#</a></h2><p>In our project we had a very simple validation class. It looked a bit like this:</p><script src="https://gist.github.com/johnnyreilly/4944545.js?file=FieldValidationBefore.cs"></script><p>I wanted to take this class and extend it to have a constructor which allowed me to specify a Type and subsequently an Expression of that Type that allowed me to specify a property. 10 points if you read the last sentence and understood it without reading it a second time.</p><p>Code is a better illustration; take a look below. I wanted to go from #1 to #2:</p><script src="https://gist.github.com/johnnyreilly/4944545.js?file=HowItIsUsed.cs"></script><p>&quot;Why?&quot; I hear you ask. Well we had a swathe of statements in the code which test each property for a problem and would create a <code>FieldValidation</code> with the very same property name if one was found. There&#x27;s no real problem with that but I&#x27;m a man that likes to refactor. Property names change and I didn&#x27;t want to have to remember to manually go through each <code>FieldValidation</code> keeping these in line. If I was using the actual property name to drive the creation of my <code>FieldValidations</code> then that problem disappears. And I like that.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="so-whats-the-solution"></a>So what&#x27;s the solution?<a class="hash-link" href="#so-whats-the-solution" title="Direct link to heading">#</a></h2><p>Well it&#x27;s this:</p><script src="https://gist.github.com/johnnyreilly/4944545.js?file=FieldValidationAfter.cs"></script><p>As you can see we have taken the original FieldValidation class and added in a generic constructor which instead of taking <code>string fieldName</code> as a first argument it takes <code>Expression&amp;lt;Func&amp;lt;T, object&amp;gt;&amp;gt; expression</code>. LINQ&#x27;s Expression magic is used to determine the supplied property name which is smashing. If you were wondering, the first <code>MemberExpression</code> code is used for <em>reference</em> types. The <code>UnaryExpression</code> wrapping a <code>MemberExpression</code> code is used for <em>value</em> types. A good explanation of this can be found <a href="http://stackoverflow.com/a/12975480/761388" target="_blank" rel="noopener noreferrer">here</a>.</p><p>My colleague directed me to <a href="http://stackoverflow.com/a/2916344" target="_blank" rel="noopener noreferrer">this crucial StackOverflow answer</a> which provided some much needed direction when I was thrashing. And that&#x27;s it; we&#x27;re done, home free.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/expression">Expression</a><a class="margin-horiz--sm" href="/tags/constructors">Constructors</a><a class="margin-horiz--sm" href="/tags/generic">Generic</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/2013/01/14/twitterbootstrapmvc4-meet-bootstrap_14">Twitter.Bootstrap.MVC4 meet Bootstrap Datepicker *and* get your Internationalization on...</a></h2><div class="margin-vert--md"><time datetime="2013-01-14T00:00:00.000Z" class="blogPostDate_Ta7i">January 14, 2013  ¬∑ 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p><a href="http://icanmakethiswork.blogspot.co.uk/2013/01/twitterbootstrapmvc4-meet-bootstrap.html" target="_blank" rel="noopener noreferrer">Last time</a> I wrote about marrying up Twitter.Bootstrap.MVC4 and Bootstrap Datepicker. It came together quite nicely but when I took a more in depth look at what I&#x27;d done I discovered a problem. The brief work on regionalisation / internationalisation / localisation / globalisation / whatever it&#x27;s called this week... wasn&#x27;t really working. We had problems with the validation.</p><p> I also discovered that Stefan Petre&#x27;s Bootstrap Datepicker appears to have been abandoned. Andrew Rowls has taken it on and created a GitHub repository for it <a href="https://github.com/eternicode/bootstrap-datepicker" target="_blank" rel="noopener noreferrer">here</a>. Besides bug fixes he&#x27;s also introduced the ability for the Bootstrap Datepicker to customised for different cultures.</p><p>Since these 2 subjects are linked I tackled them together and thought it might be worth writing up here. You can find the conclusion of my work in a GitHub repository I created <a href="https://github.com/johnnyreilly/BootstrapMvcSample" target="_blank" rel="noopener noreferrer">here</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="going-global-down-in-acapulco"></a>Going global down in Acapulco<a class="hash-link" href="#going-global-down-in-acapulco" title="Direct link to heading">#</a></h2><p>First step in internationalising any ASP.Net web app is adding the following to the <code>web.config</code>:</p><script src="https://gist.github.com/4528994.js?file=web.config"></script><p>Then I pulled <a href="https://github.com/jquery/globalize" target="_blank" rel="noopener noreferrer">Globalize</a> and the <a href="https://github.com/eternicode/bootstrap-datepicker" target="_blank" rel="noopener noreferrer">Andrew Rowls fork of Bootstrap Datepicker</a> into the project (replacing Stefan&#x27;s original assets). As well as this I pulled in the <code>jQuery.validate.globalize.js</code> extension <a href="http://icanmakethiswork.blogspot.co.uk/2012/09/globalize-and-jquery-validate.html" target="_blank" rel="noopener noreferrer">I wrote about here</a>. (This replaces some of the default jQuery Validate functionality for culture-specific functionality based on Globalize.) This extension depends on a meta tag that is generated using the following file (which also handles the serving up of the relevant JavaScript culture bundles, more of which shortly):</p><script src="https://gist.github.com/4528994.js?file=GlobalizationHelpers.cs"></script><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="culture-specific-script-bundles"></a>Culture-specific script bundles<a class="hash-link" href="#culture-specific-script-bundles" title="Direct link to heading">#</a></h2><p>With all of my dependancies in place I was now ready to press on. Since both Globalize and the new Bootstrap Datepicker come with their own culture-specific JavaScript files it seemed a good idea to make use of ASP.Nets new bundling functionality. This I did here:</p><script src="https://gist.github.com/4528994.js?file=BootstrapBundleConfig.cs"></script><p>The code above creates a script bundle for each culture when the application starts up. This script bundle contains the culture-specific Globalize and Bootstrap Datepicker JavaScript files. If further culture-specific components were added to the application it would make sense to include these here as well.</p><p><code>_BootstrapLayout.basic.cshtml</code> has been amended to make use of the new bundles and also to include a meta tag that will used to drive regionalisation:</p><script src="https://gist.github.com/4528994.js?file=_BootstrapLayout.basic.cshtml"></script><p>To illustrate how this works, a German user running a machine with the de-DE culture would be served up the following 2 files:</p><ul><li><code>globalize.culture.de-DE.js</code></li><li><code>bootstrap-datepicker.de.js</code></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="where-have-we-got-to"></a>Where have we got to?<a class="hash-link" href="#where-have-we-got-to" title="Direct link to heading">#</a></h2><p>With all this done we have now fixed the validation issues we were experiencing previously. This was done by including the Globalize library, the accept-language meta tag and the jQuery Validate Globalize extensions.</p><p>Besides this we&#x27;ve laid the groundwork for introducing internationalised datepickers by introducing Andrew Rowls fork of the Bootstrap Datepicker. That&#x27;s what we&#x27;ll do next...</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="international-bootstrap-datepicker"></a>International Bootstrap Datepicker<a class="hash-link" href="#international-bootstrap-datepicker" title="Direct link to heading">#</a></h2><p>The final steps of switching over to using a culture-specific date picker are achieved by making a change to the Scripts section in the <code>Create.cshtml</code> file. The existing (and very simple) section should be replaced with this:</p><script src="https://gist.github.com/4528994.js?file=Create.cshtml"></script><p>The script above takes the region from the accept-language meta tag and attempts to look up an associated &quot;language&quot; for the Bootstrap Datepicker. If it finds one it uses it, if not then the default language of &quot;en&quot; / English will be used.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>In this post we:</p><ol><li>fixed the validation issues we&#x27;d introduced by marrying up Twitter.Bootstrap.MVC4 and the Bootstrap Datepicker</li><li>switched over to using the Andrew Rowls fork of Bootstrap Datepicker and made use of the internationalisation functionality it exposes.</li></ol></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/internationalization">Internationalization</a><a class="margin-horiz--sm" href="/tags/twitter-bootstrap-mvc-4">Twitter.Bootstrap.MVC4</a><a class="margin-horiz--sm" href="/tags/globalize-js">Globalize JS</a><a class="margin-horiz--sm" href="/tags/twitter-bootstrap">Twitter Bootstrap</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/2013/01/09/twitterbootstrapmvc4-meet-bootstrap">Twitter.Bootstrap.MVC4 meet Bootstrap Datepicker</a></h2><div class="margin-vert--md"><time datetime="2013-01-09T00:00:00.000Z" class="blogPostDate_Ta7i">January 9, 2013  ¬∑ 4 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="update-14012013"></a>Update 14/01/2013<a class="hash-link" href="#update-14012013" title="Direct link to heading">#</a></h2><p> Since I wrote this I&#x27;ve taken things on a little further - to read about that go <a href="http://icanmakethiswork.blogspot.co.uk/2013/01/twitterbootstrapmvc4-meet-bootstrap_14.html" target="_blank" rel="noopener noreferrer">here</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="getting-responsive"></a>Getting Responsive<a class="hash-link" href="#getting-responsive" title="Direct link to heading">#</a></h2><p>It&#x27;s the new year, it&#x27;s time for new things. Long on my list of &quot;things to do&quot; was getting up to speed with <a href="http://en.wikipedia.org/wiki/Responsive_web_design" target="_blank" rel="noopener noreferrer">Responsive web design</a>. No doubt like everyone else I&#x27;ve been hearing more and more about this over the last year (by the way there was a <a href="http://mashable.com/2012/12/11/responsive-web-design/" target="_blank" rel="noopener noreferrer">good article on Mashable</a> about this last month). RWD (in case you don&#x27;t already know) is pretty much about having web interfaces that format their presentation based on the device they&#x27;re running to provide a good user experience. (I kind of think of it as a <a href="http://en.wikipedia.org/wiki/Write_once,_run_anywhere" target="_blank" rel="noopener noreferrer">write once, run anywhere</a> approach - though hopefully without the negative connotations...)</p><p>Rather than diving straight in myself I&#x27;d heard at a user group that it might be worth taking <a href="http://twitter.github.com/bootstrap/" target="_blank" rel="noopener noreferrer">Twitter Bootstrap</a> as a baseline. I&#x27;m a <strike>lazy</strike></p><p> busy fellow so this sounded ideal.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="i-like-aspnet-mvc"></a>I like ASP.Net MVC...<a class="hash-link" href="#i-like-aspnet-mvc" title="Direct link to heading">#</a></h2><p>... and this flavoured my investigations. I quickly stumbled on an <a href="http://lostechies.com/erichexter/2012/11/20/twitter-bootstrap-mvc4-the-template-nuget-package-for-asp-net-mvc4-projects/%20" target="_blank" rel="noopener noreferrer">article written by Eric Hexter</a>. Eric had brought together Twitter Bootstrap and ASP.Net MVC 4 in a <a href="http://nuget.org/packages/twitter.bootstrap.mvc4" target="_blank" rel="noopener noreferrer">NuGet package</a>. Excellent work chap!</p><p>To get up and running with Eric&#x27;s work was a straightforward proposition. I...</p><ol><li><p>Created new MVC 4 application in Visual Studio called ‚ÄúBootstrapMvcSample‚Äù using the ‚ÄúEmpty‚Äù Project Template.</p></li><li><p>Executed the following commands at the NuGet Package Manager Console: - <code>Install-Package twitter.bootstrap.mvc4</code></p><ul><li><code>Install-Package twitter.bootstrap.mvc4.sample</code></li></ul></li></ol><p>Check out the responsive goodness I had when I ran it:</p><p><img src="http://4.bp.blogspot.com/-2ytMlGLGRpo/UO1mqfi7yQI/AAAAAAAAAYs/RRuVGbr8nAg/s400/TwitterBootstrapFullSize.png"></p><p><img src="http://3.bp.blogspot.com/-780OCEuXoLw/UO1maRJ-CZI/AAAAAAAAAYg/chBHgYMAIJk/s400/TwitterBootstrapTitchyTiny.png"></p><p>This is just 1 page, with <code>@media</code> queries doing the heavy lifting.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="bootstrap-datepicker"></a>Bootstrap Datepicker<a class="hash-link" href="#bootstrap-datepicker" title="Direct link to heading">#</a></h2><p>The eagle-eyed amongst you will have noticed that the edit screen above features a date field. I&#x27;ve long been a fan of datepickers to allow users to enter a date in an application in an intuitive fashion. Until native browser datepickers become the norm we&#x27;ll be relying on some kind of component. Up until now my datepicker of choice has been the <a href="http://jqueryui.com/datepicker/" target="_blank" rel="noopener noreferrer">jQuery UI one</a>. Based on a quick Google it seemed that jQuery UI and Twitter Bootstrap were not necessarily natural bedfellows. (Though <a href="http://addyosmani.github.com/jquery-ui-bootstrap/" target="_blank" rel="noopener noreferrer">Addy Osmani&#x27;s jQuery UI Bootstrap</a> shows some promise...)</p><p>Since I feared ending up down a blind alley I found myself casting around for a Twitter Bootstrap datepicker. I quickly happened upon <a href="http://www.eyecon.ro/bootstrap-datepicker/" target="_blank" rel="noopener noreferrer">Stefan Petre&#x27;s Bootstrap Datepicker</a> which looked just the ticket.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="shake-hands-and-play-nice"></a>Shake hands and play nice...<a class="hash-link" href="#shake-hands-and-play-nice" title="Direct link to heading">#</a></h2><p>Incorporating the Bootstrap Datepicker into Twitter.Bootstrap.MVC4 was actually a pretty straightforward affair. I added the following datepicker assets to the ASP.Net MVC project as follows:</p><ul><li><code>bootstrap-datepicker.js</code> was added to <code>~\Scripts</code>.</li><li><code>datepicker.css</code> was added to <code>~\Content</code>. I renamed this file to <code>bootstrap-datepicker.css</code> to stay in line with the other css files.</li></ul><p>Once this was done I amended the <code>BootstrapBundleConfig.cs</code> bundles to include these assets. Once this was done the bundle file looked like this:</p><script src="https://gist.github.com/4529746.js?file=BootstrapBundleConfig.cs"></script><p>I then created this folder:<code>~\Views\Shared\EditorTemplates</code>. To this folder I added the following <code>Date.cshtml</code> Partial to hold the datepicker EditorTemplate: (Having this in place meant that properties with the <code>[DataType(DataType.Date)]</code> attribute would automatically use this EditorTemplate when rendering an editor - I understand <code>[UIHint]</code> attributes can be used to the same end.)</p><script src="https://gist.github.com/4529746.js?file=Date.cshtml"></script><p>And finally I amended the <code>Create.cshtml</code> View (which perhaps more accurately might be called the Edit View?) to include a bit of JavaScript at the bottom to initialise any datepickers on the screen.</p><script src="https://gist.github.com/4529746.js?file=Create.cshtml"></script><p>Et voil√† - it works!</p><p><img src="http://4.bp.blogspot.com/-_SfaYN2dfuk/UO2JmrqO_gI/AAAAAAAAAZA/Y904hmwcqaI/s400/TwitterBootstrapDatepicker.png"></p><p>My thanks to <a href="https://twitter.com/ehexter" target="_blank" rel="noopener noreferrer">Eric Hexter</a> and Stefan Petre for doing all the hard work!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="still-to-do"></a>Still to do<a class="hash-link" href="#still-to-do" title="Direct link to heading">#</a></h2><p>I haven&#x27;t really tested how this all fits together (if at all) with browsers running a non-English culture. There may still be a little tinkering require to get that working...</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/asp-net-mvc">asp.net mvc</a><a class="margin-horiz--sm" href="/tags/twitter-bootstrap-mvc-4">Twitter.Bootstrap.MVC4</a><a class="margin-horiz--sm" href="/tags/responsive">Responsive</a><a class="margin-horiz--sm" href="/tags/twitter-bootstrap">Twitter Bootstrap</a><a class="margin-horiz--sm" href="/tags/bootstrap-datepicker">Bootstrap Datepicker</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/2013/01/03/html-to-pdf-using-wcf-service">HTML to PDF using a WCF Service</a></h2><div class="margin-vert--md"><time datetime="2013-01-03T00:00:00.000Z" class="blogPostDate_Ta7i">January 3, 2013  ¬∑ 4 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="tl-dr---talk-is-cheap-show-me-the-code"></a>TL; DR - &quot;Talk is cheap. Show me the code.&quot;<a class="hash-link" href="#tl-dr---talk-is-cheap-show-me-the-code" title="Direct link to heading">#</a></h2><p> Some time ago I wrote a <a href="http://icanmakethiswork.blogspot.com/2012/04/making-pdfs-from-html-in-c-using.html" target="_blank" rel="noopener noreferrer">post which demonstrated how you could make PDFs from HTML</a> using C# and <a href="http://code.google.com/p/wkhtmltopdf/" target="_blank" rel="noopener noreferrer">wkhtmltopdf</a>. To my lasting surprise this has been the most popular post I&#x27;ve written. I recently put together an ASP.NET WCF service which exposed this functionality which I thought might be worth sharing. The code can be found on GitHub <a href="https://github.com/johnnyreilly/PdfMakerWcfService" target="_blank" rel="noopener noreferrer">here</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="a-little-more-detail"></a>A little more detail<a class="hash-link" href="#a-little-more-detail" title="Direct link to heading">#</a></h2><p>I should say up front that I&#x27;m still a little ambivalent about how sensible an idea this is. Behind the scenes this WCF service is remotely firing up wkhtmltopdf using <code>System.Diagnostics.Process</code>. I feel a little wary about recommending this as a solution for a variety of not particularly defined reasons. However, I have to say I&#x27;ve found this pretty stable and reliable. Bottom line it seems to work and work consistently. But I though I should include a caveat emptor; there is probably a better approach than this available. Anyway...</p><p>There isn&#x27;t actually a great deal to say about this WCF service. It should (hopefully) just do what it says on the tin. Putting it together didn&#x27;t involve a great deal of work; essentially it takes the code from the initial blog post and just wraps it in a WCF service called <code>PdfMaker</code>. The service exposes 2 methods:</p><ol><li><code>GetPdf</code> - given a supplied URL this method creates a PDF and then returns it as a Stream to the client</li><li><code>GetPdfUrl</code> - given a supplied URL this method creates a PDF and then returns the location of it to the client</li></ol><p>Both of these methods also set a Location header in the response indicating the location of the created PDF.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="that-which-binds-us"></a>That which binds us<a class="hash-link" href="#that-which-binds-us" title="Direct link to heading">#</a></h2><p>The service uses <code>webHttpBinding</code>. This is commonly employed when people want to expose a RESTful WCF service. The reason I&#x27;ve used this binding is I wanted a simple &quot;in&quot; when calling the service. I wanted to be able to call the service via AJAX as well as directly by browsing to the service and supplying a URL-encoded URL like this:</p><p><code>http://localhost:59002/PdfMaker.svc/GetPdf?url=http%3A%2F%2Fnews.ycombinator.com/</code>You may wonder why I&#x27;m using <a href="http://news.ycombinator.com" target="_blank" rel="noopener noreferrer">http://news.ycombinator.com</a> for the example above. I chose this as Hacker News is a very simple site; very few resources and a small page size. This means the service has less work to do when creating the PDF; it&#x27;s a quick demo.</p><p>I should say that this service is arguably **not** completely RESTful as each GET operation behind the scenes attempts to create a new PDF (arguably a side-effect). These should probably be POST operations as they create a new resource each time they&#x27;re hit. However, if they were I wouldn&#x27;t be able to just enter a URL into a browser for testing and that&#x27;s really useful. So tough, I shake my fist at the devotees of pure REST on this occasion. (If I should be attacked in the street shortly after this blog is posted then the police should be advised this is good line of inquiry...)</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="good-behaviour"></a>Good behaviour<a class="hash-link" href="#good-behaviour" title="Direct link to heading">#</a></h2><p>It&#x27;s worth noting that <code>automaticFormatSelectionEnabled</code> set to true on the behaviour so that content negotiation is enabled. Obviously for the <code>GetPdf</code> action this is rather meaningless as it&#x27;s a stream that&#x27;s passed back. However, for the <code>GetPdfUrl</code> action the returned string can either be JSON or XML. The Fiddler screenshots below demonstrate this in action:</p><p><img src="http://4.bp.blogspot.com/-CX7w0jI0jTE/UOVaDP5Ae-I/AAAAAAAAAXk/H7zhyYYjPGA/s400/GetPdfUrl%2B-%2BJSON.png"></p><p><img src="http://4.bp.blogspot.com/-78GBDqI596I/UOVaTchTbBI/AAAAAAAAAXw/rz2Dg4g8BRs/s400/GetPdfUrl%2B-%2BXML.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="test-harness"></a>Test Harness<a class="hash-link" href="#test-harness" title="Direct link to heading">#</a></h2><p>As a final touch I added in a test harness in the form of <code>Demo.aspx</code>. If you browse to it you&#x27;ll see a screen a little like this:</p><p><img src="http://2.bp.blogspot.com/-zoyt7ufl9FQ/UOVmD0VPh0I/AAAAAAAAAYE/DnmZmbx-Mxc/s400/PdfMakerDemo.png"></p><p>It&#x27;s fairly self-explanatory as you can see. And here&#x27;s an example of the output generated when pointing at Hacker News:</p><iframe src="https://docs.google.com/file/d/0B87K8-qxOZGFMGNCUWRneUFsVFU/preview" width="500" height="500"></iframe><p>And that&#x27;s it. If there was a need this service could be easily extended to leverage the <a href="http://madalgo.au.dk/~jakobt/wkhtmltoxdoc/wkhtmltopdf-0.9.9-doc.html" target="_blank" rel="noopener noreferrer">various options</a> that wkhtmltopdf makes available. Hope people find it useful.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/wkhtmltopdf">wkhtmltopdf</a><a class="margin-horiz--sm" href="/tags/html">html</a><a class="margin-horiz--sm" href="/tags/wcf">WCF</a><a class="margin-horiz--sm" href="/tags/pdf">pdf</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/2012/11/13/a-nicer-net-api-for-bloombergs-open-api">Getting up to speed with Bloomberg&#x27;s Open API...</a></h2><div class="margin-vert--md"><time datetime="2012-11-13T00:00:00.000Z" class="blogPostDate_Ta7i">November 13, 2012  ¬∑ 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>A good portion of any devs life is usually spent playing with APIs. If you need to integrate some other system into the system you&#x27;re working on (and it&#x27;s rare to come upon a situation where this doesn&#x27;t happen at some point) then it&#x27;s API time.</p><p> Some APIs are well documented and nice to use. Some aren&#x27;t. I recently spent a goodly period of time investigating <a href="http://www.openbloomberg.com/open-api/" target="_blank" rel="noopener noreferrer">Bloomberg&#x27;s Open API</a> and it was a slightly painful experience. So much so that I thought it best to write up my own experiences and maybe I can save others time and a bit of pain.</p><p>Also, as I investigated the Bloomberg Open API I found myself coming up with my own little mini-C#-API. (It&#x27;s generally a sure sign you&#x27;ve found an API you don&#x27;t love if you end up writing your own wrapper.) This mini API did the heavy lifting for me and just handed back nicely structured data to deal with. I have included this wrapper here as well.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="research"></a>Research<a class="hash-link" href="#research" title="Direct link to heading">#</a></h2><p>The initial plan was to, through code, extract Libor and Euribor rates from Bloomberg. I had access to a Bloomberg terminal and I had access to the internet - what could stop me? After digging around for a little while I found some useful resources that could be accessed from the Bloomberg terminal:</p><ol><li>Typing ‚Äú<code>WAPI&amp;lt;GO&amp;gt;</code>‚Äù into Bloomberg lead me to the Bloomberg API documentation.</li><li>Typing ‚Äú<code>DOCS 2055451&amp;lt;GO&amp;gt;</code>‚Äù into Bloomberg (I know - it&#x27;s a bit cryptic) provided me with samples of how to use the Bloomberg API in VBA</li></ol><p><img src="http://4.bp.blogspot.com/-mZxP0-jXRIo/UKJ8y8Gs5AI/AAAAAAAAAW0/qNyIN9hGBiQ/s400/bloombergwapidocumentation.gif"></p><p>To go with this I found some useful documentation of the Bloomberg Open API <a href="http://www.openbloomberg.com/files/2012/10/blpapi-developers-guide.pdf" target="_blank" rel="noopener noreferrer">here</a> and I found the .NET Bloomberg Open API itself <a href="http://www.openbloomberg.com/open-api/" target="_blank" rel="noopener noreferrer">here</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="hello-world"></a>Hello World?<a class="hash-link" href="#hello-world" title="Direct link to heading">#</a></h2><p>The first goal when getting up to speed with an API is getting it to do something. Anything. Just stick a fork into it and see if it croaks. Sticking a fork into Open API was achieved by taking the 30-odd example apps included in the Bloomberg Open API and running each in turn on the Bloomberg box until I had my &quot;he&#x27;s alive!!&quot; moment. (I did find it surprising that not all of the examples worked - I don&#x27;t know if there&#x27;s a good reason for this...)</p><p>However, when I tried to write my own C# console application to interrogate the Open API it wasn&#x27;t as plain sailing as I&#x27;d hoped. I&#x27;d write something that looked correct, compiled successfully and deploy it onto the Bloomberg terminal only to have it die a sad death whenever I tried to fire it off.</p><p>I generally find the fastest way to get up and running with an API is to debug it. To make calls to the API and then examine, field by field and method by method, what is actually there. This wasn&#x27;t really an option with my console app though. I was using a shared Bloomberg terminal with very limited access. No Visual Studio on the box and no remote debugging enabled.</p><p>It was then that I had something of a eureka moment. I realised that the code in the VBA samples I&#x27;d downloaded from Bloomberg looked quite similar to the C# code samples that shipped with Open API. Hmmmm.... Shortly after this I found myself sat at the Bloomberg machine debugging the Bloomberg API using the VBA IDE in Excel. (For the record, these debugging tools are aren&#x27;t too bad at all - they&#x27;re nowhere near as slick as their VS counterparts but they do the job.) This was my <a href="http://en.wikipedia.org/wiki/Rosetta_Stone" target="_blank" rel="noopener noreferrer">Rosetta Stone</a> - I could take what I&#x27;d learned from the VBA samples and translate that into equivalent C# / .NET code (bearing in mind what I&#x27;d learned from debugging in Excel and in fact sometimes bringing along the VBA comments themselves if they provided some useful insight).</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="hes-the-bloomberg-im-the-wrapper"></a>He&#x27;s the Bloomberg, I&#x27;m the Wrapper<a class="hash-link" href="#hes-the-bloomberg-im-the-wrapper" title="Direct link to heading">#</a></h2><p>So I&#x27;m off and romping... I have something that works. Hallelujah! Now that that hurdle had been crossed I found myself examining the actual Bloomberg API code itself. It functioned just fine but it did a couple of things that I wasn&#x27;t too keen on:</p><ol><li>The Bloomberg API came with custom data types. I didn&#x27;t want to use these unless it was absolutely necessary - I just wanted to stick to the standard .NET types. This way if I needed to hand data onto another application I wouldn&#x27;t be making each of these applications dependant on the Bloomberg Open API.</li><li>To get the data out of the Bloomberg API there was an awful lot of boilerplate. Code which handled the possibilities of very large responses that might be split into several packages. Code which walked the element tree returned from Bloomberg parsing out the data. It wasn&#x27;t a beacon of simplicity.</li></ol><p>I wanted an API that I could simply invoke with security codes and required fields. And in return I wanted to be passed nicely structured data. As I&#x27;ve already mentioned a desire to not introduce unnecessary dependencies I thought it might well suit to make use of nested Dictionaries. I came up with a simple C# Console project / application which had a reference to the Bloomberg Open API. It contained the following class; essentially my wrapper for Open API operations: (please note this is deliberately a very &quot;bare-bones&quot; implementation)</p><script src="https://gist.github.com/4065815.js?file=BloombergApi.cs"></script><p>The project also contained this class which demonstrates how I made use of my wrapper:</p><script src="https://gist.github.com/4065815.js?file=NicerBloombergApiDemo.cs"></script><p>And here&#x27;s what the output looked like:</p><p><img src="http://1.bp.blogspot.com/-1ghUYqbl0AE/UKJ_3vsuKqI/AAAAAAAAAXI/pPKR5dup48U/s400/Bloomberg.png"></p><p>This covered my bases. It was simple, it was easy to consume and it didn&#x27;t require any custom types. My mini-API is only really catering for my own needs (unsurprisingly). However, there&#x27;s lots more to the Bloomberg Open API and I may end up taking this further in the future if I encounter use cases that my current API doesn&#x27;t cover.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="update-07122012"></a>Update (07/12/2012)<a class="hash-link" href="#update-07122012" title="Direct link to heading">#</a></h2><p>Finally, a PS. I found in the <a href="http://www.openbloomberg.com/faq/" target="_blank" rel="noopener noreferrer">Open API FAQs</a> that <em>&quot;Testing any of that functionality currently requires a valid Bloomberg Desktop API (DAPI), Server API (SAPI) or Managed B-Pipe subscription. Bloomberg is planning on releasing a stand-alone simulator which will not require a subscription.&quot;</em> There isn&#x27;t any word yet on this stand-alone simulator. I emailed Bloomberg at <a href="mailto:open-tech@bloomberg.net" target="_blank" rel="noopener noreferrer">open-tech@bloomberg.net</a> to ask about this. They kindly replied that <em>&quot;Unfortunately it is not yet available. We understand that this makes testing API applications somewhat impractical, so we&#x27;re continuing to work on this tool.&quot;</em> Fingers crossed for something we can test soon!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="note-to-self-because-i-keep-forgetting"></a>Note to self (because I keep forgetting)<a class="hash-link" href="#note-to-self-because-i-keep-forgetting" title="Direct link to heading">#</a></h2><p>If you&#x27;re looking to investigate what data is available about a security in Bloomberg it&#x27;s worth typing ‚Äú<code>FLDS&amp;lt;GO&amp;gt;</code>‚Äù into Bloomberg. This is the Bloomberg Fields Finder. Likewise, if you&#x27;re trying to find a security you could try typing ‚Äú<code>SECF&amp;lt;GO&amp;gt;</code>‚Äù into Bloomberg as this is the Security Finder.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/net">.NET</a><a class="margin-horiz--sm" href="/tags/c">c#</a><a class="margin-horiz--sm" href="/tags/bloomberg">Bloomberg</a><a class="margin-horiz--sm" href="/tags/open-api">Open API</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/2012/11/02/xsdxml-schema-generator-xsdexe-taking">XSD/XML Schema Generator + Xsd.exe:Taking the pain out of manual XML</a></h2><div class="margin-vert--md"><time datetime="2012-11-02T00:00:00.000Z" class="blogPostDate_Ta7i">November 2, 2012  ¬∑ 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="is-it-2003-again"></a>Is it 2003 again?!?<a class="hash-link" href="#is-it-2003-again" title="Direct link to heading">#</a></h2><p> I&#x27;ve just discovered Xsd.exe. It&#x27;s not new. Or shiny. And in fact it&#x27;s been around since .NET 1.1. Truth be told, I&#x27;ve been aware of it for years but up until now I&#x27;ve not had need of it. But now now I&#x27;ve investigated it a bit I&#x27;ve found that it, combined with the XSD/XML Schema Generator can make for a nice tool to add to the utility belt.</p><p>Granted XML has long since stopped being sexy. But if you need it, as I did recently, then this is for you.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="to-the-xml-batman"></a>To the XML Batman!<a class="hash-link" href="#to-the-xml-batman" title="Direct link to heading">#</a></h2><p>Now XML is nothing new to me (or I imagine anyone who&#x27;s been developing within the last 10 years). But most of the time when I use XML I&#x27;m barely aware that it&#x27;s going on - by and large it&#x27;s XML doing the heavy lifting underneath my web services. But the glory of this situation is, I never have to think about it. It just works. All I have to deal with are nice strongly typed objects which makes writing robust code a doddle.</p><p>I recently came upon a situation where I was working with XML in the raw; that is to say strings. I was going to be supplied with strings of XML which would represent various objects. It would be my job to take the supplied XML, extract out the data I needed and proceed accordingly.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="we-dont-need-no-validation"></a>We Don&#x27;t Need No Validation...<a class="hash-link" href="#we-dont-need-no-validation" title="Direct link to heading">#</a></h2><p>I lied!</p><p>In order to write something reliable I needed to be able to validate that the supplied XML was as I expected. So, <a href="http://en.wikipedia.org/wiki/XML_Schema_(W3C)" target="_blank" rel="noopener noreferrer">XSD</a> time. If you&#x27;re familiar with XML then you&#x27;re probably equally familar with XSD which, to quote Wikipedia <em>&quot;can be used to express a set of rules to which an XML document must conform in order to be considered &#x27;valid&#x27;&quot;</em>.</p><p>Now I&#x27;ve written my fair share of XSDs over the years and I&#x27;ve generally found it a slightly tedious exercise. So I was delighted to discover an online tool to simplify the task. It&#x27;s called the <a href="http://www.freeformatter.com/xsd-generator.html" target="_blank" rel="noopener noreferrer">XSD/XML Schema Generator</a>. What this marvellous tool does is allow you to enter an example of your XML which it then uses to reverse engineer an XSD.</p><p>Here&#x27;s an example. I plugged in this:</p><script src="https://gist.github.com/4000326.js?file=contact.xml"></script><p>And pulled out this:</p><script src="https://gist.github.com/4000326.js?file=contact.xsd"></script><p>Fantastic! It doesn&#x27;t matter if the tool gets something slightly wrong; you can tweak the generated XSD to your hearts content. This is great because it does the hard work for you, allowing you to step back, mop your brow and then heartily approve the results. This tool is a labour saving device. Put simply, it&#x27;s a dishwasher.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="tools-of-the-trade"></a>Tools of the Trade<a class="hash-link" href="#tools-of-the-trade" title="Direct link to heading">#</a></h2><p>How to get to the actual data? I was initially planning to break out the <a href="http://msdn.microsoft.com/en-us/library/system.xml.linq.xdocument(v=vs.100).aspx" target="_blank" rel="noopener noreferrer"><code>XDocument</code></a>, plug in my XSD and use the <code>Validate</code> method. Which would do the job just dandy.</p><p>However I resisted. As much as I like LINQ to XML I turned to use <a href="http://msdn.microsoft.com/en-us/library/x6c1kb0s(v=vs.100).aspx" target="_blank" rel="noopener noreferrer">Xsd.exe</a> instead. As I&#x27;ve mentioned, this tool is as old as the hills. But there&#x27;s gold in them thar hills, listen: <em>&quot;The XML Schema Definition (Xsd.exe) tool generates XML schema or common language runtime classes from XDR, XML, and XSD files, or from classes in a runtime assembly.&quot;</em></p><p>Excited? Thought not. But what this means is we can hurl our XSD at this tool and it will toss back a nicely formatted C# class for me to use. Good stuff! So how&#x27;s it done? Well MSDN is roughly as informative as it ever is (which is to say, not terribly) but fortunately there&#x27;s not a great deal to it. You fire up the Visual Studio Command Prompt (and I advise doing this in Administrator mode to escape permissions pain). Then you enter a command to generate your class. Here&#x27;s an example using the Contact.xsd file we generated earlier:</p><p><code>xsd.exe &quot;C:\\Contact.xsd&quot; /classes /out:&quot;C:\\&quot; /namespace:&quot;MyNameSpace&quot;</code>Generation looks like this:</p><p><img src="http://1.bp.blogspot.com/-TR-eaxshZo8/UJPclxs8JjI/AAAAAAAAAWg/TNKZuyi-8NU/s400/XsdInAction.png"></p><p>And you&#x27;re left with the lovely Contact.cs class:</p><script src="https://gist.github.com/4000326.js?file=Contact.cs"></script><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="justify-your-actions"></a>Justify Your Actions<a class="hash-link" href="#justify-your-actions" title="Direct link to heading">#</a></h2><p>But why is this good stuff? Indeed why is this more interesting than the newer, and hence obviously cooler, LINQ to XML? Well for my money it&#x27;s the following reasons that are important:</p><ol><li>Intellisense - I have always loved this. Call me lazy but I think intellisense frees up the mind to think about what problem you&#x27;re actually trying to solve. Xsd.exe&#x27;s generated classes give me that; I don&#x27;t need to hold the whole data structure in my head as I code.</li><li>Terse code - I&#x27;m passionate about less code. I think that a noble aim in software development is to write as little code as possible in order to achieve your aims. I say this as generally I have found that writing a minimal amount of code expresses the intention of the code in a far clearer fashion. In service of that aim Xsd.exe&#x27;s generated classes allow me to write less code than would be required with LINQ to XML.</li><li>To quote Scott Hanselman &quot;<a href="http://www.hanselman.com/blog/NuGetPackageOfTheWeek6DynamicMalleableEnjoyableExpandoObjectsWithClay.aspx" target="_blank" rel="noopener noreferrer">successful compilation is just the first unit test</a>&quot;. That it is but it&#x27;s a doozy. If I&#x27;m making changes to the code and I&#x27;ve been using LINQ to XML I&#x27;m not going to see the benefits of strong typing that I would with Xsd.exe&#x27;s generated classes. I like learning if I&#x27;ve broken the build sooner rather than later; strong typing gives me that safety net.</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="serialization--deserialization-helper"></a>Serialization / Deserialization Helper<a class="hash-link" href="#serialization--deserialization-helper" title="Direct link to heading">#</a></h2><p>As you read this you&#x27;re no doubt thinking &quot;but wait he&#x27;s shown us how to create XSDs from XML and classes from XSDs but how do we take XML and turn it into objects? And how do we turn those objects back into XML?&quot;</p><p>See how I read your mind just there? It&#x27;s a gift. Well, I&#x27;ve written a little static helper class for the very purpose:</p><script src="https://gist.github.com/4000326.js?file=XmlConverter.cs"></script><p>And here&#x27;s an example of how to use it:</p><script src="https://gist.github.com/4000326.js?file=XmlConverterUsage.cs"></script><p>I was tempted to name my methods in tribute to Crockford&#x27;s JSON (namely <code>ToXML</code> becoming <code>stringify</code> and <code>ToObject</code> becoming <code>parse</code>). Maybe later.</p><p>And that&#x27;s us done. Whilst it&#x27;s no doubt unfashionable I think that this is a very useful approach indeed and I commend it to the interweb!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="update---using-xsdexe-to-generate-xsd-from-xml"></a>Update - using Xsd.exe to generate XSD from XML<a class="hash-link" href="#update---using-xsdexe-to-generate-xsd-from-xml" title="Direct link to heading">#</a></h2><p>I was chatting to a friend about this blog post and he mentioned that you can actually use Xsd.exe to generate XSD files from XML as well. He&#x27;s quite right - this feature does exist. To go back to our example from earlier we can execute the following command:</p><p><code>xsd.exe &quot;C:\\Contact.xml&quot; /out:&quot;C:\\&quot; </code>And this will generate the following file:</p><script src="https://gist.github.com/4000326.js?file=Generated by XSD contact.xsd"></script><p>However, the XSD generated above is very much a &quot;Microsoft XSD&quot;; it&#x27;s an XSD which features MS properties and so on. It&#x27;s fine but I think that generally I prefer my XSDs to be as vanilla as possible. To that end I&#x27;m likely to stick to using the XSD/XML Schema Generator as it doesn&#x27;t appear to be possible to get Xsd.exe to generate &quot;vanilla XSD&quot;.</p><p>Thanks to Ajay for bringing it to my attention though.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/xsd-exe">Xsd.exe</a><a class="margin-horiz--sm" href="/tags/xsd-xml-schema-generator">XSD/XML Schema Generator</a><a class="margin-horiz--sm" href="/tags/linq-to-xml">LINQ to XML</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/2012/10/22/mvc-3-meet-dictionary">MVC 3 meet Dictionary</a></h2><div class="margin-vert--md"><time datetime="2012-10-22T00:00:00.000Z" class="blogPostDate_Ta7i">October 22, 2012  ¬∑ 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="documenting-a-jsonvalueproviderfactory-gotcha"></a>Documenting a JsonValueProviderFactory Gotcha<a class="hash-link" href="#documenting-a-jsonvalueproviderfactory-gotcha" title="Direct link to heading">#</a></h2><p> About a year ago I was involved in the migration of an ASP.NET WebForms application over to MVC 3. We&#x27;d been doing a lot of AJAX-y / Single Page Application-y things in the project and had come to the conclusion that MVC might be a slightly better fit since we intended to continue down this path.</p><p>During the migration we encountered a bug in MVC 3 concerning Dictionary deserialization. This bug has subsequently tripped me up a few more times as I failed to remember the nature of the problem correctly. So I&#x27;ve written the issue up here as an aide to my own lamentable memory.</p><p>Before I begin I should say that the problem *<u>has been resolved in MVC 4</u></p><p>*. However given that I imagine many MVC 3 projects will not upgrade instantly there&#x27;s probably some value in documenting the issue (and how to work around it). By the way, you can see my initial plea for assistance in <a href="http://stackoverflow.com/q/6881440/761388" target="_blank" rel="noopener noreferrer">this StackOverflow question</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-problem"></a>The Problem<a class="hash-link" href="#the-problem" title="Direct link to heading">#</a></h2><p>The problem is that deserialization of Dictionary objects does not behave in the expected and desired fashion. When you fire off a dictionary it arrives at your endpoint as the enormously unhelpful <code>null</code>. To see this for yourself you can try using this JavaScript:</p><script src="https://gist.github.com/3931778.js?file=PostDictionaryTest.js"></script><p>With this C#:</p><script src="https://gist.github.com/3931778.js?file=HomeController.cs"></script><p>You get a null <code>null</code> dictionary.</p><p><img src="http://3.bp.blogspot.com/-Lsz_lrqsLF8/UIVcfCzfGrI/AAAAAAAAAVM/gkq0qsVZTMw/s400/MyDictionaryIsNull.png"></p><p>After a long time googling around on the topic I eventually discovered, much to my surprise, that I was actually tripping over a bug in MVC 3. It was filed by <a href="http://stackoverflow.com/users/29407/darin-dimitrov" target="_blank" rel="noopener noreferrer">Darin Dimitrov</a> of Stack Overflow fame and I found details about it filed as an official bug <a href="http://connect.microsoft.com/VisualStudio/feedback/details/636647/make-jsonvalueproviderfactory-work-with-dictionary-types-in-asp-net-mvc" target="_blank" rel="noopener noreferrer">here</a>. To quote Darin:</p><p>&quot;<em>The System.Web.Mvc.JsonValueProviderFactory introduced in ASP.NET MVC 3 enables action methods to send and receive JSON-formatted text and to model-bind the JSON text to parameters of action methods. Unfortunately it doesn&#x27;t work with dictionaries</em>&quot;</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-workaround"></a>The Workaround<a class="hash-link" href="#the-workaround" title="Direct link to heading">#</a></h2><p>My colleague found a workaround for the issue <a href="http://stackoverflow.com/a/5397743/761388" target="_blank" rel="noopener noreferrer">here</a>. There are 2 parts to this:</p><ol><li>Dictionaries in JavaScript are simple JavaScript Object Literals. In order to workaround this issue it is necessary to <code>JSON.stringify</code> our Dictionary / JOL before sending it to the endpoint. This is done so a string can be picked up at the endpoint.</li><li>The signature of your action is switched over from a Dictionary reference to a string reference. Deserialization is then manually performed back from the string to a Dictionary within the Action itself.</li></ol><p>I&#x27;ve adapted my example from earlier to demonstrate this; first the JavaScript:</p><script src="https://gist.github.com/3931778.js?file=PostDictionaryTestWorkaround.js"></script><p>Then the C#:</p><script src="https://gist.github.com/3931778.js?file=HomeControllerWorkaround.cs"></script><p>And now we&#x27;re able to get a dictionary:</p><p><img src="http://1.bp.blogspot.com/-7_sHRAsZjbY/UIVnwqH7tRI/AAAAAAAAAVg/jkYd3aHKPF4/s400/MyDictionaryIsNotNull.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="summary-and-a-ps"></a>Summary and a PS<a class="hash-link" href="#summary-and-a-ps" title="Direct link to heading">#</a></h2><p>So that&#x27;s it; a little unglamourous but this works. I&#x27;m slightly surprised that that wasn&#x27;t picked up before MVC 3 was released but at least it&#x27;s been fixed for MVC 4. I look forward to this blog post being irrelevant and out of date ‚ò∫.</p><p>For what it&#x27;s worth in my example above we&#x27;re using the trusty old <code>System.Web.Script.Serialization.JavaScriptSerializer</code> to perform deserialization. My preference is actually to use <a href="http://james.newtonking.com/projects/json-net.aspx" target="_blank" rel="noopener noreferrer">JSON.Nets</a> implementation but for the sake of simplicity I went with .NETs internal one here. To be honest, either is fine to my knowledge.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/mvc-3">MVC 3</a><a class="margin-horiz--sm" href="/tags/dictionary">Dictionary</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/2012/10/05/using-web-optimization-with-mvc-3">Using Web Optimization with MVC 3</a></h2><div class="margin-vert--md"><time datetime="2012-10-05T00:00:00.000Z" class="blogPostDate_Ta7i">October 5, 2012  ¬∑ 4 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>A while ago I <a href="http://icanmakethiswork.blogspot.com/2012/06/how-im-structuring-my-javascript-in-web.html#WebOptimization" target="_blank" rel="noopener noreferrer">wrote</a> about optimally serving up JavaScript in web applications. I mentioned that Microsoft had come up with a NuGet package called <a href="http://nuget.org/packages/Microsoft.AspNet.Web.Optimization" target="_blank" rel="noopener noreferrer">Microsoft ASP.NET Web Optimization</a> which could help with that by minifying and bundling CSS and JavaScript. At the time I was wondering if I would be able to to use this package with pre-existing MVC 3 projects (given that the package had been released together with MVC 4). Happily it turns out you can. But it&#x27;s not quite as straightforward as I might have liked so I&#x27;ve documented how to get going with this here...</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="getting-the-basics-in-place"></a>Getting the Basics in Place<a class="hash-link" href="#getting-the-basics-in-place" title="Direct link to heading">#</a></h2><p>To keep it simple I&#x27;m going to go through taking a &quot;vanilla&quot; MVC 3 app and enhancing it to work with Web Optimization. To start, follow these basic steps:</p><ol><li>Open Visual Studio (bet you didn&#x27;t see that coming!)</li><li>Create a new MVC 3 application (I called mine &quot;WebOptimizationWithMvc3&quot; to demonstrate my imaginative flair). It doesn&#x27;t really matter which sort of MVC 3 project you create - I chose an Intranet application but really that&#x27;s by the by.</li><li>Update pre-existing NuGet packages</li><li>At the NuGet console type: &quot;<code>Install-Package Microsoft.AspNet.Web.Optimization</code>&quot;</li></ol><p>Whilst the NuGet package adds the necessary references to your MVC 3 project it doesn&#x27;t add the corresponding namespaces to the web.configs. To fix this manually add the following child XML element to the <code>&amp;lt;namespaces&amp;gt;</code> element in your root and Views web.config files:</p><p><code>&amp;lt;add namespace=&quot;System.Web.Optimization&quot; /&amp;gt;</code></p><p>This gives you access to <code>Scripts</code> and <code>Styles</code> in your views without needing the fully qualified namespace. For reasons best known to Microsoft I had to close down and restart Visual Studio before intellisense started working. You may need to do likewise.</p><p>Next up we want to get some JavaScript / CSS bundles in place. To do this, create a folder in the root of your project called &quot;App_Start&quot;. There&#x27;s nothing magical about this to my knowledge; this is just a convention that&#x27;s been adopted to store all the bits of startup in one place and avoid clutterage. (I think this grew out of Nuget; see <a href="http://blog.davidebbo.com/2011/02/appstart-folder-convention-for-nuget.html" target="_blank" rel="noopener noreferrer">David Ebbo talking about this here</a>.) Inside your new folder you should add a new class called <code>BundleConfig.cs</code> which looks like this:</p><script src="https://gist.github.com/3839486.js?file=BundleConfig.cs"></script><p>The above is what you get when you create a new MVC 4 project (as it includes Web Optimization out of the box). All it does is create some JavaScript and CSS bundles relating to jQuery, jQuery UI, jQuery Validate, Modernizr and the standard site CSS. Nothing radical here but this example should give you an idea of how bundling can be configured and used. To make use of <code>BundleConfig.cs</code> you should modify your <code>Global.asax.cs</code> so it looks like this:</p><script src="https://gist.github.com/3839486.js?file=Global.asax.cs"></script><p>Once you&#x27;ve done this you&#x27;re ready to start using Web Optimization in your MVC 3 application.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="switching-over-_layoutcshtml-to-use-web-optimization"></a>Switching over _Layout.cshtml to use Web Optimization<a class="hash-link" href="#switching-over-_layoutcshtml-to-use-web-optimization" title="Direct link to heading">#</a></h2><p>With a &quot;vanilla&quot; MVC 3 app the only use of CSS and JavaScript files is found in <code>_Layout.cshtml</code>. To switch over to using Web Optimization you should replace the existing <code>_Layout.cshtml</code> with this: (you&#x27;ll see that the few differences that there are between the 2 are solely around the replacement of link / script tags with references to <code>Scripts</code> and <code>Styles</code> instead)</p><script src="https://gist.github.com/3839486.js?file=_Layout.cshtml"></script><p>Do note that in the above <code>Scripts.Render</code> call we&#x27;re rendering out 3 bundles; jQuery, jQuery UI and jQuery Validate. We&#x27;re not using any of these in <code>_Layout.cshtml</code> but rendering these (and their associated link tags) gives us a chance to demonstrate that everything is working as expected.</p><p>In your root web.config file make sure that the following tag is in place: <code>&amp;lt;compilation debug=&quot;&lt;b&gt;true&lt;/b&gt;&quot; targetFramework=&quot;4.0&quot;&amp;gt;</code>. Then run, the generated HTML should look something like this:</p><script src="https://gist.github.com/3839486.js?file=debug  true"></script><p>This demonstrates that when the application has debug set to true you see the full scripts / links being rendered out as you would hope (to make your debugging less painful).</p><p>Now go back to your root <code>web.config</code> file and chance the debug tag to false: <code>&amp;lt;compilation debug=&quot;&lt;b&gt;false&lt;/b&gt;&quot; targetFramework=&quot;4.0&quot;&amp;gt;</code>. This time when you run, the generated HTML should look something like this:</p><script src="https://gist.github.com/3839486.js?file=debug  false"></script><p>This time you can see that in non-debug mode (ie how it would run in Production) minified bundles of scripts and css files are being served up instead of the raw files. And that&#x27;s it; done.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/asp-net">asp.net</a><a class="margin-horiz--sm" href="/tags/bundling">Bundling</a><a class="margin-horiz--sm" href="/tags/mvc-3">MVC 3</a><a class="margin-horiz--sm" href="/tags/web-optimization">Web Optimization</a><a class="margin-horiz--sm" href="/tags/minification">Minification</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/2012/10/03/unit-testing-and-entity-framework-filth">Unit Testing and Entity Framework: The Filth and the Fury</a></h2><div class="margin-vert--md"><time datetime="2012-10-03T00:00:00.000Z" class="blogPostDate_Ta7i">October 3, 2012  ¬∑ 8 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>Just recently I&#x27;ve noticed that there appears to be something of a controversy around Unit Testing and Entity Framework. I first came across it as I was Googling around for useful posts on using MOQ in conjunction with EF. I&#x27;ve started to notice the topic more and more and as I have mixed feelings on the subject (that is to say I don&#x27;t have a settled opinion) I thought I&#x27;d write about this and see if I came to any kind of conclusion...</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-setup"></a>The Setup<a class="hash-link" href="#the-setup" title="Direct link to heading">#</a></h2><p>It started as I was working on a new project. We were using ASP.NET MVC 3 and Entity Framework with DbContext as our persistence layer. Rather than crowbarring the tests in afterwards the intention was to write tests to support the ongoing development. Not quite test driven development but certainly <a href="http://blog.troyd.net/Test+Supported+Development+TSD+Is+NOT+Test+Driven+Development+TDD.aspx" target="_blank" rel="noopener noreferrer">test supported development</a>. (Let&#x27;s not get into the internecine conflict as to whether this is black belt testable code or not - it isn&#x27;t but he who pays the piper etc.) Oh and we were planning to use MOQ as our mocking library.</p><p>It was the first time I&#x27;d used DbContext rather than ObjectContext and so I thought I&#x27;d do a little research on how people were using DbContext with regards to testability. I had expected to find that there was some kind of consensus and an advised way forwards. I didn&#x27;t get that at all. Instead I found a number of conflicting opinions.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="using-the-repository--unit-of-work-patterns"></a>Using the Repository / Unit of Work Patterns<a class="hash-link" href="#using-the-repository--unit-of-work-patterns" title="Direct link to heading">#</a></h2><p>One thread of advice that came out was that people advised using the Repository / Unit of Work patterns as wrappers when it came to making testable code. This is kind of interesting in itself as to the best of my understanding ObjectSet / ObjectContext and DbSet / DbContext are both in themselves implementations of the Repository / Unit of Work patterns. So the advice was to build a Repository / Unit of Work pattern to wrap an existing Repository / Unit of Work pattern.</p><p>Not as mad as it sounds. The reason for the extra abstraction is that ObjectContext / DbContext in the raw are not MOQ-able.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="or-maybe-im-wrong-maybe-you-can-moq-dbcontext"></a>Or maybe I&#x27;m wrong, maybe you can MOQ DbContext?<a class="hash-link" href="#or-maybe-im-wrong-maybe-you-can-moq-dbcontext" title="Direct link to heading">#</a></h2><p>No you can&#x27;t. Well that&#x27;s not true. You can and it&#x27;s documented <a href="http://romiller.com/2012/02/14/testing-with-a-fake-dbcontext/" target="_blank" rel="noopener noreferrer">here</a> but there&#x27;s a &quot;but&quot;. You need to be using Entity Frameworks Code First approach; actually coding up your DbContext yourself. Before I&#x27;d got on board the project had already begun and we were already some way down the road of using the Database First approach. So this didn&#x27;t seem to be a go-er really.</p><p>The best article I found on testability and Entity Framework was <a href="http://msdn.microsoft.com/en-us/library/ff714955.aspx" target="_blank" rel="noopener noreferrer">this one</a> by <a href="http://odetocode.com/" target="_blank" rel="noopener noreferrer">K. Scott Allen</a> which essentially detailed how you could implement the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext. In the end I adapted this to do the same thing sat on top of DbSet / DbContext instead.</p><p>With this in place I had me my testable code. I was quite happy with this as it seemed quite intelligible. My new approach looked similar to the existing DbSet / DbContext code and so there wasn&#x27;t a great deal of re-writing to do. Sorted, right?</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="here-come-the-nagging-doubts"></a>Here come the nagging doubts...<a class="hash-link" href="#here-come-the-nagging-doubts" title="Direct link to heading">#</a></h2><p>I did wonder, given that I found a number of articles about applying the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext that there didn&#x27;t seem to be many examples to do the same for DbSet / DbContext. (I did find a few examples of this but none that felt satisfactory to me for a variety of reasons.) This puzzled me.</p><p>I also started to notice that a 1 man war was being waged against the approach I was using by <a href="http://www.ladislavmrnka.com/about/" target="_blank" rel="noopener noreferrer">Ladislav Mrnka</a>. Here are a couple of examples of his crusade:</p><ul><li><a href="http://stackoverflow.com/a/6904479/761388" target="_blank" rel="noopener noreferrer">An answer on StackOverflow</a> (there&#x27;s quite a few similar answers around on StackOverflow saying similar)</li><li><a href="http://romiller.com/2012/02/14/testing-with-a-fake-dbcontext/#div-comment-1620" target="_blank" rel="noopener noreferrer">A comment on Rowan Millers post about fake DbContexts</a></li></ul><p>Ladislav is quite strongly of the opinion that wrapping DbSet / DbContext (and I presume ObjectSet / ObjectContext too) in a further Repository / Unit of Work is an antipattern. To quote him: <em>&quot;The reason why I don‚Äôt like it is leaky abstraction in Linq-to-entities queries ... In your test you have Linq-to-Objects which is superset of Linq-to-entities and only subset of queries written in L2O is translatable to L2E&quot;</em>. It&#x27;s worth looking at <a href="http://www.youtube.com/watch?v=gNeSZYke-_Q" target="_blank" rel="noopener noreferrer">Jon Skeets explanation of &quot;leaky abstractions&quot;</a> which he did for TekPub.</p><p>As much as I didn&#x27;t want to admit it - I have come to the conclusion Ladislav probably has a point for a number of reasons:</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="1-just-because-it-compiles-and-passes-unit-tests-dont-imagine-that-means-it-works"></a>1. Just because it compiles and passes unit tests don&#x27;t imagine that means it works...<a class="hash-link" href="#1-just-because-it-compiles-and-passes-unit-tests-dont-imagine-that-means-it-works" title="Direct link to heading">#</a></h3><p>Unfortunately, a LINQ query that looks right, compiles and has passing unit tests written for it doesn&#x27;t necessarily work. You can take a query that fails when executed against Entity Framework and come up with test data that will pass that unit test. As Ladislav rightly points out: <code>LINQ-to-Objects != LINQ-to-Entities</code>.</p><p>So in this case unit tests of this sort don&#x27;t provide you with any security. What you need are **<u>integration</u></p><p>** tests. Tests that run against an instance of the database and demonstrate that LINQ will actually translate queries / operations into valid SQL.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="2-complex-queries"></a>2. Complex queries<a class="hash-link" href="#2-complex-queries" title="Direct link to heading">#</a></h3><p>You can write some pretty complex LINQ queries if you want. This is made particularly easy if you&#x27;re using <a href="http://blogs.msdn.com/b/ericlippert/archive/2009/12/07/query-transformations-are-syntactic.aspx" target="_blank" rel="noopener noreferrer">comprehension syntax</a>. Whilst these queries may be simple to write it can be uphill work to generate test data to satisfy this. So much so that at times it can feel you&#x27;ve made a rod for your own back using this approach.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="3-lazy-loading"></a>3. Lazy Loading<a class="hash-link" href="#3-lazy-loading" title="Direct link to heading">#</a></h3><p>By default Entity Framework employs lazy loading. This a useful approach which reduces the amount of data that is transported. Sometimes this approach forces you to specify up front if you require a particular entity through use of <code>Include</code> statements. This again doesn&#x27;t lend itself to testing particularly well.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="where-does-this-leave-us"></a>Where does this leave us?<a class="hash-link" href="#where-does-this-leave-us" title="Direct link to heading">#</a></h2><p>Having considered all of the above for a while and tried out various different approaches I think I&#x27;m coming to the conclusion that Ladislav is probably right. Implementing the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext or DbSet / DbContext doesn&#x27;t seem a worthwhile effort in the end.</p><p>So what&#x27;s a better idea? I think that in the name of simplicity you might as well have a simple class which wraps all of your Entity Framework code. This class could implement an interface and hence be straightforwardly MOQ-able (or alternatively all methods could be virtual and you could forego the interface). Along with this you should have integration tests in place which test the execution of the actual Entity Framework code against a test database.</p><p>Now I should say this approach is not necessarily my final opinion. It seems sensible and practical. I think it is likely to simplify the tests that are written around a project. It will certainly be more reliable than just having unit tests in place.</p><p>In terms of the project I&#x27;m working on at the moment we&#x27;re kind of doing this in a halfway house sense. That is to say, we&#x27;re still using our Repository / Unit of Work wrappers for DbSet / DbContext but where things move away from simple operations we&#x27;re adding extra methods to our Unit of Work class or Repository classes which wrap this functionality and then testing it using our integration tests.</p><p>I&#x27;m open to the possibility that my opinion may be modified further. And I&#x27;d be very interested to know what other people think on the subject.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="update"></a>Update<a class="hash-link" href="#update" title="Direct link to heading">#</a></h2><p>It turns out that I&#x27;m not alone in thinking about this issue and indeed others have expressed this rather better than me - take a look at Jimmy Bogard&#x27;s post for an example: <a href="http://lostechies.com/jimmybogard/2012/09/20/limiting-your-abstractions/" target="_blank" rel="noopener noreferrer">http://lostechies.com/jimmybogard/2012/09/20/limiting-your-abstractions/</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="update-2"></a>Update 2<a class="hash-link" href="#update-2" title="Direct link to heading">#</a></h2><p>I&#x27;ve also recently watched the following Pluralsight course by Julie Lerman: <a href="http://pluralsight.com/training/Courses/TableOfContents/efarchitecture#efarchitecture-m3-archrepo" target="_blank" rel="noopener noreferrer">http://pluralsight.com/training/Courses/TableOfContents/efarchitecture#efarchitecture-m3-archrepo</a>. In this course Julie talks about different implementations of the Repository and Unit of Work patterns in conjunction with Entity Framework. Julie is in favour of using this approach but in this module she elaborates on different &quot;flavours&quot; of these patterns that you might want to use for different reasons (bounded contexts / reference contexts etc). She makes a compelling case and helpfully she is open enough to say that this a point of contention in the community. At the end of watching this I think I felt happy that our &quot;halfway house&quot; approach seems to fit and seems to work. More than anything else Julie made clear that there isn&#x27;t one definitively &quot;true&quot; approach. Rather many different but similar approaches for achieving the same goal. Good stuff Julie!</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/unit-testing">unit testing</a><a class="margin-horiz--sm" href="/tags/entity-framework">Entity Framework</a><a class="margin-horiz--sm" href="/tags/anti-pattern">anti-pattern</a><a class="margin-horiz--sm" href="/tags/moq">MOQ</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/page/18"><div class="pagination-nav__label">¬´ Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/page/20"><div class="pagination-nav__label">Older Entries ¬ª</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.abcb43ba.js"></script>
<script src="/runtime~main.333857ee.js"></script>
<script src="/main.cedb1112.js"></script>
<script src="/1.b4966bec.js"></script>
<script src="/2.45eb8537.js"></script>
<script src="/a6aa9e1f.16952003.js"></script>
<script src="/c3b5bd8c.985f0121.js"></script>
<script src="/9e16dc16.7798d1bf.js"></script>
<script src="/3fde0b39.6680c3ff.js"></script>
<script src="/c741b9e4.28cb2d0e.js"></script>
<script src="/0a4541fe.fea080d1.js"></script>
<script src="/32cba561.ca0734d4.js"></script>
<script src="/e0812a81.f25c4a3d.js"></script>
<script src="/22119250.a5038537.js"></script>
<script src="/94977d73.2ade51ca.js"></script>
<script src="/d76b298c.6a32ccf5.js"></script>
<script src="/7d658055.831d1391.js"></script>
<script src="/96adae60.806b73ab.js"></script>
</body>
</html>