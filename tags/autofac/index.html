<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Posts tagged &quot;autofac&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;autofac&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;autofac&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;autofac&quot;"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/autofac"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/autofac"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/autofac" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/autofac" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.3ed665c6.css">
<link rel="preload" href="/assets/js/styles.f7659eed.js" as="script">
<link rel="preload" href="/assets/js/runtime~main.74f1dcf9.js" as="script">
<link rel="preload" href="/assets/js/main.77bdfe03.js" as="script">
<link rel="preload" href="/assets/js/1.194e3740.js" as="script">
<link rel="preload" href="/assets/js/2.85d4c801.js" as="script">
<link rel="preload" href="/assets/js/6875c492.1786d4e6.js" as="script">
<link rel="preload" href="/assets/js/c3b5bd8c.a1a5ba6a.js" as="script">
<link rel="preload" href="/assets/js/f3c1932d.71d30788.js" as="script">
<link rel="preload" href="/assets/js/c987543e.266459d5.js" as="script">
<link rel="preload" href="/assets/js/e7029de0.92a8358e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/about">About</a></li><li class="menu__list-item"><a class="menu__link" href="/blog-archive">Blog Archive</a></li><li class="menu__list-item"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="menu__link">Twitter</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/20/bicep-meet-azure-pipelines">Bicep in Azure Pipelines</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/17/rss-update-we-moved-to-docusaurus">RSS update; we moved to Docusaurus</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/15/from-blogger-to-docusaurus">From Blogger to Docusaurus</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/10/managed-identity-azure-sql-entity-framework">Managed Identity, Azure SQL and Entity Framework</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/06/generate-typescript-and-csharp-clients-with-nswag">Generate TypeScript and CSharp clients with NSwag based on an API</a></li></ul></div></div><main class="col col--7"><h1>2 posts tagged with &quot;autofac&quot;</h1><a href="/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/2020/10/02/autofac-6-integration-tests-and-generic-hosting">Autofac 6, integration tests and .NET generic hosting</a></h2><div class="margin-vert--md"><time datetime="2020-10-02T00:00:00.000Z" class="blogPostDate_fNvV">October 2, 2020 Â· 3 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><p>I <a href="https://blog.johnnyreilly.com/2020/05/autofac-webapplicationfactory-and.html" target="_blank" rel="noopener noreferrer">blogged a little while ago around to support integration tests using Autofac</a>. This was specific to Autofac but documented a workaround for a <a href="https://github.com/dotnet/aspnetcore/issues/14907" target="_blank" rel="noopener noreferrer">long standing issue with <code>ConfigureTestContainer</code> that was introduced into .NET core 3.0</a> which affects <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-3.1#default-service-container-replacement" target="_blank" rel="noopener noreferrer">all third-party containers</a> that use <code>ConfigureTestContainer</code> in their tests.</p><p>I&#x27;ll not repeat the contents of the previous post - it all still stands. However, with Autofac 6 the approach documented there will cease to work. This is because the previous approach relied upon <code>ContainerBuilder</code> not being sealed. <a href="https://github.com/autofac/Autofac/issues/1120" target="_blank" rel="noopener noreferrer">As of Autofac 6 it is.</a></p><p>Happily the tremendous <a href="https://twitter.com/evocationist" target="_blank" rel="noopener noreferrer">Alistair Evans</a> came up with an <a href="https://github.com/autofac/Autofac/issues/1207#issuecomment-701961371" target="_blank" rel="noopener noreferrer">alternative approach</a> which is listed below:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Based upon https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/3.x/IntegrationTestsSample</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;typeparam name=&quot;TStartup&quot;&gt;&lt;/typeparam&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class AutofacWebApplicationFactory&lt;TStartup&gt; : WebApplicationFactory&lt;TStartup&gt; where TStartup : class</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected override IHost CreateHost(IHostBuilder builder)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            builder.UseServiceProviderFactory&lt;ContainerBuilder&gt;(new CustomServiceProviderFactory());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return base.CreateHost(builder);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Based upon https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-620750841 - only necessary because of an issue in ASP.NET Core</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class CustomServiceProviderFactory : IServiceProviderFactory&lt;ContainerBuilder&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private AutofacServiceProviderFactory _wrapped;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private IServiceCollection _services;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public CustomServiceProviderFactory()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            _wrapped = new AutofacServiceProviderFactory();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public ContainerBuilder CreateBuilder(IServiceCollection services)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Store the services for later.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            _services = services;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return _wrapped.CreateBuilder(services);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public IServiceProvider CreateServiceProvider(ContainerBuilder containerBuilder)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var sp = _services.BuildServiceProvider();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma warning disable CS0612 // Type or member is obsolete</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var filters = sp.GetRequiredService&lt;IEnumerable&lt;IStartupConfigureContainerFilter&lt;ContainerBuilder&gt;&gt;&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma warning restore CS0612 // Type or member is obsolete</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            foreach (var filter in filters)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                filter.ConfigureContainer(b =&gt; { })(containerBuilder);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return _wrapped.CreateServiceProvider(containerBuilder);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Using this in place of the previous approach should allow you continue running your integration tests with Autofac 6. Thanks Alistair!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="concern-for-third-party-containers"></a>Concern for third-party containers<a class="hash-link" href="#concern-for-third-party-containers" title="Direct link to heading">#</a></h2><p>Whilst this gets us back up and running, <a href="https://github.com/autofac/Autofac/issues/1207#issuecomment-702250044" target="_blank" rel="noopener noreferrer">Alistair pointed out that this approach depends upon a deprecated interface</a>. This is the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.istartupconfigurecontainerfilter-1.configurecontainer?view=aspnetcore-3.1" target="_blank" rel="noopener noreferrer"><code>IStartupConfigureContainerFilter</code></a> which <a href="https://github.com/dotnet/aspnetcore/pull/11505" target="_blank" rel="noopener noreferrer">has been marked as <code>Obsolete</code> since mid 2019</a>. What this means is, at some point, this approach will stop working.</p><p>The marvellous David Fowler has said that <a href="https://github.com/autofac/Autofac/issues/1207#issuecomment-702361608" target="_blank" rel="noopener noreferrer"><code>ConfigureTestContainer</code> issue should be resolved in .NET</a>. However it&#x27;s worth noting that this has been an issue since .NET Core 3 shipped and unfortunately the wonderful <a href="https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-702287717" target="_blank" rel="noopener noreferrer">Chris Ross has advised that it&#x27;s not likely to be fixed for .NET 5</a>.</p><p>I&#x27;m very keen this does get resolved in .NET. Building tests upon an <code>Obsolete</code> attribute doesn&#x27;t fill me with confidence. I&#x27;m a long time user of Autofac and I&#x27;d like to continue to be. Here&#x27;s hoping that&#x27;s made possible by a fix landing in .NET. If this is something you care about, it may be worth upvoting / commenting on <a href="https://github.com/dotnet/aspnetcore/issues/14907" target="_blank" rel="noopener noreferrer">the issue in GitHub</a> so the team are aware of desire around this being resolved.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/autofac">autofac</a><a class="margin-horiz--sm" href="/tags/asp-net">asp.net</a><a class="margin-horiz--sm" href="/tags/configure-test-container">ConfigureTestContainer</a><a class="margin-horiz--sm" href="/tags/integration-testing">Integration Testing</a></div><div class="col text--right"><a aria-label="Read more about Autofac 6, integration tests and .NET generic hosting" href="/2020/10/02/autofac-6-integration-tests-and-generic-hosting"><strong>Read More</strong></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/2020/05/21/autofac-webapplicationfactory-and">Autofac, WebApplicationFactory and integration tests</a></h2><div class="margin-vert--md"><time datetime="2020-05-21T00:00:00.000Z" class="blogPostDate_fNvV">May 21, 2020 Â· 4 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><p><strong>Updated 2nd Oct 2020:</strong> <em>for an approach that works with Autofac 6 see <a href="https://blog.johnnyreilly.com/2020/10/autofac-6-integration-tests-and-generic-hosting.html" target="_blank" rel="noopener noreferrer">this post.</a></em></p><hr><p>This is one of those occasions where I&#x27;m not writing up my own work so much as my discovery after in depth googling.</p><p>Integration tests with ASP.NET Core are the best. They spin up an in memory version of your application and let you fire requests at it. They&#x27;ve gone through a number of iterations since ASP.NET Core has been around. You may also be familiar with the <code>TestServer</code> approach of earlier versions. For some time, the advised approach has been using <code>&lt;a href=&quot;https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-3.1#basic-tests-with-the-default-webapplicationfactory&quot;&gt;WebApplicationFactory&lt;/a&gt;</code>.</p><p>What makes this approach particularly useful / powerful is that you can swap out dependencies of your running app with fakes / stubs etc. Just like unit tests! But potentially more useful because they run your whole app and hence give you a greater degree of confidence. What does this mean? Well, imagine you changed a piece of middleware in your application; this could potentially break functionality. Unit tests would probably not reveal this. Integration tests would.</p><p>There is a fly in the ointment. A hair in the gazpacho. ASP.NET Core ships with dependency injection in the box. It has its own Inversion of Control container which is perfectly fine. However, many people are accustomed to using other IOC containers such as <a href="https://autofac.org/" target="_blank" rel="noopener noreferrer">Autofac</a>.</p><p>What&#x27;s the problem? Well, swapping out dependencies registered using ASP.NET Core&#x27;s IOC requires using a hook called <a href="https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-3.1#inject-mock-services" target="_blank" rel="noopener noreferrer"><code>ConfigureTestServices</code></a>. There&#x27;s an equivalent hook for swapping out services registered using a custom IOC container: <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestcontainer?view=aspnetcore-3.0" target="_blank" rel="noopener noreferrer"><code>ConfigureTestContainer</code></a>. Unfortunately, there is a bug in ASP.NET Core as of version 3.0: <a href="https://github.com/dotnet/aspnetcore/issues/14907" target="_blank" rel="noopener noreferrer">When using GenericHost, in tests <code>ConfigureTestContainer</code> is not executed</a></p><p>This means you cannot swap out dependencies that have been registered with Autofac and the like. According to the tremendous <a href="https://www.twitter.com/davidfowl" target="_blank" rel="noopener noreferrer">David Fowler</a> of the ASP.NET team, <a href="https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-592102145" target="_blank" rel="noopener noreferrer">this will hopefully be resolved</a>.</p><p>In the meantime, <a href="https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-620750841" target="_blank" rel="noopener noreferrer">there&#x27;s a workaround thanks to various commenters on the thread</a>. Instead of using <code>WebApplicationFactory</code> directly, subclass it and create a custom <code>AutofacWebApplicationFactory</code> (the name is not important). This custom class overrides the behavior of <code>ConfigureServices</code> and <code>CreateHost</code> with a <code>CustomServiceProviderFactory</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace My.Web.Tests.Helpers {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Based upon https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/3.x/IntegrationTestsSample</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;typeparam name=&quot;TStartup&quot;&gt;&lt;/typeparam&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class AutofacWebApplicationFactory&lt;TStartup&gt; : WebApplicationFactory&lt;TStartup&gt; where TStartup : class {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected override void ConfigureWebHost(IWebHostBuilder builder) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            builder.ConfigureServices(services =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    services.AddSingleton&lt;IAuthorizationHandler&gt;(new PassThroughPermissionedRolesHandler());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .ConfigureTestServices(services =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }).ConfigureTestContainer&lt;Autofac.ContainerBuilder&gt;(builder =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // called after Startup.ConfigureContainer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected override IHost CreateHost(IHostBuilder builder) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            builder.UseServiceProviderFactory(new CustomServiceProviderFactory());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return base.CreateHost(builder);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Based upon https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-620750841 - only necessary because of an issue in ASP.NET Core</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class CustomServiceProviderFactory : IServiceProviderFactory&lt;CustomContainerBuilder&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public CustomContainerBuilder CreateBuilder(IServiceCollection services) =&gt; new CustomContainerBuilder(services);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public IServiceProvider CreateServiceProvider(CustomContainerBuilder containerBuilder) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new AutofacServiceProvider(containerBuilder.CustomBuild());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class CustomContainerBuilder : Autofac.ContainerBuilder {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly IServiceCollection services;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public CustomContainerBuilder(IServiceCollection services) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this.services = services;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this.Populate(services);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public Autofac.IContainer CustomBuild() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var sp = this.services.BuildServiceProvider();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma warning disable CS0612 // Type or member is obsolete</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var filters = sp.GetRequiredService&lt;IEnumerable&lt;IStartupConfigureContainerFilter&lt;Autofac.ContainerBuilder&gt;&gt;&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma warning restore CS0612 // Type or member is obsolete</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            foreach (var filter in filters) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                filter.ConfigureContainer(b =&gt; { }) (this);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return this.Build();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>I&#x27;m going to level with you; I don&#x27;t understand all of this code. I&#x27;m not au fait with the inner workings of ASP.NET Core or Autofac but I can tell you what this allows. With this custom <code>WebApplicationFactory</code> in play you get <code>ConfigureTestContainer</code> back in the mix! You get to write code like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net.Http.Headers;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Threading.Tasks;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using FakeItEasy;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using FluentAssertions;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.TestHost;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Xunit;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.Options;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Autofac;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net.Http;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Newtonsoft.Json;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace My.Web.Tests.Controllers</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class MyControllerTests : IClassFixture&lt;AutofacWebApplicationFactory&lt;My.Web.Startup&gt;&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly AutofacWebApplicationFactory&lt;My.Web.Startup&gt; _factory;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public MyControllerTests(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            AutofacWebApplicationFactory&lt;My.Web.Startup&gt; factory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            _factory = factory;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [Fact]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public async Task My() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var fakeSomethingService = A.Fake&lt;IMySomethingService&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var fakeConfig = Options.Create(new MyConfiguration {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                SomeConfig = &quot;Important thing&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                OtherConfigMaybeAnEmailAddress = &quot;johnny_reilly@hotmail.com&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            A.CallTo(() =&gt; fakeSomethingService.DoSomething(A&lt;string&gt;.Ignored))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .Returns(Task.FromResult(true));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            void ConfigureTestServices(IServiceCollection services) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                services.AddSingleton(fakeConfig);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            void ConfigureTestContainer(ContainerBuilder builder) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                builder.RegisterInstance(fakeSomethingService);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var client = _factory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .WithWebHostBuilder(builder =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    builder.ConfigureTestServices(ConfigureTestServices);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    builder.ConfigureTestContainer&lt;Autofac.ContainerBuilder&gt;(ConfigureTestContainer);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .CreateClient();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Act</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var request = StringContent(&quot;{\&quot;sommat\&quot;:\&quot;to see\&quot;}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            request.Headers.ContentType = MediaTypeHeaderValue.Parse(&quot;application/json&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var response = await client.PostAsync(&quot;/something/submit&quot;, request);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Assert</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            response.StatusCode.Should().Be(HttpStatusCode.OK);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            A.CallTo(() =&gt; fakeSomethingService.DoSomething(A&lt;string&gt;.Ignored))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .MustHaveHappened();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/autofac">autofac</a><a class="margin-horiz--sm" href="/tags/asp-net-core">ASP.Net Core</a><a class="margin-horiz--sm" href="/tags/configure-test-container">ConfigureTestContainer</a><a class="margin-horiz--sm" href="/tags/integration-testing">Integration Testing</a></div><div class="col text--right"><a aria-label="Read more about Autofac, WebApplicationFactory and integration tests" href="/2020/05/21/autofac-webapplicationfactory-and"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/styles.f7659eed.js"></script>
<script src="/assets/js/runtime~main.74f1dcf9.js"></script>
<script src="/assets/js/main.77bdfe03.js"></script>
<script src="/assets/js/1.194e3740.js"></script>
<script src="/assets/js/2.85d4c801.js"></script>
<script src="/assets/js/6875c492.1786d4e6.js"></script>
<script src="/assets/js/c3b5bd8c.a1a5ba6a.js"></script>
<script src="/assets/js/f3c1932d.71d30788.js"></script>
<script src="/assets/js/c987543e.266459d5.js"></script>
<script src="/assets/js/e7029de0.92a8358e.js"></script>
</body>
</html>