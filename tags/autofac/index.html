<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.1">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">2 posts tagged with &quot;autofac&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="2 posts tagged with &quot;autofac&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/autofac"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/blog/2020-05-21-autofac-webapplicationfactory-integration-tests/autofac-webapplicationfactory-tests.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/blog/2020-05-21-autofac-webapplicationfactory-integration-tests/autofac-webapplicationfactory-tests.png"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/autofac"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/autofac" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/autofac" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.98074f82.css">
<link rel="preload" href="/assets/js/runtime~main.599c5f5e.js" as="script">
<link rel="preload" href="/assets/js/main.85bec0ca.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP shadow--md">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">I CAN MAKE THIS WORK</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/about">About</a></li><li class="menu__list-item"><a class="menu__link" href="/blog-archive">Blog Archive</a></li><li class="menu__list-item"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="menu__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="menu__list-item"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/07/01/c-sharp-9-azure-functions-in-process">C# 9 in-process Azure Functions</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/06/30/react-18-and-typescript">React 18 and TypeScript</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/06/11/azure-functions-dotnet-5-query-params-di-bicep">Azure Functions and .NET 5: Query params, Dependency Injection, Bicep &amp; Build</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/05/15/azurite-and-table-storage-dev-container">Azurite and Table Storage in a dev container</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/05/08/create-pipeline-with-azure-devops-api">Create a Pipeline with the Azure DevOps API</a></li></ul></nav></aside><main class="col col--7"><header class="margin-bottom--xl"><h1>2 posts tagged with &quot;autofac&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_GeHD"><a href="/2020/10/02/autofac-6-integration-tests-and-generic-hosting">Autofac 6, integration tests and .NET generic hosting</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-10-02T00:00:00.000Z">October 2, 2020</time> Â· 3 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer">John Reilly</a></div><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><p>I <a href="/2020/05/21/autofac-webapplicationfactory-integration-tests">blogged a little while ago around to support integration tests using Autofac</a>. This was specific to Autofac but documented a workaround for a <a href="https://github.com/dotnet/aspnetcore/issues/14907" target="_blank" rel="noopener noreferrer">long standing issue with <code>ConfigureTestContainer</code> that was introduced into .NET core 3.0</a> which affects <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-3.1#default-service-container-replacement" target="_blank" rel="noopener noreferrer">all third-party containers</a> that use <code>ConfigureTestContainer</code> in their tests.</p><p><img alt="A title image for the blog featuring the Autofac logo" src="/assets/images/autofac-integration-tests-7950d2a75e653006ab8defd2c2f26740.png"></p><p>I&#x27;ll not repeat the contents of the previous post - it all still stands. However, with Autofac 6 the approach documented there will cease to work. This is because the previous approach relied upon <code>ContainerBuilder</code> not being sealed. <a href="https://github.com/autofac/Autofac/issues/1120" target="_blank" rel="noopener noreferrer">As of Autofac 6 it is.</a></p><p>Happily the tremendous <a href="https://twitter.com/evocationist" target="_blank" rel="noopener noreferrer">Alistair Evans</a> came up with an <a href="https://github.com/autofac/Autofac/issues/1207#issuecomment-701961371" target="_blank" rel="noopener noreferrer">alternative approach</a> which is listed below:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;summary&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// Based upon https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/3.x/IntegrationTestsSample</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;/summary&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;typeparam name=&quot;TStartup&quot;&gt;&lt;/typeparam&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">public class AutofacWebApplicationFactory&lt;TStartup&gt; : WebApplicationFactory&lt;TStartup&gt; where TStartup : class</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    protected override IHost CreateHost(IHostBuilder builder)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        builder.UseServiceProviderFactory&lt;ContainerBuilder&gt;(new CustomServiceProviderFactory());</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return base.CreateHost(builder);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;summary&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// Based upon https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-620750841 - only necessary because of an issue in ASP.NET Core</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;/summary&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">public class CustomServiceProviderFactory : IServiceProviderFactory&lt;ContainerBuilder&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    private AutofacServiceProviderFactory _wrapped;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    private IServiceCollection _services;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public CustomServiceProviderFactory()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        _wrapped = new AutofacServiceProviderFactory();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public ContainerBuilder CreateBuilder(IServiceCollection services)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // Store the services for later.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        _services = services;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return _wrapped.CreateBuilder(services);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public IServiceProvider CreateServiceProvider(ContainerBuilder containerBuilder)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        var sp = _services.BuildServiceProvider();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma warning disable CS0612 // Type or member is obsolete</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        var filters = sp.GetRequiredService&lt;IEnumerable&lt;IStartupConfigureContainerFilter&lt;ContainerBuilder&gt;&gt;&gt;();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma warning restore CS0612 // Type or member is obsolete</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        foreach (var filter in filters)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            filter.ConfigureContainer(b =&gt; { })(containerBuilder);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return _wrapped.CreateServiceProvider(containerBuilder);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }        </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Using this in place of the previous approach should allow you continue running your integration tests with Autofac 6. Thanks Alistair!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="concern-for-third-party-containers"></a>Concern for third-party containers<a class="hash-link" href="#concern-for-third-party-containers" title="Direct link to heading">#</a></h2><p>Whilst this gets us back up and running, <a href="https://github.com/autofac/Autofac/issues/1207#issuecomment-702250044" target="_blank" rel="noopener noreferrer">Alistair pointed out that this approach depends upon a deprecated interface</a>. This is the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.istartupconfigurecontainerfilter-1.configurecontainer?view=aspnetcore-3.1" target="_blank" rel="noopener noreferrer"><code>IStartupConfigureContainerFilter</code></a> which <a href="https://github.com/dotnet/aspnetcore/pull/11505" target="_blank" rel="noopener noreferrer">has been marked as <code>Obsolete</code> since mid 2019</a>. What this means is, at some point, this approach will stop working.</p><p>The marvellous David Fowler has said that <a href="https://github.com/autofac/Autofac/issues/1207#issuecomment-702361608" target="_blank" rel="noopener noreferrer"><code>ConfigureTestContainer</code> issue should be resolved in .NET</a>. However it&#x27;s worth noting that this has been an issue since .NET Core 3 shipped and unfortunately the wonderful <a href="https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-702287717" target="_blank" rel="noopener noreferrer">Chris Ross has advised that it&#x27;s not likely to be fixed for .NET 5</a>.</p><p>I&#x27;m very keen this does get resolved in .NET. Building tests upon an <code>Obsolete</code> attribute doesn&#x27;t fill me with confidence. I&#x27;m a long time user of Autofac and I&#x27;d like to continue to be. Here&#x27;s hoping that&#x27;s made possible by a fix landing in .NET. If this is something you care about, it may be worth upvoting / commenting on <a href="https://github.com/dotnet/aspnetcore/issues/14907" target="_blank" rel="noopener noreferrer">the issue in GitHub</a> so the team are aware of desire around this being resolved.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/tags/autofac">autofac</a><a class="margin-horiz--sm" href="/tags/asp-net">asp.net</a><a class="margin-horiz--sm" href="/tags/configure-test-container">ConfigureTestContainer</a><a class="margin-horiz--sm" href="/tags/integration-testing">Integration Testing</a></div><div class="col text--right"><a aria-label="Read more about Autofac 6, integration tests and .NET generic hosting" href="/2020/10/02/autofac-6-integration-tests-and-generic-hosting"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_GeHD"><a href="/2020/05/21/autofac-webapplicationfactory-integration-tests">Autofac, WebApplicationFactory and integration tests</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-05-21T00:00:00.000Z">May 21, 2020</time> Â· 4 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer">John Reilly</a></div><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><p><strong>Updated 2nd Oct 2020:</strong> <em>for an approach that works with Autofac 6 and <code>ConfigureTestContainer</code> see <a href="/2020/10/02/autofac-6-integration-tests-and-generic-hosting">this post</a>.</em></p><p><img alt="A title image for the blog featuring the Autofac logo" src="/assets/images/autofac-webapplicationfactory-tests-7c8017cf9919642beee16f4f9b5a59b3.png"></p><p>This is one of those occasions where I&#x27;m not writing up my own work so much as my discovery after in depth googling.</p><p>Integration tests with ASP.NET Core are the best. They spin up an in memory version of your application and let you fire requests at it. They&#x27;ve gone through a number of iterations since ASP.NET Core has been around. You may also be familiar with the <code>TestServer</code> approach of earlier versions. For some time, the advised approach has been using <a href="https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-3.1#basic-tests-with-the-default-webapplicationfactory" target="_blank" rel="noopener noreferrer"><code>WebApplicationFactory</code></a>.</p><p>What makes this approach particularly useful / powerful is that you can swap out dependencies of your running app with fakes / stubs etc. Just like unit tests! But potentially more useful because they run your whole app and hence give you a greater degree of confidence. What does this mean? Well, imagine you changed a piece of middleware in your application; this could potentially break functionality. Unit tests would probably not reveal this. Integration tests would.</p><p>There is a fly in the ointment. A hair in the gazpacho. ASP.NET Core ships with dependency injection in the box. It has its own Inversion of Control container which is perfectly fine. However, many people are accustomed to using other IOC containers such as <a href="https://autofac.org/" target="_blank" rel="noopener noreferrer">Autofac</a>.</p><p>What&#x27;s the problem? Well, swapping out dependencies registered using ASP.NET Core&#x27;s IOC requires using a hook called <a href="https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-3.1#inject-mock-services" target="_blank" rel="noopener noreferrer"><code>ConfigureTestServices</code></a>. There&#x27;s an equivalent hook for swapping out services registered using a custom IOC container: <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestcontainer?view=aspnetcore-3.0" target="_blank" rel="noopener noreferrer"><code>ConfigureTestContainer</code></a>. Unfortunately, there is a bug in ASP.NET Core as of version 3.0: <a href="https://github.com/dotnet/aspnetcore/issues/14907" target="_blank" rel="noopener noreferrer">When using GenericHost, in tests <code>ConfigureTestContainer</code> is not executed</a></p><p>This means you cannot swap out dependencies that have been registered with Autofac and the like. According to the tremendous <a href="https://www.twitter.com/davidfowl" target="_blank" rel="noopener noreferrer">David Fowler</a> of the ASP.NET team, <a href="https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-592102145" target="_blank" rel="noopener noreferrer">this will hopefully be resolved</a>.</p><p>In the meantime, <a href="https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-620750841" target="_blank" rel="noopener noreferrer">there&#x27;s a workaround thanks to various commenters on the thread</a>. Instead of using <code>WebApplicationFactory</code> directly, subclass it and create a custom <code>AutofacWebApplicationFactory</code> (the name is not important). This custom class overrides the behavior of <code>ConfigureServices</code> and <code>CreateHost</code> with a <code>CustomServiceProviderFactory</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespace My.Web.Tests.Helpers {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;summary&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Based upon https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/3.x/IntegrationTestsSample</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;typeparam name=&quot;TStartup&quot;&gt;&lt;/typeparam&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public class AutofacWebApplicationFactory&lt;TStartup&gt; : WebApplicationFactory&lt;TStartup&gt; where TStartup : class {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        protected override void ConfigureWebHost(IWebHostBuilder builder) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            builder.ConfigureServices(services =&gt; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    services.AddSingleton&lt;IAuthorizationHandler&gt;(new PassThroughPermissionedRolesHandler());</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                })</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                .ConfigureTestServices(services =&gt; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                }).ConfigureTestContainer&lt;Autofac.ContainerBuilder&gt;(builder =&gt; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    // called after Startup.ConfigureContainer</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                });</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        protected override IHost CreateHost(IHostBuilder builder) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            builder.UseServiceProviderFactory(new CustomServiceProviderFactory());</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return base.CreateHost(builder);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;summary&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Based upon https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-620750841 - only necessary because of an issue in ASP.NET Core</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public class CustomServiceProviderFactory : IServiceProviderFactory&lt;CustomContainerBuilder&gt; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public CustomContainerBuilder CreateBuilder(IServiceCollection services) =&gt; new CustomContainerBuilder(services);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public IServiceProvider CreateServiceProvider(CustomContainerBuilder containerBuilder) =&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        new AutofacServiceProvider(containerBuilder.CustomBuild());</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public class CustomContainerBuilder : Autofac.ContainerBuilder {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly IServiceCollection services;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public CustomContainerBuilder(IServiceCollection services) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            this.services = services;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            this.Populate(services);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public Autofac.IContainer CustomBuild() {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            var sp = this.services.BuildServiceProvider();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma warning disable CS0612 // Type or member is obsolete</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            var filters = sp.GetRequiredService&lt;IEnumerable&lt;IStartupConfigureContainerFilter&lt;Autofac.ContainerBuilder&gt;&gt;&gt;();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma warning restore CS0612 // Type or member is obsolete</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            foreach (var filter in filters) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                filter.ConfigureContainer(b =&gt; { }) (this);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return this.Build();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>I&#x27;m going to level with you; I don&#x27;t understand all of this code. I&#x27;m not au fait with the inner workings of ASP.NET Core or Autofac but I can tell you what this allows. With this custom <code>WebApplicationFactory</code> in play you get <code>ConfigureTestContainer</code> back in the mix! You get to write code like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net.Http.Headers;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Threading.Tasks;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using FakeItEasy;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using FluentAssertions;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.TestHost;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Xunit;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.Options;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Autofac;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net.Http;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Newtonsoft.Json;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespace My.Web.Tests.Controllers</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public class MyControllerTests : IClassFixture&lt;AutofacWebApplicationFactory&lt;My.Web.Startup&gt;&gt; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly AutofacWebApplicationFactory&lt;My.Web.Startup&gt; _factory;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public MyControllerTests(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            AutofacWebApplicationFactory&lt;My.Web.Startup&gt; factory</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        ) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            _factory = factory;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        [Fact]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public async Task My() {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            var fakeSomethingService = A.Fake&lt;IMySomethingService&gt;();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            var fakeConfig = Options.Create(new MyConfiguration {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                SomeConfig = &quot;Important thing&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                OtherConfigMaybeAnEmailAddress = &quot;johnny_reilly@hotmail.com&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            A.CallTo(() =&gt; fakeSomethingService.DoSomething(A&lt;string&gt;.Ignored))</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                .Returns(Task.FromResult(true));</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            void ConfigureTestServices(IServiceCollection services) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                services.AddSingleton(fakeConfig);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            void ConfigureTestContainer(ContainerBuilder builder) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                builder.RegisterInstance(fakeSomethingService);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            var client = _factory</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                .WithWebHostBuilder(builder =&gt; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    builder.ConfigureTestServices(ConfigureTestServices);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    builder.ConfigureTestContainer&lt;Autofac.ContainerBuilder&gt;(ConfigureTestContainer);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                })</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                .CreateClient();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            // Act</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            var request = StringContent(&quot;{\&quot;sommat\&quot;:\&quot;to see\&quot;}&quot;);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            request.Headers.ContentType = MediaTypeHeaderValue.Parse(&quot;application/json&quot;);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            var response = await client.PostAsync(&quot;/something/submit&quot;, request);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            // Assert</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            response.StatusCode.Should().Be(HttpStatusCode.OK);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            A.CallTo(() =&gt; fakeSomethingService.DoSomething(A&lt;string&gt;.Ignored))</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                .MustHaveHappened();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/tags/autofac">autofac</a><a class="margin-horiz--sm" href="/tags/web-application-factory">WebApplicationFactory</a><a class="margin-horiz--sm" href="/tags/asp-net-core">ASP.Net Core</a><a class="margin-horiz--sm" href="/tags/configure-test-container">ConfigureTestContainer</a><a class="margin-horiz--sm" href="/tags/integration-testing">Integration Testing</a></div><div class="col text--right"><a aria-label="Read more about Autofac, WebApplicationFactory and integration tests" href="/2020/05/21/autofac-webapplicationfactory-integration-tests"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">RSS</a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">Atom</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.599c5f5e.js"></script>
<script src="/assets/js/main.85bec0ca.js"></script>
</body>
</html>