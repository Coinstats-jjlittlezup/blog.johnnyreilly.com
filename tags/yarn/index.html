<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Posts tagged &quot;yarn&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;yarn&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;yarn&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;yarn&quot;"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.a30a8c8e.css">
<link rel="preload" href="/styles.abcb43ba.js" as="script">
<link rel="preload" href="/runtime~main.333857ee.js" as="script">
<link rel="preload" href="/main.cedb1112.js" as="script">
<link rel="preload" href="/1.b4966bec.js" as="script">
<link rel="preload" href="/2.45eb8537.js" as="script">
<link rel="preload" href="/6875c492.7c950930.js" as="script">
<link rel="preload" href="/c3b5bd8c.985f0121.js" as="script">
<link rel="preload" href="/1b063778.ba6817b4.js" as="script">
<link rel="preload" href="/012d4097.320797bc.js" as="script">
<link rel="preload" href="/19afa2f3.36feef6f.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/03/10/managed-identity-azure-sql-entity-framework">Managed Identity, Azure SQL and Entity Framework</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/03/06/generate-typescript-and-csharp-clients-with-nswag">Generate TypeScript and CSharp clients with NSwag based on an API</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure">Goodbye Client Affinity, Hello Data Protection with Azure</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service">Making Easy Auth tokens survive releases on Linux Azure App Service</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/02/11/azure-app-service-health-checks-and-zero-downtime-deployments">Azure App Service, Health checks and zero downtime deployments</a></li></ul></div></div><main class="col col--8"><h1>2 posts tagged with &quot;yarn&quot;</h1><a href="/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/2019/06/07/typescript-webpack-you-down-with-pnp">TypeScript / webpack - you down with PnP? Yarn, you know me!</a></h2><div class="margin-vert--md"><time datetime="2019-06-07T00:00:00.000Z" class="blogPostDate_Ta7i">June 7, 2019  · 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>Yarn PnP is an innovation by the Yarn team designed to speed up module resolution by node. To quote the <a href="https://yarnpkg.com/en/docs/pnp" target="_blank" rel="noopener noreferrer">(excellent) docs</a>:</p><blockquote><p>Plug’n’Play is an alternative installation strategy unveiled in September 2018...</p><p>The way regular installs work is simple: Yarn generates a <code>node_modules</code> directory that Node is then able to consume. In this context, Node doesn’t know the first thing about what a package is: it only reasons in terms of files. “Does this file exist here? No? Let’s look in the parent <code>node_modules</code> then. Does it exist here? Still no? Too bad… parent folder it is!” - and it does this until it matches something that matches one of the possibilities. That’s vastly inefficient.</p><p>When you think about it, Yarn knows everything about your dependency tree - it evens installs it! So why is Node tasked with locating your packages on the disk? Why don’t we simply query Yarn, and let it tell us where to look for a package X required by a package Y? That’s what Plug’n’Play (abbreviated PnP) is. Instead of generating a node_modules directory and leaving the resolution to Node, we now generate a single .pnp.js file and let Yarn tell us where to find our packages.</p></blockquote><p>Yarn has been worked upon, amongst others, by the excellent <a href="https://twitter.com/arcanis" target="_blank" rel="noopener noreferrer">Maël Nison</a>. You can hear him talking about it in person <a href="https://youtu.be/XePfzVs852s" target="_blank" rel="noopener noreferrer">in this talk at JSConfEU</a>.</p><p>Thanks particularly to Maël&#x27;s work, it&#x27;s possible to use Yarn PnP with TypeScript using webpack with <code>ts-loader</code> <em>and</em><code>fork-ts-checker-webpack-plugin</code>. This post intends to show you just how simple it is to convert a project that uses either to work with Yarn PnP.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="vanilla-ts-loader"></a>Vanilla <code>ts-loader</code><a class="hash-link" href="#vanilla-ts-loader" title="Direct link to heading">#</a></h2><p>Your project is built using standalone <code>ts-loader</code>; i.e. a simple setup that handles both transpilation and type checking.</p><p>First things first, add this property to your <code>package.json</code>: (this is only required if you are using Yarn 1; this tag will be optional starting from the v2, where projects will switch to PnP by default.)</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;installConfig&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;pnp&quot;: true </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Also, because this is webpack, we&#x27;re going to need to add an extra dependency in the form of <code>pnp-webpack-plugin</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">yarn add -D pnp-webpack-plugin</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>To quote the excellent docs, make the following amends to your <code>webpack.config.js</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">const PnpWebpackPlugin = require(`pnp-webpack-plugin`);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">module.exports = { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    module: { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        rules: [{ </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            test: /\.ts$/, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            loader: require.resolve(&#x27;ts-loader&#x27;), </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            options: PnpWebpackPlugin.tsLoaderOptions(), </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }], </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    resolve: { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        plugins: [ PnpWebpackPlugin, ], </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    resolveLoader: { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        plugins: [ PnpWebpackPlugin.moduleLoader(module), ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If you have any options you want to pass to <code>ts-loader</code>, just pass them as parameter of <code>pnp-webpack-plugin</code>&#x27;s <code>tsLoaderOptions</code> function and it will take care of forwarding them properly. Behind the scenes the <code>tsLoaderOptions</code> function is providing <code>ts-loader</code> with the options necessary to switch into Yarn PnP mode.</p><p>Congratulations; you now have <code>ts-loader</code> functioning with Yarn PnP support!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="fork-ts-checker-webpack-plugin-with-ts-loader"></a><code>fork-ts-checker-webpack-plugin</code> with <code>ts-loader</code><a class="hash-link" href="#fork-ts-checker-webpack-plugin-with-ts-loader" title="Direct link to heading">#</a></h2><p>You may well be using <code>fork-ts-checker-webpack-plugin</code> to handle type checking whilst <code>ts-loader</code> gets on with the transpilation. This workflow is also supported using <code>pnp-webpack-plugin</code>. You&#x27;ll have needed to follow the same steps as the <code>ts-loader</code> setup. It&#x27;s just the <code>webpack.config.js</code> tweaks that will be different.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">const PnpWebpackPlugin = require(`pnp-webpack-plugin`);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">module.exports = { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    plugins: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new ForkTsCheckerWebpackPlugin(PnpWebpackPlugin.forkTsCheckerOptions({</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            useTypescriptIncrementalApi: false, // not possible to use this until: https://github.com/microsoft/TypeScript/issues/31056</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        })),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    module: { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        rules: [{ </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            test: /\.ts$/, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            loader: require.resolve(&#x27;ts-loader&#x27;), </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            options: PnpWebpackPlugin.tsLoaderOptions({ transpileOnly: true }), </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }], </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    resolve: { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        plugins: [ PnpWebpackPlugin, ], </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    resolveLoader: { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        plugins: [ PnpWebpackPlugin.moduleLoader(module), ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Again if you have any options you want to pass to <code>ts-loader</code>, just pass them as parameter of <code>pnp-webpack-plugin</code>&#x27;s <code>tsLoaderOptions</code> function. As we&#x27;re using <code>fork-ts-checker-webpack-plugin</code> we&#x27;re going to want to stop <code>ts-loader</code> doing type checking with the <code>transpileOnly: true</code> option.</p><p>We&#x27;re now initialising <code>fork-ts-checker-webpack-plugin</code> with <code>pnp-webpack-plugin</code>&#x27;s <code>forkTsCheckerOptions</code> function. Behind the scenes the <code>forkTsCheckerOptions</code> function is providing the <code>fork-ts-checker-webpack-plugin</code> with the options necessary to switch into Yarn PnP mode.</p><p>And that&#x27;s it! You now have <code>ts-loader</code> and <code>fork-ts-checker-webpack-plugin</code> functioning with Yarn PnP support!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="living-on-the-bleeding-edge"></a>Living on the Bleeding Edge<a class="hash-link" href="#living-on-the-bleeding-edge" title="Direct link to heading">#</a></h2><p>Whilst you can happily develop and build using Yarn PnP, it&#x27;s worth bearing in mind that this is a new approach. As such, there&#x27;s some rough edges right now.</p><p>If you&#x27;re interested in Yarn PnP, it&#x27;s worth taking the v2 of Yarn (Berry) for a spin. You can find it here: <a href="https://github.com/yarnpkg/berry" target="_blank" rel="noopener noreferrer">https://github.com/yarnpkg/berry</a>. It&#x27;s where most of the Yarn PnP work happens, and it includes zip loading - two birds, one stone!</p><p>Because there isn&#x27;t first class support for Yarn PnP in TypeScript itself yet, you cannot make use of the Watch API through <code>fork-ts-checker-webpack-plugin</code>. (You can read about that issue <a href="https://github.com/microsoft/TypeScript/issues/31056" target="_blank" rel="noopener noreferrer">here</a>)</p><p>As you&#x27;ve likely noticed, the webpack configuration required makes for a noisy <code>webpack.config.js</code>. Further to that, VS Code (which is powered by TypeScript remember) has no support for Yarn PnP yet and so will present resolution errors to you. If you can ignore the sea of red squigglies all over your source files in the editor and just look at your webpack build you&#x27;ll be fine.</p><p>There is a tool called <code>PnPify</code> that adds support for PnP to TypeScript (in particular tsc). You can find more information here: <a href="https://yarnpkg.github.io/berry/advanced/pnpify" target="_blank" rel="noopener noreferrer">https://yarnpkg.github.io/berry/advanced/pnpify</a>. For tsc it would be:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$&gt; yarn pnpify tsc [...]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The gist is that it simulates the existence of <code>node_modules</code> by leveraging the data from the PnP file. As such it&#x27;s not a perfect fix (<code>pnp-webpack-plugin</code> is a better integration), but it&#x27;s a very useful tool to have to unblock yourself when using a project that doesn&#x27;t support it.</p><p>PnPify actually allows us to use TypeScript in VSCode with PnP! Its documentation is here: <a href="https://yarnpkg.github.io/berry/advanced/pnpify#vscode-support" target="_blank" rel="noopener noreferrer">https://yarnpkg.github.io/berry/advanced/pnpify#vscode-support</a></p><p>All of these hindrances should hopefully be resolved in future. Ideally, one day a good developer experience can be the default experience. In the meantime, you can still dev - just be prepared for the rough edges. Here&#x27;s some useful resources to track the future of support:</p><ul><li>You can follow more on built in webpack support here: <a href="https://github.com/webpack/enhanced-resolve/issues/162" target="_blank" rel="noopener noreferrer">https://github.com/webpack/enhanced-resolve/issues/162</a></li><li>And on built in TypeScript support here: <a href="https://github.com/Microsoft/TypeScript/issues/18896" target="_blank" rel="noopener noreferrer">https://github.com/Microsoft/TypeScript/issues/18896</a></li><li>Finally, there it&#x27;s worth watching the <a href="https://github.com/nodejs/modules" target="_blank" rel="noopener noreferrer">nodejs/module</a> repository, which debates amongst other things how to properly integrate loaders with Node.</li></ul><p>This last one would be nice because:</p><ul><li>We&#x27;d stop having to patch require</li><li>We probably wouldn&#x27;t have to use yarn node if Node itself was able to find the loader somehow (such as if it was listed in the package.json metadata)</li></ul><p>Thanks to Maël for his tireless work on Yarn. To my mind Maël is certainly a candidate for the hardest worker in open source. I&#x27;ve been shamelessly borrowing his excellent docs for this post - thanks for writing so excellently Maël!</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/type-script">TypeScript</a><a class="margin-horiz--sm" href="/tags/yarn">yarn</a><a class="margin-horiz--sm" href="/tags/webpack">Webpack</a><a class="margin-horiz--sm" href="/tags/pn-p">PnP</a></div><div class="col text--right"><a aria-label="Read more about TypeScript / webpack - you down with PnP? Yarn, you know me!" href="/2019/06/07/typescript-webpack-you-down-with-pnp"><strong>Read More</strong></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/2019/01/05/github-actions-and-yarn">GitHub Actions and Yarn</a></h2><div class="margin-vert--md"><time datetime="2019-01-05T00:00:00.000Z" class="blogPostDate_Ta7i">January 5, 2019  · 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>I&#x27;d been meaning to automate the npm publishing of <a href="https://github.com/TypeStrong/ts-loader" target="_blank" rel="noopener noreferrer"><code>ts-loader</code></a> for the longest time. I had attempted to use Travis to do this in the same way as <a href="https://github.com/Realytics/fork-ts-checker-webpack-plugin" target="_blank" rel="noopener noreferrer"><code>fork-ts-checker-webpack-plugin</code></a>. Alas using secure environment variables in Travis has unfortunate implications for ts-loader&#x27;s test pack.</p><p>Be not afeard. I&#x27;ve heard there&#x27;s a new shiny thing from GitHub that I could use instead... It&#x27;s a sign; I must use it!</p><p>GitHub Actions are still in beta. Technically Actions are <a href="https://developer.github.com/actions/creating-github-actions/" target="_blank" rel="noopener noreferrer">code run in Docker containers</a> in response to events. This didn&#x27;t mean a great deal to me until I started thinking about what I wanted to do with <code>ts-loader</code>&#x27;s publishing flow.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="automate-what"></a>Automate What?<a class="hash-link" href="#automate-what" title="Direct link to heading">#</a></h2><p>Each time I publish a release of <code>ts-loader</code> I execute the following node commands by hand:</p><ol><li><code>yarn install</code> - to install <code>ts-loader</code>&#x27;s dependencies</li><li><code>yarn build</code> - to build <code>ts-loader</code></li><li><code>yarn test</code> - to run <code>ts-loader</code>&#x27;s test packs</li><li><code>npm publish</code> - to publish the release of <code>ts-loader</code> to npm</li></ol><p>Having read up on GitHub Actions it seemed like they were born to handle this sort of task.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="github-action-for-npm"></a>GitHub Action for <code>npm</code><a class="hash-link" href="#github-action-for-npm" title="Direct link to heading">#</a></h2><p>I quickly discovered that someone out there <s>loves me</s></p><p> had <a href="https://github.com/actions/npm" target="_blank" rel="noopener noreferrer">already written a GitHub Action for <code>npm</code></a>.</p><p>The example in the <a href="https://github.com/actions/npm/blob/master/README.md" target="_blank" rel="noopener noreferrer"><code>README.md</code></a> could be easily tweaked to meet my needs with one caveat: I had to use <code>npm</code> in place of <code>yarn</code>. I didn&#x27;t want to switch from <code>yarn</code>. What to do?</p><p>Well, remember when I said actions are code run in Docker containers? Another way to phrase that is to say: GitHub Actions are Docker images. Let&#x27;s look under the covers of the <code>npm</code> GitHub Action. As we peer inside the <a href="https://github.com/actions/npm/blob/e7aaefed7c9f2e83d493ff810f17fa5ccd7ed437/Dockerfile#L1" target="_blank" rel="noopener noreferrer"><code>Dockerfile</code></a> what do we find?</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">FROM node:10-slim</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Hmmmm.... Interesting. The base image of the <code>npm</code> GitHub Action is <code>node:10-slim</code>. Looking it up, it seems the <code>-slim</code> Docker images come with <a href="https://github.com/nodejs/docker-node/blob/master/Dockerfile-slim.template" target="_blank" rel="noopener noreferrer"><code>yarn</code> included</a>. Which means we should be able to use <code>yarn</code> inside the <code>npm</code> GitHub Action. Nice!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="github-action-for-npm-for-yarn"></a>GitHub Action for <code>npm</code> for <code>yarn</code><a class="hash-link" href="#github-action-for-npm-for-yarn" title="Direct link to heading">#</a></h2><p>Using <code>yarn</code> from the GitHub Action for <code>npm</code> is delightfully simple. Here&#x27;s what running <code>npm install</code> looks like:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># install with npm</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">action &quot;install&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  uses = &quot;actions/npm@1.0.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  args = &quot;install&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Pivoting to use <code>yarn install</code> instead of <code>npm install</code> is as simple as:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># install with yarn</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">action &quot;install&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  uses = &quot;actions/npm@1.0.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  runs = &quot;yarn&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  args = &quot;install&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>You can see we&#x27;ve introduced the <code>runs = &quot;yarn&quot;</code> and after that the <code>args</code> are whatever you need them to be.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="going-with-the-workflow"></a>Going With The Workflow<a class="hash-link" href="#going-with-the-workflow" title="Direct link to heading">#</a></h2><p>A GitHub Workflow that implements the steps I need would look like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">workflow &quot;build, test and publish on release&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  on = &quot;push&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resolves = &quot;publish&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># install with yarn</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">action &quot;install&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  uses = &quot;actions/npm@1.0.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  runs = &quot;yarn&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  args = &quot;install&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># build with yarn</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">action &quot;build&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  needs = &quot;install&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  uses = &quot;actions/npm@1.0.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  runs = &quot;yarn&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  args = &quot;build&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># test with yarn</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">action &quot;test&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  needs = &quot;build&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  uses = &quot;actions/npm@1.0.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  runs = &quot;yarn&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  args = &quot;test&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># filter for a new tag</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">action &quot;check for new tag&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  needs = &quot;Test&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  uses = &quot;actions/bin/filter@master&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  args = &quot;tag&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># publish with npm</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">action &quot;publish&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  needs = &quot;check for new tag&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  uses = &quot;actions/npm@1.0.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  args = &quot;publish&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  secrets = [&quot;NPM_AUTH_TOKEN&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>As you can see, this is a direct automation of steps 1-4 I listed earlier. Since all these actions are executed in the same container, we can skip from <code>yarn</code> to <code>npm</code> with gay abandon.</p><p>What&#x27;s absolutely amazing is, when I got access to GitHub Actions <a href="https://github.com/TypeStrong/ts-loader/blob/master/.github/main.workflow" target="_blank" rel="noopener noreferrer">my hand crafted workflow</a> looked like it should work first time! I know, right? Don&#x27;t you love it when that happens? <a href="https://github.com/actions/bin/issues/13" target="_blank" rel="noopener noreferrer">Alas there&#x27;s presently a problem with filters in GitHub Actions</a>. But that&#x27;s by the by, if you&#x27;re just looking to use a GitHub Action with yarn instead of npm then you are home free.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="you-dont-actually-need-the-npm-github-action"></a>You Don&#x27;t Actually Need the npm GitHub Action<a class="hash-link" href="#you-dont-actually-need-the-npm-github-action" title="Direct link to heading">#</a></h2><p>You heard me right. Docker containers be Docker containers. You don&#x27;t actually need to use this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">uses = &quot;actions/npm@1.0.0&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>You can use <em>any</em> Docker container which has node / npm installed! So if you&#x27;d like to use say node 11 instead you could just do this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">uses = &quot;docker://node:11&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Which would use the node 11 image on <a href="https://hub.docker.com/_/node" target="_blank" rel="noopener noreferrer">docker hub</a>.</p><p>Which is pretty cool. You know what&#x27;s even more incredible? Inside a workflow you can switch <code>uses</code> mid-workflow and keep the output. That&#x27;s right; you can have a work flow with say three actions running <code>uses = &quot;docker://node:11&quot;</code> and then a fourth running <code>uses = &quot;actions/npm@1.0.0&quot;</code>. That&#x27;s <em>so</em> flexible and powerful!</p><p>Thanks to <a href="https://github.com/mcolyer" target="_blank" rel="noopener noreferrer">Matt Colyer</a> and <a href="https://github.com/LandonSchropp" target="_blank" rel="noopener noreferrer">Landon Schropp</a> for <a href="https://github.com/actions/npm/issues/9" target="_blank" rel="noopener noreferrer">schooling me on the intricicies of GitHub Actions</a>. Much ❤</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/docker">docker</a><a class="margin-horiz--sm" href="/tags/yarn">yarn</a><a class="margin-horiz--sm" href="/tags/git-hub-actions">GitHub Actions</a></div><div class="col text--right"><a aria-label="Read more about GitHub Actions and Yarn" href="/2019/01/05/github-actions-and-yarn"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.abcb43ba.js"></script>
<script src="/runtime~main.333857ee.js"></script>
<script src="/main.cedb1112.js"></script>
<script src="/1.b4966bec.js"></script>
<script src="/2.45eb8537.js"></script>
<script src="/6875c492.7c950930.js"></script>
<script src="/c3b5bd8c.985f0121.js"></script>
<script src="/1b063778.ba6817b4.js"></script>
<script src="/012d4097.320797bc.js"></script>
<script src="/19afa2f3.36feef6f.js"></script>
</body>
</html>