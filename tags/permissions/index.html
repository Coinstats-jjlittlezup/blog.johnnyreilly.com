<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">One post tagged with &quot;permissions&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="One post tagged with &quot;permissions&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/permissions"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/blog/2021-02-08-arm-templates-security-role-assignments/with-great-power-comes-great-responsibility.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/blog/2021-02-08-arm-templates-security-role-assignments/with-great-power-comes-great-responsibility.jpg"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/permissions"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/permissions" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/permissions" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.c5af4104.css">
<link rel="preload" href="/assets/js/runtime~main.557caf17.js" as="script">
<link rel="preload" href="/assets/js/main.7c6b86f5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/08/01/typescript-abstract-classes-and-constructors">TypeScript, abstract classes, and constructors</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/07/14/directory-build-props-c-sharp-9-for-all">Directory.Build.props: C# 9 for all your projects</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/07/11/webpack-esbuild-why-not-both">webpack? esbuild? Why not both?</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/07/07/output-connection-strings-and-keys-from-azure-bicep">Output connection strings and keys from Azure Bicep</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/07/01/c-sharp-9-azure-functions-in-process">C# 9 in-process Azure Functions</a></li></ul></nav></aside><main class="col col--7"><header class="margin-bottom--xl"><h1>One post tagged with &quot;permissions&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_GeHD"><a href="/2021/02/08/arm-templates-security-role-assignments">ARM templates, security, role assignments and magic GUIDs</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-02-08T00:00:00.000Z">February 8, 2021</time> Â· 6 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer">John Reilly</a></div><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><p>If you&#x27;re deploying to Azure, there&#x27;s a good chance you&#x27;re using <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview" target="_blank" rel="noopener noreferrer">ARM templates</a> to do so. Once you&#x27;ve got past &quot;Hello World&quot;, you&#x27;ll probably find yourself in a situation when you&#x27;re deploying multiple types of resource to make your solution. For instance, you may be deploying an <a href="https://docs.microsoft.com/en-us/azure/app-service/quickstart-arm-template?pivots=platform-linux#review-the-template" target="_blank" rel="noopener noreferrer">App Service</a> alongside <a href="https://docs.microsoft.com/en-us/azure/templates/microsoft.keyvault/vaults" target="_blank" rel="noopener noreferrer">Key Vault</a> and <a href="https://docs.microsoft.com/en-us/azure/templates/microsoft.storage/storageaccounts" target="_blank" rel="noopener noreferrer">Storage</a>.</p><p>One of the hardest things when it comes to deploying software and having it work, is permissions. Without adequate permissions configured, the most beautiful code can do <em>nothing</em>. Incidentally, this is a good thing. We&#x27;re deploying to the web; many people are there, not all good. As a different kind of web-head once said:</p><p> <img alt="Spider-man saying with great power, comes great responsibility" src="/assets/images/with-great-power-comes-great-responsibility-be2ae78bc5a7371b606fc4ea7d0f83fa.jpg"></p><p>Azure has great power and <a href="https://docs.microsoft.com/en-us/azure/security/fundamentals/identity-management-best-practices#use-role-based-access-control" target="_blank" rel="noopener noreferrer">suggests you use it wisely</a>.</p><blockquote><p>Access management for cloud resources is critical for any organization that uses the cloud. <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/overview" target="_blank" rel="noopener noreferrer">Azure role-based access control (Azure RBAC)</a> helps you manage who has access to Azure resources, what they can do with those resources, and what areas they have access to.</p><p>Designating groups or individual roles responsible for specific functions in Azure helps avoid confusion that can lead to human and automation errors that create security risks. Restricting access based on the <a href="https://en.wikipedia.org/wiki/Need_to_know" target="_blank" rel="noopener noreferrer">need to know</a> and <a href="https://en.wikipedia.org/wiki/Principle_of_least_privilege" target="_blank" rel="noopener noreferrer">least privilege</a> security principles is imperative for organizations that want to enforce security policies for data access.</p></blockquote><p>This is good advice. With that in mind, how can we ensure that the different resources we&#x27;re deploying to Azure can talk to one another?</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="role-up-for-your-assignments"></a>Role (up for your) assignments<a class="hash-link" href="#role-up-for-your-assignments" title="Direct link to heading">#</a></h2><p>The answer is roles. There&#x27;s a number of roles that exist in Azure that can be assigned to users, groups, service principals and managed identities. In our own case we&#x27;re using managed identity for our resources. What we can do is use <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-works" target="_blank" rel="noopener noreferrer">&quot;role assignments&quot;</a> to give our managed identity access to given resources. <a href="https://twitter.com/ArLucaID" target="_blank" rel="noopener noreferrer">Arturo Lucatero</a> gives a great short explanation of this:</p><iframe width="560" height="315" src="https://www.youtube.com/embed/Dzhm-garKBM" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe><p>Whilst this explanation is delightfully simple, the actual implementation when it comes to ARM templates is a little more involved. Because now it&#x27;s time to talk &quot;magic&quot; GUIDs. Consider the following truncated ARM template, which gives our managed identity (and hence our App Service which uses this identity) access to Key Vault and Storage:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;$schema&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;variables&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;managedIdentity&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(&#x27;mi-&#x27;, parameters(&#x27;applicationName&#x27;), &#x27;-&#x27;, parameters(&#x27;environment&#x27;), &#x27;-&#x27;, &#x27;001&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;appInsightsName&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(&#x27;appi-&#x27;, parameters(&#x27;applicationName&#x27;), &#x27;-&#x27;, parameters(&#x27;environment&#x27;), &#x27;-&#x27;, &#x27;001&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;keyVaultName&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(&#x27;kv-&#x27;, parameters(&#x27;applicationName&#x27;), &#x27;-&#x27;, parameters(&#x27;environment&#x27;), &#x27;-&#x27;, &#x27;001&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;storageAccountName&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(&#x27;st&#x27;, parameters(&#x27;applicationName&#x27;), parameters(&#x27;environment&#x27;), &#x27;001&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;storageBlobDataContributor&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;ba92f5b4-2d11-453d-a403-e96b0029c9fe&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;keyVaultSecretsOfficer&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;b86a8fe4-44ce-4948-aee5-eccb2c155cd7&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;keyVaultCryptoOfficer&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;14b46e9e-c2b7-41b4-b07b-48a6ebf60603&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;uniqueRoleGuidKeyVaultSecretsOfficer&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[guid(resourceId(&#x27;Microsoft.KeyVault/vaults&#x27;,  variables(&#x27;keyVaultName&#x27;)), variables(&#x27;keyVaultSecretsOfficer&#x27;), resourceId(&#x27;Microsoft.KeyVault/vaults&#x27;, variables(&#x27;keyVaultName&#x27;)))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;uniqueRoleGuidKeyVaultCryptoOfficer&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[guid(resourceId(&#x27;Microsoft.KeyVault/vaults&#x27;,  variables(&#x27;keyVaultName&#x27;)), variables(&#x27;keyVaultCryptoOfficer&#x27;), resourceId(&#x27;Microsoft.KeyVault/vaults&#x27;, variables(&#x27;keyVaultName&#x27;)))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;uniqueRoleGuidStorageAccount&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[guid(resourceId(&#x27;Microsoft.Storage/storageAccounts&#x27;,  variables(&#x27;storageAccountName&#x27;)), variables(&#x27;storageBlobDataContributor&#x27;), resourceId(&#x27;Microsoft.Storage/storageAccounts&#x27;, variables(&#x27;storageAccountName&#x27;)))]&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;resources&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Microsoft.ManagedIdentity/userAssignedIdentities&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[variables(&#x27;managedIdentity&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;apiVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2018-11-30&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;location&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[parameters(&#x27;location&#x27;)]&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Microsoft.Storage/storageAccounts/providers/roleAssignments&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;apiVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2020-04-01-preview&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(variables(&#x27;storageAccountName&#x27;), &#x27;/Microsoft.Authorization/&#x27;, variables(&#x27;uniqueRoleGuidStorageAccount&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;dependsOn&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities&#x27;, variables(&#x27;managedIdentity&#x27;))]&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;properties&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;roleDefinitionId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[variables(&#x27;storageBlobDataContributor&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[reference(resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities/&#x27;, variables(&#x27;managedIdentity&#x27;)), &#x27;2018-11-30&#x27;).principalId]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;scope&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.Storage/storageAccounts&#x27;, variables(&#x27;storageAccountName&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalType&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ServicePrincipal&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Microsoft.KeyVault/vaults/providers/roleAssignments&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;apiVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2018-01-01-preview&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(variables(&#x27;keyVaultName&#x27;), &#x27;/Microsoft.Authorization/&#x27;, variables(&#x27;uniqueRoleGuidKeyVaultSecretsOfficer&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;dependsOn&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities&#x27;, variables(&#x27;managedIdentity&#x27;))]&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;properties&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;roleDefinitionId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[variables(&#x27;keyVaultSecretsOfficer&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[reference(resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities/&#x27;, variables(&#x27;managedIdentity&#x27;)), &#x27;2018-11-30&#x27;).principalId]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;scope&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.KeyVault/vaults&#x27;, variables(&#x27;keyVaultName&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalType&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ServicePrincipal&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Microsoft.KeyVault/vaults/providers/roleAssignments&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;apiVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2018-01-01-preview&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(variables(&#x27;keyVaultName&#x27;), &#x27;/Microsoft.Authorization/&#x27;, variables(&#x27;uniqueRoleGuidKeyVaultCryptoOfficer&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;dependsOn&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities&#x27;, variables(&#x27;managedIdentity&#x27;))]&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;properties&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;roleDefinitionId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[variables(&#x27;keyVaultCryptoOfficer&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[reference(resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities/&#x27;, variables(&#x27;managedIdentity&#x27;)), &#x27;2018-11-30&#x27;).principalId]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;scope&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.KeyVault/vaults&#x27;, variables(&#x27;keyVaultName&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalType&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ServicePrincipal&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Let&#x27;s take a look at these three variables:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token property">&quot;storageBlobDataContributor&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;ba92f5b4-2d11-453d-a403-e96b0029c9fe&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token property">&quot;keyVaultSecretsOfficer&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;b86a8fe4-44ce-4948-aee5-eccb2c155cd7&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token property">&quot;keyVaultCryptoOfficer&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;14b46e9e-c2b7-41b4-b07b-48a6ebf60603&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The three variables above contain the subscription resource ids for the roles <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#storage-blob-data-contributor" target="_blank" rel="noopener noreferrer">Storage Blob Data Contributor</a>, <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#key-vault-secrets-officer-preview" target="_blank" rel="noopener noreferrer">Key Vault Secrets Officer</a> and <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#key-vault-crypto-officer-preview" target="_blank" rel="noopener noreferrer">Key Vault Crypto Officer</a>. The first question on your mind is likely: &quot;what is <code>ba92f5b4-2d11-453d-a403-e96b0029c9fe</code> and where does it come from?&quot; Great question! Well, each of these GUIDs represents a built-in role in Azure RBAC. The <code>ba92f5b4-2d11-453d-a403-e96b0029c9fe</code> represents the Storage Blob Data Contributor role.</p><p>How can I look these up? Well, there&#x27;s two ways; <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles" target="_blank" rel="noopener noreferrer">there&#x27;s an article which documents them here</a> or you could crack open the <a href="https://azure.microsoft.com/en-gb/features/cloud-shell/" target="_blank" rel="noopener noreferrer">Cloud Shell</a> and look up a role by GUID like so:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ps"><pre tabindex="0" class="prism-code language-ps codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Get-AzRoleDefinition | ? {$_.id -eq &quot;ba92f5b4-2d11-453d-a403-e96b0029c9fe&quot; }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Name             : Storage Blob Data Contributor</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Id               : ba92f5b4-2d11-453d-a403-e96b0029c9fe</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">IsCustom         : False</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Description      : Allows for read, write and delete access to Azure Storage blob containers and data</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Actions          : {Microsoft.Storage/storageAccounts/blobServices/containers/delete, Microsoft.Storage/storageAccounts/blobServices/containers/read,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                   Microsoft.Storage/storageAccounts/blobServices/containers/write, Microsoft.Storage/storageAccounts/blobServices/generateUserDelegationKey/action}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NotActions       : {}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DataActions      : {Microsoft.Storage/storageAccounts/blobServices/containers/blobs/delete, Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                   Microsoft.Storage/storageAccounts/blobServices/containers/blobs/write, Microsoft.Storage/storageAccounts/blobServices/containers/blobs/move/actionâ€¦}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NotDataActions   : {}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">AssignableScopes : {/}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Or by name like so:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ps"><pre tabindex="0" class="prism-code language-ps codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Get-AzRoleDefinition | ? {$_.name -like &quot;*Crypto Officer*&quot; }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Name             : Key Vault Crypto Officer</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Id               : 14b46e9e-c2b7-41b4-b07b-48a6ebf60603</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">IsCustom         : False</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Description      : Perform any action on the keys of a key vault, except manage permissions. Only works for key vaults that use the &#x27;Azure role-based access control&#x27; permission model.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Actions          : {Microsoft.Authorization/*/read, Microsoft.Insights/alertRules/*, Microsoft.Resources/deployments/*, Microsoft.Resources/subscriptions/resourceGroups/readâ€¦}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NotActions       : {}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DataActions      : {Microsoft.KeyVault/vaults/keys/*}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NotDataActions   : {}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">AssignableScopes : {/}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As you can see, the <code>Actions</code> section of the output above (and in even more detail on the <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles" target="_blank" rel="noopener noreferrer">linked article</a>) provides information about what the different roles can do. So if you&#x27;re looking to enable one Azure resource to talk to another, you should be able to refer to these to identify a role that you might want to use.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="creating-a-role-assignment"></a>Creating a role assignment<a class="hash-link" href="#creating-a-role-assignment" title="Direct link to heading">#</a></h2><p>So now we understand how you identify the roles in question, let&#x27;s take the final leap and look at assigning those roles to our managed identity. For each role assignment, you&#x27;ll need a <code>roleAssignments</code> resource defined that looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Microsoft.KeyVault/vaults/providers/roleAssignments&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;apiVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2018-01-01-preview&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[concat(variables(&#x27;keyVaultName&#x27;), &#x27;/Microsoft.Authorization/&#x27;, variables(&#x27;uniqueRoleGuidKeyVaultCryptoOfficer&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;dependsOn&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities&#x27;, variables(&#x27;managedIdentity&#x27;))]&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;properties&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;roleDefinitionId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[variables(&#x27;keyVaultCryptoOfficer&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[reference(resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities/&#x27;, variables(&#x27;managedIdentity&#x27;)), &#x27;2018-11-30&#x27;).principalId]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;scope&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[resourceId(&#x27;Microsoft.KeyVault/vaults&#x27;, variables(&#x27;keyVaultName&#x27;))]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token property">&quot;principalType&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ServicePrincipal&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Let&#x27;s go through the above, significant property by significant property (it&#x27;s also worth checking the official reference <a href="https://docs.microsoft.com/en-us/azure/templates/microsoft.authorization/roleassignments" target="_blank" rel="noopener noreferrer">here</a>):</p><ul><li><code>type</code> - the type of role assignment we want to create, for a key vault it&#x27;s <code>&quot;Microsoft.KeyVault/vaults/providers/roleAssignments&quot;</code>, for storage it&#x27;s <code>&quot;Microsoft.Storage/storageAccounts/providers/roleAssignments&quot;</code>. The pattern is that it&#x27;s the resource type, followed by <code>&quot;/providers/roleAssignments&quot;</code>. </li><li><code>dependsOn</code> - before we can create a role assignment, we need the service principal we desire to permission (in our case a managed identity) to exist</li><li><code>properties.roleDefinitionId</code> - the role that we&#x27;re assigning, provided as an id. So for this example it&#x27;s the <code>keyVaultCryptoOfficer</code> variable, which was earlier defined as <code>[subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;ba92f5b4-2d11-453d-a403-e96b0029c9fe&#x27;)]</code>. (Note the use of the GUID)</li><li><code>properties.principalId</code> - the id of the principal we&#x27;re adding permissions for. In our case this is a managed identity (a type of service principal).</li><li><code>properties.scope</code> - we&#x27;re modifying another resource; our key vault isn&#x27;t defined in this ARM template and we want to specify the resource we&#x27;re granting permissions to.</li><li><code>properties.principalType</code> - the type of principal that we&#x27;re creating an assignment for; in our this is <code>&quot;ServicePrincipal&quot;</code> - our managed identity.</li></ul><p>There is an alternate approach that you can use where the <code>type</code> is <code>&quot;Microsoft.Authorization/roleAssignments&quot;</code>. Whilst this also works, it displayed errors in the <a href="https://marketplace.visualstudio.com/items?itemName=msazurermtools.azurerm-vscode-tools" target="_blank" rel="noopener noreferrer">Azure tooling for VS Code</a>. As such, we&#x27;ve opted not to use that approach in our ARM templates.</p><p>Many thanks to the awesome <a href="https://github.com/jmccor99" target="_blank" rel="noopener noreferrer">John McCormick</a> who wrangled permissions with me until we bent Azure RBAC to our will.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/tags/azure">Azure</a><a class="margin-horiz--sm" href="/tags/arm-templates">ARM templates</a><a class="margin-horiz--sm" href="/tags/role-assignments">role assignments</a><a class="margin-horiz--sm" href="/tags/permissions">permissions</a></div><div class="col text--right"><a aria-label="Read more about ARM templates, security, role assignments and magic GUIDs" href="/2021/02/08/arm-templates-security-role-assignments"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.557caf17.js"></script>
<script src="/assets/js/main.7c6b86f5.js"></script>
</body>
</html>