<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Posts tagged &quot;windows service&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;windows service&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;windows service&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;windows service&quot;"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/windows-service"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/windows-service"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/windows-service" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/windows-service" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.3ed665c6.css">
<link rel="preload" href="/assets/js/styles.f7659eed.js" as="script">
<link rel="preload" href="/assets/js/runtime~main.74f1dcf9.js" as="script">
<link rel="preload" href="/assets/js/main.77bdfe03.js" as="script">
<link rel="preload" href="/assets/js/1.194e3740.js" as="script">
<link rel="preload" href="/assets/js/2.85d4c801.js" as="script">
<link rel="preload" href="/assets/js/6875c492.1786d4e6.js" as="script">
<link rel="preload" href="/assets/js/c3b5bd8c.a1a5ba6a.js" as="script">
<link rel="preload" href="/assets/js/6266f07f.4f1bab4e.js" as="script">
<link rel="preload" href="/assets/js/a976e6bb.e277a62d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/about">About</a></li><li class="menu__list-item"><a class="menu__link" href="/blog-archive">Blog Archive</a></li><li class="menu__list-item"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="menu__link">Twitter</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/20/bicep-meet-azure-pipelines">Bicep in Azure Pipelines</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/17/rss-update-we-moved-to-docusaurus">RSS update; we moved to Docusaurus</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/15/from-blogger-to-docusaurus">From Blogger to Docusaurus</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/10/managed-identity-azure-sql-entity-framework">Managed Identity, Azure SQL and Entity Framework</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/06/generate-typescript-and-csharp-clients-with-nswag">Generate TypeScript and CSharp clients with NSwag based on an API</a></li></ul></div></div><main class="col col--7"><h1>One post tagged with &quot;windows service&quot;</h1><a href="/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/2012/03/22/wcf-moving-from-config-to-code-simple">WCF - moving from Config to Code, a simple WCF service harness (plus implementing your own Authorization)</a></h2><div class="margin-vert--md"><time datetime="2012-03-22T00:00:00.000Z" class="blogPostDate_fNvV">March 22, 2012 Â· 11 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><p>Last time I wrote about WCF I was getting up and running with <a href="http://icanmakethiswork.blogspot.com/2012/02/wcf-transport-windows-authentication.html" target="_blank" rel="noopener noreferrer">WCF Transport Windows authentication using NetTcpBinding in an Intranet environment</a>. I ended up with a WCF service hosted in a Windows Service which did pretty much what the previous post name implies.</p><p> Since writing that I&#x27;ve taken things on a bit further and I thought it worth recording my approach whilst it&#x27;s still fresh in my mind. There&#x27;s 3 things I want to go over:</p><ol><li>I&#x27;ve moved away from the standard config driven WCF approach to a more &quot;code-first&quot; style</li><li>I&#x27;ve established a basic Windows Service hosted WCF service / client harness which is useful if you&#x27;re trying to get up and running with a WCF service quickly</li><li>I&#x27;ve locked down the WCF authorization to a single Windows account through the use of my own <a href="http://msdn.microsoft.com/en-us/library/ms731774.aspx" target="_blank" rel="noopener noreferrer">ServiceAuthorizationManager</a></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="moving-from-config-to-code"></a>Moving from Config to Code<a class="hash-link" href="#moving-from-config-to-code" title="Direct link to heading">#</a></h2><p>So, originally I was doing what all the cool kids are doing and driving the configuration of my WCF service and all its clients through config files. And why not? I&#x27;m in good company.</p><p>Here&#x27;s why not: it gets *<strong>very</strong>* verbose *<strong>very</strong>* quickly....</p><p>Okay - that&#x27;s not the end of the world. My problem was that I had ~10 Windows Services and 3 Web applications that needed to call into my WCF Service. I didn&#x27;t want to have to separately tweak 15 or so configs each time I wanted to make one standard change to WCF configuration settings. I wanted everything in one place.</p><p>Now there&#x27;s newer (and probably hipper) ways of achieving this. <a href="http://stackoverflow.com/a/2814286" target="_blank" rel="noopener noreferrer">Here&#x27;s one possibility I happened upon on StackOverflow that looks perfectly fine.</a></p><p>Well I didn&#x27;t use a hip new approach - no I went Old School with my old friend the <a href="http://msdn.microsoft.com/en-us/library/ms228154.aspx" target="_blank" rel="noopener noreferrer">appSettings file attribute</a>. Remember that? It&#x27;s just a simple way to have all your common appSettings configuration settings in a single file which can be linked to from as many other apps as you like. It&#x27;s wonderful and I&#x27;ve been using it for a long time now. Unfortunately it&#x27;s pretty basic in that it&#x27;s only the appSettings section that can be shared out; no <code>&amp;lt;system.serviceModel&amp;gt;</code> or similar.</p><p>But that wasn&#x27;t really a problem from my perspective. I realised that there were actually very few things that needed to be configurable for my WCF service. Really I wanted a basic WCF harness that could be initialised in code which implicitly set all the basic configuration with settings that worked (ie it was set up with defaults like maximum message size which were sufficiently sized). On top of that I would allow myself to configure just those things that I needed to through the use of my own custom WCF config settings in the shared appSettings.config file.</p><p>Once done I massively reduced the size of my configs from frankly gazillions of entries to just these appSettings.config entries which were shared across each of my WCF service clients and by my Windows Service harness:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><div tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">appSettings</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">add</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">WcfBaseAddressForClient</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">net.tcp://localhost:9700/</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">add</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">WcfWindowsSecurityApplied</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">true</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">add</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">WcfCredentialsUserName</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">myUserName</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">add</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">WcfCredentialsPassword</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">myPassword</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">add</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">WcfCredentialsDomain</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">myDomain</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">appSettings</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>And these config settings used only by my Windows Service harness:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><div tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">appSettings</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">file</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">../Shared/AppSettings.config</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">add</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">WcfBaseAddressForService</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">net.tcp://localhost:9700/</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">appSettings</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="show-me-your-harness"></a>Show me your harness<a class="hash-link" href="#show-me-your-harness" title="Direct link to heading">#</a></h2><p>I ended up with a quite a nice basic &quot;vanilla&quot; framework that allowed me to quickly set up Windows Service hosted WCF services. The framework also provided me with a simple way to consume these WCF services with a minimum of code an configuration. No muss. No fuss. :-) So pleased with it was I that I thought I&#x27;d go through it here much in the manner of a chef baking a cake...</p><p>To start with I created myself a Windows Service in Visual Studio which I grandly called &quot;WcfWindowsService&quot;. The main service class looked like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class WcfWindowsService: ServiceBase</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static string WindowsServiceName = &quot;WCF Windows Service&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static string WindowsServiceDescription = &quot;Windows service that hosts a WCF service.&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private static readonly log4net.ILog _logger = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public List&lt;ServiceHost&gt; _serviceHosts = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public WcfWindowsService()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ServiceName = WindowsServiceName;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static void Main()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ServiceBase.Run(new WcfWindowsService());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The Windows Service is starting</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;param name=&quot;args&quot;&gt;&lt;/param&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    protected override void OnStart(string[] args)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        CloseAndClearServiceHosts();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        //Make log4net startup</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        XmlConfigurator.Configure();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _logger.Warn(&quot;WCF Windows Service starting...&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _logger.Info(&quot;Global.WcfWindowsSecurityApplied = &quot; + Global.WcfWindowsSecurityApplied.ToString().ToLower());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (Global.WcfWindowsSecurityApplied)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          _logger.Info(&quot;Global.WcfOnlyAuthorizedForWcfCredentials = &quot; + Global.WcfOnlyAuthorizedForWcfCredentials.ToString().ToLower());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          if (Global.WcfOnlyAuthorizedForWcfCredentials)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            _logger.Info(&quot;Global.WcfCredentialsDomain = &quot; + Global.WcfCredentialsDomain);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            _logger.Info(&quot;Global.WcfCredentialsUserName = &quot; + Global.WcfCredentialsUserName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        //Create binding</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var wcfBinding = WcfHelper.CreateBinding(Global.WcfWindowsSecurityApplied);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Create a servicehost and endpoints for each service and open each</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _serviceHosts = new List&lt;ServiceHost&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _serviceHosts.Add(WcfServiceFactory&lt;IHello&gt;.CreateAndOpenServiceHost(typeof(HelloService), wcfBinding));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _serviceHosts.Add(WcfServiceFactory&lt;IGoodbye&gt;.CreateAndOpenServiceHost(typeof(GoodbyeService), wcfBinding));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _logger.Warn(&quot;WCF Windows Service started.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      catch (Exception exc)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _logger.Error(&quot;Problem starting up&quot;, exc);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        throw exc;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The Windows Service is stopping</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    protected override void OnStop()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      CloseAndClearServiceHosts();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      _logger.Warn(&quot;WCF Windows Service stopped&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Close and clear service hosts in list and clear it down</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private void CloseAndClearServiceHosts()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      if (_serviceHosts != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        foreach (var serviceHost in _serviceHosts)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          CloseAndClearServiceHost(serviceHost);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _serviceHosts.Clear();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Close and clear the passed service host</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;param name=&quot;serviceHost&quot;&gt;&lt;/param&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private void CloseAndClearServiceHost(ServiceHost serviceHost)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      if (serviceHost != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _logger.Info(string.Join(&quot;, &quot;, serviceHost.BaseAddresses) + &quot; is closing...&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        serviceHost.Close();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _logger.Info(string.Join(&quot;, &quot;, serviceHost.BaseAddresses) + &quot; is closed&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>As you&#x27;ve no doubt noticed this makes use of <a href="http://logging.apache.org/log4net/" target="_blank" rel="noopener noreferrer">Log4Net</a> for logging purposes (I&#x27;ll assume you&#x27;re aware of it). My Windows Service implements such fantastic WCF services as HelloService and GoodbyeService. Each revolutionary in their own little way. To give you a taste of the joie de vivre that these services exemplify take a look at this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Implement the IHello service contract in a service class.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public class HelloService : WcfServiceAuthorizationManager, IHello</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Implement the IHello methods.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public string GreetMe(string thePersonToGreet)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      return &quot;well hello there &quot; + thePersonToGreet;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Exciting! WcfWindowsService also references another class called &quot;Global&quot; which is a helper class - to be honest not much more than a wrapper for my config settings. It looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static public class Global</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #region Properties</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // eg &quot;net.tcp://localhost:9700/&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static string WcfBaseAddressForService { get { return ConfigurationManager.AppSettings[&quot;WcfBaseAddressForService&quot;]; } }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // eg true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static bool WcfWindowsSecurityApplied { get { return bool.Parse(ConfigurationManager.AppSettings[&quot;WcfWindowsSecurityApplied&quot;]); } }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // eg true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static bool WcfOnlyAuthorizedForWcfCredentials { get { return bool.Parse(ConfigurationManager.AppSettings[&quot;WcfOnlyAuthorizedForWcfCredentials&quot;]); } }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // eg &quot;myDomain&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static string WcfCredentialsDomain { get { return ConfigurationManager.AppSettings[&quot;WcfCredentialsDomain&quot;]; } }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // eg &quot;myUserName&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static string WcfCredentialsUserName { get { return ConfigurationManager.AppSettings[&quot;WcfCredentialsUserName&quot;]; } }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // eg &quot;myPassword&quot; - this should *never* be stored unencrypted and is only ever used by clients that are not already running with the approved Windows credentials</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static string WcfCredentialsPassword { get { return ConfigurationManager.AppSettings[&quot;WcfCredentialsPassword&quot;]; } }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #endregion</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>WcfWindowsService creates and hosts a HelloService and a GoodbyeService when it starts up. It does this using my handy WcfServiceFactory:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class WcfServiceFactory&lt;TInterface&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private static readonly log4net.ILog _logger = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static ServiceHost CreateAndOpenServiceHost(Type serviceType, NetTcpBinding wcfBinding)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      var serviceHost = new ServiceHost(serviceType, new Uri(Global.WcfBaseAddressForService + ServiceHelper&lt;TInterface&gt;.GetServiceName()));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      serviceHost.AddServiceEndpoint(typeof(TInterface), wcfBinding, &quot;&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      serviceHost.Authorization.ServiceAuthorizationManager = new WcfServiceAuthorizationManager(); // This allows us to control authorisation within WcfServiceAuthorizationManager</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      serviceHost.Open();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      _logger.Info(string.Join(&quot;, &quot;, serviceHost.BaseAddresses) + &quot; is now listening.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      return serviceHost;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>To do this it also uses my equally handy WcfHelper class:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static public class WcfHelper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Create a NetTcpBinding</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;param name=&quot;useWindowsSecurity&quot;&gt;&lt;/param&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /// &lt;returns&gt;&lt;/returns&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static NetTcpBinding CreateBinding(bool useWindowsSecurity)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      var wcfBinding = new NetTcpBinding();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      if (useWindowsSecurity)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        wcfBinding.Security.Mode = SecurityMode.Transport;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        wcfBinding.Security.Transport.ClientCredentialType = TcpClientCredentialType.Windows;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        wcfBinding.Security.Mode = SecurityMode.None;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      wcfBinding.MaxBufferSize = int.MaxValue;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      wcfBinding.MaxReceivedMessageSize = int.MaxValue;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      wcfBinding.ReaderQuotas.MaxArrayLength = int.MaxValue;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      wcfBinding.ReaderQuotas.MaxDepth = int.MaxValue;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      wcfBinding.ReaderQuotas.MaxStringContentLength = int.MaxValue;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      wcfBinding.ReaderQuotas.MaxBytesPerRead = int.MaxValue;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      return wcfBinding;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  /// Create a WCF Client for use anywhere (be it Windows Service or ASP.Net web application)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  /// nb Credential fields are optional and only likely to be needed by web applications</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  /// &lt;typeparam name=&quot;TInterface&quot;&gt;&lt;/typeparam&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public class WcfClientFactory&lt;TInterface&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static TInterface CreateChannel(bool useWindowsSecurity, string wcfBaseAddress, string wcfCredentialsUserName = null, string wcfCredentialsPassword = null, string wcfCredentialsDomain = null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      //Create NetTcpBinding using universally</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      var wcfBinding = WcfHelper.CreateBinding(useWindowsSecurity);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      //Get Service name from examining the ServiceNameAttribute decorating the interface</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      var serviceName = ServiceHelper&lt;TInterface&gt;.GetServiceName();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      //Create the factory for creating your channel</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      var factory = new ChannelFactory&lt;TInterface&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        wcfBinding,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new EndpointAddress(wcfBaseAddress + serviceName)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      //if credentials have been supplied then use them</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      if (!string.IsNullOrEmpty(wcfCredentialsUserName))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        factory.Credentials.Windows.ClientCredential = new System.Net.NetworkCredential(wcfCredentialsUserName, wcfCredentialsPassword, wcfCredentialsDomain);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      //Create the channel</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      var channel = factory.CreateChannel();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      return channel;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Now the above WcfHelper class and it&#x27;s comrade-in-arms the WcfClientFactory don&#x27;t live in the WcfWindowsService project with the other classes. No. They live in a separate project called the WcfWindowsServiceContracts project with their old mucker the ServiceHelper:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class ServiceHelper&lt;T&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static string GetServiceName()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      var customAttributes = typeof(T).GetCustomAttributes(false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      if (customAttributes.Length &gt; 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        foreach (var customAttribute in customAttributes)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          if (customAttribute is ServiceNameAttribute)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return ((ServiceNameAttribute)customAttribute).ServiceName;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      throw new ArgumentException(&quot;Interface is missing ServiceNameAttribute&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  [AttributeUsage(AttributeTargets.Interface, AllowMultiple = false)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public class ServiceNameAttribute : System.Attribute</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public ServiceNameAttribute(string serviceName)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      this.ServiceName = serviceName;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public string ServiceName { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Now can you guess what the WcfWindowsServiceContracts project might contain? Yes; contracts for your services (oh the excitement)! What might one of these contracts look like I hear you ask... Well, like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[ServiceContract()]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  [ServiceName(&quot;HelloService&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public interface IHello</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [OperationContract]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string GreetMe(string thePersonToGreet);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The WcfWindowsServiceContracts project is included in *<strong>any</strong>* WCF client solution that wants to call your WCF services. It is also included in the WCF service solution. It facilitates the calling of services. What you&#x27;re no doubt wondering is how this might be achieved. Well here&#x27;s how, it uses our old friend the <code>WcfClientFactory</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var helloClient = WcfClientFactory&lt;IHello&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .CreateChannel(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      useWindowsSecurity:     Global.WcfWindowsSecurityApplied,  // eg true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      wcfBaseAddress:         Global.WcfBaseAddressForClient,    // eg &quot;net.tcp://localhost:9700/&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      wcfCredentialsUserName: Global.WcfCredentialsUserName,     // eg &quot;myUserName&quot; - Optional parameter - only passed by web applications that need to impersonate the valid user</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      wcfCredentialsPassword: Global.WcfCredentialsPassword,     // eg &quot;myPassword&quot; - Optional parameter - only passed by web applications that need to impersonate the valid user</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      wcfCredentialsDomain:   Global.WcfCredentialsDomain        // eg &quot;myDomain&quot; - Optional parameter - only passed by web applications that need to impersonate the valid user</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  var greeting = helloClient.GreetMe(&quot;John&quot;); //&quot;well hello there John&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>See? Simple as simple. The eagle eyed amongst you will have noticed that client example above is using &quot;<code>Global</code>&quot; which is essentially a copy of the <code>Global</code> class mentioned above that is part of the WcfWindowsService project.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="locking-down-authorization-to-a-single-windows-account"></a>Locking down Authorization to a single Windows account<a class="hash-link" href="#locking-down-authorization-to-a-single-windows-account" title="Direct link to heading">#</a></h2><p>I can tell you think i&#x27;ve forgotten something. &quot;Tell me about this locking down to the single Windows account / what is this mysterious <code>WcfServiceAuthorizationManager</code> class that all your WCF services inherit from? Don&#x27;t you fob me off now.... etc&quot;</p><p>Well ensuring that only a single Windows account is authorised (yes dammit the original English spelling) to access our WCF services is achieved by implementing our own <code>ServiceAuthorizationManager</code> class. This implementation is used for authorisation by your <code>ServiceHost</code> and the logic sits in the overridden <code>CheckAccessCore</code> method. All of our WCF service classes will inherit from our <code>ServiceAuthorizationManager</code> class and so trigger the <code>CheckAccessCore</code> authorisation each time they are called.</p><p>As you can see from the code below, depending on our configuration, we lock down access to all our WCF services to a specific Windows account. This is far from the only approach that you might want to take to authorisation; it&#x27;s simply the one that we&#x27;ve been using. However the power of being able to implement your own authorisation in the <code>CheckAccessCore</code> method allows you the flexibility to do pretty much anything you want:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class WcfServiceAuthorizationManager : ServiceAuthorizationManager</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    protected static readonly log4net.ILog _logger = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    protected override bool CheckAccessCore(OperationContext operationContext)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      if (Global.WcfWindowsSecurityApplied)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if ((operationContext.ServiceSecurityContext.IsAnonymous) ||</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          (operationContext.ServiceSecurityContext.PrimaryIdentity == null))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          _logger.Error(&quot;WcfWindowsSecurityApplied = true but no credentials have been supplied&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          return false;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (Global.WcfOnlyAuthorizedForWcfCredentials)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          if (operationContext.ServiceSecurityContext.PrimaryIdentity.Name.ToLower() == Global.WcfCredentialsDomain.ToLower() + &quot;\\&quot; + Global.WcfCredentialsUserName.ToLower())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            _logger.Debug(&quot;WcfOnlyAuthorizedForWcfCredentials = true and the valid user (&quot; + operationContext.ServiceSecurityContext.PrimaryIdentity.Name + &quot;) has been supplied and access allowed&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return true;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            _logger.Error(&quot;WcfOnlyAuthorizedForWcfCredentials = true and an invalid user (&quot; + operationContext.ServiceSecurityContext.PrimaryIdentity.Name + &quot;) has been supplied and access denied&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return false;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          _logger.Debug(&quot;WcfOnlyAuthorizedForWcfCredentials = false, credentials were supplied (&quot; + operationContext.ServiceSecurityContext.PrimaryIdentity.Name + &quot;) so access allowed&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          return true;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _logger.Info(&quot;WcfWindowsSecurityApplied = false so we are allowing unfettered access&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return true;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Phewwww... I know this has ended up as a bit of a brain dump but hopefully people will find it useful. At some point I&#x27;ll try to put up the above solution on GitHub so people can grab it easily for themselves.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/service-authorization-manager">ServiceAuthorizationManager</a><a class="margin-horiz--sm" href="/tags/windows-account">Windows Account</a><a class="margin-horiz--sm" href="/tags/windows-service">Windows Service</a><a class="margin-horiz--sm" href="/tags/configuration">configuration</a><a class="margin-horiz--sm" href="/tags/wcf">WCF</a><a class="margin-horiz--sm" href="/tags/authorisation">authorisation</a><a class="margin-horiz--sm" href="/tags/net-tcp-binding">NetTcpBinding</a></div><div class="col text--right"><a aria-label="Read more about WCF - moving from Config to Code, a simple WCF service harness (plus implementing your own Authorization)" href="/2012/03/22/wcf-moving-from-config-to-code-simple"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/styles.f7659eed.js"></script>
<script src="/assets/js/runtime~main.74f1dcf9.js"></script>
<script src="/assets/js/main.77bdfe03.js"></script>
<script src="/assets/js/1.194e3740.js"></script>
<script src="/assets/js/2.85d4c801.js"></script>
<script src="/assets/js/6875c492.1786d4e6.js"></script>
<script src="/assets/js/c3b5bd8c.a1a5ba6a.js"></script>
<script src="/assets/js/6266f07f.4f1bab4e.js"></script>
<script src="/assets/js/a976e6bb.e277a62d.js"></script>
</body>
</html>