<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.1">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">Goodbye Client Affinity, Hello Data Protection with Azure | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="Goodbye Client Affinity, Hello Data Protection with Azure | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="How to use ASP.NET Data Protection to remove the need for sticky sessions with Client Affinity"><meta data-react-helmet="true" property="og:description" content="How to use ASP.NET Data Protection to remove the need for sticky sessions with Client Affinity"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/blog/2021-02-27-goodbye-client-affinity-hello-data-protection-with-azure/traffic-to-app-service.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/blog/2021-02-27-goodbye-client-affinity-hello-data-protection-with-azure/traffic-to-app-service.png"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.98074f82.css">
<link rel="preload" href="/assets/js/runtime~main.11174a99.js" as="script">
<link rel="preload" href="/assets/js/main.13704c93.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP shadow--md">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">I CAN MAKE THIS WORK</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/about">About</a></li><li class="menu__list-item"><a class="menu__link" href="/blog-archive">Blog Archive</a></li><li class="menu__list-item"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="menu__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="menu__list-item"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/06/30/react-18-and-typescript">React 18 and TypeScript</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/06/11/azure-functions-dotnet-5-query-params-di-bicep">Azure Functions and .NET 5: Query params, Dependency Injection, Bicep &amp; Build</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/05/15/azurite-and-table-storage-dev-container">Azurite and Table Storage in a dev container</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/05/08/create-pipeline-with-azure-devops-api">Create a Pipeline with the Azure DevOps API</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/05/01/blog-archive-for-docusaurus">Blog Archive for Docusaurus</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="blogPostTitle_GeHD">Goodbye Client Affinity, Hello Data Protection with Azure</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2021-02-27T00:00:00.000Z">February 27, 2021</time> Â· 4 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer">John Reilly</a></div><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><p>I&#x27;ve written lately about <a href="https://blog.johnnyreilly.com/2021/02/azure-app-service-health-checks-and-zero-downtime-deployments.html" target="_blank" rel="noopener noreferrer">zero downtime releases with Azure App Service</a>. Zero downtime releases are only successful if your authentication mechanism survives a new deployment. We looked in my last post at <a href="https://blog.johnnyreilly.com/2021/02/easy-auth-tokens-survive-releases-on-linux-azure-app-service.html" target="_blank" rel="noopener noreferrer">how to achieve this with Azure&#x27;s in-built authentication mechanism; Easy Auth</a>.</p><p>We&#x27;re now going to look at how the same goal can be achieved if your ASP.NET application is authenticating another way. We achieve this through use of the <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview" target="_blank" rel="noopener noreferrer">ASP.NET Data Protection</a> system. Andrew Lock has written <a href="https://andrewlock.net/an-introduction-to-the-data-protection-system-in-asp-net-core/" target="_blank" rel="noopener noreferrer">an excellent walkthrough on the topic</a> and I encourage you to read it.</p><p>We&#x27;re interested in the ASP.NET data-protection system because it encrypts and decrypts sensitive data including the authentication cookie. It&#x27;s wonderful that the data protection does this, but at the same time it presents a problem. We would like to route traffic to <em>multiple</em> instances of our applicationâ€¦ So traffic could go to instance 1, instance 2 of our app etc.</p><p> <img alt="traffic to app service" src="/assets/images/traffic-to-app-service-0fb4d2ef97f99c82fd5fba1240824fb9.png"></p><p>How can we ensure the different instances of our app can read the authentication cookies regardless of the instance that produced them? How can we ensure that instance 1 can read cookies produced by instance 2 and vice versa? And for that matter, we&#x27;d like all instances to be able to read cookies whether they were produced by an instance in a production or staging slot.</p><p>We&#x27;re aiming to avoid the use of &quot;sticky sessions&quot; and ARRAffinity cookies. These ensure that traffic is continually routed to the same instance. Routing to the same instance explicitly prevents us from stopping routing traffic to an old instance and starting routing to a new one.</p><p>With the data protection activated and multiple instances of your app service you immediately face the issue that different instances of the app will be unable to read cookies they did not create. This is the default behaviour of data protection. <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/web-farm?view=aspnetcore-5.0#data-protection" target="_blank" rel="noopener noreferrer">To quote the docs:</a></p><blockquote><p>Data Protection relies upon a set of cryptographic keys stored in a key ring. When the Data Protection system is initialized, it applies default settings that store the key ring locally. Under the default configuration, a unique key ring is stored on each node of the web farm. Consequently, each web farm node can&#x27;t decrypt data that&#x27;s encrypted by an app on any other node.</p></blockquote><p>The problem here is the data protection keys (the key ring) is being stored locally on each instance. What are the implications of this? Well, For example, instance 2 doesn&#x27;t have access to the keys instance 1 is using and so can&#x27;t decrypt instance 1 cookies.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sharing-is-caring"></a>Sharing is caring<a class="hash-link" href="#sharing-is-caring" title="Direct link to heading">#</a></h2><p>What we need to do is move away from storing keys locally, and to storing it in a <em>shared</em> place instead. We&#x27;re going to store data protection keys in Azure Blob Storage and protect the keys with Azure Key Vault:</p><p><img alt="persist keys to azure blob" src="/assets/images/data-protection-zero-downtime-d267eb88eafd479df49a359021e7f628.png"></p><p>All instances of the application can access the key ring and consequently sharing cookies is enabled. <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview?view=aspnetcore-5.0#protectkeyswithazurekeyvault" target="_blank" rel="noopener noreferrer">As the documentation attests</a>, enabling this is fairly simple. It amounts to adding the following packages to your ASP.NET app:</p><ul><li><a href="https://www.nuget.org/packages/Azure.Extensions.AspNetCore.DataProtection.Blobs" target="_blank" rel="noopener noreferrer"><code>Azure.Extensions.AspNetCore.DataProtection.Blobs</code></a></li><li><a href="https://www.nuget.org/packages/Azure.Extensions.AspNetCore.DataProtection.Keys" target="_blank" rel="noopener noreferrer"><code>Azure.Extensions.AspNetCore.DataProtection.Keys</code></a></li></ul><p>And adding the following to the <code>ConfigureServices</code> in your ASP.NET app:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">services.AddDataProtection().SetApplicationName(&quot;OurWebApp&quot;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // azure credentials require storage blob contributor role permissions</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // eg https://my-storage-account.blob.core.windows.net/keys/key</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .PersistKeysToAzureBlobStorage(new Uri($&quot;https://{Configuration[&quot;StorageAccountName&quot;]}.blob.core.windows.net/keys/key&quot;), new DefaultAzureCredential())</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // azure credentials require key vault crypto role permissions</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // eg https://my-key-vault.vault.azure.net/keys/dataprotection</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .ProtectKeysWithAzureKeyVault(new Uri($&quot;https://{Configuration[&quot;KeyVaultName&quot;]}.vault.azure.net/keys/dataprotection&quot;), new DefaultAzureCredential());</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In the above example you can see we&#x27;re passing the name of our Storage account and Key Vault via configuration.</p><p>There&#x27;s one more crucial piece of the puzzle here; and it&#x27;s role assignments, better known as permissions. Your App Service needs to be able to read and write to Azure Key Vault and the Azure Blob Storage. The permissions of <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#storage-blob-data-contributor" target="_blank" rel="noopener noreferrer">Storage Blob Data Contributor</a> and <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#key-vault-crypto-officer-preview" target="_blank" rel="noopener noreferrer">Key Vault Crypto Officer</a> are sufficient to enable this. (If you&#x27;d like to see what configuring that looks like via ARM templates then <a href="https://blog.johnnyreilly.com/2021/02/arm-templates-security-role-assignments.html" target="_blank" rel="noopener noreferrer">check out this post</a>.)</p><p>With this in place we&#x27;re able to route traffic to any instance of our application, secure in the knowledge that it will be able to read the cookies. Furthermore, we&#x27;ve enabled zero downtime releases as a direct consequence.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/tags/azure">Azure</a><a class="margin-horiz--sm" href="/tags/data-protection">Data Protection</a><a class="margin-horiz--sm" href="/tags/easy-auth">Easy Auth</a><a class="margin-horiz--sm" href="/tags/asp-net">ASP.NET</a><a class="margin-horiz--sm" href="/tags/client-affinity">Client Affinity</a></div><div class="col margin-top--sm"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/blog/2021-02-27-goodbye-client-affinity-hello-data-protection-with-azure.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/2021/03/06/generate-typescript-and-csharp-clients-with-nswag"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« NSwag: TypeScript and CSharp client generation based on an API</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Making Easy Auth tokens survive releases on Linux Azure App Service Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#sharing-is-caring" class="table-of-contents__link">Sharing is caring</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">RSS</a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">Atom</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.11174a99.js"></script>
<script src="/assets/js/main.13704c93.js"></script>
</body>
</html>