<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog.johnnyreilly.com/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog.johnnyreilly.com/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Azure App Service, Health checks and zero downtime deployments | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="Azure App Service, Health checks and zero downtime deployments | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="I&#x27;ve been working recently on zero downtime deployments using Azure App Service. They&#x27;re facilitated by a combination of Health checks and deployment slots. This post will talk about why this is important and how it works."><meta data-react-helmet="true" property="og:description" content="I&#x27;ve been working recently on zero downtime deployments using Azure App Service. They&#x27;re facilitated by a combination of Health checks and deployment slots. This post will talk about why this is important and how it works."><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/blog.johnnyreilly.com/img/favicon.ico"><link rel="stylesheet" href="/blog.johnnyreilly.com/styles.a30a8c8e.css">
<link rel="preload" href="/blog.johnnyreilly.com/styles.b80bbee1.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/runtime~main.94d0c56d.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/main.08f1a502.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/1.b4966bec.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/2.7d3f6764.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/ccc49370.bc2c92b9.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/c3b5bd8c.4d75ffb7.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/f61b3e3a.e3cbe6e6.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/blog.johnnyreilly.com/"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">üåû</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/blog.johnnyreilly.com/"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/03/10/managed-identity-azure-sql-entity-framework">Managed Identity, Azure SQL and Entity Framework</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/03/06/generate-typescript-and-csharp-clients-with-nswag">Generate TypeScript and CSharp clients with NSwag based on an API</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure">Goodbye Client Affinity, Hello Data Protection with Azure</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service">Making Easy Auth tokens survive releases on Linux Azure App Service</a></li><li class="sidebarItem_2T0D"><a aria-current="page" class="sidebarItemLink_v5H9 sidebarItemLinkActive_1anX" href="/blog.johnnyreilly.com/2021/02/11/azure-app-service-health-checks-and-zero-downtime-deployments">Azure App Service, Health checks and zero downtime deployments</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_3-lP">Azure App Service, Health checks and zero downtime deployments</h1><div class="margin-vert--md"><time datetime="2021-02-11T00:00:00.000Z" class="blogPostDate_Ta7i">February 11, 2021  ¬∑ 8 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>I&#x27;ve been working recently on zero downtime deployments using Azure App Service. They&#x27;re facilitated by a combination of <a href="https://docs.microsoft.com/en-us/azure/app-service/monitor-instances-health-check" target="_blank" rel="noopener noreferrer">Health checks</a> and <a href="https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots" target="_blank" rel="noopener noreferrer">deployment slots</a>. This post will talk about why this is important and how it works.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="why-zero-downtime-deployments"></a>Why zero downtime deployments?<a class="hash-link" href="#why-zero-downtime-deployments" title="Direct link to heading">#</a></h2><p>Historically (and for many applications, currently) deployment results in downtime. A period of time during the release where an application is not available to users whilst the new version is deployed. There are a number of downsides to releases with downtime:</p><ol><li>Your users cannot use your application. This will frustrate them and make them sad.</li><li>Because you&#x27;re a kind person and you want your users to be happy, you&#x27;ll optimise to make their lives better. You&#x27;ll release when the fewest users are accessing your application. It will likely mean you&#x27;ll end up working late, early or at weekends.</li><li>Again because you want to reduce impact on users, you&#x27;ll release less often. This means that every release will bring with it a greater collection of changes. This is turn will often result in a large degree of focus on manually testing each release, to reduce the likelihood of bugs ending up in users hands. This is a noble aim, but it drags the teams focus away from shipping.</li></ol><p>Put simply: downtime in releases impacts customer happiness and leads to reduced pace for teams. It&#x27;s a vicious circle.</p><p>But if we turn it around, what does it look like if releases have <em>no</em> downtime at all?</p><ol><li>Your users can always use your application. This will please them.</li><li>Your team is now safe to release at any time, day or night. They will likely release more often as a consequence.</li><li>If your team has sufficient automated testing in place, they&#x27;re now in a position where they can move to <a href="https://www.atlassian.com/continuous-delivery/principles/continuous-integration-vs-delivery-vs-deployment" target="_blank" rel="noopener noreferrer">Continuous Deployment</a>.</li><li>Releases become boring. This is good. They &quot;just work‚Ñ¢Ô∏è&quot; and so the team can focus instead on building the cool features that are going to make users lives even better.</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="manual-zero-downtime-releases-with-app-services"></a>Manual zero downtime releases with App Services<a class="hash-link" href="#manual-zero-downtime-releases-with-app-services" title="Direct link to heading">#</a></h2><p>App Services have the ability to scale out. To <a href="https://azure.microsoft.com/en-us/blog/scaling-up-and-scaling-out-in-windows-azure-web-sites/" target="_blank" rel="noopener noreferrer">quote the docs</a>:</p><blockquote><p>A scale out operation is the equivalent of creating multiple copies of your web site and adding a load balancer to distribute the demand between them. When you scale out ... there is no need to configure load balancing separately since this is already provided by the platform.</p></blockquote><p>As you can see, scaling out works by having multiple instances of your app. Deployment slots are exactly this, but with an extra twist. If you add a deployment slot to your App Service, then you <strong>no longer deploy to production</strong>. Instead you deploy to your staging slot. Your staging slot is accessible in the same way your production slot is accessible. So whilst your users may go to <a href="https://my-glorious-app.io" target="_blank" rel="noopener noreferrer">https://my-glorious-app.io</a>, your staging slot may live at <a href="https://my-glorious-app-stage.azurewebsites.net" target="_blank" rel="noopener noreferrer">https://my-glorious-app-stage.azurewebsites.net</a> instead. Because this is accessible, this is testable. You are in a position to test the deployed application before making it generally available.</p><p> <img src="/blog.johnnyreilly.com/assets/images/app-service-with-slots-16aac8093f6180c5595123ea418e11e1.png"></p><p>Once you&#x27;re happy that everything looks good, you can &quot;swap slots&quot;. What this means, is the version of the app living in the staging slot, gets moved into the production slot. So that which lived at <a href="https://my-glorious-app-stage.azurewebsites.net" target="_blank" rel="noopener noreferrer">https://my-glorious-app-stage.azurewebsites.net</a> moves to <a href="https://my-glorious-app.io" target="_blank" rel="noopener noreferrer">https://my-glorious-app.io</a>. For a more details on what that involves <a href="https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots#what-happens-during-a-swap" target="_blank" rel="noopener noreferrer">read this</a>. The significant take home is this: there is no downtime. Traffic stops being routed to the old instance and starts being routed to the new one. It&#x27;s as simple as that.</p><p>I should mention at this point that there&#x27;s a <a href="https://opensource.com/article/17/5/colorful-deployments" target="_blank" rel="noopener noreferrer">number of zero downtime strategies out there</a> and slots can help support a number of these. This includes canary deployments, where a subset of traffic is routed to the new version prior to it being opened out more widely. In our case, we&#x27;re looking at rolling deployments, where we replace the currently running instances of our application with the new ones; but it&#x27;s worth being aware that there are other strategies that slots can facilitate.</p><p>So what does it look like when slots swap? Well, to test that out, we swapped slots on our two App Service instances. We repeatedly CURLed our apps <a href="https://blog.johnnyreilly.com/2021/01/surfacing-azure-pipelines-build-info-in.html" target="_blank" rel="noopener noreferrer"><code>api/build</code></a> endpoint that exposes the build information; to get visibility around which version of our app we were routing traffic to. This is what we saw:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:51:51 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.5&quot;,&quot;buildId&quot;:&quot;17992&quot;,&quot;commitHash&quot;:&quot;c2122919df54bfa6a0d20bceb9f06890f822b26e&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:51:54 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.6&quot;,&quot;buildId&quot;:&quot;18015&quot;,&quot;commitHash&quot;:&quot;062ac1488fcf1737fe1dbab0d05c095786218f30&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:51:57 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.5&quot;,&quot;buildId&quot;:&quot;17992&quot;,&quot;commitHash&quot;:&quot;c2122919df54bfa6a0d20bceb9f06890f822b26e&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:00 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.6&quot;,&quot;buildId&quot;:&quot;18015&quot;,&quot;commitHash&quot;:&quot;062ac1488fcf1737fe1dbab0d05c095786218f30&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:03 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.6&quot;,&quot;buildId&quot;:&quot;18015&quot;,&quot;commitHash&quot;:&quot;062ac1488fcf1737fe1dbab0d05c095786218f30&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:05 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.6&quot;,&quot;buildId&quot;:&quot;18015&quot;,&quot;commitHash&quot;:&quot;062ac1488fcf1737fe1dbab0d05c095786218f30&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:08 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.5&quot;,&quot;buildId&quot;:&quot;17992&quot;,&quot;commitHash&quot;:&quot;c2122919df54bfa6a0d20bceb9f06890f822b26e&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:10 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.6&quot;,&quot;buildId&quot;:&quot;18015&quot;,&quot;commitHash&quot;:&quot;062ac1488fcf1737fe1dbab0d05c095786218f30&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:12 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.5&quot;,&quot;buildId&quot;:&quot;17992&quot;,&quot;commitHash&quot;:&quot;c2122919df54bfa6a0d20bceb9f06890f822b26e&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:15 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.6&quot;,&quot;buildId&quot;:&quot;18015&quot;,&quot;commitHash&quot;:&quot;062ac1488fcf1737fe1dbab0d05c095786218f30&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thu Jan 21 11:52:17 GMT 2021</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;buildNumber&quot;:&quot;20210121.6&quot;,&quot;buildId&quot;:&quot;18015&quot;,&quot;commitHash&quot;:&quot;062ac1488fcf1737fe1dbab0d05c095786218f30&quot;}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The first new version of our application showed up in a production slot at 11:51:54, and the last old version showed up at 11:52:12. So it took a total of 15 seconds to complete the transition from hitting only instances of the old application to hitting only instances of the new application. During that 15 seconds either old or new versions of the application would be serving traffic. Significantly, there was always a version of the application returning responses.</p><p>This is <em>very</em> exciting! We have zero downtime deployments!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="rollbacks-for-bonus-points"></a>Rollbacks for bonus points<a class="hash-link" href="#rollbacks-for-bonus-points" title="Direct link to heading">#</a></h2><p>We now have the new version of the app (<code>buildNumber: 20210121.6</code>) in the production slot, and the old version of the app (<code>buildNumber: 20210121.5</code>) in the staging slot.</p><p>Slots have a tremendous rollback story. If it emerges that there was some uncaught issue in your release and you&#x27;d like to revert to the previous version, you can! Just as we swapped just now to move <code>buildNumber: 20210121.6</code> from the staging slot to the production slot and <code>buildNumber: 20210121.5</code> the other way, we can swap right back and revert our release like so:</p><p><img src="/blog.johnnyreilly.com/assets/images/app-service-with-slots-and-build-number-cb3ff72d23c65edd5c0775f2c018ac8c.png"></p><p>Once again users going to <a href="https://my-glorious-app.io" target="_blank" rel="noopener noreferrer">https://my-glorious-app.io</a> are hitting <code>buildNumber: 20210121.5</code>.</p><p>This is also <em>very</em> exciting! We have zero downtime deployments <em>and</em> rollbacks!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="automated-zero-downtime-releases-with-health-checks"></a>Automated zero downtime releases with Health checks<a class="hash-link" href="#automated-zero-downtime-releases-with-health-checks" title="Direct link to heading">#</a></h2><p>The final piece of the puzzle here automation. You&#x27;re a sophisticated team, you&#x27;ve put a great deal of energy into automating your tests. You don&#x27;t want your release process to be manual for this very reason; you trust your test coverage. You want to move to Continuous Deployment.</p><p>Fortunately, automating swapping slots is a breeze with <code>azure-pipelines.yml</code>. Consider the following:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-yml codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeployApp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> DeployARMTemplates</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">download</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> current</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">artifact</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> webapp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureWebApp@1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Deploy Web Application&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(azureResourceGroup)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">appName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(appServiceName)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">package</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(Pipeline.Workspace)/webapp/</span><span class="token important">**/*.zip</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">slotName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> stage</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">deployToSlotOrASE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">deploymentMethod</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> auto</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> SwapSlots</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Swap Slots</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> DeployApp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureAppServiceManage@0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Swap Slots</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Swap Slots&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(azureResourceGroup)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">webAppName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(appServiceName)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">SourceSlot</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;stage&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The first job here, deploys our previously built <code>webapp</code> to the <code>stage</code> slot. The second job swaps the slot.</p><p>When I first considered this, the question rattling around in the back of my mind was this: how does App Service know when it&#x27;s safe to swap? What if we swap before our app has fully woken up and started serving responses?</p><p>It so happens that using <a href="https://docs.microsoft.com/en-us/azure/app-service/monitor-instances-health-check" target="_blank" rel="noopener noreferrer">Health checks, App Service caters for this beautifully</a>. A health check endpoint is a URL in your application which, when hit, checks the dependencies of your application. &quot;Is the database accessible?&quot; &quot;Are the APIs I depend upon accessible?&quot; The diagram from the docs expresses it very well:</p><p><img src="/blog.johnnyreilly.com/assets/images/health-check-failure-diagram-fa96ff15c146b91e8deaac2c01d9fa66.png"></p><p>This approach is very similar to <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/" target="_blank" rel="noopener noreferrer">liveness, readiness and startup probes in Kubernetes</a>. To make use of Health checks, in our ARM template for our App Service we have configured a <code>healthCheckPath</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token property">&quot;siteConfig&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;linuxFxVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;[parameters(&#x27;linuxFxVersion&#x27;)]&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;alwaysOn&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;http20Enabled&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;minTlsVersion&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;healthCheckPath&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/api/health&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This tells App Service where to look to check the health. The health check endpoint itself is provided by the <code>MapHealthChecks</code> in our <code>Startup.cs</code> of our .NET application:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-cs codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">app.UseEndpoints(endpoints =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    endpoints.MapControllerRoute(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        name: &quot;default&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        pattern: &quot;{controller}/{action=Index}/{id?}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    endpoints.MapHealthChecks(&quot;/api/health&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>You read a full list of all the ways App Service uses Health checks <a href="https://docs.microsoft.com/en-us/azure/app-service/monitor-instances-health-check#what-app-service-does-with-health-checks" target="_blank" rel="noopener noreferrer">here</a>. Pertinent for zero downtime deployments is this:</p><blockquote><p>when scaling up or out, App Service pings the Health check path to ensure new instances are ready.</p></blockquote><p>This is the magic sauce. App Service doesn&#x27;t route traffic to an instance until it&#x27;s given the thumbs up that it&#x27;s ready in the form of passing health checks. This is excellent; it is this that makes automated zero downtime releases a reality.</p><p>Props to the various Azure teams that have made this possible; I&#x27;m very impressed by the way in which the Health checks and slots can be combined together to support some tremendous use cases.</p></section></article><div><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/blog/2021-02-11-azure-app-service-health-checks-and-zero-downtime-deployments.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog.johnnyreilly.com/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">¬´ Making Easy Auth tokens survive releases on Linux Azure App Service</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog.johnnyreilly.com/2021/02/08/arm-templates-security-role-assignments"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">ARM templates, security, role assignments and magic GUIDs ¬ª</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#why-zero-downtime-deployments" class="table-of-contents__link">Why zero downtime deployments?</a></li><li><a href="#manual-zero-downtime-releases-with-app-services" class="table-of-contents__link">Manual zero downtime releases with App Services</a></li><li><a href="#rollbacks-for-bonus-points" class="table-of-contents__link">Rollbacks for bonus points</a></li><li><a href="#automated-zero-downtime-releases-with-health-checks" class="table-of-contents__link">Automated zero downtime releases with Health checks</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/blog.johnnyreilly.com/styles.b80bbee1.js"></script>
<script src="/blog.johnnyreilly.com/runtime~main.94d0c56d.js"></script>
<script src="/blog.johnnyreilly.com/main.08f1a502.js"></script>
<script src="/blog.johnnyreilly.com/1.b4966bec.js"></script>
<script src="/blog.johnnyreilly.com/2.7d3f6764.js"></script>
<script src="/blog.johnnyreilly.com/ccc49370.bc2c92b9.js"></script>
<script src="/blog.johnnyreilly.com/c3b5bd8c.4d75ffb7.js"></script>
<script src="/blog.johnnyreilly.com/f61b3e3a.e3cbe6e6.js"></script>
</body>
</html>