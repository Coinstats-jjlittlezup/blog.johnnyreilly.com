<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">ASP.NET, Serilog and Application Insights | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="ASP.NET, Serilog and Application Insights | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="If you&#x27;re deploying an ASP.NET application to Azure App Services, there&#x27;s a decent chance you&#x27;ll also be using the fantastic Serilog and will want to plug it into Azure&#x27;s Application Insights."><meta data-react-helmet="true" property="og:description" content="If you&#x27;re deploying an ASP.NET application to Azure App Services, there&#x27;s a decent chance you&#x27;ll also be using the fantastic Serilog and will want to plug it into Azure&#x27;s Application Insights."><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/2021/01/30/aspnet-serilog-and-application-insights"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/2021/01/30/aspnet-serilog-and-application-insights"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2021/01/30/aspnet-serilog-and-application-insights" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2021/01/30/aspnet-serilog-and-application-insights" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.06828b8d.css">
<link rel="preload" href="/assets/js/styles.34fdb787.js" as="script">
<link rel="preload" href="/assets/js/runtime~main.fa2ae691.js" as="script">
<link rel="preload" href="/assets/js/main.06ae1ef2.js" as="script">
<link rel="preload" href="/assets/js/1.1633a53e.js" as="script">
<link rel="preload" href="/assets/js/2.c345114a.js" as="script">
<link rel="preload" href="/assets/js/ccc49370.b9733cf3.js" as="script">
<link rel="preload" href="/assets/js/c3b5bd8c.19074e3d.js" as="script">
<link rel="preload" href="/assets/js/fbe9a1e7.8fa07d46.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/about">About</a></li><li class="menu__list-item"><a class="menu__link" href="/blog-archive">Blog Archive</a></li><li class="menu__list-item"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="menu__link">Twitter</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/23/bicep-meet-azure-pipelines-2">Bicep meet Azure Pipelines 2</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/20/bicep-meet-azure-pipelines">Bicep meet Azure Pipelines</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/17/rss-update-we-moved-to-docusaurus">RSS update; we moved to Docusaurus</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/15/from-blogger-to-docusaurus">From Blogger to Docusaurus</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/10/managed-identity-azure-sql-entity-framework">Managed Identity, Azure SQL and Entity Framework</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="margin-bottom--sm blogPostTitle_GeHD">ASP.NET, Serilog and Application Insights</h1><div class="margin-vert--md"><time datetime="2021-01-30T00:00:00.000Z" class="blogPostDate_fNvV">January 30, 2021 Â· 4 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><p>If you&#x27;re deploying an ASP.NET application to Azure App Services, there&#x27;s a decent chance you&#x27;ll also be using the fantastic <a href="https://serilog.net/" target="_blank" rel="noopener noreferrer">Serilog</a> and will want to plug it into Azure&#x27;s <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview" target="_blank" rel="noopener noreferrer">Application Insights</a>.</p><p>This post will show you how it&#x27;s done, and it&#x27;ll also build upon the <a href="https://blog.johnnyreilly.com/2021/01/surfacing-azure-pipelines-build-info-in.html" target="_blank" rel="noopener noreferrer">build info work from our previous post</a>. In what way? Great question. Well logs are a tremendous diagnostic tool. If you have logs which display some curious behaviour, and you&#x27;d like to replicate that in another environment, you really want to take exactly that version of the codebase out to play. Our last post introduced build info into our application in the form of our <code>AppVersionInfo</code> class that looks something like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><div tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;buildNumber&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;20210130.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;buildId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;123456&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;branchName&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;main&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;commitHash&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;7089620222c30c1ad88e4b556c0a7908ddd34a8e&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>We&#x27;d initially exposed an endpoint in our application which surfaced up this information. Now we&#x27;re going to take that self same information and bake it into our log messages by making use of <a href="https://github.com/serilog/serilog/wiki/Enrichment" target="_blank" rel="noopener noreferrer">Serilog&#x27;s enrichment functionality</a>. Build info and Serilog&#x27;s enrichment are the double act your logging has been waiting for.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="lets-plug-it-together"></a>Let&#x27;s plug it together<a class="hash-link" href="#lets-plug-it-together" title="Direct link to heading">#</a></h2><p>We&#x27;re going to need a number of Serilog dependencies added to our <code>.csproj</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><div tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">PackageReference</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Serilog.AspNetCore</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">3.4.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">PackageReference</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Serilog.Enrichers.Environment</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">2.1.3</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">PackageReference</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Serilog.Enrichers.Thread</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">3.1.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">PackageReference</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Serilog.Sinks.ApplicationInsights</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">3.1.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">PackageReference</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Serilog.Sinks.Async</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">1.4.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The earlier in your application lifetime you get logging wired up, the happier you will be. Earlier, means more information when you&#x27;re diagnosing issues. So we want to start in our <code>Program.cs</code>; <code>Startup.cs</code> would be just <em>way</em> too late.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class Program {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    const string APP_NAME = &quot;MyAmazingApp&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static int Main(string[] args) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        AppVersionInfo.InitialiseBuildInfoGivenPath(Directory.GetCurrentDirectory());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        LoggerConfigurationExtensions.SetupLoggerConfiguration(APP_NAME, AppVersionInfo.GetBuildInfo());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Log.Information(&quot;Starting web host&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            CreateHostBuilder(args).Build().Run();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        catch (Exception ex)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Log.Fatal(ex, &quot;Host terminated unexpectedly&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        finally</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Log.CloseAndFlush();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static IHostBuilder CreateHostBuilder(string[] args) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Host.CreateDefaultBuilder(args)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .UseSerilog((hostBuilderContext, services, loggerConfiguration) =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                loggerConfiguration.ConfigureBaseLogging(APP_NAME, AppVersionInfo.GetBuildInfo());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                loggerConfiguration.AddApplicationInsightsLogging(services, hostBuilderContext.Configuration);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .ConfigureWebHostDefaults(webBuilder =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                webBuilder</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    .UseStartup&lt;Startup&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>If you look at the code above you&#x27;ll see that the first line of code that executes is <code>AppVersionInfo.InitialiseBuildInfoGivenPath</code>. This initialises our <code>AppVersionInfo</code> so we have meaningful build info to pump into our logs. The next thing we do is to configure Serilog with <code>LoggerConfigurationExtensions.SetupLoggerConfiguration</code>. This provides us with a configured logger so we are free to log any issues that take place during startup. (Incidentally, after startup you&#x27;ll likely inject an <code>ILogger</code> into your classes rather than using the static <code>Log</code> directly.)</p><p>Finally, we call <code>CreateHostBuilder</code> which in turn calls <code>UseSerilog</code> to plug Serilog into ASP.NET. If you take a look inside the body of <code>UserSerilog</code> you&#x27;ll see we configure the logging of ASP.NET (in the same we did for Serilog) and we hook into Application Insights as well. There&#x27;s been a number of references to <code>LoggerConfigurationExtensions</code>. Let&#x27;s take a look at it:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">internal static class LoggerConfigurationExtensions {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    internal static void SetupLoggerConfiguration(string appName, BuildInfo buildInfo) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Log.Logger = new LoggerConfiguration()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .ConfigureBaseLogging(appName, buildInfo)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .CreateLogger();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    internal static LoggerConfiguration ConfigureBaseLogging(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        this LoggerConfiguration loggerConfiguration,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        string appName,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        BuildInfo buildInfo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        loggerConfiguration</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .MinimumLevel.Debug()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .MinimumLevel.Override(&quot;Microsoft&quot;, LogEventLevel.Information)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // AMAZING COLOURS IN THE CONSOLE!!!!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .WriteTo.Async(a =&gt; a.Console(theme: AnsiConsoleTheme.Code))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.FromLogContext()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.WithMachineName()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.WithThreadId()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Build information as custom properties</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.WithProperty(nameof(buildInfo.BuildId), buildInfo.BuildId)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.WithProperty(nameof(buildInfo.BuildNumber), buildInfo.BuildNumber)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.WithProperty(nameof(buildInfo.BranchName), buildInfo.BranchName)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.WithProperty(nameof(buildInfo.CommitHash), buildInfo.CommitHash)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Enrich.WithProperty(&quot;ApplicationName&quot;, appName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return loggerConfiguration;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    internal static LoggerConfiguration AddApplicationInsightsLogging(this LoggerConfiguration loggerConfiguration, IServiceProvider services, IConfiguration configuration)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (!string.IsNullOrWhiteSpace(configuration.GetValue&lt;string&gt;(&quot;APPINSIGHTS_INSTRUMENTATIONKEY&quot;)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            loggerConfiguration.WriteTo.ApplicationInsights(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                services.GetRequiredService&lt;TelemetryConfiguration&gt;(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                TelemetryConverter.Traces);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return loggerConfiguration;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>If we take a look at the <code>ConfigureBaseLogging</code> method above, we can see that our logs are being enriched with the build info, property by property. We&#x27;re also giving ourselves a beautifully coloured console thanks to Serilog&#x27;s glorious <a href="https://github.com/serilog/serilog-sinks-console#themes" target="_blank" rel="noopener noreferrer">theme support</a>:</p><p> <img src="/assets/images/coloured-console-235bc09c89c446ffb16f886abbfa36b2.png"></p><p>Take a moment to admire the salmon pinks. Is it not lovely?</p><p>Finally we come to the main act. Plugging in Application Insights is as simple as dropping in <code>loggerConfiguration.WriteTo.ApplicationInsights</code> into our configuration. You&#x27;ll note that this depends upon the existence of an application setting of <code>APPINSIGHTS_INSTRUMENTATIONKEY</code> - this is the secret sauce that we need to be in place so we can pipe logs merrily to Application Insights. So you&#x27;ll need this configuration in place so this works.</p><p><img src="/assets/images/application-insights-properties-bad281e33f559caeb9a87686f1b58f55.png"></p><p>As you can see, we now have the likes of <code>BuildNumber</code>, <code>CommitHash</code> and friends visible on each log. Happy diagnostic days!</p><p>I&#x27;m indebted to the marvellous <a href="https://twitter.com/MarcelMichau" target="_blank" rel="noopener noreferrer">Marcel Michau</a> who showed me how to get the fiddlier parts of how to get Application Insights plugged in the right way. Thanks chap!</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/asp-net">asp.net</a><a class="margin-horiz--sm" href="/tags/azure">Azure</a><a class="margin-horiz--sm" href="/tags/application-insights">Application Insights</a><a class="margin-horiz--sm" href="/tags/serilog">Serilog</a></div></footer></article><div><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/blog/2021-01-30-aspnet-serilog-and-application-insights.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/2021/02/08/arm-templates-security-role-assignments"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« ARM templates, security, role assignments and magic GUIDs</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/2021/01/29/surfacing-azure-pipelines-build-info-in"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Surfacing Azure Pipelines Build Info in a .NET React SPA Â»</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#lets-plug-it-together" class="table-of-contents__link">Let&#39;s plug it together</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/styles.34fdb787.js"></script>
<script src="/assets/js/runtime~main.fa2ae691.js"></script>
<script src="/assets/js/main.06ae1ef2.js"></script>
<script src="/assets/js/1.1633a53e.js"></script>
<script src="/assets/js/2.c345114a.js"></script>
<script src="/assets/js/ccc49370.b9733cf3.js"></script>
<script src="/assets/js/c3b5bd8c.19074e3d.js"></script>
<script src="/assets/js/fbe9a1e7.8fa07d46.js"></script>
</body>
</html>