<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">Azure Easy Auth and Roles with .NET (and .NET Core) | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="Azure Easy Auth and Roles with .NET (and .NET Core) | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="If this post is interesting to you, you may also want to look at this one where we try to use Microsoft.Identity.Web for the same purpose."><meta data-react-helmet="true" property="og:description" content="If this post is interesting to you, you may also want to look at this one where we try to use Microsoft.Identity.Web for the same purpose."><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/2021/01/14/azure-easy-auth-and-roles-with-dotnet-and-core"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/2021/01/14/azure-easy-auth-and-roles-with-dotnet-and-core"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2021/01/14/azure-easy-auth-and-roles-with-dotnet-and-core" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2021/01/14/azure-easy-auth-and-roles-with-dotnet-and-core" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.e07a5399.css">
<link rel="preload" href="/assets/js/runtime~main.d21c5588.js" as="script">
<link rel="preload" href="/assets/js/main.5fe109db.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/about">About</a></li><li class="menu__list-item"><a class="menu__link" href="/blog-archive">Blog Archive</a></li><li class="menu__list-item"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="menu__link">Twitter</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/05/01/blog-archive-for-docusaurus">Blog Archive for Docusaurus</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/04/24/service-now-api-and-typescript-conditional-types">The Service Now API and TypeScript Conditional Types</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/04/20/ts-loader-goes-webpack-5">ts-loader goes webpack 5</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/04/10/hello-world-bicep">Hello World Bicep</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/23/bicep-meet-azure-pipelines-2">Bicep meet Azure Pipelines 2</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="margin-bottom--sm blogPostTitle_GeHD">Azure Easy Auth and Roles with .NET (and .NET Core)</h1><div class="margin-vert--md"><time datetime="2021-01-14T00:00:00.000Z" class="blogPostDate_fNvV">January 14, 2021 · 6 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><p><em>If this post is interesting to you, you may also want to <a href="https://blog.johnnyreilly.com/2021/01/azure-easy-auth-and-roles-with-net-and-microsoft-identity-web.html" target="_blank" rel="noopener noreferrer">look at this one where we try to use Microsoft.Identity.Web for the same purpose.</a></em></p><p> Azure has a feature which is intended to allow Authentication and Authorization to be applied outside of your application code. It&#x27;s called <a href="https://docs.microsoft.com/en-us/azure/app-service/overview-authentication-authorization" target="_blank" rel="noopener noreferrer">&quot;Easy Auth&quot;</a>. Unfortunately, in the context of App Services it doesn&#x27;t work with .NET Core and .NET. Perhaps it would be better to say: of the various .NETs, it supports .NET Framework. <a href="https://docs.microsoft.com/en-us/azure/app-service/overview-authentication-authorization#userapplication-claims" target="_blank" rel="noopener noreferrer">To quote the docs</a>:</p><blockquote><p>At this time, ASP.NET Core does not currently support populating the current user with the Authentication/Authorization feature. However, some <a href="https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth" target="_blank" rel="noopener noreferrer">3rd party, open source middleware components</a> do exist to help fill this gap.</p></blockquote><p>Thanks to <a href="https://twitter.com/MaximRouiller" target="_blank" rel="noopener noreferrer">Maxime Rouiller</a> there&#x27;s a way forward here. However, as I was taking this for a spin today, I discovered another issue.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="where-are-our-roles"></a>Where are our roles?<a class="hash-link" href="#where-are-our-roles" title="Direct link to heading">#</a></h2><p>Consider the following .NET controller:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Authorize(Roles = &quot;Administrator,Reader&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[HttpGet(&quot;api/admin-reader&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public string GetWithAdminOrReader() =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;this is a secure endpoint that users with the Administrator or Reader role can access&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Authorize(Roles = &quot;Administrator&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[HttpGet(&quot;api/admin&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public string GetWithAdmin() =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;this is a secure endpoint that users with the Administrator role can access&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Authorize(Roles = &quot;Reader&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[HttpGet(&quot;api/reader&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public string GetWithReader() =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;this is a secure endpoint that users with the Reader role can access&quot;;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The three endpoints above restrict access based upon roles. However, even with Maxime&#x27;s marvellous shim in the mix, authorization doesn&#x27;t work when deployed to an Azure App Service. Why? Well, it comes down to how roles are mapped to claims.</p><p>Let&#x27;s back up a bit. First of all we&#x27;ve added a dependency to our project:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> package MaximeRouiller.Azure.AppService.EasyAuth</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Next we&#x27;ve updated our <code>Startup.cs``ConfigureServices</code> such that it looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (Env.IsDevelopment()) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    services.AddMicrosoftIdentityWebAppAuthentication(Configuration);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    services.AddAuthentication(&quot;EasyAuth&quot;).AddEasyAuthAuthentication((o) =&gt; { });</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>With the above in place, either the Microsoft Identity platform will directly be used for authentication, or Maxime&#x27;s package will be used as the default authentication scheme. The driver for this is <code>Env</code> which is an <code>IHostEnvironment</code> that was injected to the <code>Startup.cs</code>. Running locally, both authentication and authorization will work. However, deployed to an Azure App Service, only authentication will work.</p><p>It turns out that directly using the Microsoft Identity platform, we see roles claims coming through like so:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><div tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Administrator&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Reader&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>But in Azure we see roles claims showing up with a different <code>type</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><div tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Administrator&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Reader&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>This is the crux of the problem; .NET and .NET Core are looking in a different place for roles.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="role-up-role-up"></a>Role up, role up!<a class="hash-link" href="#role-up-role-up" title="Direct link to heading">#</a></h2><p>There wasn&#x27;t an obvious way to make this work with Maxime&#x27;s package. So we ended up lifting the source code of Maxime&#x27;s package and tweaking it. Take a look:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Authentication;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.Logging;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.Options;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Collections.Generic;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Linq;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Security.Claims;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Text.Encodings.Web;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Text.Json;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Text.Json.Serialization;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Threading.Tasks;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// Based on https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// Essentially EasyAuth only supports .NET Framework: https://docs.microsoft.com/en-us/azure/app-service/app-service-authentication-how-to#access-user-claims</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// This allows us to get support for Authentication and Authorization (using roles) with .NET</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace EasyAuth {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static class EasyAuthAuthenticationBuilderExtensions {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static AuthenticationBuilder AddEasyAuthAuthentication(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this IServiceCollection services) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            services.AddAuthentication(&quot;EasyAuth&quot;).AddEasyAuthAuthenticationScheme(o =&gt; { });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static AuthenticationBuilder AddEasyAuthAuthenticationScheme(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this AuthenticationBuilder builder,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Action&lt;EasyAuthAuthenticationOptions&gt; configure) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                builder.AddScheme&lt;EasyAuthAuthenticationOptions, EasyAuthAuthenticationHandler&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;EasyAuth&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;EasyAuth&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    configure);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class EasyAuthAuthenticationOptions : AuthenticationSchemeOptions {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public EasyAuthAuthenticationOptions() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Events = new object();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class EasyAuthAuthenticationHandler : AuthenticationHandler&lt;EasyAuthAuthenticationOptions&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public EasyAuthAuthenticationHandler(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            IOptionsMonitor&lt;EasyAuthAuthenticationOptions&gt; options,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ILoggerFactory logger,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            UrlEncoder encoder,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ISystemClock clock)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            : base(options, logger, encoder, clock) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var easyAuthEnabled = string.Equals(Environment.GetEnvironmentVariable(&quot;WEBSITE_AUTH_ENABLED&quot;, EnvironmentVariableTarget.Process), &quot;True&quot;, StringComparison.InvariantCultureIgnoreCase);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (!easyAuthEnabled) return Task.FromResult(AuthenticateResult.NoResult());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var easyAuthProvider = Context.Request.Headers[&quot;X-MS-CLIENT-PRINCIPAL-IDP&quot;].FirstOrDefault();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var msClientPrincipalEncoded = Context.Request.Headers[&quot;X-MS-CLIENT-PRINCIPAL&quot;].FirstOrDefault();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (string.IsNullOrWhiteSpace(easyAuthProvider) ||</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    string.IsNullOrWhiteSpace(msClientPrincipalEncoded))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    return Task.FromResult(AuthenticateResult.NoResult());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var decodedBytes = Convert.FromBase64String(msClientPrincipalEncoded);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var msClientPrincipalDecoded = System.Text.Encoding.Default.GetString(decodedBytes);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var clientPrincipal = JsonSerializer.Deserialize&lt;MsClientPrincipal&gt;(msClientPrincipalDecoded);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (clientPrincipal == null) return Task.FromResult(AuthenticateResult.NoResult());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var mappedRolesClaims = clientPrincipal.Claims</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    .Where(claim =&gt; claim.Type == &quot;roles&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    .Select(claim =&gt; new Claim(ClaimTypes.Role, claim.Value))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    .ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var claims = clientPrincipal.Claims.Select(claim =&gt; new Claim(claim.Type, claim.Value)).ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                claims.AddRange(mappedRolesClaims);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var principal = new ClaimsPrincipal();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                principal.AddIdentity(new ClaimsIdentity(claims, clientPrincipal.AuthenticationType, clientPrincipal.NameType, clientPrincipal.RoleType));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var ticket = new AuthenticationTicket(principal, easyAuthProvider);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var success = AuthenticateResult.Success(ticket);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                Context.User = principal;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return Task.FromResult(success);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            } catch (Exception ex) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return Task.FromResult(AuthenticateResult.Fail(ex));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class MsClientPrincipal {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [JsonPropertyName(&quot;auth_typ&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public string? AuthenticationType { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [JsonPropertyName(&quot;claims&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public IEnumerable&lt;UserClaim&gt; Claims { get; set; } = Array.Empty&lt;UserClaim&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [JsonPropertyName(&quot;name_typ&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public string? NameType { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [JsonPropertyName(&quot;role_typ&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public string? RoleType { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class UserClaim {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [JsonPropertyName(&quot;typ&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public string Type { get; set; } = string.Empty;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [JsonPropertyName(&quot;val&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public string Value { get; set; } = string.Empty;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>There&#x27;s a number of changes in the above code to Maxime&#x27;s package. Three changes that are not significant and one that is. First the insignificant changes:</p><ol><li>It uses <a href="https://docs.microsoft.com/en-us/dotnet/standard/serialization/system-text-json-how-to?pivots=dotnet-5-0" target="_blank" rel="noopener noreferrer"><code>System.Text.Json</code></a> in place of JSON.NET</li><li>It uses <a href="https://blog.johnnyreilly.com/2020/12/nullable-reference-types-csharp-strictnullchecks.html" target="_blank" rel="noopener noreferrer">C#s nullable reference types</a></li><li>It changes the extension method signature such that instead of entering <code>services.AddAuthentication().AddEasyAuthAuthentication((o) =&amp;gt; { })</code> we now need only enter <code>services.AddEasyAuthAuthentication()</code></li></ol><p>Now the significant change:</p><p>Where the middleware encounters claims in the <code>X-MS-CLIENT-PRINCIPAL</code> header with the <code>Type</code> of <code>&quot;roles&quot;</code> it creates brand new claims for each, with the same <code>Value</code> but with the official <code>Type</code> supplied by <code>ClaimsTypes.Role</code> of <code>&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</code>. The upshot of this, is that when the processed claims are inspected in Azure they now look more like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><div tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Administrator&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Reader&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Administrator&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Reader&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>As you can see, we now have both the originally supplied roles <em>as well</em> as roles of the type that .NET and .NET Core expect. Consequently, roles based behaviour starts to work. Thanks to Maxime for his fine work on the initial solution. It would be tremendous if neither the code in this blog post nor Maxime&#x27;s shim were required. Still, until that glorious day!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="update-potential-ways-forward"></a>Update: Potential ways forward<a class="hash-link" href="#update-potential-ways-forward" title="Direct link to heading">#</a></h2><p>When I was tweeting this post, Maxime was good enough to respond and suggest that this may be resolved within Azure itself in future:</p><blockquote><p>Oh, so that&#x27;s why they removed the name? 😲😜 Jokes aside, we hope that this package won&#x27;t be necessary for the future. I know that <a href="https://twitter.com/mattchenderson?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">@mattchenderson</a> is part of a working group to update Easy Auth. Might want to make sure you follow him as well. 😁</p><p>— Maxime Rouiller (@MaximRouiller) <a href="https://twitter.com/MaximRouiller/status/1349804324713615366?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">January 14, 2021</a></p></blockquote><script src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>There&#x27;s a prospective PR that would add an event to Maxime&#x27;s API. If something along these lines was merged, then my workaround would no longer be necessary. Follow the PR <a href="https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth/pull/13" target="_blank" rel="noopener noreferrer">here</a>.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/azure">Azure</a><a class="margin-horiz--sm" href="/tags/app-service">App service</a><a class="margin-horiz--sm" href="/tags/authorisation">authorisation</a><a class="margin-horiz--sm" href="/tags/authentication">Authentication</a><a class="margin-horiz--sm" href="/tags/azure-ad">azure AD</a></div></footer></article><div><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/blog/2021-01-14-azure-easy-auth-and-roles-with-dotnet-and-core.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/2021/01/17/azure-easy-auth-and-roles-with-net-and-microsoft-identity-web"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« Azure Easy Auth and Roles with .NET and Microsoft.Identity.Web</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/2021/01/03/strongly-typing-react-query-s-usequeries"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Strongly typing react-querys useQueries »</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#where-are-our-roles" class="table-of-contents__link">Where are our roles?</a></li><li><a href="#role-up-role-up" class="table-of-contents__link">Role up, role up!</a></li><li><a href="#update-potential-ways-forward" class="table-of-contents__link">Update: Potential ways forward</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Support me</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><h4 class="footer__title">Feeds</h4><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">RSS</a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item">Atom</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d21c5588.js"></script>
<script src="/assets/js/main.5fe109db.js"></script>
</body>
</html>