<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog.johnnyreilly.com/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog.johnnyreilly.com/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed"><title data-react-helmet="true">Google Analytics API and ASP.Net Core | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="Google Analytics API and ASP.Net Core | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="Some of my posts are meaningful treaties on the nature of software development. Some are detailed explanations of approaches you can use. Some are effectively code dumps. This is one of those."><meta data-react-helmet="true" property="og:description" content="Some of my posts are meaningful treaties on the nature of software development. Some are detailed explanations of approaches you can use. Some are effectively code dumps. This is one of those."><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/blog.johnnyreilly.com/img/favicon.ico"><link rel="stylesheet" href="/blog.johnnyreilly.com/styles.a755cef0.css">
<link rel="preload" href="/blog.johnnyreilly.com/styles.e251ffc4.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/runtime~main.17090397.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/main.76845b2c.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/1.32932134.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/2.7bb643e8.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/ccc49370.1c32a13b.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/c3b5bd8c.b09f7905.js" as="script">
<link rel="preload" href="/blog.johnnyreilly.com/a9301a2e.7beca555.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/blog.johnnyreilly.com/"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/blog.johnnyreilly.com/"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/blog.johnnyreilly.com/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/03/06/generate-typescript-and-csharp-clients-with-nswag">Generate TypeScript and CSharp clients with NSwag based on an API</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure">Goodbye Client Affinity, Hello Data Protection with Azure</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service">Making Easy Auth tokens survive releases on Linux Azure App Service</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/11/azure-app-service-health-checks-and-zero-downtime-deployments">Azure App Service, Health checks and zero downtime deployments</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog.johnnyreilly.com/2021/02/08/arm-templates-security-role-assignments">ARM templates, security, role assignments and magic GUIDs</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_3-lP">Google Analytics API and ASP.Net Core</h1><div class="margin-vert--md"><time datetime="2019-03-22T00:00:00.000Z" class="blogPostDate_Ta7i">March 22, 2019  Â· 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>Some of my posts are meaningful treaties on the nature of software development. Some are detailed explanations of approaches you can use. Some are effectively code dumps. This is one of those.</p><p>I recently had need to be able to access the API for Google Analytics from ASP.Net Core. Getting this up and running turned out to be surprisingly tough because of an absence of good examples. So here it is; an example of how you can access a simple page access stat using <a href="https://www.nuget.org/packages/Google.Apis.AnalyticsReporting.v4/" target="_blank" rel="noopener noreferrer">the API</a>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">async Task&lt;SomeKindOfDataStructure[]&gt; GetUsageFromGoogleAnalytics(DateTime startAtThisDate, DateTime endAtThisDate)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Create the DateRange object. Here we want data from last week.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var dateRange = new DateRange</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        StartDate = startAtThisDate.ToString(&quot;yyyy-MM-dd&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        EndDate = endAtThisDate.ToString(&quot;yyyy-MM-dd&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Create the Metrics and dimensions object.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // var metrics = new List&lt;Metric&gt; { new Metric { Expression = &quot;ga:sessions&quot;, Alias = &quot;Sessions&quot; } };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // var dimensions = new List&lt;Dimension&gt; { new Dimension { Name = &quot;ga:pageTitle&quot; } };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var metrics = new List&lt;Metric&gt; { new Metric { Expression = &quot;ga:uniquePageviews&quot; } };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var dimensions = new List&lt;Dimension&gt; { </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new Dimension { Name = &quot;ga:date&quot; },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new Dimension { Name = &quot;ga:dimension1&quot; } </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Get required View Id from configuration</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var viewId = $&quot;ga:{&quot;[VIEWID]&quot;}&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Create the Request object.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var reportRequest = new ReportRequest</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        DateRanges = new List&lt;DateRange&gt; { dateRange },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Metrics = metrics,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Dimensions = dimensions,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        FiltersExpression = &quot;ga:pagePath==/index.html&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ViewId = viewId</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var getReportsRequest = new GetReportsRequest {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ReportRequests = new List&lt;ReportRequest&gt; { reportRequest }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    //Invoke Google Analytics API call and get report</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var analyticsService = GetAnalyticsReportingServiceInstance();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var response = await (analyticsService.Reports.BatchGet(getReportsRequest)).ExecuteAsync();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var logins = response.Reports[0].Data.Rows.Select(row =&gt; new SomeKindOfDataStructure {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Date = new DateTime(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            year: Convert.ToInt32(row.Dimensions[0].Substring(0, 4)), </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            month: Convert.ToInt32(row.Dimensions[0].Substring(4, 2)), </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            day: Convert.ToInt32(row.Dimensions[0].Substring(6, 2))),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        NumberOfLogins = Convert.ToInt32(row.Metrics[0].Values[0])</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .OrderByDescending(login =&gt; login.Date)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .ToArray();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return logins;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// Intializes and returns Analytics Reporting Service Instance</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">AnalyticsReportingService GetAnalyticsReportingServiceInstance() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var googleAuthFlow = new GoogleAuthorizationCodeFlow(new GoogleAuthorizationCodeFlow.Initializer {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ClientSecrets = new ClientSecrets {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ClientId = &quot;[CLIENTID]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ClientSecret = &quot;[CLIENTSECRET]&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var responseToken = new TokenResponse {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        AccessToken = &quot;[ANALYTICSTOKEN]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        RefreshToken = &quot;[REFRESHTOKEN]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Scope = AnalyticsReportingService.Scope.AnalyticsReadonly, //Read-only access to Google Analytics,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        TokenType = &quot;Bearer&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var credential = new UserCredential(googleAuthFlow, &quot;&quot;, responseToken);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Create the  Analytics service.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return new AnalyticsReportingService(new BaseClientService.Initializer {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpClientInitializer = credential,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ApplicationName = &quot;my-super-applicatio&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>You can see above that you need various credentials to be able to use the API. You can acquire these by logging into GA. Enjoy!</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/asp-net-core">asp net core</a><a class="margin-horiz--sm" href="/blog.johnnyreilly.com/tags/google-analytics">google analytics</a></div></footer></article><div><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/blog/2019-03-22-google-analytics-api-and-aspnet-core.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog.johnnyreilly.com/2019/03/24/template-tricks-for-dainty-dom"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Template Tricks for a Dainty DOM</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog.johnnyreilly.com/2019/03/06/the-big-one-point-oh"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">The Big One Point Oh Â»</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_2xL- thin-scrollbar"></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/blog.johnnyreilly.com/styles.e251ffc4.js"></script>
<script src="/blog.johnnyreilly.com/runtime~main.17090397.js"></script>
<script src="/blog.johnnyreilly.com/main.76845b2c.js"></script>
<script src="/blog.johnnyreilly.com/1.32932134.js"></script>
<script src="/blog.johnnyreilly.com/2.7bb643e8.js"></script>
<script src="/blog.johnnyreilly.com/ccc49370.1c32a13b.js"></script>
<script src="/blog.johnnyreilly.com/c3b5bd8c.b09f7905.js"></script>
<script src="/blog.johnnyreilly.com/a9301a2e.7beca555.js"></script>
</body>
</html>