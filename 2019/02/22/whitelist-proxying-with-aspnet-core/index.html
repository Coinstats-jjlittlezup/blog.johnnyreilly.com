<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">WhiteList Proxying with ASP.Net Core | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="WhiteList Proxying with ASP.Net Core | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="Once upon a time there lived a young team who were building a product. They were ready to go live with their beta and so they set off on a journey to a mystical land they had heard tales of. This magical kingdom was called &quot;Production&quot;. However, Production was a land with walls and but one gate. That gate was jealously guarded by a defender named &quot;InfoSec&quot;. InfoSec was there to make sure that only the the right people, noble of thought and pure of deed were allowed into the promised land. InfoSec would ask questions like &quot;are you serving over HTTPS&quot; and &quot;what are you doing about cross site scripting&quot;?"><meta data-react-helmet="true" property="og:description" content="Once upon a time there lived a young team who were building a product. They were ready to go live with their beta and so they set off on a journey to a mystical land they had heard tales of. This magical kingdom was called &quot;Production&quot;. However, Production was a land with walls and but one gate. That gate was jealously guarded by a defender named &quot;InfoSec&quot;. InfoSec was there to make sure that only the the right people, noble of thought and pure of deed were allowed into the promised land. InfoSec would ask questions like &quot;are you serving over HTTPS&quot; and &quot;what are you doing about cross site scripting&quot;?"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.a30a8c8e.css">
<link rel="preload" href="/styles.9c2995a9.js" as="script">
<link rel="preload" href="/runtime~main.e2b992e5.js" as="script">
<link rel="preload" href="/main.015a56c2.js" as="script">
<link rel="preload" href="/1.9d1369a3.js" as="script">
<link rel="preload" href="/2.3dd236d5.js" as="script">
<link rel="preload" href="/ccc49370.96ba1876.js" as="script">
<link rel="preload" href="/c3b5bd8c.0459a1fb.js" as="script">
<link rel="preload" href="/01472655.4b329ae4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/03/10/managed-identity-azure-sql-entity-framework">Managed Identity, Azure SQL and Entity Framework</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/03/06/generate-typescript-and-csharp-clients-with-nswag">Generate TypeScript and CSharp clients with NSwag based on an API</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure">Goodbye Client Affinity, Hello Data Protection with Azure</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service">Making Easy Auth tokens survive releases on Linux Azure App Service</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/2021/02/11/azure-app-service-health-checks-and-zero-downtime-deployments">Azure App Service, Health checks and zero downtime deployments</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_3-lP">WhiteList Proxying with ASP.Net Core</h1><div class="margin-vert--md"><time datetime="2019-02-22T00:00:00.000Z" class="blogPostDate_Ta7i">February 22, 2019  Â· 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/u/1010525?s=400&amp;u=294033082cfecf8ad1645b4290e362583b33094a&amp;v=4" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noreferrer noopener">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p>Once upon a time there lived a young team who were building a product. They were ready to go live with their beta and so they set off on a journey to a mystical land they had heard tales of. This magical kingdom was called &quot;Production&quot;. However, Production was a land with walls and but one gate. That gate was jealously guarded by a defender named &quot;InfoSec&quot;. InfoSec was there to make sure that only the the right people, noble of thought and pure of deed were allowed into the promised land. InfoSec would ask questions like &quot;are you serving over HTTPS&quot; and &quot;what are you doing about cross site scripting&quot;?</p><p>The team felt they had good answers to InfoSec&#x27;s questions. However, just as they were about to step through the gate, InfoSec held up their hand and said &quot;your application wants to access a database... database access needs to take place on our own internal network. Not over the publicly accessible internet. You shall not pass.&quot;</p><p>The team, with one foot in the air, paused. They swallowed and said &quot;can you give us five minutes?&quot;</p><p> <a href="https://3.bp.blogspot.com/-tmH5nbo_kGY/XG-8jmokKdI/AAAAAAAAN_Q/1zzN3IfRtlopNC9HTRio6HdpVCeO5jMkwCPcBGAYYCw/s1600/hang-on-lads-ive-got-a-great-idea.jpg" target="_blank" rel="noopener noreferrer">![null](&lt;https://3.bp.blogspot.com/-tmH5nbo_kGY/XG-8jmokKdI/AAAAAAAAN_Q/1zzN3IfRtlopNC9HTRio6HdpVCeO5jMkwCPcBGAYYCw/s640/hang-on-lads-ive-got-a-great-idea.jpg&gt; =640x271)</a>## The Proxy Regroup</p><p>And so it came to pass that the teams product (which took the form of ASP.Net Core web application) had to be changed. Where once there had been a single application, there would now be two; one that lived on the internet (the <em>web</em> app) and one that lived on the companies private network (the <em>API</em> app). The API app would do all the database access. In fact the product team opted to move all significant operations into the API as well. This left the web app with two purposes:</p><ol><li>the straightforward serving of HTML, CSS, JS and images</li><li>the proxying of API calls through to the API app</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="proxy-part-1"></a>Proxy Part 1<a class="hash-link" href="#proxy-part-1" title="Direct link to heading">#</a></h2><p>In the early days of this proxying the team reached for <a href="https://github.com/twitchax/AspNetCore.Proxy" target="_blank" rel="noopener noreferrer"><code>AspNetCore.Proxy</code></a>. It&#x27;s a great open source project that allows you to proxy HTTP requests. It gives you complete control over the construction of proxy requests, so that you can have a request come into your API and end up proxying it to a URL with a completely different path on the proxy server.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="proxy-part-2"></a>Proxy Part 2<a class="hash-link" href="#proxy-part-2" title="Direct link to heading">#</a></h2><p>The approach offered by <code>AspNetCore.Proxy</code> is fantastically powerful in terms of control. However, we didn&#x27;t actually need that level of configurability. In fact, it resulted in us writing a great deal of boilerplate code. You see in our case we&#x27;d opted to proxy path for path, changing only the server name on each proxied request. So if a GET request came in going to <a href="https://web.app.com/api/version" target="_blank" rel="noopener noreferrer">https://web.app.com/api/version</a> then we would want to proxy it to a GET request to <a href="https://api.app.com/api/version" target="_blank" rel="noopener noreferrer">https://api.app.com/api/version</a>. You see? All we did was swap <a href="https://web.app.com" target="_blank" rel="noopener noreferrer">https://web.app.com</a> for <a href="https://api.app.com." target="_blank" rel="noopener noreferrer">https://api.app.com.</a> Nothing more. We did that as a rule. We knew we <em>always</em> wanted to do just this.</p><p>So we ended up spinning up our own solution which allowed just the specification of paths we wanted to proxy with their corresponding HTTP verbs. Let&#x27;s talk through it. Usage of our approach ended up as a middleware within our web app&#x27;s <code>Startup.cs</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public void Configure(IApplicationBuilder app) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseProxyWhiteList(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // where ServerToProxyToBaseUrl is the server you want requests to be proxied to</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                proxyAddressTweaker: (requestPath) =&gt; $&quot;{ServerToProxyToBaseUrl}{requestPath}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                whiteListProxyRoutes: new [] {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // An anonymous request</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    WhiteListProxy.AnonymousRoute(&quot;api/version&quot;, HttpMethod.Get),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // An authenticated request; to send this we must know who the user is</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    WhiteListProxy.Route(&quot;api/account/{accountId:int}/all-the-secret-info&quot;, HttpMethod.Get, HttpMethod.Post),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseMvc();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If you look at the code above you can see that we are proxing all our requests to a single server: <code>ServerToProxyToBaseUrl</code>. We&#x27;re proxying 2 different requests:</p><ol><li><code>GET</code> requests to <code>api/version</code> are proxied through as <em>anonymous</em><code>GET</code> requests.</li><li><code>GET</code> and <code>POST</code> requests to <code>api/account/{accountId:int}/all-the-secret-info</code> are proxied through as <code>GET</code> and <code>POST</code> requests. These requests require that a user be authenticated first.</li></ol><p>The <code>WhiteListProxy</code> proxy class we&#x27;ve been using looks like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Collections.Generic;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net.Http;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace My.Web.Proxy {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class WhiteListProxy {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public string Path { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public IEnumerable&lt;HttpMethod&gt; Methods { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public bool IsAnonymous { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private WhiteListProxy(string path, bool isAnonymous, params HttpMethod[] methods) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (methods == null || methods.Length == 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new ArgumentException($&quot;You need at least a single HttpMethod to be specified for {path}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Path = path;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            IsAnonymous = isAnonymous;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Methods = methods;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static WhiteListProxy Route(string path, params HttpMethod[] methods) =&gt; new WhiteListProxy(path, isAnonymous : false, methods: methods);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static WhiteListProxy AnonymousRoute(string path, params HttpMethod[] methods) =&gt; new WhiteListProxy(path, isAnonymous : true, methods: methods);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The middleware for proxying (our <code>UseProxyWhiteList</code>) looks like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Collections.Generic;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.ComponentModel;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Linq;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net.Http;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Reflection;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Threading.Tasks;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Authentication;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Builder;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Http;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Routing;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.DependencyModel;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Serilog;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace My.Web.Proxy {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static class ProxyRouteExtensions {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// Middleware which proxies the supplied whitelist routes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static void UseProxyWhiteList(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this IApplicationBuilder app,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Func&lt;string, string&gt; proxyAddressTweaker,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Action&lt;HttpContext, HttpRequestMessage&gt; preSendProxyRequestAction,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            IEnumerable&lt;WhiteListProxy&gt; whiteListProxyRoutes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.UseRouter(builder =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                foreach (var whiteListProxy in whiteListProxyRoutes) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    foreach (var method in whiteListProxy.Methods) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        builder.MapMiddlewareVerb(method.ToString(), whiteListProxy.Path, proxyApp =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            proxyApp.UseProxy_Challenge(whiteListProxy.IsAnonymous);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            proxyApp.UseProxy_Run(proxyAddressTweaker, preSendProxyRequestAction);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private static void UseProxy_Challenge(this IApplicationBuilder app, bool allowAnonymous) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.Use((context, next) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var routePath = context.Request.Path.Value;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var weAreAuthenticatedOrWeDontNeedToBe =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    context.User.Identity.IsAuthenticated || allowAnonymous;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (weAreAuthenticatedOrWeDontNeedToBe)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    return next();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return context.ChallengeAsync();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private static void UseProxy_Run(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this IApplicationBuilder app,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Func&lt;string, string&gt; proxyAddressTweaker,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Action&lt;HttpContext, HttpRequestMessage&gt; preSendProxyRequestAction</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            app.Run(async context =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var proxyAddress = &quot;&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    proxyAddress = proxyAddressTweaker(context.Request.Path.Value);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var proxyRequest = context.Request.CreateProxyHttpRequest(proxyAddress);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    if (preSendProxyRequestAction != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        preSendProxyRequestAction(context, proxyRequest);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var httpClients = context.RequestServices.GetService&lt;IHttpClients&gt;(); // IHttpClients is just a wrapper for HttpClient - insert your own here</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var proxyResponse = await httpClients.SendRequestAsync(proxyRequest,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            HttpCompletionOption.ResponseHeadersRead, context.RequestAborted)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        .ConfigureAwait(false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    await context.CopyProxyHttpResponse(proxyResponse).ConfigureAwait(false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                catch (OperationCanceledException ex) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    if (ex.CancellationToken.IsCancellationRequested)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        return;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    if (!context.Response.HasStarted)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        context.Response.StatusCode = 408;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        await context.Response</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .WriteAsync(&quot;Request timed out.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                catch (Exception e) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    if (!context.Response.HasStarted)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        context.Response.StatusCode = 500;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        await context.Response</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .WriteAsync(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                $&quot;Request could not be proxied.\n\n{e.Message}\n\n{e.StackTrace}.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static void AddOrReplaceHeader(this HttpRequestMessage request, string headerName, string headerValue) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // It&#x27;s possible for there to be multiple headers with the same name; we only want a single header to remain.  Our one.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            while (request.Headers.TryGetValues(headerName, out var existingAuthorizationHeader)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                request.Headers.Remove(headerName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            request.Headers.TryAddWithoutValidation(headerName, headerValue);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static HttpRequestMessage CreateProxyHttpRequest(this HttpRequest request, string uriString) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var uri = new Uri(uriString + request.QueryString);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var requestMessage = new HttpRequestMessage();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var requestMethod = request.Method;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (!HttpMethods.IsGet(requestMethod) &amp;&amp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                !HttpMethods.IsHead(requestMethod) &amp;&amp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                !HttpMethods.IsDelete(requestMethod) &amp;&amp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                !HttpMethods.IsTrace(requestMethod)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var streamContent = new StreamContent(request.Body);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                requestMessage.Content = streamContent;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Copy the request headers.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (requestMessage.Content != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                foreach (var header in request.Headers)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    if (!requestMessage.Headers.TryAddWithoutValidation(header.Key, header.Value.ToArray()))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        requestMessage.Content?.Headers.TryAddWithoutValidation(header.Key, header.Value.ToArray());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            requestMessage.Headers.Host = uri.Authority;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            requestMessage.RequestUri = uri;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            requestMessage.Method = new HttpMethod(request.Method);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return requestMessage;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static async Task CopyProxyHttpResponse(this HttpContext context, HttpResponseMessage responseMessage) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var response = context.Response;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            response.StatusCode = (int) responseMessage.StatusCode;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            foreach (var header in responseMessage.Headers) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                response.Headers[header.Key] = header.Value.ToArray();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (responseMessage.Content != null) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                foreach (var header in responseMessage.Content.Headers) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    response.Headers[header.Key] = header.Value.ToArray();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            response.Headers.Remove(&quot;transfer-encoding&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            using(var responseStream = await responseMessage.Content.ReadAsStreamAsync().ConfigureAwait(false)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                await responseStream.CopyToAsync(response.Body, 81920, context.RequestAborted).ConfigureAwait(false);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/asp-net-core">asp net core</a><a class="margin-horiz--sm" href="/tags/proxy">proxy</a><a class="margin-horiz--sm" href="/tags/http-requests">http requests</a><a class="margin-horiz--sm" href="/tags/whitelist">whitelist</a></div></footer></article><div><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/blog/2019-02-22-whitelist-proxying-with-aspnet-core.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/2019/03/06/the-big-one-point-oh"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« The Big One Point Oh</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/2019/01/13/typescript-and-webpack-watch-it"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">TypeScript and webpack: Watch It Â»</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#proxy-part-1" class="table-of-contents__link">Proxy Part 1</a></li><li><a href="#proxy-part-2" class="table-of-contents__link">Proxy Part 2</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.9c2995a9.js"></script>
<script src="/runtime~main.e2b992e5.js"></script>
<script src="/main.015a56c2.js"></script>
<script src="/1.9d1369a3.js"></script>
<script src="/2.3dd236d5.js"></script>
<script src="/ccc49370.96ba1876.js"></script>
<script src="/c3b5bd8c.0459a1fb.js"></script>
<script src="/01472655.4b329ae4.js"></script>
</body>
</html>