<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">Dual boot authentication with ASP.Net Core | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="Dual boot authentication with ASP.Net Core | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="This is a post about having two kinds of authentication working at the same time in ASP.Net Core. But choosing which authentication method to use dynamically at runtime; based upon the criteria of your choice."><meta data-react-helmet="true" property="og:description" content="This is a post about having two kinds of authentication working at the same time in ASP.Net Core. But choosing which authentication method to use dynamically at runtime; based upon the criteria of your choice."><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/2020/03/22/dual-boot-authentication-with-aspnetcore"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/2020/03/22/dual-boot-authentication-with-aspnetcore"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2020/03/22/dual-boot-authentication-with-aspnetcore" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2020/03/22/dual-boot-authentication-with-aspnetcore" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.06828b8d.css">
<link rel="preload" href="/assets/js/styles.34fdb787.js" as="script">
<link rel="preload" href="/assets/js/runtime~main.fa2ae691.js" as="script">
<link rel="preload" href="/assets/js/main.06ae1ef2.js" as="script">
<link rel="preload" href="/assets/js/1.1633a53e.js" as="script">
<link rel="preload" href="/assets/js/2.c345114a.js" as="script">
<link rel="preload" href="/assets/js/ccc49370.b9733cf3.js" as="script">
<link rel="preload" href="/assets/js/c3b5bd8c.19074e3d.js" as="script">
<link rel="preload" href="/assets/js/8890ac7a.0a62e0ad.js" as="script">
<link rel="preload" href="/assets/js/fe3d2add.28822df4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">I CAN MAKE THIS WORK</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/about">About</a></li><li class="menu__list-item"><a class="menu__link" href="/blog-archive">Blog Archive</a></li><li class="menu__list-item"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="menu__link">Twitter</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/23/bicep-meet-azure-pipelines-2">Bicep meet Azure Pipelines 2</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/20/bicep-meet-azure-pipelines">Bicep meet Azure Pipelines</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/17/rss-update-we-moved-to-docusaurus">RSS update; we moved to Docusaurus</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/15/from-blogger-to-docusaurus">From Blogger to Docusaurus</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/03/10/managed-identity-azure-sql-entity-framework">Managed Identity, Azure SQL and Entity Framework</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="margin-bottom--sm blogPostTitle_GeHD">Dual boot authentication with ASP.Net Core</h1><div class="margin-vert--md"><time datetime="2020-03-22T00:00:00.000Z" class="blogPostDate_fNvV">March 22, 2020 Â· 9 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer">John Reilly</a></h4><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><p>This is a post about having two kinds of authentication working at the same time in ASP.Net Core. But choosing which authentication method to use dynamically at runtime; based upon the criteria of your choice.</p><p>Already this sounds complicated; let&#x27;s fix that. Perhaps I should describe my situation to you. I&#x27;ve an app which has two classes of user. One class, let&#x27;s call them &quot;customers&quot; (because... uh... they&#x27;re customers). The customers access our application via a public facing website. Traffic rolls through Cloudflare and into our application. The public facing URL is something fancy like <a href="https://mega-app.com" target="_blank" rel="noopener noreferrer">https://mega-app.com</a>. That&#x27;s one class of user.</p><p>The other class of user we&#x27;ll call &quot;our peeps&quot;; because they are <em>us</em>. We use the app that we build. Traffic from &quot;us&quot; comes from a different hostname; only addressable on our network. So URLs from requests that we make are more along the lines of <a href="https://strictly4mypeeps.io" target="_blank" rel="noopener noreferrer">https://strictly4mypeeps.io</a>.</p><p>So far, so uncontroversial. Now it starts to get interesting. Our customers log into our application using their super secret credentials. It&#x27;s <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/cookie?view=aspnetcore-3.1#create-an-authentication-cookie" target="_blank" rel="noopener noreferrer">cookie based authentication</a>. But for our peeps we do something different. Having to enter your credentials each time you use the app is friction. It gets in the way. So for us we have <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/azure-active-directory/?view=aspnetcore-3.1" target="_blank" rel="noopener noreferrer">Azure AD</a> in the mix. Azure AD is how we authenticate ourselves; and that means we don&#x27;t spend 5% of each working day entering credentials.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="let-us-speak-of-the-past"></a>Let us speak of the past<a class="hash-link" href="#let-us-speak-of-the-past" title="Direct link to heading">#</a></h2><p>Now our delightful little application grew up in a simpler time. A time where you went to the marketplace, picked out some healthy looking servers, installed software upon them, got them attached to the internet, deployed an app onto them and said &quot;hey presto, we&#x27;re live!&quot;.</p><p>Way back when, we had some servers on the internet, that&#x27;s how our customers got to our app. Our peeps, us, we went to other servers that lived on our network. So we had multiple instances of our app, deployed to different machines. The ones on the internet were configured to use cookie based auth, the ones on our internal network were Azure AD.</p><p>As I said, a simpler time.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="a-new-hope"></a>A new hope<a class="hash-link" href="#a-new-hope" title="Direct link to heading">#</a></h2><p>We&#x27;ve been going through the process of cloudifying our app. Bye, bye servers, hello <a href="https://www.docker.com/" target="_blank" rel="noopener noreferrer">Docker</a> and <a href="https://kubernetes.io/" target="_blank" rel="noopener noreferrer">Kubernetes</a>. So exciting! As we change the way our app is built and deployed; we&#x27;ve been thinking about whether the choices we make still make sense.</p><p>When it came to authentication, my initial thoughts were to continue the same road we&#x27;re travelling; just in containers and pods. So where we had &quot;internal&quot; servers, we&#x27;d have &quot;internal&quot; pods, and where we&#x27;d have &quot;external&quot; servers we&#x27;d have external pods. I had the good fortune to be working with the amazingly talented <a href="https://uk.linkedin.com/in/robert-grzankowski-53618114" target="_blank" rel="noopener noreferrer">Robski</a>. Robski knows far more about K8s and networking than I&#x27;m ever likely to. He&#x27;d regularly say things like &quot;ingress&quot; and &quot;MTLS&quot; whilst I stared blankly at him. He definitely knows stuff.</p><p>Robski challenged my plans. &quot;We don&#x27;t need it. Have one pod that does both sorts of auth. If you do that, your implementation is simpler and scaling is more straightforward. You&#x27;ll only need half the pods because you won&#x27;t need internal <em>and</em> external ones; one pod can handle both sets of traffic. You&#x27;ll save money.&quot;</p><p> I loved the idea but I didn&#x27;t think that ASP.Net Core supported it. &quot;It&#x27;s just not a thing Robski; ASP.Net Core doesn&#x27;t suppport it.&quot; Robski didn&#x27;t believe me. That turned out to a <em>very good thing</em>. There followed a period of much googling and experimentation. One day of hunting in, I was still convinced there was no way to do it that would allow me to look in the mirror without self loathing. Then Robski sent me this:</p><p><img src="https://4.bp.blogspot.com/-CjllrSY1e04/XneghUmKZ_I/AAAAAAAAUEA/WfZwU25wfQUWFVItCeC5l7FITgCaru9PgCPcBGAYYCw/s400/robski-dynamic-auth.png"></p><p>It was a link to the amazing <a href="https://twitter.com/davidfowl" target="_blank" rel="noopener noreferrer">David Fowler</a> talking about <a href="https://github.com/aspnet/Security/issues/1469#issuecomment-335027005" target="_blank" rel="noopener noreferrer">some API I&#x27;d never heard of called <code>SchemeSelector</code></a>. It turned out that this was the starting point for exactly what we needed; a way to dynamically select an authentication scheme at runtime.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="show-me-the-code"></a>Show me the code<a class="hash-link" href="#show-me-the-code" title="Direct link to heading">#</a></h2><p>This API did end up landing in ASP.Net Core, but with the name <code>ForwardDefaultSelector</code>. Not the most descriptive of names and I&#x27;ve struggled to find any documentation on it at all. What I did discover was <a href="https://stackoverflow.com/a/51897159/761388" target="_blank" rel="noopener noreferrer">an answer on StackOverflow by the marvellous Barbara Post</a>. I was able to take the approach Barbara laid out and use it to my own ends. I ended up with this snippet of code added to my <code>Startup.ConfigureServices</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">services</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .AddAuthentication(sharedOptions =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sharedOptions.DefaultScheme = &quot;WhichAuthDoWeUse&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sharedOptions.DefaultAuthenticateScheme = &quot;WhichAuthDoWeUse&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sharedOptions.DefaultChallengeScheme = &quot;WhichAuthDoWeUse&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .AddPolicyScheme(&quot;WhichAuthDoWeUse&quot;, &quot;Azure AD or Cookies&quot;, options =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        options.ForwardDefaultSelector = context =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var (isExternalRequest, requestUrl) = context.Request.GetIsExternalRequestAndDomain();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (isExternalRequest) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                _logger.LogInformation(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;Request ({RequestURL}) has come from external domain ({Domain}) so using Cookie Authentication&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    requestUrl, ExternalBaseUrl);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return CookieAuthenticationDefaults.AuthenticationScheme;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           _logger.LogInformation(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               &quot;Request ({RequestURL}) has not come from external domain ({Domain}) so using Azure AD Authentication&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               requestUrl, ExternalBaseUrl);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return AzureADDefaults.AuthenticationScheme;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .AddAzureAD(options =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Configuration.Bind(&quot;AzureAd&quot;, options);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .AddCookie(options =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        options.Cookie.SecurePolicy = CookieSecurePolicy.Always;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        options.Cookie.SameSite = SameSiteMode.Strict;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        options.Cookie.HttpOnly = true;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        options.Events.OnRedirectToAccessDenied = (context) =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            context.Response.StatusCode = Microsoft.AspNetCore.Http.StatusCodes.Status401Unauthorized;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return Task.CompletedTask;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        options.Events.OnRedirectToLogin = (context) =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            context.Response.StatusCode = Microsoft.AspNetCore.Http.StatusCodes.Status401Unauthorized;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return Task.CompletedTask;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>If you look at this code it&#x27;s doing these things:</p><ol><li>Registering three types of authentication: Cookie, Azure AD and &quot;WhichAuthDoWeUse&quot;</li><li>Registers the default <code>Scheme</code> to be &quot;WhichAuthDoWeUse&quot;.</li></ol><p>&quot;WhichAuthDoWeUse&quot; is effectively an <code>if</code> statement that says, <em>&quot;if this is an external <code>Request</code> use Cookies authentication, otherwise use Azure AD&quot;</em>. Given that &quot;WhichAuthDoWeUse&quot; is the default scheme, this code runs for each request, to determine which authentication method to use.</p><p>Alongside this mechanism I added these extension methods:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Http;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Http.Extensions;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace My.App.Auth {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static class AuthExtensions {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public const string ExternalBaseUrl = &quot;https://mega-app.com&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public const string InternalBaseUrl = &quot;https://strictly4mypeeps.io&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// Determines if a request is an &quot;external&quot; URL (eg begins &quot;https://mega-app.com&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// or an &quot;internal&quot; URL (eg begins &quot;https://strictly4mypeeps.io&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static (bool, string) GetIsExternalRequestAndDomain(this HttpRequest request) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var (requestUrl, domain) = GetRequestUrlAndDomain(request);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var isExternalUrl = domain == ExternalBaseUrl;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var isUnknownPath = domain == null; // This scenario is extremely unlikely but has been observed once during testing so we will cater for it</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var isExternalRequest = isExternalUrl || isUnknownPath; // If unknown we&#x27;ll treat as &quot;external&quot; for a safe fallback</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return (isExternalRequest, requestUrl);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// Determines if a request is an &quot;external&quot; URL (eg begins &quot;https://mega-app.com&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// or an &quot;internal&quot; URL (eg begins &quot;https://strictly4mypeeps.io&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public static (bool, string) GetIsInternalRequestAndDomain(this HttpRequest request) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var (requestUrl, domain) = GetRequestUrlAndDomain(request);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var isInternalRequest = domain == InternalBaseUrl;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return (isInternalRequest, requestUrl);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private static (string, string) GetRequestUrlAndDomain(HttpRequest request) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            string requestUrl = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            string domain = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (request.Host.HasValue) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                requestUrl = request.GetEncodedUrl();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                domain = new Uri(requestUrl).GetLeftPart(UriPartial.Authority);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return (requestUrl, domain);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Finally, I updated the <code>SpaController.cs</code> (which serves initial requests to our Single Page Application) to cater for having two types of Auth in play:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><div tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// ASP.NET will try and load the index.html using the FileServer if we don&#x27;t have a route</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// here to match `/`. These attributes can&#x27;t be on Index or the spa fallback doesn&#x27;t work</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// Note: this is almost perfect except that if someone actually calls /index.html they&#x27;ll get</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// the FileServer one, not the one from this file.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [HttpGet(&quot;/&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [AllowAnonymous]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public async Task&lt;IActionResult&gt; SpaFallback([FromQuery] string returnUrl) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var redirectUrlIfUserIsInternalAndNotAuthenticated = GetRedirectUrlIfUserIsInternalAndNotAuthenticated(returnUrl);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (redirectUrlIfUserIsInternalAndNotAuthenticated != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return LocalRedirect(redirectUrlIfUserIsInternalAndNotAuthenticated);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return await Index(); // Index just serves up our SPA index.html</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// SPA landing with authorisation - this endpoint will typically not be directly navigated to by a user; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// rather it will be redirected to from the IndexWithoutAuthorisation and SpaFallback actions above</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// in the case where a user is *not* authenticated but has come from an internal URL eg https://strictlyformypeeps.io</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [HttpGet(&quot;/login-with-azure-ad&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [Authorize]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public async Task&lt;IActionResult&gt; IndexWithAuthorisation()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return await Index(); // Index just serves up our SPA index.html</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// This method returns a RedirectURL if a request is coming from an internal URL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// eg https://ix-web-int.prd.investec.cloud and is not authenticated.  In this case</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// we likely want to trigger authentication by redirecting to an authorized endpoint</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        string GetRedirectUrlIfUserIsInternalAndNotAuthenticated(string returnUrl)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // If a user is authenticated then we don&#x27;t need to trigger authentication</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var isAuthenticated = User?.Identity?.Name != null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (isAuthenticated)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // This scenario is extremely unlikely but has been observed once during testing so we will cater for it</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var (isInternalRequest, requestUrl) = Request.GetIsInternalRequestAndDomain();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (isInternalRequest) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var redirectUrl = $&quot;/login-with-azure-ad{(string.IsNullOrEmpty(returnUrl) ? &quot;&quot; : &quot;?returnUrl=&quot; + WebUtility.UrlEncode(returnUrl))}&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                _logger.LogInformation(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;Request ({RequestURL}) has come from internal domain ({InternalDomain}) but is not authenticated; redirecting to {RedirectURL}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    requestUrl, AuthExtensions.InternalBaseUrl, redirectUrl);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return redirectUrl;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The code above allows anonymous requests to land in our app through the <code>AllowAnonymous</code> attribute. However, it checks the request when it comes in to see if:</p><ol><li>It&#x27;s an internal request (i.e. the Request URL starts &quot;<a href="https://strictly4mypeeps.io/%22" target="_blank" rel="noopener noreferrer">https://strictly4mypeeps.io/&quot;</a>)</li><li>The current user is <em>not</em> authenticated.</li></ol><p>In this case the user is redirected to the <a href="https://strictly4mypeeps.io/login-with-azure-ad" target="_blank" rel="noopener noreferrer">https://strictly4mypeeps.io/login-with-azure-ad</a> route which is decorated with the <code>Authorize</code> attribute. This will trigger authentication for our unauthenticated internal users and drive them through the Azure AD login process.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="the-mystery-of-no-documentation"></a>The mystery of no documentation<a class="hash-link" href="#the-mystery-of-no-documentation" title="Direct link to heading">#</a></h2><p>I&#x27;m so surprised that this approach hasn&#x27;t yet been better documented on the (generally superb) ASP.Net Core docs. It&#x27;s such a potentially useful approach; and in our case, money saving too! I hope the official docs feature something on this in future. If they do, and I&#x27;ve just missed it (possible!) then please hit me up in the comments.</p></div></article><div><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/blog/2020-03-22-dual-boot-authentication-with-aspnetcore.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/2020/03/29/offline-storage-in-pwa"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Offline storage in a PWA</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/2020/02/21/web-workers-comlink-typescript-and-react"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Web Workers, comlink, TypeScript and React Â»</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#let-us-speak-of-the-past" class="table-of-contents__link">Let us speak of the past</a></li><li><a href="#a-new-hope" class="table-of-contents__link">A new hope</a></li><li><a href="#show-me-the-code" class="table-of-contents__link">Show me the code</a></li><li><a href="#the-mystery-of-no-documentation" class="table-of-contents__link">The mystery of no documentation</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/styles.34fdb787.js"></script>
<script src="/assets/js/runtime~main.fa2ae691.js"></script>
<script src="/assets/js/main.06ae1ef2.js"></script>
<script src="/assets/js/1.1633a53e.js"></script>
<script src="/assets/js/2.c345114a.js"></script>
<script src="/assets/js/ccc49370.b9733cf3.js"></script>
<script src="/assets/js/c3b5bd8c.19074e3d.js"></script>
<script src="/assets/js/8890ac7a.0a62e0ad.js"></script>
<script src="/assets/js/fe3d2add.28822df4.js"></script>
</body>
</html>